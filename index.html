<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"harmonyostech.github.io","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="Welcome to the HarmonyOS NEXT Knowledge Charging Station!  This is a hub for knowledge about HarmonyOS Next&#96;s new-generation system. With its self-developed kernel, HarmonyOS NEXT achieves native smoo">
<meta property="og:type" content="website">
<meta property="og:title" content="HarmonyOS NEXT Knowledge Charging Station">
<meta property="og:url" content="https://harmonyostech.github.io/index.html">
<meta property="og:site_name" content="HarmonyOS NEXT Knowledge Charging Station">
<meta property="og:description" content="Welcome to the HarmonyOS NEXT Knowledge Charging Station!  This is a hub for knowledge about HarmonyOS Next&#96;s new-generation system. With its self-developed kernel, HarmonyOS NEXT achieves native smoo">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Qingkouwei">
<meta property="article:tag" content="HarmonyOSNext, HarmonyOS NEXT, HarmonyOS, Cangjie">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://harmonyostech.github.io/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>HarmonyOS NEXT Knowledge Charging Station</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">HarmonyOS NEXT Knowledge Charging Station</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">Analysis of Core Technologies and Application Scenarios of HarmonyOS NEXT</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://harmonyostech.github.io/2025/06/30/C-HarmonyOS-Multi-Target-Artifact-Construction-Best-Practices/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Qingkouwei">
      <meta itemprop="description" content="Welcome to the HarmonyOS NEXT Knowledge Charging Station!  This is a hub for knowledge about HarmonyOS Next`s new-generation system. With its self-developed kernel, HarmonyOS NEXT achieves native smoothness, security, intelligence, and interconnectivity. We deeply analyze how its new distributed soft bus revolutionizes device connectivity experiences and explain the principles behind the enhanced perception and reasoning capabilities of the Xiaoyi intelligent agent based on the Pangu large model. Whether you are a developer exploring application development or an ordinary user eager to understand system features, you can "recharge" here and quickly grasp the essence of HarmonyOS NEXT.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HarmonyOS NEXT Knowledge Charging Station">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/06/30/C-HarmonyOS-Multi-Target-Artifact-Construction-Best-Practices/" class="post-title-link" itemprop="url">HarmonyOS Multi-Target Artifact Construction Best Practices</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2025-06-30 22:31:41" itemprop="dateCreated datePublished" datetime="2025-06-30T22:31:41+08:00">2025-06-30</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-07-13 09:43:59" itemprop="dateModified" datetime="2025-07-13T09:43:59+08:00">2025-07-13</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/HarmonyOS-Next-Tech/" itemprop="url" rel="index"><span itemprop="name">HarmonyOS Next Tech</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="HarmonyOS-Multi-Target-Artifact-Construction-Best-Practices"><a href="#HarmonyOS-Multi-Target-Artifact-Construction-Best-Practices" class="headerlink" title="HarmonyOS Multi-Target Artifact Construction Best Practices"></a>HarmonyOS Multi-Target Artifact Construction Best Practices</h1><h2 id="Background"><a href="#Background" class="headerlink" title="Background"></a>Background</h2><p>In Android or iOS development, there is often a need to create “马甲” packages (reskinned apps) from a single codebase for different themes or user groups. For example, Douyin has domestic and international versions, while Didi has personal and enterprise editions. Similarly, the HarmonyOS platform has similar requirements. This article discusses multi-artifact construction for HarmonyOS.  </p>
<h2 id="HarmonyOS-Project-Configuration-File-Description"><a href="#HarmonyOS-Project-Configuration-File-Description" class="headerlink" title="HarmonyOS Project Configuration File Description"></a>HarmonyOS Project Configuration File Description</h2><p>Below is a screenshot of the simplest HarmonyOS project:  </p>
<p><img src="/../images/HarmonyOS%E5%A4%9A%E7%9B%AE%E6%A0%87%E4%BA%A7%E7%89%A9%E6%9E%84%E5%BB%BA%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5.png"></p>
<h3 id="Project-build-profile-json5"><a href="#Project-build-profile-json5" class="headerlink" title="Project build-profile.json5"></a>Project <code>build-profile.json5</code></h3><p>In a standard Android project, modules are declared in <code>setting.gradle</code>. For HarmonyOS, module configurations are in <code>build-profile.json5</code>:  </p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span>  </span><br><span class="line">  <span class="attr">&quot;app&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span>  </span><br><span class="line">    <span class="attr">&quot;signingConfigs&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span>  </span><br><span class="line">    <span class="attr">&quot;products&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>  </span><br><span class="line">      <span class="punctuation">&#123;</span>  </span><br><span class="line">        <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;default&quot;</span><span class="punctuation">,</span>  </span><br><span class="line">        <span class="attr">&quot;signingConfig&quot;</span><span class="punctuation">:</span> <span class="string">&quot;default&quot;</span><span class="punctuation">,</span>  </span><br><span class="line">        <span class="attr">&quot;compatibleSdkVersion&quot;</span><span class="punctuation">:</span> <span class="string">&quot;5.0.0(12)&quot;</span><span class="punctuation">,</span>  </span><br><span class="line">        <span class="attr">&quot;runtimeOS&quot;</span><span class="punctuation">:</span> <span class="string">&quot;HarmonyOS&quot;</span><span class="punctuation">,</span>  </span><br><span class="line">      <span class="punctuation">&#125;</span>  </span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span>  </span><br><span class="line">    <span class="attr">&quot;buildModeSet&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>  </span><br><span class="line">      <span class="punctuation">&#123;</span>  </span><br><span class="line">        <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;debug&quot;</span><span class="punctuation">,</span>  </span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span>  </span><br><span class="line">      <span class="punctuation">&#123;</span>  </span><br><span class="line">        <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;release&quot;</span>  </span><br><span class="line">      <span class="punctuation">&#125;</span>  </span><br><span class="line">    <span class="punctuation">]</span>  </span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span>  </span><br><span class="line">  <span class="attr">&quot;modules&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>  </span><br><span class="line">    <span class="punctuation">&#123;</span>  </span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;entry&quot;</span><span class="punctuation">,</span>  </span><br><span class="line">      <span class="attr">&quot;srcPath&quot;</span><span class="punctuation">:</span> <span class="string">&quot;./entry&quot;</span><span class="punctuation">,</span>  </span><br><span class="line">      <span class="attr">&quot;targets&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>  </span><br><span class="line">        <span class="punctuation">&#123;</span>  </span><br><span class="line">          <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;default&quot;</span><span class="punctuation">,</span>  </span><br><span class="line">          <span class="attr">&quot;applyToProducts&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>  </span><br><span class="line">            <span class="string">&quot;default&quot;</span>  </span><br><span class="line">          <span class="punctuation">]</span>  </span><br><span class="line">        <span class="punctuation">&#125;</span>  </span><br><span class="line">      <span class="punctuation">]</span>  </span><br><span class="line">    <span class="punctuation">&#125;</span>  </span><br><span class="line">  <span class="punctuation">]</span>  </span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>


<p>The <code>modules</code> list declares modules with:  </p>
<ul>
<li><code>name</code>: Module name  </li>
<li><code>srcPath</code>: Module path  </li>
<li><code>targets</code>: Build targets</li>
</ul>
<p><strong>Notes</strong>: Differences from Android:  </p>
<ol>
<li>Only one <code>entry</code> module is allowed per project (e.g., creating two demo modules in an SDK project is prohibited).  </li>
<li><code>srcPath</code> can only point to the project root or subdirectories (e.g., source dependency on modules from another project is not allowed).</li>
</ol>
<h3 id="Module-build-profile-json5"><a href="#Module-build-profile-json5" class="headerlink" title="Module build-profile.json5"></a>Module <code>build-profile.json5</code></h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span>  </span><br><span class="line">  <span class="attr">&quot;apiType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;stageMode&quot;</span><span class="punctuation">,</span>  </span><br><span class="line">  <span class="attr">&quot;buildOption&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span>  </span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span>  </span><br><span class="line">  <span class="attr">&quot;buildOptionSet&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>  </span><br><span class="line">    <span class="punctuation">&#123;</span>  </span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;release&quot;</span><span class="punctuation">,</span>  </span><br><span class="line">      <span class="attr">&quot;arkOptions&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span>  </span><br><span class="line">        <span class="attr">&quot;obfuscation&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span>  </span><br><span class="line">          <span class="attr">&quot;ruleOptions&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span>  </span><br><span class="line">            <span class="attr">&quot;enable&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span>  </span><br><span class="line">            <span class="attr">&quot;files&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>  </span><br><span class="line">              <span class="string">&quot;./obfuscation-rules.txt&quot;</span>  </span><br><span class="line">            <span class="punctuation">]</span>  </span><br><span class="line">          <span class="punctuation">&#125;</span>  </span><br><span class="line">        <span class="punctuation">&#125;</span>  </span><br><span class="line">      <span class="punctuation">&#125;</span>  </span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span>  </span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span>  </span><br><span class="line">  <span class="attr">&quot;targets&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>  </span><br><span class="line">    <span class="punctuation">&#123;</span>  </span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;default&quot;</span>  </span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span>  </span><br><span class="line">    <span class="punctuation">&#123;</span>  </span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ohosTest&quot;</span><span class="punctuation">,</span>  </span><br><span class="line">    <span class="punctuation">&#125;</span>  </span><br><span class="line">  <span class="punctuation">]</span>  </span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><code>apiType</code>: API model type  <ul>
<li><code>stageMode</code>: Long-term evolution model (official recommendation)  </li>
<li><code>faMode</code>: FA model</li>
</ul>
</li>
<li><code>buildOptionSet</code>: Compilation configuration (e.g., obfuscation rules)  </li>
<li><code>targets</code>: Build targets</li>
</ul>
<h3 id="module-json5"><a href="#module-json5" class="headerlink" title="module.json5"></a><code>module.json5</code></h3><p>Example in <code>module/main/module.json5</code>:  </p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span>  </span><br><span class="line">  <span class="attr">&quot;module&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span>  </span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;entry&quot;</span><span class="punctuation">,</span>  </span><br><span class="line">    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;entry&quot;</span><span class="punctuation">,</span>  </span><br><span class="line">    <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$string:module_desc&quot;</span><span class="punctuation">,</span>  </span><br><span class="line">    <span class="attr">&quot;mainElement&quot;</span><span class="punctuation">:</span> <span class="string">&quot;EntryAbility&quot;</span><span class="punctuation">,</span>  </span><br><span class="line">    <span class="attr">&quot;deviceTypes&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>  </span><br><span class="line">      <span class="string">&quot;phone&quot;</span><span class="punctuation">,</span>  </span><br><span class="line">      <span class="string">&quot;tablet&quot;</span><span class="punctuation">,</span>  </span><br><span class="line">      <span class="string">&quot;2in1&quot;</span>  </span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span>  </span><br><span class="line">    <span class="attr">&quot;deliveryWithInstall&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span>  </span><br><span class="line">    <span class="attr">&quot;installationFree&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span>  </span><br><span class="line">    <span class="attr">&quot;pages&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$profile:main_pages&quot;</span><span class="punctuation">,</span>  </span><br><span class="line">    <span class="attr">&quot;abilities&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>  </span><br><span class="line">      <span class="punctuation">&#123;</span>  </span><br><span class="line">        <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;EntryAbility&quot;</span><span class="punctuation">,</span>  </span><br><span class="line">        <span class="attr">&quot;srcEntry&quot;</span><span class="punctuation">:</span> <span class="string">&quot;./ets/entryability/EntryAbility.ets&quot;</span><span class="punctuation">,</span>  </span><br><span class="line">        <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$string:EntryAbility_desc&quot;</span><span class="punctuation">,</span>  </span><br><span class="line">        <span class="attr">&quot;icon&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$media:layered_image&quot;</span><span class="punctuation">,</span>  </span><br><span class="line">        <span class="attr">&quot;label&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$string:EntryAbility_label&quot;</span><span class="punctuation">,</span>  </span><br><span class="line">        <span class="attr">&quot;startWindowIcon&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$media:startIcon&quot;</span><span class="punctuation">,</span>  </span><br><span class="line">        <span class="attr">&quot;startWindowBackground&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$color:start_window_background&quot;</span><span class="punctuation">,</span>  </span><br><span class="line">        <span class="attr">&quot;exported&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span>  </span><br><span class="line">        <span class="attr">&quot;skills&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>  </span><br><span class="line">          <span class="punctuation">&#123;</span>  </span><br><span class="line">            <span class="attr">&quot;entities&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>  </span><br><span class="line">              <span class="string">&quot;entity.system.home&quot;</span>  </span><br><span class="line">            <span class="punctuation">]</span><span class="punctuation">,</span>  </span><br><span class="line">            <span class="attr">&quot;actions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>  </span><br><span class="line">              <span class="string">&quot;action.system.home&quot;</span>  </span><br><span class="line">            <span class="punctuation">]</span>  </span><br><span class="line">          <span class="punctuation">&#125;</span>  </span><br><span class="line">        <span class="punctuation">]</span>  </span><br><span class="line">      <span class="punctuation">&#125;</span>  </span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span>  </span><br><span class="line">    <span class="attr">&quot;extensionAbilities&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>  </span><br><span class="line">      <span class="punctuation">&#123;</span>  </span><br><span class="line">        <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;EntryBackupAbility&quot;</span><span class="punctuation">,</span>  </span><br><span class="line">        <span class="attr">&quot;srcEntry&quot;</span><span class="punctuation">:</span> <span class="string">&quot;./ets/entrybackupability/EntryBackupAbility.ets&quot;</span><span class="punctuation">,</span>  </span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;backup&quot;</span><span class="punctuation">,</span>  </span><br><span class="line">        <span class="attr">&quot;exported&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span>  </span><br><span class="line">        <span class="attr">&quot;metadata&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>  </span><br><span class="line">          <span class="punctuation">&#123;</span>  </span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ohos.extension.backup&quot;</span><span class="punctuation">,</span>  </span><br><span class="line">            <span class="attr">&quot;resource&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$profile:backup_config&quot;</span>  </span><br><span class="line">          <span class="punctuation">&#125;</span>  </span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span>  </span><br><span class="line">      <span class="punctuation">&#125;</span>  </span><br><span class="line">    <span class="punctuation">]</span>  </span><br><span class="line">  <span class="punctuation">&#125;</span>  </span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>Similar to AndroidManifest, it declares module information and device types:  </p>
<ul>
<li><code>name</code>: Unique module identifier (≤31 bytes, no Chinese)  </li>
<li><code>type</code>: Module type (e.g., <code>entry</code>, <code>feature</code>, <code>har</code>, <code>shared</code>)  </li>
<li><code>srcEntry</code>: Code path (≤127 bytes)  </li>
<li><code>deviceTypes</code>: Supported device categories  </li>
<li><code>deliveryWithInstall</code>: Whether to install with the app (true&#x2F;false)  </li>
<li>For more details, refer to: <a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/module-configuration-file-V5">https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/module-configuration-file-V5</a></li>
</ul>
<h2 id="Official-Recommended-Module-Structure"><a href="#Official-Recommended-Module-Structure" class="headerlink" title="Official Recommended Module Structure"></a>Official Recommended Module Structure</h2><p>Flat directory module management has two drawbacks:  </p>
<ol>
<li>Messy project logic structure  </li>
<li>Unclear dependency relationships</li>
</ol>
<p>The official recommends a three-layer structure:  </p>
<pre><code>/application
 ├── common                  # Common features directory
 │
 ├── features                # Functional modules directory
 │   ├── feature1            # Sub-feature 1
 │   ├── feature2            # Sub-feature 2
 │   └── ...                 # Sub-feature n
 │
 └── product                 # Product layer directory
     ├── wearable            # Wearable devices directory
     ├── default             # Default devices directory
     └── ...
</code></pre>
<h2 id="Introduction-to-Product-and-Target"><a href="#Introduction-to-Product-and-Target" class="headerlink" title="Introduction to Product and Target"></a>Introduction to Product and Target</h2><p>Before discussing multi-target artifact construction, understand <code>target</code> and <code>product</code>:  </p>
<ul>
<li><strong>Target</strong>: Each Entry&#x2F;Feature module in a project, with build artifacts as HAPs (runnable on devices). A module can define multiple targets for customized HAPs (e.g., different functions&#x2F;resources for the same module).  </li>
<li><strong>Product</strong>: The build artifact of a HarmonyOS project is an APP package (for app market release). A project can define multiple products for customized APP packages.</li>
</ul>
<h2 id="Best-Practices"><a href="#Best-Practices" class="headerlink" title="Best Practices"></a>Best Practices</h2><h3 id="Objective"><a href="#Objective" class="headerlink" title="Objective"></a>Objective</h3><p>Develop an SDK with two encapsulated sub-SDKs for ToB and ToC businesses. The three SDKs need to be debugged via three separate Demo projects in one workspace.  </p>
<p><img src="/../images/HarmonyOS%E5%A4%9A%E7%9B%AE%E6%A0%87%E4%BA%A7%E7%89%A9%E6%9E%84%E5%BB%BA%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5.png"></p>
<h3 id="Solutions"><a href="#Solutions" class="headerlink" title="Solutions"></a>Solutions</h3><p>Since only one runnable <code>entry</code> module is allowed per HarmonyOS project, creating three separate demo modules is infeasible:  </p>
<pre><code class="language-json">&quot;modules&quot;: [  
  &#123;  
    &quot;name&quot;: &quot;app&quot;,  
    &quot;srcPath&quot;: &quot;./app&quot;,  
    &quot;targets&quot;: [  
      &#123;  
        &quot;name&quot;: &quot;default&quot;,  
        &quot;applyToProducts&quot;: [  
          &quot;default&quot;  
        ]  
      &#125;
    ]  
  &#125;,  
 &#123;  
    &quot;name&quot;: &quot;app_c&quot;,  
    &quot;srcPath&quot;: &quot;./app_c&quot;,  
    &quot;targets&quot;: [  
      &#123;  
        &quot;name&quot;: &quot;default&quot;,  
        &quot;applyToProducts&quot;: [  
          &quot;default&quot;  
        ]  
      &#125;  
    ]  
  &#125;,  
  &#123;  
    &quot;name&quot;: &quot;app_b&quot;,  
    &quot;srcPath&quot;: &quot;./app_b&quot;,  
    &quot;targets&quot;: [  
      &#123;  
        &quot;name&quot;: &quot;default&quot;,  
        &quot;applyToProducts&quot;: [  
          &quot;default&quot;  
        ]  
      &#125;  
    ]  
  &#125;
]
</code></pre>
<p>Only the first module can run, even with three declared modules.  </p>
<h4 id="Solution-1"><a href="#Solution-1" class="headerlink" title="Solution 1"></a>Solution 1</h4><p>Comment&#x2F;uncomment modules for debugging. Drawback: Requires code modifications for each debug switch.  </p>
<h4 id="Solution-2"><a href="#Solution-2" class="headerlink" title="Solution 2"></a>Solution 2</h4><p>Combine Biz2B and Biz2C into one module with two targets (2B&#x2F;2C) via different code paths. Drawback: Incompatible with independent SDK requirements.  </p>
<h4 id="Solution-3"><a href="#Solution-3" class="headerlink" title="Solution 3"></a>Solution 3</h4><p>Define separate targets for Biz2B and Biz2C, configuring source paths in module-level <code>build_profile.json5</code> with <code>sourceRoots</code>. For example, the 2C target of the Biz2B module points to an empty path, ensuring no Biz2B code is included in 2C debugging.  </p>
<h2 id="Reference-Documents"><a href="#Reference-Documents" class="headerlink" title="Reference Documents"></a>Reference Documents</h2><ol>
<li><a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/ide-customized-multi-targets-and-products-guides-0000001731595144-V5#section2554174114463">https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/ide-customized-multi-targets-and-products-guides-0000001731595144-V5#section2554174114463</a>  </li>
<li><a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/ide-using-V5">https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/ide-using-V5</a></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://harmonyostech.github.io/2025/06/30/C-HarmonyOS-IM-System-Practice-One-Development-Multi-Endpoint-Deployment/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Qingkouwei">
      <meta itemprop="description" content="Welcome to the HarmonyOS NEXT Knowledge Charging Station!  This is a hub for knowledge about HarmonyOS Next`s new-generation system. With its self-developed kernel, HarmonyOS NEXT achieves native smoothness, security, intelligence, and interconnectivity. We deeply analyze how its new distributed soft bus revolutionizes device connectivity experiences and explain the principles behind the enhanced perception and reasoning capabilities of the Xiaoyi intelligent agent based on the Pangu large model. Whether you are a developer exploring application development or an ordinary user eager to understand system features, you can "recharge" here and quickly grasp the essence of HarmonyOS NEXT.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HarmonyOS NEXT Knowledge Charging Station">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/06/30/C-HarmonyOS-IM-System-Practice-One-Development-Multi-Endpoint-Deployment/" class="post-title-link" itemprop="url">HarmonyOS IM System Practice: One Development, Multi-Endpoint Deployment</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2025-06-30 22:29:38" itemprop="dateCreated datePublished" datetime="2025-06-30T22:29:38+08:00">2025-06-30</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-07-13 09:59:56" itemprop="dateModified" datetime="2025-07-13T09:59:56+08:00">2025-07-13</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/HarmonyOS-Next-Tech/" itemprop="url" rel="index"><span itemprop="name">HarmonyOS Next Tech</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="HarmonyOS-IM-System-Practice-One-Development-Multi-Endpoint-Deployment"><a href="#HarmonyOS-IM-System-Practice-One-Development-Multi-Endpoint-Deployment" class="headerlink" title="HarmonyOS IM System Practice: One Development, Multi-Endpoint Deployment"></a>HarmonyOS IM System Practice: One Development, Multi-Endpoint Deployment</h1><p><img src="/../images/HarmonyOS%E5%AE%9E%E6%88%98IM%E7%B3%BB%E7%BB%9F%E4%B9%8B%EF%BC%9A%E9%A1%B5%E9%9D%A2%E7%BA%A7%E4%B8%80%E6%AC%A1%E5%BC%80%E5%8F%91%E5%A4%9A%E7%AB%AF%E9%83%A8%E7%BD%B2.png"></p>
<h3 id="Background-Introduction"><a href="#Background-Introduction" class="headerlink" title="Background Introduction"></a>Background Introduction</h3><p>Instant Messaging (IM) has become an indispensable part of modern applications, playing a crucial role in enhancing user experience, improving business efficiency, strengthening customer service, and driving business growth. From the live streaming apps developed at the start of my career to the current housing platform applications, IM has always played a vital role. With the rise of the HarmonyOS and the maturity of its ecosystem, many manufacturers are adapting to HarmonyOS Next. As an early adopter, I hope to explore new ways to implement IM scenarios through the new features of HarmonyOS.  </p>
<p>This article shares practical implementations of “One Development, Multi-Endpoint Deployment” (referred to as “One-Many”) in IM systems.  </p>
<h3 id="1-What-is-One-Development-Multi-Endpoint-Deployment"><a href="#1-What-is-One-Development-Multi-Endpoint-Deployment" class="headerlink" title="1. What is One Development, Multi-Endpoint Deployment?"></a>1. What is One Development, Multi-Endpoint Deployment?</h3><p>First, let’s look at the official definition of “One Development, Multi-Endpoint Deployment” (abbreviated as “One-Many”):<br><strong>One codebase, one development and release process, multi-endpoint deployment on demand.</strong>  </p>
<p><strong>Goal</strong>: Enable developers to efficiently develop applications supporting multiple device forms, ensuring compatibility with different devices while providing distributed experiences such as cross-device flow, migration, and collaboration.  </p>
<p>To achieve the “One-Many” goal, two fundamental issues need to be solved:  </p>
<ul>
<li>How to adapt to devices with different sizes and display capabilities;  </li>
<li>How to兼容 functions for devices with different system capabilities (e.g., TVs without cameras or watches without microphones).</li>
</ul>
<p>In summary: <strong>“One-Many” solves page adaptation and functional compatibility issues for different devices with a single codebase.</strong> This article focuses on page adaptation.  </p>
<p>After understanding the definition of One-Many, let’s examine the pain points of device adaptation in the past.  </p>
<p>In the early days of my career, I developed a live streaming app for two platforms: Windows and Android, each implemented with native technologies. This approach was inefficient. Later, the Windows platform switched to the QT framework for cross-platform development. However, QT increased the package size, and due to the different screen sizes of Windows and Android, the UI layouts for the two platforms had to be completely different. As a result, only business logic could be shared across platforms, while UI development remained platform-specific.  </p>
<p>Popular frameworks like Flutter face the same challenge: due to differing UI layouts, the UI layer must be adapted to platforms with different screen sizes.  </p>
<p>Before HarmonyOS Next, there was no complete solution for achieving satisfactory UI effects with a single codebase—separate adaptations were necessary. HarmonyOS’s page-level One-Many capability completely solves this problem.  </p>
<h3 id="2-What-Can-One-Many-Bring-to-IM"><a href="#2-What-Can-One-Many-Bring-to-IM" class="headerlink" title="2. What Can One-Many Bring to IM?"></a>2. What Can One-Many Bring to IM?</h3><p>In IM scenarios, take Feishu’s chat function as an example: on PC, the conversation list and chat page are arranged side-by-side:  </p>
<p><img src="/../images/HarmonyOS%E5%AE%9E%E6%88%98IM%E7%B3%BB%E7%BB%9F%E4%B9%8B%EF%BC%9A%E9%A1%B5%E9%9D%A2%E7%BA%A7%E4%B8%80%E6%AC%A1%E5%BC%80%E5%8F%91%E5%A4%9A%E7%AB%AF%E9%83%A8%E7%BD%B2-1.jpg"></p>
<p>On mobile devices with smaller screens, the conversation list and chat page become separate pages:<br><img src="/../images/HarmonyOS%E5%AE%9E%E6%88%98IM%E7%B3%BB%E7%BB%9F%E4%B9%8B%EF%BC%9A%E9%A1%B5%E9%9D%A2%E7%BA%A7%E4%B8%80%E6%AC%A1%E5%BC%80%E5%8F%91%E5%A4%9A%E7%AB%AF%E9%83%A8%E7%BD%B2-2.jpg"></p>
<p><img src="/../images/HarmonyOS%E5%AE%9E%E6%88%98IM%E7%B3%BB%E7%BB%9F%E4%B9%8B%EF%BC%9A%E9%A1%B5%E9%9D%A2%E7%BA%A7%E4%B8%80%E6%AC%A1%E5%BC%80%E5%8F%91%E5%A4%9A%E7%AB%AF%E9%83%A8%E7%BD%B2-3.jpg"></p>
<p>Based on HarmonyOS Next’s page-level One-Many capability, we can use a single codebase to implement the above chat interface adaptations.  </p>
<h3 id="3-Introduction-to-HarmonyOS-One-Many"><a href="#3-Introduction-to-HarmonyOS-One-Many" class="headerlink" title="3. Introduction to HarmonyOS One-Many"></a>3. Introduction to HarmonyOS One-Many</h3><p>Let’s think: how would we design a system to achieve the above capabilities without considering HarmonyOS?  </p>
<p>First, device-independent pixels (similar to dp units in Android) are essential to adapt content size to different device sizes.<br>Second, the system needs to support using different UIs for devices with varying screen sizes.  </p>
<p>HarmonyOS ArkUI provides two layout capabilities to solve these problems:  </p>
<ol>
<li><strong>Adaptive Layout</strong>: When the external container size changes, page elements automatically adjust based on relative relationships (e.g., proportion, fixed aspect ratio, display priority) to adapt to the container. For example, on large screens, the conversation list and chat notifications are displayed side-by-side, while on small screens, they are displayed separately. ArkTS offers seven adaptive layout capabilities: stretching, equal distribution, proportion, scaling, extension, hiding, and wrapping.  </li>
<li><strong>Responsive Layout</strong>: When the external container size changes significantly (e.g., foldable phone switching from 400vp to 1000vp width), elements adjust based on breakpoints, grids, or specific features (e.g., screen orientation, window size) to adapt to the container. ArkTS provides three responsive layout capabilities: breakpoints, media queries, and grid layout.</li>
</ol>
<h4 id="3-1-Adaptive-Layout"><a href="#3-1-Adaptive-Layout" class="headerlink" title="3.1 Adaptive Layout"></a>3.1 Adaptive Layout</h4><p>ArkUI abstracts seven adaptive layout capabilities:  </p>
<ol>
<li><strong>Stretching</strong>: When the container size changes, the increased or decreased space is <strong>fully allocated</strong> to specified areas within the container. Achieved via <code>flexGrow</code> and <code>flexShrink</code> in Flex layout.  </li>
<li><strong>Equal Distribution</strong>: When the container size changes, the space is <strong>evenly distributed</strong> to all empty areas within the container. Achieved by setting <code>justifyContent</code> to <code>FlexAlign.SpaceEvenly</code> for Row, Column, or Flex components (e.g., TAB layouts on home pages).  </li>
<li><strong>Proportion</strong>: The width or height of child components changes with the container <strong>according to a preset ratio</strong>. Implemented by setting child component width&#x2F;height as a percentage of the parent or using the <code>layoutWeight</code> property.  </li>
<li><strong>Scaling</strong>: The width and height of child components change with the container <strong>according to a preset ratio</strong> while maintaining the aspect ratio. Achieved via the <code>aspectRatio</code> property in layout constraints.  </li>
<li><strong>Extension</strong>: Child components in the container are displayed or hidden <strong>in their order within the list</strong> as the container size changes. Implemented via List components or Scroll components with Row&#x2F;Column.  </li>
<li><strong>Hiding</strong>: Child components in the container are displayed or hidden <strong>based on preset display priorities</strong>. Components with the same priority are displayed or hidden simultaneously. Achieved via the <code>displayPriority</code> property in layout constraints.  </li>
<li><strong>Wrapping</strong>: When the container size is insufficient to display all content, the layout <strong>automatically wraps to the next line</strong>. Achieved by setting <code>wrap</code> to <code>FlexWrap.Wrap</code> in Flex components.</li>
</ol>
<h4 id="3-2-Responsive-Layout"><a href="#3-2-Responsive-Layout" class="headerlink" title="3.2 Responsive Layout"></a>3.2 Responsive Layout</h4><p>Adaptive layouts ensure normal display within a certain window size range. However, when the window size changes significantly (e.g., a foldable phone switching from 400vp to 1000vp width), relying solely on adaptive layout may cause issues like abnormal image scaling or excessive white space (e.g., a feed stream that looks sparse with two columns on a large screen and should display four columns for better aesthetics). In such cases, responsive layout capabilities are needed to adjust the page structure.  </p>
<p>Responsive layout refers to the ability of page elements to automatically adapt to changes in the external container based on specific features (e.g., window width, screen orientation). The most commonly used feature in responsive layout is window width, which is divided into different ranges (called “breakpoints” in ArkUI). When the window width crosses a breakpoint, the page layout is adjusted (e.g., changing from a single column to two or three columns) for optimal display.  </p>
<p>The system currently provides three responsive layout capabilities:  </p>
<ol>
<li><strong>Breakpoints</strong>: Divide window width into ranges (breakpoints), listen for window size changes, and adjust the page layout when a breakpoint is crossed.  </li>
<li><strong>Media Queries</strong>: Listen for multiple media features (window width, orientation, light&#x2F;dark mode, device type, etc.) and adjust the page layout when features change.  </li>
<li><strong>Grid Layout</strong>: Divides the area into regular columns, allowing layout adjustments by modifying grid parameters and the number of columns occupied by child components at different breakpoints.</li>
</ol>
<h3 id="4-Practical-Implementation-of-One-Many-in-IM-Systems"><a href="#4-Practical-Implementation-of-One-Many-in-IM-Systems" class="headerlink" title="4. Practical Implementation of One-Many in IM Systems"></a>4. Practical Implementation of One-Many in IM Systems</h3><h4 id="4-1-Adapting-to-Screen-Size-Changes"><a href="#4-1-Adapting-to-Screen-Size-Changes" class="headerlink" title="4.1 Adapting to Screen Size Changes"></a>4.1 Adapting to Screen Size Changes</h4><p><strong>Grid Layout</strong><br>Grid layout provides a regular structure for layouts, solving dynamic layout problems across multi-size devices and ensuring layout consistency. For example, on small screens, the “My Page” section fills the screen, while on large screens, we may want留白 on both sides—achievable via grid layout. Grid layout parameters determine how the screen is divided into columns and can set different spacing for different screens.  </p>
<p>ArkUI provides <code>GridRow</code> and <code>GridCol</code> to implement grid layouts, which can be used to listen for breakpoints.  </p>
<p>Sample code:  </p>
<pre><code class="language-typescript">build() &#123;  
  GridRow(&#123;  
    columns: &#123;  
      sm: 4,  
      md: 12,  
      lg: 12  
    &#125;  
  &#125;) &#123;  
    GridCol(&#123; span: &#123;  
      sm: 4,  
      md: 12,  
      lg: 12  
    &#125; &#125;) &#123;  
      Column() &#123;  
        Home()  
      &#125;  
      .width(&#39;100%&#39;)  
      .height(&#39;100%&#39;)  
  
    &#125;  
    .height(&#39;100%&#39;)  
    .width(&#39;100%&#39;)  
  &#125;  
  .onBreakpointChange((breakPoints) =&gt; &#123;  
    this.currentBreakpoint = breakPoints;  
  &#125;)  
&#125;
</code></pre>
<h4 id="4-2-Displaying-Different-Content-on-Different-Screens"><a href="#4-2-Displaying-Different-Content-on-Different-Screens" class="headerlink" title="4.2 Displaying Different Content on Different Screens"></a>4.2 Displaying Different Content on Different Screens</h4><p><strong>Navigation Component</strong><br>How to display different pages on different screens? For example, showing only the conversation list on mobile devices and a split view (left list, right details) on foldables or PCs.  </p>
<p>ArkUI provides the <code>Navigation</code> component, which serves as the root container for pages and supports three display modes: single-page, split-view, and adaptive. Suitable for in-module page switching in One-Many scenarios, it enables smooth transition effects through component-level routing and offers various title bar styles for better title-content linkage. In One-Many scenarios, the Navigation component automatically adapts to window size, switching to split-view on larger screens.  </p>
<p>Key properties used:  </p>
<ul>
<li><code>navBarWidth</code>: Width of the navigation bar, effective only in split-view mode.  </li>
<li><code>navDestination</code>: Creates <code>NavDestination</code> components to build different content pages based on strings (e.g., building a chat page for selected conversations or a blank page for unselected ones).  </li>
<li><code>mode</code>: Display mode of the navigation bar. Default is <code>NavigationMode.Auto</code>; use <code>NavigationMode.Split</code> for large screens and <code>NavigationMode.Stack</code> for mobile.</li>
</ul>
<p>Sample code:  </p>
<pre><code class="language-typescript">build() &#123;  
  Column() &#123;  
    
      Navigation(this.pageInfo) &#123;   
		  Flex(&#123; direction: FlexDirection.Column, justifyContent: FlexAlign.Center &#125;) &#123;  
			ConversationList(&#123;  
			  currentConversationUserName: $currentConversationUserName,  
			  currentContactUserName: $currentContactUserName  
			&#125;)  
			  .flexGrow(BaseConstants.FLEX_GROW_ONE)  
			  .width(BaseConstants.FULL_WIDTH)  
      &#125;      
      .hideTitleBar(true)  
      .hideToolBar(true)  
      .navBarWidth(this.currentBreakpoint === BreakpointConstants.BREAKPOINT_LG ? HomeConstants.NAVIGATION_NAV_BAR_WIDTH_LG :  
      HomeConstants.NAVIGATION_NAV_BAR_WIDTH_MD)  
      .navDestination(this.PageMap)  
      .mode(this.currentBreakpoint === BreakpointConstants.BREAKPOINT_SM ? NavigationMode.Stack : NavigationMode.Split)  
      .width(BaseConstants.FULL_WIDTH)  
    &#125;
&#125;

@Builder  
PageMap(name: string) &#123;  
  if (name === &#39;ConversationDetail&#39;) &#123;  
    ConversationDetail(&#123; currentConversationUserName: this.currentConversationUserName, currentFeatureIndex: 1 &#125;);  
  &#125; else if (name === &#39;ConversationDetailNone&#39;) &#123;  
    ConversationDetailNone();  
  &#125; else &#123;  
    ConversationDetailNone();  
  &#125;  
&#125;
</code></pre>
<h3 id="5-Summary"><a href="#5-Summary" class="headerlink" title="5. Summary"></a>5. Summary</h3><p>This article introduces HarmonyOS’s page-level One-Many features and capabilities through IM chat adaptation. ArkUI truly enables one codebase for multi-endpoint deployment, solving the last mile of cross-platform development. We look forward to the improvement of the HarmonyOS ecosystem and the early experience of smooth and convenient new products.</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://harmonyostech.github.io/2025/06/30/C-Introduction-to-DevEco-Studio-for-HarmonyOS-Next-Development-ASan-and-TSan-Detection-to-Cure-Your-C-Phobia/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Qingkouwei">
      <meta itemprop="description" content="Welcome to the HarmonyOS NEXT Knowledge Charging Station!  This is a hub for knowledge about HarmonyOS Next`s new-generation system. With its self-developed kernel, HarmonyOS NEXT achieves native smoothness, security, intelligence, and interconnectivity. We deeply analyze how its new distributed soft bus revolutionizes device connectivity experiences and explain the principles behind the enhanced perception and reasoning capabilities of the Xiaoyi intelligent agent based on the Pangu large model. Whether you are a developer exploring application development or an ordinary user eager to understand system features, you can "recharge" here and quickly grasp the essence of HarmonyOS NEXT.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HarmonyOS NEXT Knowledge Charging Station">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/06/30/C-Introduction-to-DevEco-Studio-for-HarmonyOS-Next-Development-ASan-and-TSan-Detection-to-Cure-Your-C-Phobia/" class="post-title-link" itemprop="url">Introduction to DevEco Studio for HarmonyOS Next Development: ASan and TSan Detection to Cure Your C++ Phobia</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2025-06-30 22:26:15 / Modified: 22:29:25" itemprop="dateCreated datePublished" datetime="2025-06-30T22:26:15+08:00">2025-06-30</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/HarmonyOS-Next-Tech/" itemprop="url" rel="index"><span itemprop="name">HarmonyOS Next Tech</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Introduction-to-DevEco-Studio-for-HarmonyOS-Next-Development-ASan-and-TSan-Detection-to-Cure-Your-C-Phobia"><a href="#Introduction-to-DevEco-Studio-for-HarmonyOS-Next-Development-ASan-and-TSan-Detection-to-Cure-Your-C-Phobia" class="headerlink" title="Introduction to DevEco Studio for HarmonyOS Next Development: ASan and TSan Detection to Cure Your C++ Phobia"></a>Introduction to DevEco Studio for HarmonyOS Next Development: ASan and TSan Detection to Cure Your C++ Phobia</h1><h3 id="1-Background-Introduction"><a href="#1-Background-Introduction" class="headerlink" title="1. Background Introduction"></a>1. Background Introduction</h3><p>Many developers feel intimidated by C++, primarily due to memory operations. Improper memory operations such as array out-of-bounds access, memory leaks, and double-freeing can cause performance issues like high memory consumption,卡顿 (lag), or even program crashes. When an error terminates an app process, error logs are thrown to indicate the crash cause. Developers can analyze these logs—collected automatically by the system as FaultLog—to identify the problematic code. FaultLog includes:  </p>
<ul>
<li>App Freeze  </li>
<li>CPP Crash  </li>
<li>JS Crash  </li>
<li>System Freeze  </li>
<li>ASan  </li>
<li>TSan</li>
</ul>
<p>While other tools are commonly used, this article focuses on DevEco Studio’s memory and thread debugging tools: ASan (Address Sanitizer) and TSan (Thread Sanitizer), as ArkTS’s single-threading and non-shared memory multi-threading often shift complex multi-threading to the C++ layer.  </p>
<h3 id="2-ASan-Detection"><a href="#2-ASan-Detection" class="headerlink" title="2. ASan Detection"></a>2. ASan Detection</h3><p>C++ memory issues mainly involve out-of-bounds access, memory leaks, and double-freeing. For performance reasons, compilers and runtime frameworks don’t check memory operations by default. DevEco Studio’s ASan helps detect such issues.  </p>
<h4 id="2-1-ASan-Configuration"><a href="#2-1-ASan-Configuration" class="headerlink" title="2.1 ASan Configuration"></a>2.1 ASan Configuration</h4><p>ASan is controlled by <code>ASAN_OPTIONS</code> parameters, which set detection levels, output formats, and error report details. Configure parameters in:  </p>
<ol>
<li>The project’s <code>app.json5</code> (higher priority)  </li>
<li>Run&#x2F;Debug Configurations</li>
</ol>
<h5 id="2-1-1-Configuring-in-app-json5"><a href="#2-1-1-Configuring-in-app-json5" class="headerlink" title="2.1.1 Configuring in app.json5"></a>2.1.1 Configuring in app.json5</h5><p>In <code>AppScope &gt; app.json5</code>:  </p>
<pre><code class="language-json">&#123;
  &quot;app&quot;: &#123;
    &quot;appEnvironments&quot;: [
      &#123;
        &quot;name&quot;: &quot;ASAN_OPTIONS&quot;,
        &quot;value&quot;: &quot;log_exe_name=true abort_on_error=0 print_cmdline=true&quot; // For reference only
      &#125;
    ],
    ...
  &#125;
&#125;
</code></pre>
<h5 id="2-1-2-Configuring-in-Run-Debug-Configurations"><a href="#2-1-2-Configuring-in-Run-Debug-Configurations" class="headerlink" title="2.1.2 Configuring in Run&#x2F;Debug Configurations"></a>2.1.2 Configuring in Run&#x2F;Debug Configurations</h5><p><img src="/../images/HarmonyOS%20Next%20%E5%B7%A5%E5%85%B7%E4%BB%8B%E7%BB%8D%EF%BC%9AASan%E4%B8%8ETSan%E6%A3%80%E6%B5%8B%E6%A0%B9%E6%B2%BB%E4%BD%A0%E7%9A%84C++%E6%81%90%E6%83%A7%E7%97%87.png"><br>Add a configuration named <code>ASAN_OPTIONS</code> with the value: <code>log_exe_name=true abort_on_error=0 print_cmdline=true</code>.  </p>
<h5 id="2-1-3-Configurable-Parameters"><a href="#2-1-3-Configurable-Parameters" class="headerlink" title="2.1.3 Configurable Parameters"></a>2.1.3 Configurable Parameters</h5><table>
<thead>
<tr>
<th align="left">Parameter</th>
<th align="left">Default</th>
<th align="left">Required</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody><tr>
<td align="left">log_exe_name</td>
<td align="left">true</td>
<td align="left">Yes</td>
<td align="left">Includes the executable name in memory error logs (non-modifiable).</td>
</tr>
<tr>
<td align="left">log_path</td>
<td align="left">&#x2F;dev&#x2F;asanlog&#x2F;asan.log</td>
<td align="left">No</td>
<td align="left">Required for ROM versions &lt; NEXT.0.0.68 (non-modifiable); deprecated in NEXT.0.0.68+.</td>
</tr>
<tr>
<td align="left">abort_on_error</td>
<td align="left">false</td>
<td align="left">Yes</td>
<td align="left">Specifies whether to call <code>abort()</code> or <code>_exit()</code> after printing errors:<br>- <code>false</code>: Use <code>_exit()</code><br>- <code>true</code>: Use <code>abort()</code></td>
</tr>
<tr>
<td align="left">strip_path_prefix</td>
<td align="left">-</td>
<td align="left">No</td>
<td align="left">Removes the configured prefix from file paths in error logs (e.g., <code>/data/storage/el1</code>).</td>
</tr>
<tr>
<td align="left">detect_stack_use_after_return</td>
<td align="left">false</td>
<td align="left">No</td>
<td align="left">Checks for access to freed stack space:<br>- <code>true</code>: Enable check<br>- <code>false</code>: Disable check.</td>
</tr>
<tr>
<td align="left">halt_on_error</td>
<td align="left">0</td>
<td align="left">No</td>
<td align="left">Determines if the program continues after detecting errors:<br>- <code>0</code>: Continue<br>- <code>1</code>: Terminate.</td>
</tr>
<tr>
<td align="left">malloc_context_size</td>
<td align="left">-</td>
<td align="left">No</td>
<td align="left">Number of call stack layers shown when a memory error occurs.</td>
</tr>
<tr>
<td align="left">suppressions</td>
<td align="left">“”</td>
<td align="left">No</td>
<td align="left">Suppresses specified file names.</td>
</tr>
<tr>
<td align="left">handle_segv</td>
<td align="left">-</td>
<td align="left">No</td>
<td align="left">Checks for segmentation faults.</td>
</tr>
<tr>
<td align="left">handle_sigill</td>
<td align="left">-</td>
<td align="left">No</td>
<td align="left">Checks for SIGILL signals.</td>
</tr>
<tr>
<td align="left">quarantine_size_mb</td>
<td align="left">256</td>
<td align="left">No</td>
<td align="left">Size of the quarantine area for detecting freed stack space access errors.</td>
</tr>
</tbody></table>
<h4 id="2-2-Enabling-ASan"><a href="#2-2-Enabling-ASan" class="headerlink" title="2.2 Enabling ASan"></a>2.2 Enabling ASan</h4><p>Enable ASan in two ways:  </p>
<ol>
<li>In the run&#x2F;debug window, click <strong>Diagnostics</strong> and check <strong>Address Sanitizer</strong>.<br><img src="/../images/HarmonyOS%20Next%20%E5%B7%A5%E5%85%B7%E4%BB%8B%E7%BB%8D%EF%BC%9AASan%E4%B8%8ETSan%E6%A3%80%E6%B5%8B%E6%A0%B9%E6%B2%BB%E4%BD%A0%E7%9A%84C++%E6%81%90%E6%83%A7%E7%97%87-2.png"> </li>
<li>Add ASan configuration in <code>AppScope/app.json5</code>.<br><img src="/../images/HarmonyOS%20Next%20%E5%B7%A5%E5%85%B7%E4%BB%8B%E7%BB%8D%EF%BC%9AASan%E4%B8%8ETSan%E6%A3%80%E6%B5%8B%E6%A0%B9%E6%B2%BB%E4%BD%A0%E7%9A%84C++%E6%81%90%E6%83%A7%E7%97%87-3.png"></li>
</ol>
<p><strong>Note:</strong> For dependent native libraries, configure <code>arguments: &quot;-DOHOS_ENABLE_ASAN=ON&quot;</code> in the library’s <code>build-profile.json5</code> to compile SO files in ASan mode.<br><img src="/../images/HarmonyOS%20Next%20%E5%B7%A5%E5%85%B7%E4%BB%8B%E7%BB%8D%EF%BC%9AASan%E4%B8%8ETSan%E6%A3%80%E6%B5%8B%E6%A0%B9%E6%B2%BB%E4%BD%A0%E7%9A%84C++%E6%81%90%E6%83%A7%E7%97%87-5.png"> </p>
<p>When a memory error occurs, ASan logs appear. Click the link in the log to jump to the problematic code. For example, an array out-of-bounds error triggers:<br><img src="/../images/HarmonyOS%20Next%20%E5%B7%A5%E5%85%B7%E4%BB%8B%E7%BB%8D%EF%BC%9AASan%E4%B8%8ETSan%E6%A3%80%E6%B5%8B%E6%A0%B9%E6%B2%BB%E4%BD%A0%E7%9A%84C++%E6%81%90%E6%83%A7%E7%97%87-6.png"><br><img src="/../images/HarmonyOS%20Next%20%E5%B7%A5%E5%85%B7%E4%BB%8B%E7%BB%8D%EF%BC%9AASan%E4%B8%8ETSan%E6%A3%80%E6%B5%8B%E6%A0%B9%E6%B2%BB%E4%BD%A0%E7%9A%84C++%E6%81%90%E6%83%A7%E7%97%87-7.png"></p>
<h4 id="2-3-ASan-Error-Codes"><a href="#2-3-ASan-Error-Codes" class="headerlink" title="2.3 ASan Error Codes"></a>2.3 ASan Error Codes</h4><p>ASan reports specific error codes with causes:  </p>
<h5 id="2-3-1-heap-buffer-overflow"><a href="#2-3-1-heap-buffer-overflow" class="headerlink" title="2.3.1 heap-buffer-overflow"></a>2.3.1 heap-buffer-overflow</h5><ul>
<li><strong>Cause&#x2F;Impact:</strong> Out-of-bounds access, leading to security vulnerabilities and crash risks.  </li>
<li><strong>Fix:</strong> Check bounds for known-size collections; validate sizes before accessing dynamic collections.  </li>
<li><strong>Example:</strong>  <pre><code class="language-cpp">int heapBufferOverflow() &#123;
    char *buffer = (char *)malloc(10);
    *(buffer + 11) = &#39;n&#39;; // Overflow
    *(buffer + 12) = &#39;n&#39;; // Overflow
    free(buffer);
    return buffer[1];
&#125;
</code></pre>
</li>
</ul>
<h5 id="2-3-2-stack-buffer-underflow"><a href="#2-3-2-stack-buffer-underflow" class="headerlink" title="2.3.2 stack-buffer-underflow"></a>2.3.2 stack-buffer-underflow</h5><ul>
<li><strong>Cause&#x2F;Impact:</strong> Access below the buffer bound, risking security and crashes.  </li>
<li><strong>Fix:</strong> Ensure indices are not less than the lower bound.  </li>
<li><strong>Example:</strong>  <pre><code class="language-cpp">int stackBufferUnderflow() &#123;
    int subscript = -1;
    char buffer[42];
    buffer[subscript] = 42; // Underflow
    return 0;
&#125;
</code></pre>
</li>
</ul>
<h5 id="2-3-3-stack-use-after-scope"><a href="#2-3-3-stack-use-after-scope" class="headerlink" title="2.3.3 stack-use-after-scope"></a>2.3.3 stack-use-after-scope</h5><ul>
<li><strong>Cause&#x2F;Impact:</strong> Using stack variables outside their scope, risking security and crashes.  </li>
<li><strong>Fix:</strong> Mind variable scoping.  </li>
<li><strong>Example:</strong>  <pre><code class="language-cpp">int *gp;
bool b = true;
int stackUseAfterScope() &#123;
    if (b) &#123;
        int x[5];
        gp = x + 1; // Pointer to stack variable
    &#125;
    return *gp; // Use after scope ends
&#125;
</code></pre>
</li>
</ul>
<h5 id="2-3-4-attempt-free-nonallocated-memory"><a href="#2-3-4-attempt-free-nonallocated-memory" class="headerlink" title="2.3.4 attempt-free-nonallocated-memory"></a>2.3.4 attempt-free-nonallocated-memory</h5><ul>
<li><strong>Cause&#x2F;Impact:</strong> Freeing non-heap or unallocated memory, risking security and crashes.  </li>
<li><strong>Fix:</strong> Avoid <code>free()</code> on non-heap or unallocated memory.  </li>
<li><strong>Example:</strong>  <pre><code class="language-cpp">int main() &#123;
    int value = 42;
    free(&amp;value); // Free stack variable
    return 0;
&#125;
</code></pre>
</li>
</ul>
<h5 id="2-3-5-double-free"><a href="#2-3-5-double-free" class="headerlink" title="2.3.5 double-free"></a>2.3.5 double-free</h5><ul>
<li><strong>Cause&#x2F;Impact:</strong> Freeing memory twice, risking security and crashes.  </li>
<li><strong>Fix:</strong> Initialize pointers to <code>NULL</code> and reset them after freeing.  </li>
<li><strong>Example:</strong>  <pre><code class="language-cpp">int main() &#123;
    int *x = new int[42];
    delete [] x;
    delete [] x; // Double-free
    return 0;
&#125;
</code></pre>
</li>
</ul>
<h5 id="2-3-6-heap-use-after-free"><a href="#2-3-6-heap-use-after-free" class="headerlink" title="2.3.6 heap-use-after-free"></a>2.3.6 heap-use-after-free</h5><ul>
<li><strong>Cause&#x2F;Impact:</strong> Accessing freed memory, risking security and crashes.  </li>
<li><strong>Fix:</strong> Implement a <code>free()</code> alternative or destructor to reset pointers.  </li>
<li><strong>Example:</strong>  <pre><code class="language-cpp">#include &lt;stdlib.h&gt;
int main() &#123;
    int *array = new int[5];
    delete[] array;
    return array[5]; // Use after free
&#125;
</code></pre>
</li>
</ul>
<h4 id="2-4-Additional-Notes"><a href="#2-4-Additional-Notes" class="headerlink" title="2.4 Additional Notes"></a>2.4 Additional Notes</h4><ul>
<li>If any module enables ASan, the entry module must also enable ASan; otherwise, the app will crash on startup with a CPP Crash error.</li>
</ul>
<h3 id="3-TSan-Detection"><a href="#3-TSan-Detection" class="headerlink" title="3. TSan Detection"></a>3. TSan Detection</h3><p>Another C++ challenge is multi-threading, where unpredictable execution orders complicate debugging. DevEco Studio’s TSan (ThreadSanitizer) detects data races, using a compiler instrumentation module and runtime library.  </p>
<h4 id="3-1-Key-Application-Scenarios"><a href="#3-1-Key-Application-Scenarios" class="headerlink" title="3.1 Key Application Scenarios"></a>3.1 Key Application Scenarios</h4><p>TSan helps identify multi-threading issues:  </p>
<ul>
<li><strong>Data Race Detection:</strong> Occurs when two or more threads access the same memory without proper synchronization (at least one write), causing unpredictable behavior.  </li>
<li><strong>Lock Error Detection:</strong>  <ul>
<li>Deadlock: Threads wait for each other’s locks, halting execution.  </li>
<li>Double Unlock: Unlocking an already unlocked lock.  </li>
<li>Unlock Without Hold: Unlocking a lock not held by the thread.</li>
</ul>
</li>
<li><strong>Condition Variable Error Detection:</strong>  <ul>
<li>Wait Without Lock: Calling <code>wait()</code> without holding the related lock.  </li>
<li>Signal&#x2F;Broadcast Without Lock: Calling <code>signal()</code>&#x2F;<code>broadcast()</code> without holding the related lock.</li>
</ul>
</li>
</ul>
<h4 id="3-2-TSan-Configuration"><a href="#3-2-TSan-Configuration" class="headerlink" title="3.2 TSan Configuration"></a>3.2 TSan Configuration</h4><p>Enable TSan in two ways:  </p>
<ol>
<li>In the run&#x2F;debug window, click <strong>Diagnostics</strong> and check <strong>Thread Sanitizer</strong>.<br><img src="/../images/HarmonyOS%20Next%20%E5%B7%A5%E5%85%B7%E4%BB%8B%E7%BB%8D%EF%BC%9AASan%E4%B8%8ETSan%E6%A3%80%E6%B5%8B%E6%A0%B9%E6%B2%BB%E4%BD%A0%E7%9A%84C++%E6%81%90%E6%83%A7%E7%97%87-8.png"></li>
<li>Modify <code>AppScope/app.json5</code> to add TSan configuration.<br><img src="/../images/HarmonyOS%20Next%20%E5%B7%A5%E5%85%B7%E4%BB%8B%E7%BB%8D%EF%BC%9AASan%E4%B8%8ETSan%E6%A3%80%E6%B5%8B%E6%A0%B9%E6%B2%BB%E4%BD%A0%E7%9A%84C++%E6%81%90%E6%83%A7%E7%97%87-9.png"></li>
</ol>
<p><strong>Note:</strong> For referenced native libraries, configure <code>arguments: &quot;-DOHOS_ENABLE_TSAN=ON&quot;</code> in the library’s <code>build-profile.json5</code> to compile SO files in TSan mode.  </p>
<h4 id="3-3-Enabling-TSan"><a href="#3-3-Enabling-TSan" class="headerlink" title="3.3 Enabling TSan"></a>3.3 Enabling TSan</h4><p>When a thread error occurs during app run&#x2F;debug, TSan logs appear. Click the link to jump to the problematic code:<br><img src="/../images/HarmonyOS%20Next%20%E5%B7%A5%E5%85%B7%E4%BB%8B%E7%BB%8D%EF%BC%9AASan%E4%B8%8ETSan%E6%A3%80%E6%B5%8B%E6%A0%B9%E6%B2%BB%E4%BD%A0%E7%9A%84C++%E6%81%90%E6%83%A7%E7%97%87-10.png"> </p>
<p>TSan reports include:  </p>
<ul>
<li>Error type (e.g., data race, deadlock)  </li>
<li>Memory address  </li>
<li>Thread info (ID and stack trace)  </li>
<li>Source code locations and stack traces  </li>
<li>Context (read&#x2F;write type, access size)</li>
</ul>
<p><strong>Note:</strong> <code>call_once</code> may trigger false positives. Add <code>__attribute__((no_sanitize(&quot;thread&quot;)))</code> before the function to suppress this.  </p>
<h4 id="3-4-Additional-Notes"><a href="#3-4-Additional-Notes" class="headerlink" title="3.4 Additional Notes"></a>3.4 Additional Notes</h4><ul>
<li>TSan reduces performance by 5–15x and increases memory usage by 5–10x, potentially affecting features like GPU rendering.  </li>
<li>ASan and TSan cannot be enabled simultaneously.  </li>
<li>TSan supports API 12 and above.</li>
</ul>
<h3 id="4-Summary"><a href="#4-Summary" class="headerlink" title="4. Summary"></a>4. Summary</h3><p>This article introduces DevEco Studio’s ASan and TSan tools for debugging C++ memory and thread issues:  </p>
<ul>
<li><strong>ASan</strong> detects address overflows, memory leaks, and double-freeing.  </li>
<li><strong>TSan</strong> detects data races, lock errors, and condition variable issues.</li>
</ul>
<p>DevEco Studio’s tooling simplifies C++ development by identifying and resolving complex issues. Familiarizing yourself with these tools empowers you to tackle C++ challenges confidently, eliminating hidden risks through systematic detection.</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://harmonyostech.github.io/2025/06/30/C-HarmonyOS-Next-NAPI-Asynchronous-Call-Introduction/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Qingkouwei">
      <meta itemprop="description" content="Welcome to the HarmonyOS NEXT Knowledge Charging Station!  This is a hub for knowledge about HarmonyOS Next`s new-generation system. With its self-developed kernel, HarmonyOS NEXT achieves native smoothness, security, intelligence, and interconnectivity. We deeply analyze how its new distributed soft bus revolutionizes device connectivity experiences and explain the principles behind the enhanced perception and reasoning capabilities of the Xiaoyi intelligent agent based on the Pangu large model. Whether you are a developer exploring application development or an ordinary user eager to understand system features, you can "recharge" here and quickly grasp the essence of HarmonyOS NEXT.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HarmonyOS NEXT Knowledge Charging Station">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/06/30/C-HarmonyOS-Next-NAPI-Asynchronous-Call-Introduction/" class="post-title-link" itemprop="url">HarmonyOS Next NAPI Asynchronous Call Introduction</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2025-06-30 22:24:07" itemprop="dateCreated datePublished" datetime="2025-06-30T22:24:07+08:00">2025-06-30</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-07-13 17:11:56" itemprop="dateModified" datetime="2025-07-13T17:11:56+08:00">2025-07-13</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/HarmonyOS-Next-Tech/" itemprop="url" rel="index"><span itemprop="name">HarmonyOS Next Tech</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="HarmonyOS-Next-NAPI-Asynchronous-Call-Introduction"><a href="#HarmonyOS-Next-NAPI-Asynchronous-Call-Introduction" class="headerlink" title="HarmonyOS Next NAPI Asynchronous Call Introduction"></a>HarmonyOS Next NAPI Asynchronous Call Introduction</h1><h2 id="Why-Asynchronous-Calls-Are-Needed"><a href="#Why-Asynchronous-Calls-Are-Needed" class="headerlink" title="Why Asynchronous Calls Are Needed?"></a>Why Asynchronous Calls Are Needed?</h2><p>TS is single-threaded. If a TS-invoked C++ method performs time-consuming tasks (e.g., file operations, network requests, database operations, image processing), these tasks should be executed asynchronously via threads in the C++ layer. Asynchronous task results are typically obtained through callbacks. Maintaining synchronization between native and main threads requires effort, but NAPI (based on the asynchronous I&#x2F;O library libuv) provides an asynchronous call mechanism to manage threads uniformly, simplifying development.  </p>
<h2 id="Introduction-to-NAPI-Asynchronous-Calls"><a href="#Introduction-to-NAPI-Asynchronous-Calls" class="headerlink" title="Introduction to NAPI Asynchronous Calls"></a>Introduction to NAPI Asynchronous Calls</h2><p>HarmonyOS Next supports callback and promise-based asynchronous interfaces following the OpenHarmony Napi standard.  </p>
<h3 id="Introduction-to-Asynchronous-Call-APIs"><a href="#Introduction-to-Asynchronous-Call-APIs" class="headerlink" title="Introduction to Asynchronous Call APIs"></a>Introduction to Asynchronous Call APIs</h3><h4 id="Create-Async-Work-napi-create-async-work"><a href="#Create-Async-Work-napi-create-async-work" class="headerlink" title="Create Async Work: napi_create_async_work()"></a>Create Async Work: <code>napi_create_async_work()</code></h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">napi_status <span class="title function_">napi_create_async_work</span><span class="params">(napi_env env,</span></span><br><span class="line"><span class="params">                                  napi_value async_resource,</span></span><br><span class="line"><span class="params">                                  napi_value async_resource_name,</span></span><br><span class="line"><span class="params">                                  napi_async_execute_callback execute,</span></span><br><span class="line"><span class="params">                                  napi_async_complete_callback complete,</span></span><br><span class="line"><span class="params">                                  <span class="type">void</span>* data,</span></span><br><span class="line"><span class="params">                                  napi_async_work* result)</span>;</span><br></pre></td></tr></table></figure>

<p><strong>Parameters</strong>:  </p>
<ul>
<li><code>[in] env</code>: Execution environment provided by the framework (pass directly by default).  </li>
<li><code>[in] async_resource</code>: Optional, associated with <code>async_hooks</code>.  </li>
<li><code>[in] async_resource_name</code>: Identifier for async resource diagnostics via <code>async_hooks</code> API.  </li>
<li><code>[in] execute</code>: Business logic function executed by the worker thread pool (non-blocking).  </li>
<li><code>[in] complete</code>: Callback triggered after <code>execute</code> finishes or is canceled (runs in the EventLoop thread).  </li>
<li><code>[in] data</code>: User-provided context data for passing parameters.  </li>
<li><code>[out] result</code>: Pointer to the created async work item.  </li>
<li><strong>Return</strong>: <code>napi_ok</code> on success, otherwise an error code.</li>
</ul>
<h4 id="Queue-Async-Work-napi-queue-async-work"><a href="#Queue-Async-Work-napi-queue-async-work" class="headerlink" title="Queue Async Work: napi_queue_async_work()"></a>Queue Async Work: <code>napi_queue_async_work()</code></h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">napi_status <span class="title function_">napi_queue_async_work</span><span class="params">(napi_env env,</span></span><br><span class="line"><span class="params">                                 napi_async_work work)</span>;</span><br></pre></td></tr></table></figure>

<p><strong>Parameters</strong>:  </p>
<ul>
<li><code>[in] env</code>: Execution environment.  </li>
<li><code>[in] work</code>: Handle from <code>napi_create_async_work()</code>.</li>
</ul>
<h4 id="Cancel-Async-Work-napi-cancel-async-work"><a href="#Cancel-Async-Work-napi-cancel-async-work" class="headerlink" title="Cancel Async Work: napi_cancel_async_work()"></a>Cancel Async Work: <code>napi_cancel_async_work()</code></h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">napi_status <span class="title function_">napi_cancel_async_work</span><span class="params">(napi_env env,</span></span><br><span class="line"><span class="params">                                  napi_async_work work)</span>;</span><br></pre></td></tr></table></figure>

<p><strong>Parameters</strong>:  </p>
<ul>
<li><code>[in] env</code>: Execution environment.  </li>
<li><code>[in] work</code>: Handle from <code>napi_create_async_work()</code>.  </li>
<li><strong>Behavior</strong>: Cancels queued work if unstarted. Returns <code>napi_generic_failure</code> if started. The complete callback is invoked with <code>napi_cancelled</code> on success. Do not delete the work before the callback executes.</li>
</ul>
<h4 id="Delete-Async-Work-napi-delete-async-work"><a href="#Delete-Async-Work-napi-delete-async-work" class="headerlink" title="Delete Async Work: napi_delete_async_work()"></a>Delete Async Work: <code>napi_delete_async_work()</code></h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">napi_status <span class="title function_">napi_delete_async_work</span><span class="params">(napi_env env,</span></span><br><span class="line"><span class="params">                                  napi_async_work work)</span>;</span><br></pre></td></tr></table></figure>

<p><strong>Parameters</strong>:  </p>
<ul>
<li><code>[in] env</code>: Execution environment.  </li>
<li><code>[in] work</code>: Handle from <code>napi_create_async_work()</code>.</li>
</ul>
<h3 id="Principle-of-Asynchronous-Implementation"><a href="#Principle-of-Asynchronous-Implementation" class="headerlink" title="Principle of Asynchronous Implementation"></a>Principle of Asynchronous Implementation</h3><p>In synchronous mode, all code runs in the native method (main thread). Asynchronous mode uses <code>napi_create_async_work()</code> to create an async work item:  </p>
<ol>
<li>The native method receives and converts data, stores it in context, creates an async work item, queues it, and returns <code>nullptr</code> (callback) or a <code>Promise</code> (promise).  </li>
<li>The async work item defines two functions:  <ul>
<li><code>execute</code>: Runs in the worker thread (non-blocking), processes business logic, and writes results to context.  </li>
<li><code>complete</code>: Runs in the EventLoop thread after <code>execute</code> finishes&#x2F;cancels, converts results to JS types, and invokes callbacks or resolves promises.</li>
</ul>
</li>
</ol>
<p><strong>Asynchronous processing flow chart</strong>:<br><img src="/../images/HarmonyOS%20Next%20NAPI%E5%BC%82%E6%AD%A5%E8%B0%83%E7%94%A8%E5%85%A5%E9%97%A8-1.png"></p>
<h3 id="Advantages-Over-Native-Threads"><a href="#Advantages-Over-Native-Threads" class="headerlink" title="Advantages Over Native Threads"></a>Advantages Over Native Threads</h3><ul>
<li><strong>Thread Management</strong>: NodeJS abstracts thread lifecycle and synchronization. <code>napi_create_async_work()</code> executes tasks in the background and calls back to the JS thread automatically via libuv’s event loop.  </li>
<li><strong>Memory Management</strong>: NodeJS garbage collection integrates with async work. N-API manages resource lifecycles to prevent premature recycling.  </li>
<li><strong>Callback Mechanism</strong>: Provides a seamless callback mechanism for JS-C++ interaction, integrating with the JS event loop.  </li>
<li><strong>Thread Pool &amp; Concurrency</strong>: Leverages NodeJS’s libuv thread pool, eliminating manual thread management.  </li>
<li><strong>Error Handling</strong>: Simplifies error propagation from native code to JS via callback exceptions.</li>
</ul>
<h2 id="Asynchronous-Interface-Implementation"><a href="#Asynchronous-Interface-Implementation" class="headerlink" title="Asynchronous Interface Implementation"></a>Asynchronous Interface Implementation</h2><h3 id="Callback-Based-Asynchronous-Interface-Audio-Encoding-Example"><a href="#Callback-Based-Asynchronous-Interface-Audio-Encoding-Example" class="headerlink" title="Callback-Based Asynchronous Interface (Audio Encoding Example)"></a>Callback-Based Asynchronous Interface (Audio Encoding Example)</h3><h4 id="eTS-Definition-of-the-Example-Interface"><a href="#eTS-Definition-of-the-Example-Interface" class="headerlink" title="eTS Definition of the Example Interface"></a>eTS Definition of the Example Interface</h4><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="attr">encodePcmDataForOpusWithOgg</span>: <span class="function">(<span class="params"><span class="attr">inputBuffer</span>: <span class="title class_">ArrayBuffer</span>, <span class="attr">callback</span>: () =&gt; <span class="built_in">void</span></span>) =&gt;</span> <span class="built_in">void</span>;</span><br></pre></td></tr></table></figure>

<h4 id="Initialize-Context-Data"><a href="#Initialize-Context-Data" class="headerlink" title="Initialize Context Data"></a>Initialize Context Data</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">EncodeAudioData</span> &#123;</span>  </span><br><span class="line">    napi_async_work asyncWork = nullptr;  </span><br><span class="line">    napi_ref callback = nullptr;  </span><br><span class="line">    <span class="type">void</span>* inputBuffer = nullptr;  </span><br><span class="line">    <span class="type">size_t</span> inputSize = <span class="number">0</span>;  </span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="Create-Async-Work-Item"><a href="#Create-Async-Work-Item" class="headerlink" title="Create Async Work Item"></a>Create Async Work Item</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> napi_value <span class="title function_">encodePCMToOpusOggNative</span><span class="params">(napi_env env, napi_callback_info info)</span> &#123;  </span><br><span class="line">    <span class="type">size_t</span> argc = <span class="number">2</span>;  </span><br><span class="line">    napi_value args[<span class="number">2</span>] = &#123;nullptr&#125;;  </span><br><span class="line">    napi_get_cb_info(env, info, &amp;argc, args, nullptr, nullptr);  </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">auto</span> audioData = new EncodeAudioData&#123;.asyncWork = nullptr&#125;;  </span><br><span class="line">    napi_get_arraybuffer_info(env, args[<span class="number">0</span>], &amp;audioData-&gt;inputBuffer, &amp;audioData-&gt;inputSize);  </span><br><span class="line">    napi_create_reference(env, args[<span class="number">1</span>], <span class="number">1</span>, &amp;audioData-&gt;callback);  </span><br><span class="line">    napi_value resourceName = nullptr;  </span><br><span class="line">    napi_create_string_utf8(env, <span class="string">&quot;encodePCMToOpusOggNative&quot;</span>, NAPI_AUTO_LENGTH, &amp;resourceName);  </span><br><span class="line">    napi_create_async_work(env, nullptr, resourceName, encodeExecuteCB, encodeAsyncCompleteCB, (<span class="type">void</span>*)audioData, &amp;audioData-&gt;asyncWork);  </span><br><span class="line">    napi_queue_async_work(env, audioData-&gt;asyncWork);  </span><br><span class="line">    <span class="keyword">return</span> nullptr;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="execute-Function"><a href="#execute-Function" class="headerlink" title="execute Function"></a><code>execute</code> Function</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">encodeExecuteCB</span><span class="params">(napi_env env, <span class="type">void</span>* data)</span> &#123;  </span><br><span class="line">    EncodeAudioData* encodeAudioData = (EncodeAudioData*)data;  </span><br><span class="line">    ope_encoder_write(pEnc, (<span class="type">short</span>*)encodeAudioData-&gt;inputBuffer, encodeAudioData-&gt;inputSize / <span class="number">2</span>);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="complete-Function"><a href="#complete-Function" class="headerlink" title="complete Function"></a><code>complete</code> Function</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">encodeAsyncCompleteCB</span><span class="params">(napi_env env, napi_status status, <span class="type">void</span>* data)</span> &#123;  </span><br><span class="line">    EncodeAudioData* encodeAudioData = (EncodeAudioData*)data;  </span><br><span class="line">    napi_value callback = nullptr;  </span><br><span class="line">    napi_value undefined = nullptr;  </span><br><span class="line">    napi_get_undefined(env, &amp;undefined);  </span><br><span class="line">    napi_get_reference_value(env, encodeAudioData-&gt;callback, &amp;callback);  </span><br><span class="line">    napi_call_function(env, undefined, callback, <span class="number">0</span>, nullptr, &amp;callbackResult);  </span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (encodeAudioData-&gt;callback != nullptr) &#123;  </span><br><span class="line">        napi_delete_reference(env, encodeAudioData-&gt;callback);  </span><br><span class="line">    &#125;  </span><br><span class="line">    napi_delete_async_work(env, encodeAudioData-&gt;asyncWork);  </span><br><span class="line">    delete encodeAudioData;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="eTS-Call-Interface"><a href="#eTS-Call-Interface" class="headerlink" title="eTS Call Interface"></a>eTS Call Interface</h4><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="title function_">encodePcmDataForOpusOgg</span>(<span class="attr">inputBuffer</span>: <span class="title class_">ArrayBuffer</span>): <span class="built_in">void</span> &#123;  </span><br><span class="line">  opusOggEnc.<span class="title function_">encodePcmDataForOpusWithOgg</span>(inputBuffer, <span class="function">() =&gt;</span> &#123;  </span><br><span class="line">  &#125;);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="Promise-Based-Asynchronous-Interface"><a href="#Promise-Based-Asynchronous-Interface" class="headerlink" title="Promise-Based Asynchronous Interface"></a>Promise-Based Asynchronous Interface</h3><h4 id="Create-Promise"><a href="#Create-Promise" class="headerlink" title="Create Promise"></a>Create Promise</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">napi_status <span class="title function_">napi_create_promise</span><span class="params">(napi_env env, napi_deferred* deferred, napi_value* promise)</span>;</span><br></pre></td></tr></table></figure>
<h4 id="Initialize-Context-Data-1"><a href="#Initialize-Context-Data-1" class="headerlink" title="Initialize Context Data"></a>Initialize Context Data</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">EncodeAudioData</span> &#123;</span>  </span><br><span class="line">    napi_async_work asyncWork = nullptr;  </span><br><span class="line">    napi_deferred deferred = nullptr;  </span><br><span class="line">    <span class="type">void</span>* inputBuffer = nullptr;  </span><br><span class="line">    <span class="type">size_t</span> inputSize = <span class="number">0</span>;  </span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="Create-Async-Work-Item-1"><a href="#Create-Async-Work-Item-1" class="headerlink" title="Create Async Work Item"></a>Create Async Work Item</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> napi_value <span class="title function_">encodePromise</span><span class="params">(napi_env env, napi_callback_info info)</span> &#123;  </span><br><span class="line">    <span class="type">size_t</span> argc = <span class="number">1</span>;  </span><br><span class="line">    napi_value args[<span class="number">1</span>] = &#123;nullptr&#125;;  </span><br><span class="line">    napi_get_cb_info(env, info, &amp;argc, args, nullptr, nullptr);  </span><br><span class="line">    napi_value promise = nullptr;  </span><br><span class="line">    napi_deferred deferred = nullptr;  </span><br><span class="line">    napi_create_promise(env, &amp;deferred, &amp;promise);  </span><br><span class="line">    <span class="keyword">auto</span> audioData = new EncodeAudioData&#123;.asyncWork = nullptr, .deferred = deferred&#125;;  </span><br><span class="line">    napi_get_arraybuffer_info(env, args[<span class="number">0</span>], &amp;audioData-&gt;inputBuffer, &amp;audioData-&gt;inputSize);  </span><br><span class="line">    napi_value resourceName = nullptr;  </span><br><span class="line">    napi_create_string_utf8(env, <span class="string">&quot;encodeAudioAsyncCallback&quot;</span>, NAPI_AUTO_LENGTH, &amp;resourceName);  </span><br><span class="line">    napi_create_async_work(env, nullptr, resourceName, encodeExecuteCB, encodePromiseCompleteCB, (<span class="type">void</span>*)audioData, &amp;audioData-&gt;asyncWork);  </span><br><span class="line">    napi_queue_async_work(env, audioData-&gt;asyncWork);  </span><br><span class="line">    <span class="keyword">return</span> promise;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="complete-Callback"><a href="#complete-Callback" class="headerlink" title="complete Callback"></a><code>complete</code> Callback</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">encodePromiseCompleteCB</span><span class="params">(napi_env env, napi_status status, <span class="type">void</span>* data)</span> &#123;  </span><br><span class="line">    EncodeAudioData* encodeAudioData = (EncodeAudioData*)data;  </span><br><span class="line">    napi_value undefined;  </span><br><span class="line">    napi_get_undefined(env, &amp;undefined);  </span><br><span class="line">    napi_resolve_deferred(env, encodeAudioData-&gt;deferred, undefined);  </span><br><span class="line">    <span class="keyword">if</span> (encodeAudioData-&gt;callback != nullptr) &#123;  </span><br><span class="line">        napi_delete_reference(env, encodeAudioData-&gt;callback);  </span><br><span class="line">    &#125;  </span><br><span class="line">    napi_delete_async_work(env, encodeAudioData-&gt;asyncWork);  </span><br><span class="line">    delete encodeAudioData;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="eTS-Call-Interface-1"><a href="#eTS-Call-Interface-1" class="headerlink" title="eTS Call Interface"></a>eTS Call Interface</h4><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="title function_">encodePcmDataForOpusOgg</span>(<span class="attr">inputBuffer</span>: <span class="title class_">ArrayBuffer</span>): <span class="built_in">void</span> &#123;  </span><br><span class="line">  opusOggEnc.<span class="title function_">encodePcmDataForOpusWithOggPromise</span>(inputBuffer).<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;  </span><br><span class="line">  &#125;);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="Standardized-Asynchronous-Interface"><a href="#Standardized-Asynchronous-Interface" class="headerlink" title="Standardized Asynchronous Interface"></a>Standardized Asynchronous Interface</h3><p>If Promise support is enabled, async methods must support both callback and promise modes. Determine the mode by the number of parameters:  </p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">encodePcmDataForOpusWithOgg</span>(<span class="params"><span class="attr">inputBuffer</span>: <span class="title class_">ArrayBuffer</span>, <span class="attr">callback</span>: () =&gt; <span class="built_in">void</span></span>): <span class="built_in">void</span>;  </span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">encodePcmDataForOpusWithOgg</span>(<span class="params"><span class="attr">inputBuffer</span>: <span class="title class_">ArrayBuffer</span></span>): <span class="title class_">Promise</span>&lt;<span class="built_in">void</span>&gt;;</span><br><span class="line"><span class="string">``</span><span class="string">`  </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#### Unified Context Structure  </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">`</span><span class="string">``</span>c</span><br><span class="line">struct <span class="title class_">EncodeAudioData</span> &#123;  </span><br><span class="line">    napi_async_work asyncWork = nullptr;  </span><br><span class="line">    napi_ref callback = nullptr;  </span><br><span class="line">    napi_deferred deferred = nullptr;  </span><br><span class="line">    <span class="built_in">void</span>* inputBuffer = nullptr;  </span><br><span class="line">    size_t inputSize = <span class="number">0</span>;  </span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="Native-Method-Implementation"><a href="#Native-Method-Implementation" class="headerlink" title="Native Method Implementation"></a>Native Method Implementation</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> napi_value <span class="title function_">encodePCMToOpusOggNative</span><span class="params">(napi_env env, napi_callback_info info)</span> &#123;  </span><br><span class="line">    <span class="type">size_t</span> argc = <span class="number">2</span>;  </span><br><span class="line">    napi_value args[<span class="number">2</span>] = &#123;nullptr&#125;;  </span><br><span class="line">    napi_get_cb_info(env, info, &amp;argc, args, nullptr, nullptr);  </span><br><span class="line">    <span class="keyword">auto</span> audioData = new EncodeAudioData&#123;.asyncWork = nullptr&#125;;  </span><br><span class="line">    <span class="keyword">if</span> (argc == <span class="number">1</span>) &#123;  </span><br><span class="line">        napi_value promise = nullptr;  </span><br><span class="line">        napi_deferred deferred = nullptr;  </span><br><span class="line">        napi_create_promise(env, &amp;deferred, &amp;promise);  </span><br><span class="line">        audioData-&gt;deferred = deferred;  </span><br><span class="line">        napi_get_arraybuffer_info(env, args[<span class="number">0</span>], &amp;audioData-&gt;inputBuffer, &amp;audioData-&gt;inputSize);  </span><br><span class="line">        napi_value resourceName = nullptr;  </span><br><span class="line">        napi_create_string_utf8(env, <span class="string">&quot;encodePCMToOpusOggNativePromise&quot;</span>, NAPI_AUTO_LENGTH, &amp;resourceName);  </span><br><span class="line">        napi_create_async_work(env, nullptr, resourceName, encodeExecuteCB, encodePromiseCompleteCB, (<span class="type">void</span>*)audioData, &amp;audioData-&gt;asyncWork);  </span><br><span class="line">        napi_queue_async_work(env, audioData-&gt;asyncWork);  </span><br><span class="line">        <span class="keyword">return</span> promise;  </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">        napi_get_arraybuffer_info(env, args[<span class="number">0</span>], &amp;audioData-&gt;inputBuffer, &amp;audioData-&gt;inputSize);  </span><br><span class="line">        napi_create_reference(env, args[<span class="number">1</span>], <span class="number">1</span>, &amp;audioData-&gt;callback);  </span><br><span class="line">        napi_value resourceName = nullptr;  </span><br><span class="line">        napi_create_string_utf8(env, <span class="string">&quot;encodePCMToOpusOggNativeCallback&quot;</span>, NAPI_AUTO_LENGTH, &amp;resourceName);  </span><br><span class="line">        napi_create_async_work(env, nullptr, resourceName, encodeExecuteCB, encodeAsyncCompleteCB, (<span class="type">void</span>*)audioData, &amp;audioData-&gt;asyncWork);  </span><br><span class="line">        napi_queue_async_work(env, audioData-&gt;asyncWork);  </span><br><span class="line">        <span class="keyword">return</span> nullptr;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://harmonyostech.github.io/2025/06/30/C-A-Comprehensive-Guide-to-Data-Type-Conversion-Between-ArkTS-and-C-in-HarmonyOS-Next/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Qingkouwei">
      <meta itemprop="description" content="Welcome to the HarmonyOS NEXT Knowledge Charging Station!  This is a hub for knowledge about HarmonyOS Next`s new-generation system. With its self-developed kernel, HarmonyOS NEXT achieves native smoothness, security, intelligence, and interconnectivity. We deeply analyze how its new distributed soft bus revolutionizes device connectivity experiences and explain the principles behind the enhanced perception and reasoning capabilities of the Xiaoyi intelligent agent based on the Pangu large model. Whether you are a developer exploring application development or an ordinary user eager to understand system features, you can "recharge" here and quickly grasp the essence of HarmonyOS NEXT.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HarmonyOS NEXT Knowledge Charging Station">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/06/30/C-A-Comprehensive-Guide-to-Data-Type-Conversion-Between-ArkTS-and-C-in-HarmonyOS-Next/" class="post-title-link" itemprop="url">A Comprehensive Guide to Data Type Conversion Between ArkTS and C++ in HarmonyOS Next</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2025-06-30 22:22:43 / Modified: 22:23:51" itemprop="dateCreated datePublished" datetime="2025-06-30T22:22:43+08:00">2025-06-30</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/HarmonyOS-Next-Tech/" itemprop="url" rel="index"><span itemprop="name">HarmonyOS Next Tech</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="A-Comprehensive-Guide-to-Data-Type-Conversion-Between-ArkTS-and-C-in-HarmonyOS-Next"><a href="#A-Comprehensive-Guide-to-Data-Type-Conversion-Between-ArkTS-and-C-in-HarmonyOS-Next" class="headerlink" title="A Comprehensive Guide to Data Type Conversion Between ArkTS and C++ in HarmonyOS Next"></a>A Comprehensive Guide to Data Type Conversion Between ArkTS and C++ in HarmonyOS Next</h1><h2 id="Background"><a href="#Background" class="headerlink" title="Background"></a>Background</h2><p>ArkTS is the primary development language for HarmonyOS, with C++ support provided for certain capabilities—such as audio-video codecs—where HarmonyOS only offers C++ APIs. For migrating existing capabilities from other platforms, C++ is also the most efficient choice. Thus, mastering interaction between ArkTS and C++ has become an essential skill for HarmonyOS developers.  </p>
<p>Each programming language defines its own data types, and cross-language function calls involve type conversion. ArkTS-C++ conversion is primarily provided by Node-API interfaces. This article introduces the conversion interfaces and best practices.  </p>
<p>Developers familiar with Android JNI (Java Native Interface) know that JNI provides type conversion between Java and C++. Unlike JNI, NAPI (Node-API) encapsulates all parameters for TS-to-C++ calls into a single structure:  </p>
<pre><code class="language-cpp">static napi_value add(napi_env env, napi_callback_info info)  
&#123;
&#125;
</code></pre>
<p>Regardless of the parameter count, all arguments are encapsulated in <code>napi_callback_info</code>, which can be parsed as:  </p>
<pre><code class="language-cpp">size_t argc = 7; // Number of parameters
napi_value args[7] = &#123;nullptr&#125;;
napi_get_cb_info(env, info, &amp;argc, args, nullptr, nullptr);
</code></pre>
<p>Parameters passed from ArkTS can then be read from the <code>args</code> array. The following sections detail type conversion methods.  </p>
<h2 id="Converting-ArkTS-Types-to-C"><a href="#Converting-ArkTS-Types-to-C" class="headerlink" title="Converting ArkTS Types to C++"></a>Converting ArkTS Types to C++</h2><h3 id="Basic-Data-Types"><a href="#Basic-Data-Types" class="headerlink" title="Basic Data Types"></a>Basic Data Types</h3><p><strong>ArkTS basic types</strong>:  </p>
<ul>
<li>Number (numeric)  </li>
<li>String  </li>
<li>Boolean  </li>
<li>BigInt (arbitrary-precision integer)  </li>
<li>Object</li>
</ul>
<p><strong>C++ basic types</strong>:  </p>
<ul>
<li>Integer: <code>int</code>, <code>short</code>, <code>long</code>, <code>long long</code>  </li>
<li>Floating-point: <code>float</code>, <code>double</code>, <code>long double</code>  </li>
<li>Character: <code>char</code>  </li>
<li>Boolean: <code>bool</code></li>
</ul>
<p><strong>NAPI conversion functions for basic types</strong>:  </p>
<ul>
<li>To boolean: <code>napi_get_value_bool</code>  </li>
<li>To int32: <code>napi_get_value_int32</code>  </li>
<li>To int64: <code>napi_get_value_int64</code>  </li>
<li>To uint32: <code>napi_get_value_uint32</code>  </li>
<li>To double: <code>napi_get_value_double</code>  </li>
<li>To bigint (signed 64-bit): <code>napi_get_value_bigint_int64</code>  </li>
<li>To bigint (unsigned 64-bit): <code>napi_get_value_bigint_uint64</code></li>
</ul>
<p>Except for <code>bool</code>, TS numeric types map to various C++ numeric subtypes, each requiring a specific conversion function:  </p>
<pre><code class="language-cpp">int intValue;
napi_get_value_int32(env, args[0], &amp;intValue);
</code></pre>
<h3 id="String-Conversion"><a href="#String-Conversion" class="headerlink" title="String Conversion"></a>String Conversion</h3><p>String and object handling is more complex. Use <code>napi_get_value_string_utf8</code> to convert a JS string to a C++ <code>std::string</code>. First, determine the string length:  </p>
<pre><code class="language-c">napi_status napi_get_value_string_utf8(napi_env env,
                                       napi_value value,
                                       char* buf,
                                       size_t bufsize,
                                       size_t* result)
</code></pre>
<p>The following utility function converts a JS string to a C++ string:  </p>
<pre><code class="language-cpp">void JsValueToString(const napi_env &amp;env, const napi_value &amp;value, std::string &amp;target) &#123;  
    size_t result = 0;  
    napi_get_value_string_utf8(env, value, nullptr, 0, &amp;result);  
    std::unique_ptr&lt;char[]&gt; buf(new char[result+1]);  
    if (!buf.get()) &#123;  
        return;  
    &#125;  
    memset(buf.get(), 0, result+1);  
    napi_get_value_string_utf8(env, value, buf.get(), result+1, &amp;result);  
    target = buf.get();  
&#125;
</code></pre>
<h3 id="Object-Conversion"><a href="#Object-Conversion" class="headerlink" title="Object Conversion"></a>Object Conversion</h3><p>To parse object parameters, convert them to <code>napi_value</code> via <code>napi_get_cb_info</code>, then use <code>napi_get_named_property</code> to retrieve attributes:  </p>
<pre><code class="language-cpp">// ArkTS object:
export class Task &#123;  
  
  public id: number; // Unique task identifier  
  public channel?: number;   
  //...
&#125;

napi_value Demo::startTask(napi_env env, napi_callback_info info) &#123;
    size_t argc = 1;
    napi_value js_obj;
    napi_get_cb_info(env, info, &amp;argc, &amp;js_obj, nullptr, nullptr);

    napi_value taskIdNapiValue;
    napi_get_named_property(env, js_obj, &quot;id&quot;, &amp;taskIdNapiValue);
    int32_t taskid;
    napi_get_value_int32(env, taskIdNapiValue, &amp;taskid);

    napi_value channelSelectNapiValue;
    napi_get_named_property(env, js_obj, &quot;channelSelect&quot;, &amp;channelSelectNapiValue);
    int32_t channel_select;
    napi_get_value_int32(env, channelSelectNapiValue, &amp;channel_select);

    // ... Business logic
    return nullptr;
&#125;
</code></pre>
<h3 id="Array-Conversion"><a href="#Array-Conversion" class="headerlink" title="Array Conversion"></a>Array Conversion</h3><p>Similar to strings, arrays require length retrieval via <code>napi_get_array_length</code> before element extraction with <code>napi_get_element</code>:  </p>
<pre><code class="language-cpp">napi_value Demo::setArrays(napi_env env, napi_callback_info info) &#123;
    std::vector&lt;std::string&gt; backupip_list;

    size_t argc = 1;
    napi_value args[1] = &#123;nullptr&#125;;
    napi_get_cb_info(env, info, &amp;argc, args, nullptr, nullptr);
    bool is_array;
    napi_is_array(env, args[0], &amp;is_array);
    if (!is_array) &#123;
        return nullptr;
    &#125;
    napi_value array = args[0];
    uint32_t length;
    napi_get_array_length(env, array, &amp;length);
    for (int i = 0; i &lt; length; i++) &#123;
        napi_value element;
        napi_get_element(env, array, i, &amp;element);
        std::string ipStr;
        NapiUtil::JsValueToString(env, element, ipStr);
        backupip_list.push_back(ipStr);
    &#125;   
    // ... Business logic
    return nullptr;
&#125;
</code></pre>
<h3 id="ArrayBuffer-Conversion"><a href="#ArrayBuffer-Conversion" class="headerlink" title="ArrayBuffer Conversion"></a>ArrayBuffer Conversion</h3><p>For binary data transfer from TS to C++, use <code>napi_get_arraybuffer_info</code> to convert <code>ArrayBuffer</code> to a C++ byte stream:  </p>
<pre><code class="language-c">napi_status napi_get_arraybuffer_info(napi_env env,
                                      napi_value arraybuffer,
                                      void** data,
                                      size_t* byte_length)
</code></pre>
<p>Example usage:  </p>
<pre><code class="language-cpp">napi_value Demo::setArrayBufferData(napi_env env, napi_callback_info info) &#123;
    size_t argc = 1;
    napi_value js_cb;
    napi_get_cb_info(env, info, &amp;argc, &amp;js_cb, nullptr, nullptr);

    void* buffer; 
    size_t length; 
    napi_get_arraybuffer_info(env, js_cb, &amp;buffer, &amp;length); 
    uint32_t* data = (uint32_t*) buffer;

    // ... Business logic
    return nullptr;
&#125;
</code></pre>
<h2 id="Converting-C-Types-to-ArkTS"><a href="#Converting-C-Types-to-ArkTS" class="headerlink" title="Converting C++ Types to ArkTS"></a>Converting C++ Types to ArkTS</h2><p>To return specific types from C++ to TS (instead of <code>nullptr</code>), convert C++ types to TS via NAPI functions that create <code>napi_value</code> objects:  </p>
<ul>
<li><code>napi_create_uint32</code>  </li>
<li><code>napi_create_int64</code>  </li>
<li><code>napi_create_double</code>  </li>
<li><code>napi_create_bigint_int64</code>  </li>
<li><code>napi_create_bigint_uint64</code>  </li>
<li><code>napi_create_bigint_words</code>  </li>
<li><code>napi_create_string_utf8</code> (and others for different encodings)</li>
</ul>
<p>Example:  </p>
<pre><code class="language-cpp">napi_value Demo::hasSon(napi_env env, napi_callback_info info) &#123;
    size_t argc = 1;
    napi_value args[1] = &#123;nullptr&#125;;
    napi_get_cb_info(env, info, &amp;argc, args, nullptr, nullptr);
    int id;
    napi_get_value_int32(env, args[0], &amp;id);
    napi_value result;
    bool hasSonById = _HasSon(id);
    napi_get_boolean(env, hasSonById, &amp;result);
    return result;
&#125;
</code></pre>
<h2 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h2><p>This article introduces data types in C++ and TS, along with bidirectional conversion methods. Mastering these conversions enables efficient interaction with C++ modules in HarmonyOS development.</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://harmonyostech.github.io/2025/06/30/C-HarmonyOS-Next-Best-Practices-for-Ringing-and-Vibration-in-Call-Pages/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Qingkouwei">
      <meta itemprop="description" content="Welcome to the HarmonyOS NEXT Knowledge Charging Station!  This is a hub for knowledge about HarmonyOS Next`s new-generation system. With its self-developed kernel, HarmonyOS NEXT achieves native smoothness, security, intelligence, and interconnectivity. We deeply analyze how its new distributed soft bus revolutionizes device connectivity experiences and explain the principles behind the enhanced perception and reasoning capabilities of the Xiaoyi intelligent agent based on the Pangu large model. Whether you are a developer exploring application development or an ordinary user eager to understand system features, you can "recharge" here and quickly grasp the essence of HarmonyOS NEXT.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HarmonyOS NEXT Knowledge Charging Station">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/06/30/C-HarmonyOS-Next-Best-Practices-for-Ringing-and-Vibration-in-Call-Pages/" class="post-title-link" itemprop="url">HarmonyOS Next Best Practices for Ringing and Vibration in Call Pages</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2025-06-30 22:21:07 / Modified: 22:22:17" itemprop="dateCreated datePublished" datetime="2025-06-30T22:21:07+08:00">2025-06-30</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/HarmonyOS-Next-Tech/" itemprop="url" rel="index"><span itemprop="name">HarmonyOS Next Tech</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="HarmonyOS-Next-Best-Practices-for-Ringing-and-Vibration-in-Call-Pages"><a href="#HarmonyOS-Next-Best-Practices-for-Ringing-and-Vibration-in-Call-Pages" class="headerlink" title="HarmonyOS Next Best Practices for Ringing and Vibration in Call Pages"></a>HarmonyOS Next Best Practices for Ringing and Vibration in Call Pages</h1><h3 id="1-Background-Introduction"><a href="#1-Background-Introduction" class="headerlink" title="1. Background Introduction"></a>1. Background Introduction</h3><p><img src="/../images/HarmonyOS%20Next%20%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E4%B9%8B%E5%91%BC%E5%8F%AB%E9%A1%B5%E9%9D%A2%E5%93%8D%E9%93%83%E4%B8%8E%E9%9C%87%E5%8A%A8%E5%AE%9E%E7%8E%B0-1.png"><br>In developing audio-video calling modules, call ringing is typically implemented on both outgoing and incoming call pages, similar to WeChat’s video call interface. The called party often experiences vibration alongside ringing. On Android, <code>MediaPlayer</code> loops MP3 ringtones from the <code>raw</code> directory, and <code>Vibrator</code> achieves vibration effects. This article introduces how to implement ringing and vibration in HarmonyOS Next.  </p>
<h3 id="2-Ringing-Implementation"><a href="#2-Ringing-Implementation" class="headerlink" title="2. Ringing Implementation"></a>2. Ringing Implementation</h3><p>For package size considerations, we usually place a short ringtone in the app and repeat it for continuous ringing. Call pages often limit the maximum duration to one minute, so the ringtone can play for up to one minute.  </p>
<p>We place the ringtone file in <code>rawfile</code> and read it via <code>resourceManager</code>. HarmonyOS provides two ways to play audio:  </p>
<ul>
<li><strong>SoundPool</strong>: Enables low-latency short sound playback, suitable for急促 brief sound effects (e.g., camera shutter, system notifications). It supports audio resources under 1MB; files over 1MB are truncated to 1MB.  </li>
<li><strong>AVPlayer</strong>: Achieves end-to-end playback of original media resources.</li>
</ul>
<p>Since <code>SoundPool</code>‘s <code>load</code> method does not support <code>rawfile</code> directory resources, we focus on <code>AVPlayer</code> for audio playback.  </p>
<h4 id="AVPlayer-Playback-Workflow"><a href="#AVPlayer-Playback-Workflow" class="headerlink" title="AVPlayer Playback Workflow"></a>AVPlayer Playback Workflow</h4><p>The full process includes: creating an <code>AVPlayer</code>, setting playback resources, configuring parameters (volume&#x2F;speed&#x2F;focus mode), playback control (play&#x2F;pause&#x2F;seek&#x2F;stop), resetting, and destroying resources.  </p>
<p><code>AVPlayer</code> is similar to Android’s <code>MediaPlayer</code>, maintaining a state machine. You can actively get the current state via the <code>state</code> property or listen for changes using <code>on(&#39;stateChange&#39;)</code>. Operating on an <code>AVPlayer</code> in an error state may throw exceptions or cause undefined behavior.  </p>
<p><img src="/../images/HarmonyOS%20Next%20%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E4%B9%8B%E5%91%BC%E5%8F%AB%E9%A1%B5%E9%9D%A2%E5%93%8D%E9%93%83%E4%B8%8E%E9%9C%87%E5%8A%A8%E5%AE%9E%E7%8E%B0.png"></p>
<h4 id="Ringing-Tool-RingAVPlayer"><a href="#Ringing-Tool-RingAVPlayer" class="headerlink" title="Ringing Tool: RingAVPlayer"></a>Ringing Tool: <code>RingAVPlayer</code></h4><ol>
<li>Create the player: <code>let avPlayer: media.AVPlayer = await media.createAVPlayer();</code>  </li>
<li>Set state change callbacks: <code>avPlayer.on(&#39;stateChange&#39;, async (state: string, reason: media.StateChangeReason) =&gt; &#123;&#125;);</code>  </li>
<li>Get the local audio resource FD: <code>let fileDescriptor = await context.resourceManager.getRawFd(&#39;ring.mp3&#39;);</code>  </li>
<li>Assign <code>fdSrc</code> to trigger the <code>initialized</code> state: <code>avPlayer.fdSrc = fileDescriptor;</code>  </li>
<li>In the state callback, call <code>avPlayer.prepare()</code> after receiving <code>initialized</code> to trigger resource loading.  </li>
<li>In the state callback, call <code>avPlayer.play()</code> after receiving <code>prepared</code>; set <code>avPlayer.loop = true</code> before playback for looping.  </li>
<li>Call <code>stop</code> to end playback.</li>
</ol>
<pre><code class="language-typescript">import &#123; media &#125; from &#39;@kit.MediaKit&#39;;  
import &#123; common &#125; from &#39;@kit.AbilityKit&#39;;  
import &#123; BusinessError &#125; from &#39;@kit.BasicServicesKit&#39;;  
import &#123; audio &#125; from &#39;@kit.AudioKit&#39;;  
import &#123; Logg &#125; from &#39;../../../../../../../Index&#39;;  
  
const TAG = &#39;RingAVPlayer&#39;;  
export class RingAVPlayer &#123;  
  private mAVPlayer: media.AVPlayer|undefined = undefined;  
  private count: number = 0;  
  
  // Register AVPlayer callback functions  
  setAVPlayerCallback(avPlayer: media.AVPlayer) &#123;  
    // Seek operation result callback  
    avPlayer.on(&#39;seekDone&#39;, (seekDoneTime: number) =&gt; &#123;  
      Logg.i(TAG, `AVPlayer seek succeeded, seek time is $&#123;seekDoneTime&#125;`);  
    &#125;)  
    // Error callback: call reset when an error occurs  
    avPlayer.on(&#39;error&#39;, (err: BusinessError) =&gt; &#123;  
      Logg.e(TAG, `Invoke avPlayer failed, code is $&#123;err.code&#125;, message is $&#123;err.message&#125;`);  
      avPlayer.reset(); // Reset resources, trigger idle state  
    &#125;)  
    // State machine change callback  
    avPlayer.on(&#39;stateChange&#39;, async (state: string, reason: media.StateChangeReason) =&gt; &#123;  
      switch (state) &#123;  
        case &#39;idle&#39;:  
          console.info(&#39;AVPlayer state idle called.&#39;);  
          avPlayer.release();  
          break;  
        case &#39;initialized&#39;:  
          Logg.i(TAG, &#39;AVPlayer state initialized called.&#39;);  
          avPlayer.audioRendererInfo = &#123;  
            usage: audio.StreamUsage.STREAM_USAGE_MUSIC,  
            rendererFlags: 0  
          &#125;  
          avPlayer.prepare();  
          break;  
        case &#39;prepared&#39;:  
          Logg.i(TAG, &#39;AVPlayer state prepared called.&#39;);  
          avPlayer.loop = true;  
          avPlayer.play();  
          break;  
        case &#39;playing&#39;:  
          Logg.i(TAG, &#39;AVPlayer state playing called.&#39;);  
          break;  
        case &#39;paused&#39;:  
          Logg.i(TAG, &#39;AVPlayer state paused called.&#39;);  
          break;  
        case &#39;completed&#39;:  
          Logg.i(TAG, &#39;AVPlayer state completed called.&#39;);  
          break;  
        case &#39;stopped&#39;:  
          Logg.i(TAG, &#39;AVPlayer state stopped called.&#39;);  
          break;  
        case &#39;released&#39;:  
          Logg.i(TAG, &#39;AVPlayer state released called.&#39;);  
          break;  
        default:  
          Logg.i(TAG, &#39;AVPlayer state unknown called.&#39;);  
          break;  
      &#125;  
    &#125;)  
  &#125;  
  
  // Demo: Use resource manager to get media files in HAP and play via fdSrc  
  async startAVPlayer() &#123;  
    this.mAVPlayer = await media.createAVPlayer();  
    this.setAVPlayerCallback(this.mAVPlayer);  
    let context = getContext(this) as common.UIAbilityContext;  
    let fileDescriptor = await context.resourceManager.getRawFd(&#39;call_music.mp3&#39;);  
    let avFileDescriptor: media.AVFileDescriptor =  
      &#123; fd: fileDescriptor.fd, offset: fileDescriptor.offset, length: fileDescriptor.length &#125;;  
    this.mAVPlayer.fdSrc = avFileDescriptor;  
  &#125;  
  
  stopAVPlayer() &#123;  
    if (this.mAVPlayer) &#123;  
      this.mAVPlayer.stop();  
      this.mAVPlayer.release();  
    &#125;  
  &#125;  
&#125;
</code></pre>
<h3 id="3-Vibration-Implementation"><a href="#3-Vibration-Implementation" class="headerlink" title="3. Vibration Implementation"></a>3. Vibration Implementation</h3><p>On Android, <code>Vibrator</code> is used as follows:  </p>
<pre><code class="language-java">protected long[] pattern = &#123; 1000, 1000, 1000, 1000 &#125;;
mVibrator = (Vibrator) getSystemService(Context.VIBRATOR_SERVICE);  
mVibrator.vibrate(pattern, 0);
</code></pre>
<p>The array elements represent vibration durations (ms). The first element is the wait time before vibration, and subsequent elements alternate between vibration and pause. <code>repeat</code> determines repetition: <code>-1</code> for no repeat, <code>0</code> for continuous vibration. <code>&#123; 1000, 1000, 1000, 1000 &#125;</code> means wait 1s, vibrate 1s, wait 1s, vibrate 1s, repeating. Call <code>cancel</code> to stop.  </p>
<p>HarmonyOS Next provides corresponding vibration capabilities via the <code>Vibrator</code> module, supporting:  </p>
<ul>
<li>Key presses with different intensities and durations  </li>
<li>Alarms and calls with single or periodic vibrations of varying intensities and durations</li>
</ul>
<h4 id="Three-Vibration-Types"><a href="#Three-Vibration-Types" class="headerlink" title="Three Vibration Types"></a>Three Vibration Types</h4><table>
<thead>
<tr>
<th align="left">Name</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody><tr>
<td align="left">Fixed-duration vibration</td>
<td align="left">Specify a duration; the motor vibrates at default intensity and frequency. See <code>VibrateTime</code>.</td>
</tr>
<tr>
<td align="left">Preset vibration</td>
<td align="left">System-defined vibration effects for fixed scenarios (e.g., <code>haptic.clock.timer</code> for timer adjustments). See <code>VibratePreset</code>.</td>
</tr>
<tr>
<td align="left">Custom vibration</td>
<td align="left">Allows users to design vibration effects via configuration files. See <code>VibrateFromFile</code>.</td>
</tr>
</tbody></table>
<h4 id="Example-Code"><a href="#Example-Code" class="headerlink" title="Example Code"></a>Example Code</h4><h5 id="Fixed-Duration-Vibration"><a href="#Fixed-Duration-Vibration" class="headerlink" title="Fixed-Duration Vibration"></a>Fixed-Duration Vibration</h5><pre><code class="language-typescript">import &#123; vibrator &#125; from &#39;@kit.SensorServiceKit&#39;;
import &#123; BusinessError &#125; from &#39;@kit.BasicServicesKit&#39;;

try &#123;
  vibrator.startVibration(&#123;
    type: &#39;time&#39;,
    duration: 1000,
  &#125;, &#123;
    id: 0,
    usage: &#39;alarm&#39;
  &#125;, (error: BusinessError) =&gt; &#123;
    if (error) &#123;
      console.error(`Failed to start vibration. Code: $&#123;error.code&#125;, message: $&#123;error.message&#125;`);
      return;
    &#125;
    console.info(&#39;Succeed in starting vibration&#39;);
  &#125;);
&#125; catch (err) &#123;
  let e: BusinessError = err as BusinessError;
  console.error(`An unexpected error occurred. Code: $&#123;e.code&#125;, message: $&#123;e.message&#125;`);
&#125;

// Stop fixed-duration vibration
import &#123; vibrator &#125; from &#39;@kit.SensorServiceKit&#39;;
import &#123; BusinessError &#125; from &#39;@kit.BasicServicesKit&#39;;

try &#123;
  vibrator.stopVibration(vibrator.VibratorStopMode.VIBRATOR_STOP_MODE_TIME, (error: BusinessError) =&gt; &#123;
    if (error) &#123;
      console.error(`Failed to stop vibration. Code: $&#123;error.code&#125;, message: $&#123;error.message&#125;`);
      return;
    &#125;
    console.info(&#39;Succeed in stopping vibration&#39;);
  &#125;)
&#125; catch (err) &#123;
  let e: BusinessError = err as BusinessError;
  console.error(`An unexpected error occurred. Code: $&#123;e.code&#125;, message: $&#123;e.message&#125;`);
&#125;
</code></pre>
<h5 id="Preset-Vibration"><a href="#Preset-Vibration" class="headerlink" title="Preset Vibration"></a>Preset Vibration</h5><pre><code class="language-typescript">import &#123; vibrator &#125; from &#39;@kit.SensorServiceKit&#39;;
import &#123; BusinessError &#125; from &#39;@kit.BasicServicesKit&#39;;

try &#123;
  vibrator.isSupportEffect(&#39;haptic.effect.soft&#39;, (err: BusinessError, state: boolean) =&gt; &#123;
    if (err) &#123;
      console.error(`Failed to query effect. Code: $&#123;err.code&#125;, message: $&#123;err.message&#125;`);
      return;
    &#125;
    console.info(&#39;Succeed in querying effect&#39;);
    if (state) &#123;
      vibrator.startVibration(&#123;
        type: &#39;preset&#39;,
        effectId: &#39;haptic.effect.soft&#39;,
        count: 1,
        intensity: 50,
      &#125;, &#123;
        usage: &#39;unknown&#39;
      &#125;, (error: BusinessError) =&gt; &#123;
        if (error) &#123;
          console.error(`Failed to start vibration. Code: $&#123;error.code&#125;, message: $&#123;error.message&#125;`);
        &#125; else &#123;
          console.info(&#39;Succeed in starting vibration&#39;);
        &#125;
      &#125;);
    &#125;
  &#125;)
&#125; catch (error) &#123;
  let e: BusinessError = error as BusinessError;
  console.error(`An unexpected error occurred. Code: $&#123;e.code&#125;, message: $&#123;e.message&#125;`);
&#125;

// Stop preset vibration
import &#123; vibrator &#125; from &#39;@kit.SensorServiceKit&#39;;
import &#123; BusinessError &#125; from &#39;@kit.BasicServicesKit&#39;;

try &#123;
  vibrator.stopVibration(vibrator.VibratorStopMode.VIBRATOR_STOP_MODE_PRESET, (error: BusinessError) =&gt; &#123;
    if (error) &#123;
      console.error(`Failed to stop vibration. Code: $&#123;error.code&#125;, message: $&#123;error.message&#125;`);
      return;
    &#125;
    console.info(&#39;Succeed in stopping vibration&#39;);
  &#125;)
&#125; catch (err) &#123;
  let e: BusinessError = err as BusinessError;
  console.error(`An unexpected error occurred. Code: $&#123;e.code&#125;, message: $&#123;e.message&#125;`);
&#125;
</code></pre>
<h5 id="Custom-Vibration-from-File"><a href="#Custom-Vibration-from-File" class="headerlink" title="Custom Vibration from File"></a>Custom Vibration from File</h5><pre><code class="language-typescript">import &#123; vibrator &#125; from &#39;@kit.SensorServiceKit&#39;;
import &#123; resourceManager &#125; from &#39;@kit.LocalizationKit&#39;;
import &#123; BusinessError &#125; from &#39;@kit.BasicServicesKit&#39;;

const fileName: string = &#39;xxx.json&#39;;
let rawFd: resourceManager.RawFileDescriptor = getContext().resourceManager.getRawFdSync(fileName);

try &#123;
  vibrator.startVibration(&#123;
    type: &quot;file&quot;,
    hapticFd: &#123; fd: rawFd.fd, offset: rawFd.offset, length: rawFd.length &#125;
  &#125;, &#123;
    id: 0,
    usage: &#39;alarm&#39;
  &#125;, (error: BusinessError) =&gt; &#123;
    if (error) &#123;
      console.error(`Failed to start vibration. Code: $&#123;error.code&#125;, message: $&#123;error.message&#125;`);
      return;
    &#125;
    console.info(&#39;Succeed in starting vibration&#39;);
  &#125;);
&#125; catch (err) &#123;
  let e: BusinessError = err as BusinessError;
  console.error(`An unexpected error occurred. Code: $&#123;e.code&#125;, message: $&#123;e.message&#125;`);
&#125;

getContext().resourceManager.closeRawFdSync(fileName);

// Stop all vibrations
import &#123; vibrator &#125; from &#39;@kit.SensorServiceKit&#39;;
import &#123; BusinessError &#125; from &#39;@kit.BasicServicesKit&#39;;

try &#123;
  vibrator.stopVibration((error: BusinessError) =&gt; &#123;
    if (error) &#123;
      console.error(`Failed to stop vibration. Code: $&#123;error.code&#125;, message: $&#123;error.message&#125;`);
      return;
    &#125;
    console.info(&#39;Succeed in stopping vibration&#39;);
  &#125;)
&#125; catch (error) &#123;
  let e: BusinessError = error as BusinessError;
  console.error(`An unexpected error occurred. Code: $&#123;e.code&#125;, message: $&#123;e.message&#125;`);
&#125;
</code></pre>
<h3 id="4-Reference-Documents"><a href="#4-Reference-Documents" class="headerlink" title="4. Reference Documents"></a>4. Reference Documents</h3><ul>
<li><a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references-V5/js-apis-vibrator-V5#effectid">@ohos.vibrator (Vibration)</a>  </li>
<li><a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/vibrator-guidelines-V5">Vibration Development Guide (ArkTS)</a>  </li>
<li><a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references-V5/js-apis-inner-multimedia-soundpool-V5#load">SoundPool (Audio Pool) API</a>  </li>
<li><a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references-V5/js-apis-media-V5#avplayer9">@ohos.multimedia.media (Media Service)</a></li>
</ul>
<h3 id="5-Summary"><a href="#5-Summary" class="headerlink" title="5. Summary"></a>5. Summary</h3><p>This article introduces implementing custom ringing and vibration effects on call pages in HarmonyOS Next audio-video calling scenarios, focusing on <code>AVPlayer</code> and <code>vibrator</code> APIs.</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://harmonyostech.github.io/2025/06/30/C-HarmonyOS-Next-Best-Practices-for-Actively-Invoking-Methods-Encapsulated-in-Custom-Controls/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Qingkouwei">
      <meta itemprop="description" content="Welcome to the HarmonyOS NEXT Knowledge Charging Station!  This is a hub for knowledge about HarmonyOS Next`s new-generation system. With its self-developed kernel, HarmonyOS NEXT achieves native smoothness, security, intelligence, and interconnectivity. We deeply analyze how its new distributed soft bus revolutionizes device connectivity experiences and explain the principles behind the enhanced perception and reasoning capabilities of the Xiaoyi intelligent agent based on the Pangu large model. Whether you are a developer exploring application development or an ordinary user eager to understand system features, you can "recharge" here and quickly grasp the essence of HarmonyOS NEXT.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HarmonyOS NEXT Knowledge Charging Station">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/06/30/C-HarmonyOS-Next-Best-Practices-for-Actively-Invoking-Methods-Encapsulated-in-Custom-Controls/" class="post-title-link" itemprop="url">HarmonyOS Next Best Practices for Actively Invoking Methods Encapsulated in Custom Controls</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2025-06-30 22:19:54 / Modified: 22:20:13" itemprop="dateCreated datePublished" datetime="2025-06-30T22:19:54+08:00">2025-06-30</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/HarmonyOS-Next-Tech/" itemprop="url" rel="index"><span itemprop="name">HarmonyOS Next Tech</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="HarmonyOS-Next-Best-Practices-for-Actively-Invoking-Methods-Encapsulated-in-Custom-Controls"><a href="#HarmonyOS-Next-Best-Practices-for-Actively-Invoking-Methods-Encapsulated-in-Custom-Controls" class="headerlink" title="HarmonyOS Next Best Practices for Actively Invoking Methods Encapsulated in Custom Controls"></a>HarmonyOS Next Best Practices for Actively Invoking Methods Encapsulated in Custom Controls</h1><h3 id="1-Background-Introduction"><a href="#1-Background-Introduction" class="headerlink" title="1. Background Introduction"></a>1. Background Introduction</h3><p>The primary development language for HarmonyOS Next is ArkTS, and its framework ArkUI is a declarative UI. Declarative UIs typically do not manipulate controls directly but drive UI refreshes through state variable updates. However, in some scenarios, state-driven UI refreshes cannot meet complex business logic, requiring parent layouts to invoke methods in child controls. How to handle this?  </p>
<h3 id="2-Reference-to-System-Approaches"><a href="#2-Reference-to-System-Approaches" class="headerlink" title="2. Reference to System Approaches"></a>2. Reference to System Approaches</h3><p>System-provided controls like Dialog, TextTimer, and TextArea require a controller during construction, allowing parent controls to directly invoke child control methods via the controller:  </p>
<ul>
<li><code>TextTimerController</code> provides <code>start</code>, <code>pause</code>, and <code>reset</code> methods for parent components.  </li>
<li><code>CustomDialogController</code> provides <code>open</code> and <code>close</code> methods for parent components.</li>
</ul>
<p>We can adopt a similar approach: encapsulate a controller for child components to enable parent-component invocation.  </p>
<h3 id="3-Encapsulation-of-Child-Component-Invocation"><a href="#3-Encapsulation-of-Child-Component-Invocation" class="headerlink" title="3. Encapsulation of Child Component Invocation"></a>3. Encapsulation of Child Component Invocation</h3><p>The parent component invokes methods of the child component by calling a controller exposed by the child component. This encapsulates capabilities like data processing, refreshing, animations, and notifications.  </p>
<h4 id="Implementation-Steps"><a href="#Implementation-Steps" class="headerlink" title="Implementation Steps:"></a>Implementation Steps:</h4><ol>
<li>Define a <code>ChildController</code> class with methods matching those in the child component:</li>
</ol>
<pre><code class="language-typescript">class ChildController &#123; 
  changeText = (value: string) =&gt; &#123; console.log(&#39;11111&#39;) &#125; 
&#125; 
export let ChildRef = new ChildController()
</code></pre>
<ol start="2">
<li>In the child component, assign actual methods to the controller. In <code>aboutToAppear</code>, map the child component’s methods to the controller’s method variables:</li>
</ol>
<pre><code class="language-typescript">@Component
struct Child &#123;
  @State private text: string = &#39;初始值&#39;;
  private controller: ChildController = new ChildController();

  aboutToAppear() &#123;
    if (this.controller) &#123;
      this.controller.changeText = this.changeText;
    &#125;
    console.log(&#39;aaa&#39;);
  &#125;

  private changeText = (value: string) =&gt; &#123;
    this.text = value;
    console.log(&#39;bbb&#39;);
  &#125;

  build() &#123;
    Column() &#123;
      Text(this.text);
    &#125;
  &#125;
&#125;
</code></pre>
<ol start="3">
<li>In the parent component, create a controller object, pass it to the child component, and invoke the controller’s methods:</li>
</ol>
<pre><code class="language-typescript">@Entry
@Component
struct Parent &#123;
  private ChildRef = new ChildController();
  build() &#123;
    Column() &#123;
      Text(&#39;调用 Child 的 changeText&#39;).fontSize(&#39;18vp&#39;).fontColor(Color.Gray);
      Divider();
      Child(&#123; controller: this.ChildRef &#125;);
    &#125;
  &#125;
&#125;
</code></pre>
<h3 id="4-Design-Analysis"><a href="#4-Design-Analysis" class="headerlink" title="4. Design Analysis"></a>4. Design Analysis</h3><p>This approach uses an intermediate controller object for indirect communication:  </p>
<ul>
<li>The parent component holds the controller, while the child component assigns its actual methods to the controller during initialization.  </li>
<li>When the parent component invokes the controller’s methods, it effectively calls the child component’s methods.  </li>
<li>This achieves loose coupling, avoiding direct parent dependency on child component internals, and enhances code maintainability and extensibility.</li>
</ul>
<h3 id="5-Summary"><a href="#5-Summary" class="headerlink" title="5. Summary"></a>5. Summary</h3><p>This article introduces a method for parent components to invoke child components in the declarative UI framework ArkUI. Through loose-coupling communication, it solves the challenge of parent components directly invoking child component methods without holding direct references.</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://harmonyostech.github.io/2025/06/30/C-HarmonyOS-Next-Audio-Video-Practice-OPUS-Audio-Encoding/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Qingkouwei">
      <meta itemprop="description" content="Welcome to the HarmonyOS NEXT Knowledge Charging Station!  This is a hub for knowledge about HarmonyOS Next`s new-generation system. With its self-developed kernel, HarmonyOS NEXT achieves native smoothness, security, intelligence, and interconnectivity. We deeply analyze how its new distributed soft bus revolutionizes device connectivity experiences and explain the principles behind the enhanced perception and reasoning capabilities of the Xiaoyi intelligent agent based on the Pangu large model. Whether you are a developer exploring application development or an ordinary user eager to understand system features, you can "recharge" here and quickly grasp the essence of HarmonyOS NEXT.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HarmonyOS NEXT Knowledge Charging Station">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/06/30/C-HarmonyOS-Next-Audio-Video-Practice-OPUS-Audio-Encoding/" class="post-title-link" itemprop="url">HarmonyOS Next Audio-Video Practice: OPUS Audio Encoding</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2025-06-30 22:17:53 / Modified: 22:19:26" itemprop="dateCreated datePublished" datetime="2025-06-30T22:17:53+08:00">2025-06-30</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/HarmonyOS-Next-Tech/" itemprop="url" rel="index"><span itemprop="name">HarmonyOS Next Tech</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="HarmonyOS-Next-Audio-Video-Practice-OPUS-Audio-Encoding"><a href="#HarmonyOS-Next-Audio-Video-Practice-OPUS-Audio-Encoding" class="headerlink" title="HarmonyOS Next Audio-Video Practice: OPUS Audio Encoding"></a>HarmonyOS Next Audio-Video Practice: OPUS Audio Encoding</h1><h2 id="Background"><a href="#Background" class="headerlink" title="Background"></a>Background</h2><p>In chat scenarios requiring short voice messages, audio content needs to be encoded and compressed. Initially, MP3 encoding was used, but later, as voice messages were applied to ASR model training, OPUS encoding became necessary for processing voice signals. Previously, Android did not support MP3 or OPUS encoding, but HarmonyOS now supports both. The encoder types supported by HarmonyOS are:  </p>
<table>
<thead>
<tr>
<th align="left">Container Format</th>
<th align="left">Audio Encoding Type</th>
</tr>
</thead>
<tbody><tr>
<td align="left">mp4</td>
<td align="left">AAC, Flac</td>
</tr>
<tr>
<td align="left">m4a</td>
<td align="left">AAC</td>
</tr>
<tr>
<td align="left">flac</td>
<td align="left">Flac</td>
</tr>
<tr>
<td align="left">aac</td>
<td align="left">AAC</td>
</tr>
<tr>
<td align="left">mp3</td>
<td align="left">MP3</td>
</tr>
<tr>
<td align="left">raw</td>
<td align="left">G711mu</td>
</tr>
<tr>
<td align="left">amr</td>
<td align="left">AMR</td>
</tr>
<tr>
<td align="left">ogg</td>
<td align="left">opus</td>
</tr>
</tbody></table>
<p>After encoding with OPUS via system APIs, the audio file could not be played. Investigation showed the encoder did not automatically perform muxing, and the system Muxer does not support the OGG container. Current packaging capabilities are as follows:  </p>
<table>
<thead>
<tr>
<th align="left">Packaging Format</th>
<th align="left">Video Codec Type</th>
<th align="left">Audio Codec Type</th>
<th align="left">Cover Type</th>
</tr>
</thead>
<tbody><tr>
<td align="left">mp4</td>
<td align="left">AVC (H.264), HEVC (H.265)</td>
<td align="left">AAC, MPEG (MP3)</td>
<td align="left">jpeg, png, bmp</td>
</tr>
<tr>
<td align="left">m4a</td>
<td align="left">-</td>
<td align="left">AAC</td>
<td align="left">jpeg, png, bmp</td>
</tr>
<tr>
<td align="left">mp3</td>
<td align="left">-</td>
<td align="left">MPEG (MP3)</td>
<td align="left">-</td>
</tr>
</tbody></table>
<p>Since HarmonyOS does not support the OGG container, we need to implement it manually.  </p>
<h2 id="Introduction-to-OPUS-OGG-Packaging"><a href="#Introduction-to-OPUS-OGG-Packaging" class="headerlink" title="Introduction to OPUS OGG Packaging"></a>Introduction to OPUS OGG Packaging</h2><p>OGG organizes logical streams in units of “pages,” each consisting of a page header and page data. The page header includes:  </p>
<ol>
<li><strong>capture_pattern (Page Identifier)</strong>: ASCII characters <code>0x4F &#39;O&#39; 0x67 &#39;g&#39; 0x67 &#39;g&#39; 0x53 &#39;S&#39;</code> (4 bytes), marking the start of a page.  </li>
<li><strong>stream_structure_version (Version ID)</strong>: Typically 0 (1 byte).  </li>
<li><strong>header_type_flag (Type Indicator)</strong>: Marks the page type (1 byte):  <ul>
<li><code>0x01</code>: The media data on this page belongs to the same packet as the previous page. If unset, this page starts a new packet.  </li>
<li><code>0x02</code>: Indicates the first page of the logical stream (BOS flag). If unset, it is not the first page.  </li>
<li><code>0x04</code>: Indicates the last page of the logical stream (EOS flag). If unset, it is not the last page.</li>
</ul>
</li>
<li><strong>granule_position</strong>: Media encoding parameters (8 bytes). For audio streams, it stores the number of PCM samples up to this page, from which timestamps can be calculated. For video streams, it stores the number of encoded frames. A value of -1 means the packet is not yet complete (little-endian).  </li>
<li><strong>serial_number</strong>: Stream ID of the page (4 bytes), distinguishing this logical stream from others (little-endian).  </li>
<li><strong>page_sequence_number</strong>: Page sequence number in the logical stream (4 bytes).  </li>
<li><strong>CRC_cbecksum</strong>: Cyclic Redundancy Check (4 bytes) for page validity.  </li>
<li><strong>number_page_segments</strong>: Number of segments in the <code>segment_table</code> (1 byte).  </li>
<li><strong>segment_table</strong>: A table defining segment lengths (0–255). Packets end at the last segment not equal to 255. For example, segments <code>FF 45 FF FF FF 40 FF 05 FF FF FF 66</code> (12 segments, 4 packets) yield packet lengths: <code>255+69=324</code>, <code>829</code>, <code>260</code>, <code>847</code>.</li>
</ol>
<p>The page header length and total page length are calculated as:  </p>
<pre><code>header_size  = 27 + number_page_segments  (bytes)
page_size = header_size + sum of segment sizes in segment_table
</code></pre>
<p>Page header format:<br><img src="/../images/20191206155347827_1247407323.png" alt="Page Header Format">  </p>
<h2 id="Implementing-OGG-Packaging"><a href="#Implementing-OGG-Packaging" class="headerlink" title="Implementing OGG Packaging"></a>Implementing OGG Packaging</h2><p>Xiph provides the open-source <code>libopusenc</code> for OPUS OGG packaging, which depends on the <code>libopus</code> library. The simplest approach is to use <code>libopusenc</code> for both OPUS encoding and container packaging.  </p>
<h3 id="libopusenc-Processing-Flow"><a href="#libopusenc-Processing-Flow" class="headerlink" title="libopusenc Processing Flow"></a>libopusenc Processing Flow</h3><h4 id="Creating-the-Encoder"><a href="#Creating-the-Encoder" class="headerlink" title="Creating the Encoder"></a>Creating the Encoder</h4><p>First, create comments:  </p>
<pre><code class="language-c">OggOpusComments *comments = ope_comments_create();  
ope_comments_add(comments, &quot;ARTIST&quot;, &quot;qingkouwei&quot;);  
ope_comments_add(comments, &quot;TITLE&quot;, &quot;qingkouwei-im&quot;);
</code></pre>
<p>Then create the encoder:  </p>
<pre><code class="language-c">OggOpusEnc *pEnc = ope_encoder_create_file(outputFilePath_, comments, inSamplerate, inChannel,  
                                          quality, &amp;error);  
if (pEnc) &#123;    
    int ret = ope_encoder_ctl(pEnc, OPUS_SET_BITRATE(outBitrate));  
&#125;
</code></pre>
<p>Parameters include the muxer output path, comment info, sampling rate, channel count, audio quality, etc.  </p>
<h4 id="Encoding-PCM-Data"><a href="#Encoding-PCM-Data" class="headerlink" title="Encoding PCM Data"></a>Encoding PCM Data</h4><pre><code class="language-c">static napi_value encodePCMToOpusOggNative(napi_env env, napi_callback_info info)  
&#123;  
    size_t argc = 1;  
    napi_value args[1] = &#123;nullptr&#125;;  
    napi_get_cb_info(env, info, &amp;argc, args, nullptr, nullptr);  
    void* inputBuffer;   
    size_t inputLength;   
    napi_get_arraybuffer_info(env, args[0], &amp;inputBuffer, &amp;inputLength);   
    ope_encoder_write(pEnc, (short *)inputBuffer, inputLength/2);  
    return nullptr;
&#125;
</code></pre>
<p>Transfer binary data from the TS layer to <code>ope_encoder_write</code>, which writes encoded data to the path specified during encoder creation.  </p>
<h4 id="Closing-the-Encoder-Muxer"><a href="#Closing-the-Encoder-Muxer" class="headerlink" title="Closing the Encoder Muxer"></a>Closing the Encoder Muxer</h4><pre><code class="language-c">static napi_value closeOpusOggEncoderNative(napi_env env, napi_callback_info info)  
&#123;  
   ope_encoder_drain(pEnc);  
   ope_encoder_destroy(pEnc);  
   if (comments != NULL) &#123;  
       ope_comments_destroy(comments);  
       comments = NULL;  
   &#125;  
   return nullptr;  
&#125;
</code></pre>
<p>Release the encoder, comments, and other objects. The overall process is straightforward, and the final OGG container file can be played normally by general players:<br>![[HarmonyOS Next 音视频之OPUS音频编码实战-1.png]]<br><img src="/../images/HarmonyOS%20Next%20%E9%9F%B3%E8%A7%86%E9%A2%91%E4%B9%8BOPUS%E9%9F%B3%E9%A2%91%E7%BC%96%E7%A0%81%E5%AE%9E%E6%88%98-1.png"></p>
<h2 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h2><p>This article introduces methods to implement OPUS encoding and OGG container packaging in HarmonyOS, addressing special audio encoding requirements in business scenarios.</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://harmonyostech.github.io/2025/06/30/C-Mastering-Image-and-Video-Selection-in-HarmonyOS-Next/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Qingkouwei">
      <meta itemprop="description" content="Welcome to the HarmonyOS NEXT Knowledge Charging Station!  This is a hub for knowledge about HarmonyOS Next`s new-generation system. With its self-developed kernel, HarmonyOS NEXT achieves native smoothness, security, intelligence, and interconnectivity. We deeply analyze how its new distributed soft bus revolutionizes device connectivity experiences and explain the principles behind the enhanced perception and reasoning capabilities of the Xiaoyi intelligent agent based on the Pangu large model. Whether you are a developer exploring application development or an ordinary user eager to understand system features, you can "recharge" here and quickly grasp the essence of HarmonyOS NEXT.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HarmonyOS NEXT Knowledge Charging Station">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/06/30/C-Mastering-Image-and-Video-Selection-in-HarmonyOS-Next/" class="post-title-link" itemprop="url">Mastering Image and Video Selection in HarmonyOS Next</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2025-06-30 22:10:39" itemprop="dateCreated datePublished" datetime="2025-06-30T22:10:39+08:00">2025-06-30</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-07-13 17:06:24" itemprop="dateModified" datetime="2025-07-13T17:06:24+08:00">2025-07-13</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/HarmonyOS-Next-Tech/" itemprop="url" rel="index"><span itemprop="name">HarmonyOS Next Tech</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Mastering-Image-and-Video-Selection-in-HarmonyOS-Next"><a href="#Mastering-Image-and-Video-Selection-in-HarmonyOS-Next" class="headerlink" title="Mastering Image and Video Selection in HarmonyOS Next"></a>Mastering Image and Video Selection in HarmonyOS Next</h1><h2 id="Background"><a href="#Background" class="headerlink" title="Background"></a>Background</h2><p>In chat applications, sending photos and videos from the album or capturing them via the camera is a common function. On Android and iOS, most apps use API-defined UIs to implement album photo&#x2F;video selection and camera capture, supporting:  </p>
<ol>
<li><strong>Album selection</strong>:  <ul>
<li>Single or multiple selection.  </li>
<li>Option to select original image quality.  </li>
<li>Filters for video file size and duration.  </li>
<li>Tap to enlarge and preview images.</li>
</ul>
</li>
<li><strong>Camera capture</strong>:  <ul>
<li>Tap to take photos, long-press to record videos.  </li>
<li>Video recording with max&#x2F;min duration limits.  </li>
<li>Preview after capture&#x2F;recording.</li>
</ul>
</li>
</ol>
<p><img src="/../images/%E3%80%90%E6%AF%8F%E6%97%A5%E5%AD%A6%E7%82%B9%E9%B8%BF%E8%92%99%E7%9F%A5%E8%AF%86%E3%80%9124.09.10%20-%20%E5%9B%BE%E7%89%87%E5%92%8C%E8%A7%86%E9%A2%91%E9%80%89%E6%8B%A9.png"><br><img src="/../images/%E3%80%90%E6%AF%8F%E6%97%A5%E5%AD%A6%E7%82%B9%E9%B8%BF%E8%92%99%E7%9F%A5%E8%AF%86%E3%80%9124.09.10%20-%20%E5%9B%BE%E7%89%87%E5%92%8C%E8%A7%86%E9%A2%91%E9%80%89%E6%8B%A9-1.png"></p>
<p>To implement these features in HarmonyOS apps, the system provides corresponding APIs requiring several permissions:  </p>
<ul>
<li>System album read permission  </li>
<li>Microphone permission  </li>
<li>Camera permission</li>
</ul>
<h2 id="Introduction-to-HarmonyOS-Permission-System"><a href="#Introduction-to-HarmonyOS-Permission-System" class="headerlink" title="Introduction to HarmonyOS Permission System"></a>Introduction to HarmonyOS Permission System</h2><p>Compared to Android, HarmonyOS offers stricter permission control, governed by its application permission management strategy. It provides a universal way for apps to access system resources (e.g., contacts) and capabilities (e.g., camera, microphone) to protect data (including user personal data) and functions from misuse or malicious use. Permission protection objects fall into two categories:  </p>
<ul>
<li><strong>Data</strong>: Personal data (photos, contacts, calendar, location) and device data (device ID, camera, microphone).  </li>
<li><strong>Functions</strong>: Device functions (accessing camera&#x2F;microphone, making calls, networking) and app functions (floating windows, creating shortcuts).</li>
</ul>
<p>HarmonyOS classifies permissions by authorization method into:  </p>
<ol>
<li><strong>system_grant (System authorization)</strong>: For non-sensitive data&#x2F;operations with controlled impacts. The system automatically grants these permissions during app installation.  </li>
<li><strong>user_grant (User authorization)</strong>: For sensitive data&#x2F;operations with potential severe impacts. Requires both manifest declaration and dynamic runtime user authorization via a pop-up.</li>
</ol>
<p>For example, microphone and camera permissions are user-grant types, with detailed usage rationales listed in the <a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/permissions-for-all-V5">Application Permission List</a>. Apps must display requested user-grant permissions on the AppGallery detail page.  </p>
<p>Another key concept is <strong>APL (Ability Privilege Level)</strong>:  </p>
<table>
<thead>
<tr>
<th align="left">APL Level</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody><tr>
<td align="left">normal</td>
<td align="left">Default level for all apps.</td>
</tr>
<tr>
<td align="left">system_basic</td>
<td align="left">Provides basic system services.</td>
</tr>
<tr>
<td align="left">system_core</td>
<td align="left">Provides core OS capabilities (cannot be configured for normal apps).</td>
</tr>
</tbody></table>
<p>Permissions are categorized by APL with varying access scopes:  </p>
<table>
<thead>
<tr>
<th align="left">APL Level</th>
<th align="left">Description</th>
<th align="left">Access Scope</th>
</tr>
</thead>
<tbody><tr>
<td align="left">normal</td>
<td align="left">Access to ordinary system resources (e.g., Wi-Fi config, camera capture) with low privacy risk.</td>
<td align="left">Apps with APL ≥ normal.</td>
</tr>
<tr>
<td align="left">system_basic</td>
<td align="left">Access to basic OS services (e.g., system settings, authentication) with higher risk.</td>
<td align="left">1. Apps with APL ≥ system_basic.<br>2. Some permissions are restrictively open to normal apps (described as <a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/restricted-permissions-V5">Restricted Permissions</a>).</td>
</tr>
<tr>
<td align="left">system_core</td>
<td align="left">Access to core OS resources critical for system operation.</td>
<td align="left">1. System apps with APL &#x3D; system_core.</td>
</tr>
</tbody></table>
<h3 id="Design-Rationale"><a href="#Design-Rationale" class="headerlink" title="Design Rationale"></a>Design Rationale</h3><ul>
<li><p><strong>Authorization methods</strong>:  </p>
<ul>
<li>system_grant is similar to Android’s normal permissions (declared in the manifest), avoiding unnecessary user prompts for non-sensitive operations (e.g., network access).  </li>
<li>user_grant requires explicit user consent for sensitive operations (e.g., camera access), aligning with privacy best practices.</li>
</ul>
</li>
<li><p><strong>Permission levels</strong>:  </p>
<ul>
<li>normal: For common app functions (e.g., camera, microphone) with clear usage scenarios.  </li>
<li>system_core: Exclusive to system apps to prevent critical system damage (e.g., like Android’s root permissions).  </li>
<li>system_basic: For system apps, with restricted openness to normal apps (e.g., album read permission is restricted because it allows silent data transmission, unlike camera&#x2F;microphone which require active user interaction).</li>
</ul>
</li>
</ul>
<h2 id="System-Picker-Permission-Free-Resource-Access"><a href="#System-Picker-Permission-Free-Resource-Access" class="headerlink" title="System Picker: Permission-Free Resource Access"></a>System Picker: Permission-Free Resource Access</h2><p>Selecting images&#x2F;videos requires system_basic restricted permissions, while camera&#x2F;microphone access needs user authorization. To streamline workflows, HarmonyOS provides system Pickers—components allowing permission-free resource selection:  </p>
<ul>
<li>The system Picker (file&#x2F;photo&#x2F;contact selector) is implemented by an independent system process.  </li>
<li>Apps obtain resources via cross-process scheduling, with temporary and restricted access rights granted by the user’s explicit actions.</li>
</ul>
<h2 id="Selecting-from-Album"><a href="#Selecting-from-Album" class="headerlink" title="Selecting from Album"></a>Selecting from Album</h2><p><img src="/../images/%E3%80%90%E6%AF%8F%E6%97%A5%E5%AD%A6%E7%82%B9%E9%B8%BF%E8%92%99%E7%9F%A5%E8%AF%86%E3%80%9124.09.10%20-%20%E5%9B%BE%E7%89%87%E5%92%8C%E8%A7%86%E9%A2%91%E9%80%89%E6%8B%A9.jpg"><br>HarmonyOS provides <code>photoAccessHelper.PhotoViewPicker()</code> to access album content. Example usage:  </p>
<pre><code class="language-typescript">import &#123; BusinessError &#125; from &#39;@kit.BasicServicesKit&#39;;
async function example01() &#123;
  try &#123;
    let photoSelectOptions = new photoAccessHelper.PhotoSelectOptions();
    photoSelectOptions.MIMEType = photoAccessHelper.PhotoViewMIMETypes.IMAGE_TYPE;
    photoSelectOptions.maxSelectNumber = 5;
    
    let photoPicker = new photoAccessHelper.PhotoViewPicker();
    photoPicker.select(photoSelectOptions).then((photoSelectResult: photoAccessHelper.PhotoSelectResult) =&gt; &#123;
      console.info(&#39;PhotoViewPicker.select successfully, PhotoSelectResult uri: &#39; + JSON.stringify(photoSelectResult));
    &#125;).catch((err: BusinessError) =&gt; &#123;
      console.error(`PhotoViewPicker.select failed with err: $&#123;err.code&#125;, $&#123;err.message&#125;`);
    &#125;);
  &#125; catch (error) &#123;
    let err: BusinessError = error as BusinessError;
    console.error(`PhotoViewPicker failed with err: $&#123;err.code&#125;, $&#123;err.message&#125;`);
  &#125;
&#125;
</code></pre>
<h3 id="Key-Objects"><a href="#Key-Objects" class="headerlink" title="Key Objects"></a>Key Objects</h3><h4 id="PhotoSelectOptions-selection-parameters"><a href="#PhotoSelectOptions-selection-parameters" class="headerlink" title="PhotoSelectOptions (selection parameters)"></a><code>PhotoSelectOptions</code> (selection parameters)</h4><table>
<thead>
<tr>
<th align="left">Name</th>
<th align="left">Type</th>
<th align="left">Required</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody><tr>
<td align="left">isEditSupported11+</td>
<td align="left">boolean</td>
<td align="left">No</td>
<td align="left">Enable photo editing (default: true).</td>
</tr>
<tr>
<td align="left">isOriginalSupported12+</td>
<td align="left">boolean</td>
<td align="left">No</td>
<td align="left">Show “Select Original” button (default: true).<br><br><strong>Feature API:</strong> Available in ability models from API version 12.</td>
</tr>
<tr>
<td align="left">subWindowName12+</td>
<td align="left">string</td>
<td align="left">No</td>
<td align="left">Subwindow name.<br><br><strong>Feature API:</strong> Available in ability models from API version 12.</td>
</tr>
</tbody></table>
<p>Inherits from <code>BaseSelectOptions</code> with additional configs:  </p>
<table>
<thead>
<tr>
<th align="left">Name</th>
<th align="left">Type</th>
<th align="left">Required</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody><tr>
<td align="left">MIMEType10+</td>
<td align="left"><a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references-V5/js-apis-photoaccesshelper-V5#photoviewmimetypes">PhotoViewMIMETypes</a></td>
<td align="left">No</td>
<td align="left">Allowed media types (default: images + videos).<br><br><strong>Feature API:</strong> Available in ability models from API version 11.</td>
</tr>
<tr>
<td align="left">maxSelectNumber10+</td>
<td align="left">number</td>
<td align="left">No</td>
<td align="left">Max selection count (max: 500, default: 50).<br><br><strong>Feature API:</strong> Available in ability models from API version 11.</td>
</tr>
<tr>
<td align="left">isPhotoTakingSupported11+</td>
<td align="left">boolean</td>
<td align="left">No</td>
<td align="left">Enable in-picker camera (default: true).<br><br><strong>Feature API:</strong> Available in ability models from API version 11.</td>
</tr>
<tr>
<td align="left">isSearchSupported11+</td>
<td align="left">boolean</td>
<td align="left">No</td>
<td align="left">Enable search (default: true).<br><br><strong>Feature API:</strong> Available in ability models from API version 11.</td>
</tr>
<tr>
<td align="left">recommendationOptions11+</td>
<td align="left"><a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references-V5/js-apis-photoaccesshelper-V5#recommendationoptions11">RecommendationOptions</a></td>
<td align="left">No</td>
<td align="left">Photo recommendation configs.<br><br><strong>Feature API:</strong> Available in ability models from API version 11.</td>
</tr>
<tr>
<td align="left">preselectedUris11+</td>
<td align="left">Array<string></td>
<td align="left">No</td>
<td align="left">Preselected media URIs.<br><br><strong>Feature API:</strong> Available in ability models from API version 11.</td>
</tr>
<tr>
<td align="left">isPreviewForSingleSelectionSupported12+</td>
<td align="left">boolean</td>
<td align="left">No</td>
<td align="left">Enable full-screen preview for single selection (default: true).<br><br><strong>Feature API:</strong> Available in ability models from API version 12.</td>
</tr>
</tbody></table>
<h4 id="PhotoSelectResult-selection-result"><a href="#PhotoSelectResult-selection-result" class="headerlink" title="PhotoSelectResult (selection result)"></a><code>PhotoSelectResult</code> (selection result)</h4><table>
<thead>
<tr>
<th align="left">Name</th>
<th align="left">Type</th>
<th align="left">Readable</th>
<th align="left">Writable</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody><tr>
<td align="left">photoUris</td>
<td align="left">Array<string></td>
<td align="left">Yes</td>
<td align="left">Yes</td>
<td align="left">URIs of selected media (usable via temporary authorization with <a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references-V5/js-apis-photoaccesshelper-V5#getassets">photoAccessHelper.getAssets</a>).</td>
</tr>
<tr>
<td align="left">isOriginalPhoto</td>
<td align="left">boolean</td>
<td align="left">Yes</td>
<td align="left">Yes</td>
<td align="left">Whether original quality was selected.</td>
</tr>
</tbody></table>
<h3 id="Distinguishing-Image-and-Video-URIs"><a href="#Distinguishing-Image-and-Video-URIs" class="headerlink" title="Distinguishing Image and Video URIs"></a>Distinguishing Image and Video URIs</h3><p>Use <code>photoAccessHelper</code> to parse media info:  </p>
<pre><code class="language-typescript">public async uriGetAssets(uri: string): Promise&lt;photoAccessHelper.PhotoAsset | undefined&gt; &#123;  
  try &#123;  
    const context = getContext(this) as common.UIAbilityContext;  
    const phAccessHelper = photoAccessHelper.getPhotoAccessHelper(context);  
    const predicates: dataSharePredicates.DataSharePredicates = new dataSharePredicates.DataSharePredicates();  
    predicates.equalTo(&#39;uri&#39;, uri);  
    const fetchOption: photoAccessHelper.FetchOptions = &#123;  
      fetchColumns: [photoAccessHelper.PhotoKeys.WIDTH, photoAccessHelper.PhotoKeys.HEIGHT, photoAccessHelper.PhotoKeys.TITLE, photoAccessHelper.PhotoKeys.DURATION],  
      predicates: predicates  
    &#125;;  
    const fetchResult: photoAccessHelper.FetchResult&lt;photoAccessHelper.PhotoAsset&gt; = await phAccessHelper.getAssets(fetchOption);  
    const asset: photoAccessHelper.PhotoAsset = await fetchResult.getFirstObject();  
    Logg.i(TAG, `asset displayName: $&#123;asset.displayName&#125;`);  
    Logg.i(TAG, `asset uri: $&#123;asset.uri&#125;`);  
    Logg.i(TAG, `asset photoType: $&#123;asset.photoType&#125;`);  
    return asset;  
  &#125; catch (error) &#123;  
    Logg.e(TAG, `uriGetAssets failed: $&#123;JSON.stringify(error)&#125;`);  
  &#125;  
  return undefined;  
&#125;
</code></pre>
<p>The <code>photoType</code> property of <code>photoAccessHelper.PhotoAsset</code> indicates media type (image&#x2F;video).  </p>
<h3 id="Obtaining-Video-Thumbnails"><a href="#Obtaining-Video-Thumbnails" class="headerlink" title="Obtaining Video Thumbnails"></a>Obtaining Video Thumbnails</h3><p>Use <code>getThumbnail()</code> on <code>photoAccessHelper.PhotoAsset</code> to get a <code>PixelMap</code>, then convert it to an image:  </p>
<pre><code class="language-typescript">import &#123; BusinessError &#125; from &#39;@kit.BasicServicesKit&#39;;
async function Demo() &#123;
  const readBuffer = new ArrayBuffer(96); // height * width * 4  
  if (pixelMap) &#123;
    pixelMap.readPixelsToBuffer(readBuffer, (error: BusinessError, res: void) =&gt; &#123;
      if (error) &#123;
        console.error(`Failed to read pixel data: $&#123;error.code&#125;, $&#123;error.message&#125;`);
        return;
      &#125;
      console.info(&#39;Pixel data read successfully.&#39;);
    &#125;);
  &#125;
&#125;
</code></pre>
<p>Use <code>image.createImagePacker()</code> to write the <code>PixelMap</code> to a file:  </p>
<pre><code class="language-typescript">let imagePath: string | undefined = undefined;  
const pixelMap = await matedata.getThumbnail();  
const cacheDir = getContext().cacheDir;  
imagePath = `$&#123;cacheDir&#125;/thumbnail$&#123;Date.now()&#125;.jpg`;  
const dstFile = fs.openSync(imagePath, fs.OpenMode.READ_WRITE | fs.OpenMode.CREATE);  
const packOpts: image.PackingOption = &#123; format: &quot;image/jpeg&quot;, quality: 98 &#125;;  
await image.createImagePacker().packToFile(pixelMap, dstFile.fd, packOpts);  
fs.close(dstFile);  
</code></pre>
<h2 id="Capturing-via-Camera"><a href="#Capturing-via-Camera" class="headerlink" title="Capturing via Camera"></a>Capturing via Camera</h2><p><img src="/../images/%E3%80%90%E6%AF%8F%E6%97%A5%E5%AD%A6%E7%82%B9%E9%B8%BF%E8%92%99%E7%9F%A5%E8%AF%86%E3%80%9124.09.10%20-%20%E5%9B%BE%E7%89%87%E5%92%8C%E8%A7%86%E9%A2%91%E9%80%89%E6%8B%A9-5.jpg"><br><img src="/../images/%E3%80%90%E6%AF%8F%E6%97%A5%E5%AD%A6%E7%82%B9%E9%B8%BF%E8%92%99%E7%9F%A5%E8%AF%86%E3%80%9124.09.10%20-%20%E5%9B%BE%E7%89%87%E5%92%8C%E8%A7%86%E9%A2%91%E9%80%89%E6%8B%A9-3.jpg"><br>Two methods to launch the system camera:  </p>
<h3 id="Using-Want"><a href="#Using-Want" class="headerlink" title="Using Want"></a>Using Want</h3><pre><code class="language-typescript">invokeCamera(callback: (uri: string) =&gt; void) &#123;  
  const context = getContext(this) as common.UIAbilityContext;  
  const want: Want = &#123;  
    action: &#39;ohos.want.action.imageCapture&#39;,  
    parameters: &#123;  
      &quot;callBundleName&quot;: context.abilityInfo.bundleName,  
    &#125;  
  &#125;;  
  const result: (error: BusinessError, data: common.AbilityResult) =&gt; void =  
    (error: BusinessError, data: common.AbilityResult) =&gt; &#123;  
      if (error &amp;&amp; error.code !== 0) &#123;  
        console.log(`$&#123;TAG_CAMERA_ERROR&#125; $&#123;JSON.stringify(error.message)&#125;`);  
        return;  
      &#125;  
      const resultUri: string = data.want?.parameters?.resourceUri as string;  
      if (callback &amp;&amp; resultUri) &#123;  
        callback(resultUri);  
      &#125;  
    &#125;;  
  context.startAbilityForResult(want, result);  
&#125;
</code></pre>
<p>This method (referencing <a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/cn/doc/harmonyos-faqs-V5/faqs-camera-14-V5">How to Call System Camera</a>) doesn’t support video duration settings.  </p>
<h3 id="Using-cameraPicker"><a href="#Using-cameraPicker" class="headerlink" title="Using cameraPicker"></a>Using cameraPicker</h3><pre><code class="language-typescript">import &#123; cameraPicker as picker &#125; from &#39;@kit.CameraKit&#39;;
import &#123; camera &#125; from &#39;@kit.CameraKit&#39;;
import &#123; common &#125; from &#39;@kit.AbilityKit&#39;;
import &#123; BusinessError &#125; from &#39;@kit.BasicServicesKit&#39;;
const mContext = getContext(this) as common.Context;

async function demo() &#123;
  try &#123;
    const pickerProfile: picker.PickerProfile = &#123;
      cameraPosition: camera.CameraPosition.CAMERA_POSITION_BACK
    &#125;;
    const pickerResult: picker.PickerResult = await picker.pick(mContext,
      [picker.PickerMediaType.PHOTO, picker.PickerMediaType.VIDEO], pickerProfile);
    console.log(`Picker result: $&#123;JSON.stringify(pickerResult)&#125;`);
  &#125; catch (error) &#123;
    const err = error as BusinessError;
    console.error(`Picker failed: $&#123;err.code&#125;`);
  &#125;
&#125;
</code></pre>
<h4 id="PickerProfile-camera-settings"><a href="#PickerProfile-camera-settings" class="headerlink" title="PickerProfile (camera settings)"></a><code>PickerProfile</code> (camera settings)</h4><table>
<thead>
<tr>
<th align="left">Name</th>
<th align="left">Type</th>
<th align="left">Required</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody><tr>
<td align="left">cameraPosition</td>
<td align="left"><a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references-V5/js-apis-camera-V5#cameraposition">camera.CameraPosition</a></td>
<td align="left">Yes</td>
<td align="left">Front&#x2F;back camera.</td>
</tr>
<tr>
<td align="left">saveUri</td>
<td align="left">string</td>
<td align="left">No</td>
<td align="left">URI to save captured media.</td>
</tr>
<tr>
<td align="left">videoDuration</td>
<td align="left">number</td>
<td align="left">No</td>
<td align="left">Max video recording duration.</td>
</tr>
</tbody></table>
<h4 id="PickerResult-capture-result"><a href="#PickerResult-capture-result" class="headerlink" title="PickerResult (capture result)"></a><code>PickerResult</code> (capture result)</h4><table>
<thead>
<tr>
<th align="left">Name</th>
<th align="left">Type</th>
<th align="left">Required</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody><tr>
<td align="left">resultCode</td>
<td align="left">number</td>
<td align="left">Yes</td>
<td align="left">0 for success, -1 for failure.</td>
</tr>
<tr>
<td align="left">resultUri</td>
<td align="left">string</td>
<td align="left">Yes</td>
<td align="left">Captured media URI (public path if saveUri is empty; same as saveUri if writable).</td>
</tr>
<tr>
<td align="left">mediaType</td>
<td align="left"><a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references-V5/js-apis-camerapicker-V5#pickermediatype">PickerMediaType</a></td>
<td align="left">Yes</td>
<td align="left">Media type (photo&#x2F;video).</td>
</tr>
</tbody></table>
<h2 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h2><p>This article introduces image&#x2F;video selection and capture capabilities in HarmonyOS Next, focusing on permission-free implementations via <code>photoAccessHelper</code> and <code>cameraPicker</code>.  </p>
<h2 id="Reference-Resources"><a href="#Reference-Resources" class="headerlink" title="Reference Resources"></a>Reference Resources</h2><ul>
<li><a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/permissions-for-all-V5">Permissions for All Apps</a>  </li>
<li><a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/restricted-permissions-V5">Restricted Permissions</a>  </li>
<li><a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/permissions-for-mdm-apps-V5">Permissions for MDM Apps</a>  </li>
<li><a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/system-app-startup-V5">Launching System Apps</a>  </li>
<li><a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references-V5/js-apis-image-V5#readpixelstobuffersync12">@ohos.multimedia.image (Image Processing)</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://harmonyostech.github.io/2025/06/30/C-Mastering-the-HarmonyOS-Next-Signature-Verification-Mechanism/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Qingkouwei">
      <meta itemprop="description" content="Welcome to the HarmonyOS NEXT Knowledge Charging Station!  This is a hub for knowledge about HarmonyOS Next`s new-generation system. With its self-developed kernel, HarmonyOS NEXT achieves native smoothness, security, intelligence, and interconnectivity. We deeply analyze how its new distributed soft bus revolutionizes device connectivity experiences and explain the principles behind the enhanced perception and reasoning capabilities of the Xiaoyi intelligent agent based on the Pangu large model. Whether you are a developer exploring application development or an ordinary user eager to understand system features, you can "recharge" here and quickly grasp the essence of HarmonyOS NEXT.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HarmonyOS NEXT Knowledge Charging Station">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/06/30/C-Mastering-the-HarmonyOS-Next-Signature-Verification-Mechanism/" class="post-title-link" itemprop="url">Mastering the HarmonyOS Next Signature Verification Mechanism</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2025-06-30 22:08:03" itemprop="dateCreated datePublished" datetime="2025-06-30T22:08:03+08:00">2025-06-30</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-07-13 09:57:51" itemprop="dateModified" datetime="2025-07-13T09:57:51+08:00">2025-07-13</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/HarmonyOS-Next-Tech/" itemprop="url" rel="index"><span itemprop="name">HarmonyOS Next Tech</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Mastering-the-HarmonyOS-Next-Signature-Verification-Mechanism"><a href="#Mastering-the-HarmonyOS-Next-Signature-Verification-Mechanism" class="headerlink" title="Mastering the HarmonyOS Next Signature Verification Mechanism"></a>Mastering the HarmonyOS Next Signature Verification Mechanism</h1><h2 id="Background-Introduction"><a href="#Background-Introduction" class="headerlink" title="Background Introduction"></a>Background Introduction</h2><p>Android app signing requires only one signature file. In the development environment, we use a debug signature by default. The debug signature alias is <code>androiddebugkey</code>, with the password <code>android</code>. The debug certificate is stored in the <code>.android</code> folder under the user directory, typically named <code>debug.keystore</code>, and doesn’t require special configuration in <code>build.gradle</code>.  </p>
<p>HarmonyOS Next adopts a signing mechanism similar to iOS. Signing configuration information for the project is stored in the project-level <code>build-profile.json5</code>. When using automatic signing, the locally generated signing configuration path is automatically updated in <code>build-profile.json5</code>. This creates an issue: since each person’s signing path differs, <code>build-profile.json5</code> cannot be configured to be ignored by Git nor maintained consistently in multi-person collaboration.  </p>
<p>Before Develop Beta6, we could create a <code>sign</code> folder in the project, use my account to generate signing files automatically, copy them to the <code>sign</code> folder, and allow others to use my signature for development and debugging. However, starting from Develop Beta6, sharing automatically generated signatures causes real-device installation failures:  </p>
<pre><code>09/06 18:10:04:702: $ hdc shell bm install -p data/local/tmp/140f0b9059b04d8286941346c79d8f7b  in 304 ms
Install Failed: error: failed to install bundle.
code:9568322
error: signature verification failed due to not trusted app source.
View detailed instructions.
09/06 18:10:04:791: $ hdc shell rm -rf data/local/tmp/140f0b9059b04d8286941346c79d8f7b
09/06 18:10:04:792: Launch com.qingkouwei.demo failed, starting handle failure progress
Error while Deploy Hap
</code></pre>
<p>As the HarmonyOS system stabilizes through iterations, system security has been strengthened. During installation, the system now verifies whether the UDID in the signature matches the device UDID. This necessitates continuing with automatic signing and finding a thorough solution.  </p>
<h2 id="HarmonyOS-Signing-Mechanism"><a href="#HarmonyOS-Signing-Mechanism" class="headerlink" title="HarmonyOS Signing Mechanism"></a>HarmonyOS Signing Mechanism</h2><p>To solve this problem, we must understand the signing principles. Let’s first look at the files generated by automatic signing:  </p>
<ul>
<li><code>.p12</code>: Key file. The P12 certificate (PKCS#12, Public-Key Cryptography Standards #12) is an encryption standard for exchanging digital certificates. It describes personal identity information, includes public and private keys for asymmetric encryption, and is stored in a keystore file. The key pair is used for digital signatures and verification.  </li>
<li><code>.csr</code>: Certificate Signing Request file, containing the public key in the key pair, public name, organization name, organizational unit, etc., used to apply for a digital certificate from AppGallery Connect.  </li>
<li><code>.cer</code>: Digital certificate issued by Huawei AppGallery Connect.  </li>
<li><code>.p7b</code>: Profile file, containing the package name of the HarmonyOS app&#x2F;service, digital certificate information, a list of certificate permissions the app&#x2F;service is allowed to apply for, and a list of devices allowed for debugging (if the app&#x2F;service type is Release, the device list is empty). Each app&#x2F;service package must include a Profile file.  </li>
<li><code>material</code> folder: Stores signing scheme-related materials, such as passwords and certificates.</li>
</ul>
<p>The P12 and CSR files are generated locally and used to upload to the AppGallery Connect platform to apply for certificates and P7B files. The role of the <code>material</code> folder is introduced later.  </p>
<h3 id="Role-of-the-Key"><a href="#Role-of-the-Key" class="headerlink" title="Role of the Key"></a>Role of the Key</h3><p>The P12 file contains public and private keys for asymmetric encryption (典型算法如RSA), where encryption and decryption keys differ. Typical uses include:  </p>
<ul>
<li><strong>Confidentiality</strong>: Encrypt plaintext with the recipient’s public key and transmit it. The ciphertext can only be decrypted with the recipient’s private key, ensuring transmission confidentiality even if intercepted.  </li>
<li><strong>Identity Verification and Tamper Prevention (Signing)</strong>: Encrypt a message with the sender’s private key to sign it. The signed message can only be decrypted with the sender’s public key, ensuring authenticity (the message indeed belongs to the sender). If the ciphertext is intercepted, modified, and resent, it cannot be decrypted, ensuring message integrity. Thus, signing ensures message authenticity and integrity.</li>
</ul>
<h3 id="Role-of-the-Digital-Certificate"><a href="#Role-of-the-Digital-Certificate" class="headerlink" title="Role of the Digital Certificate"></a>Role of the Digital Certificate</h3><p>Asymmetric encryption algorithms are time-consuming for encrypting long plaintexts. In practice, the message is first hashed using a digest algorithm (e.g., MD5, SHA), the digest is encrypted, and the plaintext, encrypted digest, and public key are sent together. The recipient decrypts the digest ciphertext, hashes the plaintext, and compares the digests to verify integrity. This is a digital signature.  </p>
<p>What is a certificate? Consider a communication fraud scenario: A intends to deceive B by sending a forged message pretending to be from C. A encrypts the file with their private key, sends it with their public key, and claims the public key belongs to C. How does B verify the public key’s ownership? This is where certificates play a role—like a network ID card proving the holder’s identity.  </p>
<p>A digital certificate is issued by a CA (Certificate Authority) and contains the holder’s information and public key. Like a notarized document, it gains validity through CA authentication. B can verify the message sender by querying the CA with the digital certificate, confirming whether the public key belongs to A or C—similar to checking an ID card.  </p>
<h2 id="Using-AppGallery-Connect-Platform-Debug-Certificates"><a href="#Using-AppGallery-Connect-Platform-Debug-Certificates" class="headerlink" title="Using AppGallery Connect Platform Debug Certificates"></a>Using AppGallery Connect Platform Debug Certificates</h2><p>The AppGallery Connect platform provides debug certificates. We can generate local keys, create debug certificates on the platform, place them in the app project’s <code>sign</code> folder, configure a unified signing file, and add other developers’ device IDs to the debug Profile. Here’s how to generate debug certificates:  </p>
<h3 id="Generating-a-P12-Key"><a href="#Generating-a-P12-Key" class="headerlink" title="Generating a P12 Key"></a>Generating a P12 Key</h3><p>DevEco Studio provides a tool to generate P12 keys. In the main menu, click <strong>Build &gt; Generate Key and CSR</strong>:  </p>
<p><img src="/../images/HarmonyOS%20Next%20%E4%B8%80%E6%96%87%E6%90%9E%E6%87%82%E7%AD%BE%E5%90%8D%E9%AA%8C%E8%AF%81%E6%9C%BA%E5%88%B6.png"></p>
<p>Key generation configuration:<br><img src="/../images/HarmonyOS%20Next%20%E4%B8%80%E6%96%87%E6%90%9E%E6%87%82%E7%AD%BE%E5%90%8D%E9%AA%8C%E8%AF%81%E6%9C%BA%E5%88%B6-1.png"></p>
<p>For “Key store file,” select the path and filename for the key file (ending with <code>.p12</code>):<br><img src="/../images/HarmonyOS%20Next%20%E4%B8%80%E6%96%87%E6%90%9E%E6%87%82%E7%AD%BE%E5%90%8D%E9%AA%8C%E8%AF%81%E6%9C%BA%E5%88%B6-2.png"><br><img src="/../images/HarmonyOS%20Next%20%E4%B8%80%E6%96%87%E6%90%9E%E6%87%82%E7%AD%BE%E5%90%8D%E9%AA%8C%E8%AF%81%E6%9C%BA%E5%88%B6-3.png"></p>
<p>Next, select the CSR file path:<br><img src="/../images/HarmonyOS%20Next%20%E4%B8%80%E6%96%87%E6%90%9E%E6%87%82%E7%AD%BE%E5%90%8D%E9%AA%8C%E8%AF%81%E6%9C%BA%E5%88%B6-4.png"></p>
<p>Upon completion, you will obtain:  </p>
<ul>
<li><code>qingkouwei.csr</code>  </li>
<li><code>qingkouwei.p12</code>  </li>
<li><code>material</code> folder</li>
</ul>
<h3 id="Applying-for-a-Debug-Certificate-and-Debug-Profile"><a href="#Applying-for-a-Debug-Certificate-and-Debug-Profile" class="headerlink" title="Applying for a Debug Certificate and Debug Profile"></a>Applying for a Debug Certificate and Debug Profile</h3><p>A certificate is a digital certificate configuring signing information for a HarmonyOS app&#x2F;meta-service, ensuring code integrity and publisher identity. In <code>.cer</code> format, it contains public keys, certificate fingerprints, etc. For applying for a debug certificate, refer to: <a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/cn/doc/app/agc-help-add-debugcert-0000001914263178">Apply for a Debug Certificate</a>  </p>
<p>The Profile (<code>.p7b</code> format) contains the package name, digital certificate information, allowed certificate permissions, and debug device list (empty for Release-type apps&#x2F;services). Each app&#x2F;meta-service must include a Profile. For applying for a debug Profile, refer to: <a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/cn/doc/app/agc-help-add-debugprofile-0000001914423102">Apply for a Debug Profile</a>  </p>
<p>Copy the downloaded <code>.p7b</code> and <code>.cer</code> files to the <code>sign</code> folder and configure signing information in <code>build-profile.json</code>:<br><img src="/../images/HarmonyOS%20Next%20%E4%B8%80%E6%96%87%E6%90%9E%E6%87%82%E7%AD%BE%E5%90%8D%E9%AA%8C%E8%AF%81%E6%9C%BA%E5%88%B6-5.png"></p>
<p>Note: The <code>storePassword</code> is not the password used when generating the signature. How to obtain it? Configure signing information via the project tool’s signing tool, which will automatically retrieve <code>storePassword</code>—this is the role of the <code>material</code> folder mentioned in signing.  </p>
<p>Note: To generate a signature, first create an APPID on the AppGallery Connect platform:<br><img src="/../images/HarmonyOS%20Next%20%E4%B8%80%E6%96%87%E6%90%9E%E6%87%82%E7%AD%BE%E5%90%8D%E9%AA%8C%E8%AF%81%E6%9C%BA%E5%88%B6-6.png"></p>
<p>Additional considerations:  </p>
<ol>
<li>Before using automatic signing, ensure the local system time matches Beijing Time (UTC&#x2F;GMT +8.00); otherwise, signing will fail.  </li>
<li>Each account can apply for up to two debug certificates. Automatic signing consumes debug certificate quotas. If two debug certificates already exist on AppGallery Connect, subsequent automatic signing for the account will fail.  </li>
<li>A certificate is “active” upon successful application. If its status becomes “invalid” or “revoked,” it is no longer usable, and all Profiles applied for with this certificate will also become invalid or revoked. You need to reapply for certificates and Profiles. Revoked certificates cannot be recovered, so proceed with caution.  </li>
<li>An app can apply for up to 100 Profile files.  </li>
<li>Modifying debug devices generates a new debug Profile; download it after it takes effect.  </li>
<li>If a Profile’s status becomes “invalid” or “revoked,” it is no longer usable; reapply for a Profile.  </li>
<li>Obtain the device UDID using the command <code>hdc shell bm get --udid</code>.</li>
</ol>
<p>If an account has already created two debug certificates, using it for automatic signing will fail with the following error:<br>![[HarmonyOS Next 调试签名最佳实践.png]]<br><img src="/../images/HarmonyOS%20Next%20%E8%B0%83%E8%AF%95%E7%AD%BE%E5%90%8D%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5.png"></p>
<h2 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h2><p>This article introduces the HarmonyOS signing mechanism and how to handle signing conflict management in collaborative development.  </p>
<h2 id="Reference-Documents"><a href="#Reference-Documents" class="headerlink" title="Reference Documents"></a>Reference Documents</h2><ol>
<li><a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/ide-signing-V5#section462703710326">App&#x2F;Service Signing</a>  </li>
<li><a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/cn/doc/app/agc-help-add-debugcert-0000001914263178">Apply for a Debug Certificate</a>  </li>
<li><a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/cn/doc/app/agc-help-add-debugprofile-0000001914423102">Apply for a Debug Profile</a>  </li>
<li><a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/cn/doc/app/agc-help-add-device-0000001946142249#section67331926102911">Register Debug Devices</a></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/37/">37</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Qingkouwei</p>
  <div class="site-description" itemprop="description">Welcome to the HarmonyOS NEXT Knowledge Charging Station!  This is a hub for knowledge about HarmonyOS Next`s new-generation system. With its self-developed kernel, HarmonyOS NEXT achieves native smoothness, security, intelligence, and interconnectivity. We deeply analyze how its new distributed soft bus revolutionizes device connectivity experiences and explain the principles behind the enhanced perception and reasoning capabilities of the Xiaoyi intelligent agent based on the Pangu large model. Whether you are a developer exploring application development or an ordinary user eager to understand system features, you can "recharge" here and quickly grasp the essence of HarmonyOS NEXT.</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">364</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">5</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">1</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Qingkouwei</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
