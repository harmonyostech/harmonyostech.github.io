<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"harmonyostech.github.io","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="HarmonyOS Next IM Combat: Sharing the Optimization Process for Slow Database Queries1. Background IntroductionIn the development of IMSDK, the client uses a relational database to store data such as c">
<meta property="og:type" content="article">
<meta property="og:title" content="HarmonyOS Next IM Combat: Sharing the Optimization Process for Slow Database Queries">
<meta property="og:url" content="https://harmonyostech.github.io/2025/06/24/HarmonyOS%20Next%20IM%20Combat:%20Sharing%20the%20Optimization%20Process%20for%20Slow%20Database%20Queries/index.html">
<meta property="og:site_name" content="HarmonyOS NEXT Knowledge Charging Station">
<meta property="og:description" content="HarmonyOS Next IM Combat: Sharing the Optimization Process for Slow Database Queries1. Background IntroductionIn the development of IMSDK, the client uses a relational database to store data such as c">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2025-06-24T06:09:32.000Z">
<meta property="article:modified_time" content="2025-06-24T07:03:00.831Z">
<meta property="article:author" content="Qingkouwei">
<meta property="article:tag" content="HarmonyOS Next">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://harmonyostech.github.io/2025/06/24/HarmonyOS%20Next%20IM%20Combat:%20Sharing%20the%20Optimization%20Process%20for%20Slow%20Database%20Queries/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>HarmonyOS Next IM Combat: Sharing the Optimization Process for Slow Database Queries | HarmonyOS NEXT Knowledge Charging Station</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">HarmonyOS NEXT Knowledge Charging Station</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">Analysis of Core Technologies and Application Scenarios of HarmonyOS NEXT</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://harmonyostech.github.io/2025/06/24/HarmonyOS%20Next%20IM%20Combat:%20Sharing%20the%20Optimization%20Process%20for%20Slow%20Database%20Queries/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Qingkouwei">
      <meta itemprop="description" content="Welcome to the HarmonyOS NEXT Knowledge Charging Station!  This is a hub for knowledge about HarmonyOS Next`s new-generation system. With its self-developed kernel, HarmonyOS NEXT achieves native smoothness, security, intelligence, and interconnectivity. We deeply analyze how its new distributed soft bus revolutionizes device connectivity experiences and explain the principles behind the enhanced perception and reasoning capabilities of the Xiaoyi intelligent agent based on the Pangu large model. Whether you are a developer exploring application development or an ordinary user eager to understand system features, you can "recharge" here and quickly grasp the essence of HarmonyOS NEXT.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HarmonyOS NEXT Knowledge Charging Station">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          HarmonyOS Next IM Combat: Sharing the Optimization Process for Slow Database Queries
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2025-06-24 14:09:32 / Modified: 15:03:00" itemprop="dateCreated datePublished" datetime="2025-06-24T14:09:32+08:00">2025-06-24</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="HarmonyOS-Next-IM-Combat-Sharing-the-Optimization-Process-for-Slow-Database-Queries"><a href="#HarmonyOS-Next-IM-Combat-Sharing-the-Optimization-Process-for-Slow-Database-Queries" class="headerlink" title="HarmonyOS Next IM Combat: Sharing the Optimization Process for Slow Database Queries"></a>HarmonyOS Next IM Combat: Sharing the Optimization Process for Slow Database Queries</h1><h4 id="1-Background-Introduction"><a href="#1-Background-Introduction" class="headerlink" title="1. Background Introduction"></a>1. Background Introduction</h4><p>In the development of IMSDK, the client uses a relational database to store data such as conversations, users, and messages. Initially, when developing consumer (C-end) applications, no issues were found. However, this year, when business (B-end) users started using the application, they reported lags and message delays. Through troubleshooting, it was found that B-end users have more conversations and messages, leading to slower database queries. Since previous operations were all performed on the main thread, this caused application lags and delays. This article shares the problems encountered during the entire optimization process, problem-solving approaches, and final effects.  </p>
<h4 id="2-Introduction-to-HarmonyOS-Next-Relational-Database"><a href="#2-Introduction-to-HarmonyOS-Next-Relational-Database" class="headerlink" title="2. Introduction to HarmonyOS Next Relational Database"></a>2. Introduction to HarmonyOS Next Relational Database</h4><p>The HarmonyOS Next relational database is based on the SQLite component, suitable for scenarios requiring storage of data with complex relationships. For example, a user’s conversation information needs to include the conversation name, type, ID, etc., while chat information in conversations needs to include message IDs, types, contents, etc. Due to the strong correspondence between data elements—with complexity higher than key-value data—a relational database is required for persistent storage.  </p>
<p>The relational database provides universal operation interfaces for applications, using SQLite as the underlying persistent storage engine. It supports database features of SQLite, including but not limited to transactions, indexes, views, triggers, foreign keys, parameterized queries, and precompiled SQL statements.  </p>
<p>To implement data persistence using a relational database, a RdbStore must be obtained, which includes operations such as database creation, table creation, and version upgrades&#x2F;downgrades. Sample code is as follows:  </p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; relationalStore &#125; <span class="keyword">from</span> <span class="string">&#x27;@kit.ArkData&#x27;</span>; <span class="comment">// Import the module</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">UIAbility</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@kit.AbilityKit&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">BusinessError</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@kit.BasicServicesKit&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="variable language_">window</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@kit.ArkUI&#x27;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// This example is implemented in an Ability, but users can also use it in other reasonable scenarios</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">EntryAbility</span> <span class="keyword">extends</span> <span class="title class_ inherited__">UIAbility</span> &#123;</span><br><span class="line">  <span class="title function_">onWindowStageCreate</span>(<span class="params"><span class="attr">windowStage</span>: <span class="variable language_">window</span>.<span class="title class_">WindowStage</span></span>) &#123;</span><br><span class="line">    <span class="comment">// If a tokenizer is desired, call isStorageTypeSupported to check if the desired tokenizer is supported on the current platform.</span></span><br><span class="line">    <span class="keyword">let</span> tokenType = relationalStore.<span class="property">Tokenizer</span>.<span class="property">ICU_TOKENIZER</span>;</span><br><span class="line">    <span class="keyword">let</span> tokenTypeSupported = relationalStore.<span class="title function_">isTokenizerSupported</span>(tokenType);</span><br><span class="line">    <span class="keyword">if</span> (!tokenTypeSupported) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">`ICU_TOKENIZER is not supported on this platform.`</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> <span class="attr">STORE_CONFIG</span>: relationalStore.<span class="property">StoreConfig</span> = &#123;</span><br><span class="line">      <span class="attr">name</span>: <span class="string">&#x27;RdbTest.db&#x27;</span>, <span class="comment">// Database file name</span></span><br><span class="line">      <span class="attr">securityLevel</span>: relationalStore.<span class="property">SecurityLevel</span>.<span class="property">S3</span>, <span class="comment">// Database security level</span></span><br><span class="line">      <span class="attr">encrypt</span>: <span class="literal">false</span>, <span class="comment">// Optional parameter to specify if the database is encrypted (default: not encrypted)</span></span><br><span class="line">      <span class="attr">customDir</span>: <span class="string">&#x27;customDir/subCustomDir&#x27;</span>, <span class="comment">// Optional parameter for the database custom path. The database will be created in the directory structure: context.databaseDir + &#x27;/rdb/&#x27; + customDir, where context.databaseDir is the app sandbox path, &#x27;/rdb/&#x27; indicates a relational database, and customDir is the custom path. If this parameter is not provided, the RdbStore instance is created in the app sandbox directory by default.</span></span><br><span class="line">      <span class="attr">isReadOnly</span>: <span class="literal">false</span>, <span class="comment">// Optional parameter to specify if the database is opened in read-only mode (default: false, readable and writable). When true, only data reading is allowed; write operations will return error code 801.</span></span><br><span class="line">      <span class="attr">tokenizer</span>: tokenType <span class="comment">// Optional parameter to specify the tokenizer used in full-text search (FTS) scenarios. If not provided, only English tokenization is supported in FTS, not other languages.</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Determine the database version and perform upgrade/downgrade operations if it does not match</span></span><br><span class="line">    <span class="comment">// Assume the current database version is 3, with table structure: EMPLOYEE (NAME, AGE, SALARY, CODES, IDENTITY)</span></span><br><span class="line">    <span class="keyword">const</span> <span class="variable constant_">SQL_CREATE_TABLE</span> = <span class="string">&#x27;CREATE TABLE IF NOT EXISTS EMPLOYEE (ID INTEGER PRIMARY KEY AUTOINCREMENT, NAME TEXT NOT NULL, AGE INTEGER, SALARY REAL, CODES BLOB, IDENTITY UNLIMITED INT)&#x27;</span>; <span class="comment">// Table creation SQL statement, where IDENTITY is a bigint type specified as UNLIMITED INT in SQL</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    relationalStore.<span class="title function_">getRdbStore</span>(<span class="variable language_">this</span>.<span class="property">context</span>, <span class="variable constant_">STORE_CONFIG</span>, <span class="function">(<span class="params">err, store</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (err) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">`Failed to get RdbStore. Code:<span class="subst">$&#123;err.code&#125;</span>, message:<span class="subst">$&#123;err.message&#125;</span>`</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">info</span>(<span class="string">&#x27;Succeeded in getting RdbStore.&#x27;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">      <span class="comment">// When the database is created, the default version is 0</span></span><br><span class="line">      <span class="keyword">if</span> (store.<span class="property">version</span> === <span class="number">0</span>) &#123;</span><br><span class="line">        store.<span class="title function_">executeSql</span>(<span class="variable constant_">SQL_CREATE_TABLE</span>) <span class="comment">// Create the data table for subsequent insert operations</span></span><br><span class="line">          .<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">            <span class="comment">// Set the database version to an integer greater than 0</span></span><br><span class="line">            store.<span class="property">version</span> = <span class="number">3</span>;</span><br><span class="line">          &#125;)</span><br><span class="line">          .<span class="title function_">catch</span>(<span class="function">(<span class="params"><span class="attr">err</span>: <span class="title class_">BusinessError</span></span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">`Failed to executeSql. Code:<span class="subst">$&#123;err.code&#125;</span>, message:<span class="subst">$&#123;err.message&#125;</span>`</span>);</span><br><span class="line">          &#125;);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">      <span class="comment">// If the database version is not 0 and does not match the current version, upgrade/downgrade operations are required</span></span><br><span class="line">      <span class="comment">// When the database exists and is assumed to be version 1 (e.g., the app upgrades to the current version, requiring the database to upgrade from version 1 to 2)</span></span><br><span class="line">      <span class="keyword">if</span> (store.<span class="property">version</span> === <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">// version = 1: Table structure: EMPLOYEE (NAME, SALARY, CODES, ADDRESS) =&gt; version = 2: Table structure: EMPLOYEE (NAME, AGE, SALARY, CODES, ADDRESS)</span></span><br><span class="line">        store.<span class="title function_">executeSql</span>(<span class="string">&#x27;ALTER TABLE EMPLOYEE ADD COLUMN AGE INTEGER&#x27;</span>)</span><br><span class="line">          .<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">            store.<span class="property">version</span> = <span class="number">2</span>;</span><br><span class="line">          &#125;).<span class="title function_">catch</span>(<span class="function">(<span class="params"><span class="attr">err</span>: <span class="title class_">BusinessError</span></span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">`Failed to executeSql. Code:<span class="subst">$&#123;err.code&#125;</span>, message:<span class="subst">$&#123;err.message&#125;</span>`</span>);</span><br><span class="line">          &#125;);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">      <span class="comment">// When the database exists and is assumed to be version 2 (e.g., the app upgrades to the current version, requiring the database to upgrade from version 2 to 3)</span></span><br><span class="line">      <span class="keyword">if</span> (store.<span class="property">version</span> === <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="comment">// version = 2: Table structure: EMPLOYEE (NAME, AGE, SALARY, CODES, ADDRESS) =&gt; version = 3: Table structure: EMPLOYEE (NAME, AGE, SALARY, CODES)</span></span><br><span class="line">        store.<span class="title function_">executeSql</span>(<span class="string">&#x27;ALTER TABLE EMPLOYEE DROP COLUMN ADDRESS&#x27;</span>)</span><br><span class="line">          .<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">            store.<span class="property">version</span> = <span class="number">3</span>;</span><br><span class="line">          &#125;).<span class="title function_">catch</span>(<span class="function">(<span class="params"><span class="attr">err</span>: <span class="title class_">BusinessError</span></span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">`Failed to executeSql. Code:<span class="subst">$&#123;err.code&#125;</span>, message:<span class="subst">$&#123;err.message&#125;</span>`</span>);</span><br><span class="line">          &#125;);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// Ensure that after obtaining the RdbStore instance and completing data table creation, perform database operations such as insert, delete, update, and query</span></span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="string">``</span><span class="string">`  </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">HarmonyOS Next provides `</span>relationalStore<span class="string">` for database operations, but in CRUD (Create, Read, Update, Delete) operations, we generally implement a layer of encapsulation to convert database result sets to actual objects.  </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#### 3. Introduction to ORM Frameworks  </span></span><br><span class="line"><span class="string">HarmonyOS Next provides the `</span>dataORM<span class="string">` library for data relationship mapping. `</span>dataORM<span class="string">` is a lightweight ORM (Object-Relational Mapping) library that simplifies local database operations, offering high database access performance and low memory consumption. It supports features such as multi-threading, chain calls, backup, upgrade, caching, etc. Designed to be lightweight, fast, and easy to use, it helps developers quickly build high-performance applications. However, `</span>dataORM<span class="string">` has some limitations (e.g., no support for composite primary keys in database tables), and the official maintenance of this library has been discontinued.  </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Later, ByteDance open-sourced `</span>rdbStore<span class="string">`, which performs database operations in the form of DTO (Data Transfer Object) objects. It encapsulates capabilities such as database creation and automatic upgrade, database predicate construction, query result deserialization, and quality optimization, enabling simple and efficient database operations. In terms of operation and maintenance, it features comprehensive unit testing, quality data tracking and reporting, full-link logging, etc. Due to issues encountered in database upgrades, we switched to `</span>rdbStore<span class="string">` for data relationship mapping.  </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#### 4. Multi-Threading Optimization  </span></span><br><span class="line"><span class="string">In scenarios with large data volumes, querying data may cause long processing times or even application freezes. General recommendations include:  </span></span><br><span class="line"><span class="string">- Limit single query data volume to no more than 5,000 records.  </span></span><br><span class="line"><span class="string">- Perform queries in a TaskPool.  </span></span><br><span class="line"><span class="string">- Keep SQL statement concatenation concise.  </span></span><br><span class="line"><span class="string">- Implement reasonable batch querying.  </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">When the number of user conversations reached a certain level, due to a join query involving 50 columns after expansion, the query took 6-7 seconds, causing severe application lags and even freeze exceptions. Therefore, complex and time-consuming queries were moved to child threads.  </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">`</span><span class="string">``</span>ts</span><br><span class="line"><span class="meta">@Concurrent</span>  </span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getConvDetailObservableThread</span>(<span class="params"><span class="attr">context</span>: <span class="title class_">Context</span>, <span class="attr">param</span>: <span class="title class_">Param</span>, <span class="attr">convId</span>: <span class="built_in">number</span></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">ConvBean</span> | <span class="literal">undefined</span>&gt; &#123;  </span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;ConvImpl&#x27;</span>, <span class="string">&quot;getConvDetailObservableThread,convId=&quot;</span> + convId);  </span><br><span class="line">  <span class="comment">// Store parameters, context, etc., in the thread</span></span><br><span class="line">  <span class="keyword">await</span> <span class="title class_">DBManager</span>.<span class="title function_">getInstance</span>().<span class="title function_">initDB</span>();  </span><br><span class="line">  <span class="keyword">const</span> conv = <span class="keyword">await</span> <span class="title class_">DBManager</span>.<span class="title function_">getInstance</span>()  </span><br><span class="line">    .<span class="title function_">getConvDaoHelper</span>()  </span><br><span class="line">    .<span class="title function_">getConvById</span>(convId);  </span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> result = <span class="keyword">await</span> taskpool.<span class="title function_">execute</span>(getConvDetailObservableThread,  </span><br><span class="line">  context,</span><br><span class="line">  param,</span><br><span class="line">  convId);</span><br></pre></td></tr></table></figure>


<p>By default, data transfer between threads uses a copy method. For ultimate performance, it can be changed to the <code>Sendable</code> method.  </p>
<h4 id="5-Optimization-for-Slow-Data-Queries"><a href="#5-Optimization-for-Slow-Data-Queries" class="headerlink" title="5. Optimization for Slow Data Queries"></a>5. Optimization for Slow Data Queries</h4><p>Although the lag was basically resolved after the above optimizations, the issue of long query times persisted. The first entry into the conversation list took 7-8 seconds, resulting in poor user experience. Additionally, a strange phenomenon occurred: the Mac version simulator took tens of milliseconds, while real devices took 6-7 seconds.  </p>
<p>Analyzing the query process step by step, since it involved a join query, using <code>relationalStore</code> interfaces for direct query execution was fast, but the process of <code>resultSet.goToNextRow()</code> in the result set was time-consuming.  </p>
<p>Initially, traversal read data row by column: <code>resultSet.getLong(resultSet.getColumnIndex(&#39;unreadMsgCount&#39;));</code>. The official API12 provided the <code>getRow</code> interface, which can read an entire column at once. After switching to the <code>getRow</code> method, the query time was optimized from 7-8 seconds to 700-800 milliseconds—ten times faster.  </p>
<p>In API18, a new <code>getRows</code> interface was added, which can read all specified rows directly, yielding even better results.  </p>
<h3 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h3><p>This article focuses on the optimization process for database query lags caused by large conversation and message data volumes among B-end users in IMSDK development based on HarmonyOS Next. It first introduces the SQLite-based features of the HarmonyOS Next relational database, including transactions, indexes, and other functions, as well as the usage of RdbStore. It then compares two ORM frameworks, <code>dataORM</code> and <code>rdbStore</code>, and switches to the more efficient <code>rdbStore</code> due to <code>dataORM</code> being discontinued and upgrade-related issues.  </p>
<p>In terms of performance optimization, a multi-threading solution moves complex queries to child threads to avoid main thread blocking, while adhering to principles such as limiting single query data to under 5,000 records and concise SQL concatenation. For query latency issues, analysis revealed low result set traversal efficiency, which was improved by using HarmonyOS-provided new interfaces like <code>getRow</code> and <code>getRows</code>, reducing query time from 7-8 seconds to 700-800 milliseconds and significantly enhancing data reading efficiency. This optimization not only resolves application lags and message delays but also provides referable practical experience for database operations in large data volume scenarios on the HarmonyOS platform.</p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/HarmonyOS-Next/" rel="tag"># HarmonyOS Next</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2025/06/08/HarmonyOS-Next-IM-Practical-Combat-Handling-So-Dynamic-Library-Crash-Issues-Caused-by-Worker-Threads/" rel="prev" title="HarmonyOS Next IM Practical Combat: Handling So Dynamic Library Crash Issues Caused by Worker Threads">
      <i class="fa fa-chevron-left"></i> HarmonyOS Next IM Practical Combat: Handling So Dynamic Library Crash Issues Caused by Worker Threads
    </a></div>
      <div class="post-nav-item">
    <a href="/2025/06/24/HarmonyOS%20Next%20IM%20Combat:%20Functional%20Anomaly%20of%20Event%20Cancellation%20Caused%20by%20Dual%20Navigation%20Lifecycles/" rel="next" title="HarmonyOS Next IM Combat: Functional Anomaly of Event Cancellation Caused by Dual Navigation Lifecycles">
      HarmonyOS Next IM Combat: Functional Anomaly of Event Cancellation Caused by Dual Navigation Lifecycles <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#HarmonyOS-Next-IM-Combat-Sharing-the-Optimization-Process-for-Slow-Database-Queries"><span class="nav-number">1.</span> <span class="nav-text">HarmonyOS Next IM Combat: Sharing the Optimization Process for Slow Database Queries</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-Background-Introduction"><span class="nav-number">1.0.0.1.</span> <span class="nav-text">1. Background Introduction</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-Introduction-to-HarmonyOS-Next-Relational-Database"><span class="nav-number">1.0.0.2.</span> <span class="nav-text">2. Introduction to HarmonyOS Next Relational Database</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-Optimization-for-Slow-Data-Queries"><span class="nav-number">1.0.0.3.</span> <span class="nav-text">5. Optimization for Slow Data Queries</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Summary"><span class="nav-number">1.0.1.</span> <span class="nav-text">Summary</span></a></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Qingkouwei</p>
  <div class="site-description" itemprop="description">Welcome to the HarmonyOS NEXT Knowledge Charging Station!  This is a hub for knowledge about HarmonyOS Next`s new-generation system. With its self-developed kernel, HarmonyOS NEXT achieves native smoothness, security, intelligence, and interconnectivity. We deeply analyze how its new distributed soft bus revolutionizes device connectivity experiences and explain the principles behind the enhanced perception and reasoning capabilities of the Xiaoyi intelligent agent based on the Pangu large model. Whether you are a developer exploring application development or an ordinary user eager to understand system features, you can "recharge" here and quickly grasp the essence of HarmonyOS NEXT.</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">300</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">3</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">1</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Qingkouwei</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
