<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"harmonyostech.github.io","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="HarmonyOS Audio-Video: Lame MP3 Encoding ImplementationBackgroundMP3 is a widely used audio compression format, renowned for its efficient compression algorithm and broad compatibility. It is one of t">
<meta property="og:type" content="article">
<meta property="og:title" content="HarmonyOS Audio-Video: Lame MP3 Encoding Implementation">
<meta property="og:url" content="https://harmonyostech.github.io/2025/06/30/C-HarmonyOS-Audio-Video-Lame-MP3-Encoding-Implementation/index.html">
<meta property="og:site_name" content="HarmonyOS NEXT Knowledge Charging Station">
<meta property="og:description" content="HarmonyOS Audio-Video: Lame MP3 Encoding ImplementationBackgroundMP3 is a widely used audio compression format, renowned for its efficient compression algorithm and broad compatibility. It is one of t">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://harmonyostech.github.io/images/HarmonyOS%20%E9%9F%B3%E8%A7%86%E9%A2%91%E4%B9%8BLame%20MP3%E7%BC%96%E7%A0%81%E5%AE%9E%E7%8E%B0.png">
<meta property="og:image" content="https://harmonyostech.github.io/images/HarmonyOS%20%E9%9F%B3%E8%A7%86%E9%A2%91%E4%B9%8BLame%20MP3%E7%BC%96%E7%A0%81%E5%AE%9E%E7%8E%B0-1.png">
<meta property="og:image" content="https://harmonyostech.github.io/images/HarmonyOS%20%E9%9F%B3%E8%A7%86%E9%A2%91%E4%B9%8BLame%20MP3%E7%BC%96%E7%A0%81%E5%AE%9E%E7%8E%B0-2.png">
<meta property="article:published_time" content="2025-06-30T13:53:45.000Z">
<meta property="article:modified_time" content="2025-07-13T09:45:09.052Z">
<meta property="article:author" content="Qingkouwei">
<meta property="article:tag" content="HarmonyOS Next">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://harmonyostech.github.io/images/HarmonyOS%20%E9%9F%B3%E8%A7%86%E9%A2%91%E4%B9%8BLame%20MP3%E7%BC%96%E7%A0%81%E5%AE%9E%E7%8E%B0.png">

<link rel="canonical" href="https://harmonyostech.github.io/2025/06/30/C-HarmonyOS-Audio-Video-Lame-MP3-Encoding-Implementation/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>HarmonyOS Audio-Video: Lame MP3 Encoding Implementation | HarmonyOS NEXT Knowledge Charging Station</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">HarmonyOS NEXT Knowledge Charging Station</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">Analysis of Core Technologies and Application Scenarios of HarmonyOS NEXT</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://harmonyostech.github.io/2025/06/30/C-HarmonyOS-Audio-Video-Lame-MP3-Encoding-Implementation/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Qingkouwei">
      <meta itemprop="description" content="Welcome to the HarmonyOS NEXT Knowledge Charging Station!  This is a hub for knowledge about HarmonyOS Next`s new-generation system. With its self-developed kernel, HarmonyOS NEXT achieves native smoothness, security, intelligence, and interconnectivity. We deeply analyze how its new distributed soft bus revolutionizes device connectivity experiences and explain the principles behind the enhanced perception and reasoning capabilities of the Xiaoyi intelligent agent based on the Pangu large model. Whether you are a developer exploring application development or an ordinary user eager to understand system features, you can "recharge" here and quickly grasp the essence of HarmonyOS NEXT.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HarmonyOS NEXT Knowledge Charging Station">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          HarmonyOS Audio-Video: Lame MP3 Encoding Implementation
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2025-06-30 21:53:45" itemprop="dateCreated datePublished" datetime="2025-06-30T21:53:45+08:00">2025-06-30</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-07-13 17:45:09" itemprop="dateModified" datetime="2025-07-13T17:45:09+08:00">2025-07-13</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/HarmonyOS-Next-Tech/" itemprop="url" rel="index"><span itemprop="name">HarmonyOS Next Tech</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="HarmonyOS-Audio-Video-Lame-MP3-Encoding-Implementation"><a href="#HarmonyOS-Audio-Video-Lame-MP3-Encoding-Implementation" class="headerlink" title="HarmonyOS Audio-Video: Lame MP3 Encoding Implementation"></a>HarmonyOS Audio-Video: Lame MP3 Encoding Implementation</h1><h2 id="Background"><a href="#Background" class="headerlink" title="Background"></a>Background</h2><p>MP3 is a widely used audio compression format, renowned for its efficient compression algorithm and broad compatibility. It is one of the most popular audio formats, supported by almost all audio playback devices, mobile devices, computers, and audio software. This makes MP3 a de facto standard format—compatibility, rather than compression performance, is the key to MP3’s market dominance.  </p>
<p>However, MP3 is a copyrighted encoding. Most mobile phone manufacturers do not include MP3 hardware encoders, only hardware decoders. The most commonly used open-source MP3 software encoder is Lame. This article takes Lame as an example to implement an MP3 software encoder based on Lame, covering the full process from cross-platform compilation to application integration.  </p>
<h2 id="Compiling-Lame"><a href="#Compiling-Lame" class="headerlink" title="Compiling Lame"></a>Compiling Lame</h2><p>There are three common compilation methods for third-party open-source C&#x2F;C++ libraries:  </p>
<ul>
<li>cmake  </li>
<li>make  </li>
<li>configure</li>
</ul>
<p>Different build scripts require configuring different variables. Lame uses the Configure build script, and configuration parameters can be viewed via <code>./Configure -h</code>. OpenHarmony provides a cross-compilation framework called lycium. After configuring third-party library information using a template, execute the build script. The lame module is already included in the <code>tpc_c_cplusplus</code> project’s <code>thirdparty</code> directory, allowing direct compilation.  </p>
<p>To compile, enter the lycium directory and run: <code>./build.sh lame</code>. Upon completion, the <code>user/lame</code> directory in lycium will contain the compiled dynamic libraries.  </p>
<p>When compiling on a macOS ARM-based computer, the following error occurred (viewed in <code>tpc_c_cplusplus/thirdparty/lame/lame-3.100/armeabi-v7a-build/build.log</code>):  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">1 error generated.</span><br><span class="line">1 error generated.</span><br><span class="line">1 error generated.</span><br><span class="line">../../mpglib/dct64_i386.c:34:10: fatal error: &#x27;config.h&#x27; file not found</span><br><span class="line">#include &lt;config.h&gt;</span><br><span class="line">         ^~~~~~~~~~</span><br><span class="line">make[2]: *** [tabinit.lo] Error 1</span><br><span class="line">make[2]: *** Waiting for unfinished jobs....</span><br><span class="line">make[2]: *** [common.lo] Error 1</span><br><span class="line">make[2]: *** [interface.lo] Error 1</span><br><span class="line">make[2]: *** [decode_i386.lo] Error 1</span><br><span class="line">make[2]: *** [layer1.lo] Error 1</span><br><span class="line">1 error generated.</span><br><span class="line">1 error generated.</span><br><span class="line">make[2]: *** [layer2.lo] Error 1</span><br><span class="line">make[2]: *** [dct64_i386.lo] Error 1</span><br><span class="line">1 error generated.</span><br><span class="line">make[2]: *** [layer3.lo] Error 1</span><br><span class="line">make[1]: *** [all-recursive] Error 1</span><br><span class="line">** [tabinit.lo] Error 1</span><br><span class="line">make[2]: *** Waiting for unfinished jobs....</span><br><span class="line">make[2]: *** [common.lo] Error 1</span><br><span class="line">make[2]: *** [interface.lo] Error 1</span><br><span class="line">make[2]: *** [decode_i386.lo] Error 1</span><br><span class="line">make[2]: *** [layer1.lo] Error 1</span><br><span class="line">1 error generated.</span><br><span class="line">1 error generated.</span><br><span class="line">make[2]: *** [layer2.lo] Error 1</span><br><span class="line">make[2]: *** [dct64_i386.lo] Error 1</span><br><span class="line">1 error generated.</span><br><span class="line">make[2]: *** [layer3.lo] Error 1</span><br><span class="line">make[1]: *** [all-recursive] Error 1</span><br><span class="line">make: *** [all] Error 2</span><br><span class="line">&quot;build.log&quot; 310L, 21047Bmake: *** [all] Error 2</span><br></pre></td></tr></table></figure>
<p>The error indicated a failure to generate the <code>config.h</code> header file, caused by version mismatches in tools依赖 (dependencies) for the Configure-based Lame. Compilation succeeded after switching to an Intel-based computer:<br><img src="/../images/HarmonyOS%20%E9%9F%B3%E8%A7%86%E9%A2%91%E4%B9%8BLame%20MP3%E7%BC%96%E7%A0%81%E5%AE%9E%E7%8E%B0.png"></p>
<h2 id="Integrating-into-a-HarmonyOS-Project"><a href="#Integrating-into-a-HarmonyOS-Project" class="headerlink" title="Integrating into a HarmonyOS Project"></a>Integrating into a HarmonyOS Project</h2><p>Next, integrate the compiled Lame dynamic library into the project via precompilation.  </p>
<p>First, create a native C++ project:<br><img src="/../images/HarmonyOS%20%E9%9F%B3%E8%A7%86%E9%A2%91%E4%B9%8BLame%20MP3%E7%BC%96%E7%A0%81%E5%AE%9E%E7%8E%B0-1.png"></p>
<p>Create a <code>third_party/lame</code> folder under the <code>cpp</code> directory, and copy the compiled SO files and exported header files to this path:<br><img src="/../images/HarmonyOS%20%E9%9F%B3%E8%A7%86%E9%A2%91%E4%B9%8BLame%20MP3%E7%BC%96%E7%A0%81%E5%AE%9E%E7%8E%B0-2.png"></p>
<p>Modify <code>CMakeLists.txt</code> to import the precompiled Lame dynamic library and add linking:  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">add_library(lame SHARED IMPORTED)  </span><br><span class="line">set_target_properties(lame  </span><br><span class="line">    PROPERTIES  </span><br><span class="line">    IMPORTED_LOCATION $&#123;CMAKE_CURRENT_SOURCE_DIR&#125;/third_party/lame/libs/$&#123;OHOS_ARCH&#125;/libmp3lame.so)  </span><br><span class="line">  </span><br><span class="line">add_library(audio_engine SHARED napi_init.cpp)  </span><br><span class="line">target_link_libraries(audio_engine PUBLIC libace_napi.z.so lame)</span><br></pre></td></tr></table></figure>
<p>Configure header file search paths to use Lame’s headers:  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">include_directories($&#123;NATIVERENDER_ROOT_PATH&#125;  </span><br><span class="line">                    $&#123;NATIVERENDER_ROOT_PATH&#125;/include  </span><br><span class="line">                   $&#123;NATIVERENDER_ROOT_PATH&#125;/third_party/lame/include  </span><br><span class="line">                    )</span><br></pre></td></tr></table></figure>
<p>The library is now ready for use after integration.  </p>
<h2 id="Recording-MP3-Audio-Files"><a href="#Recording-MP3-Audio-Files" class="headerlink" title="Recording MP3 Audio Files"></a>Recording MP3 Audio Files</h2><p>After integrating the encoding library, encapsulate C++ interfaces for TS-side calling. Here, we provide three basic interfaces:  </p>
<ol>
<li>Create an encoder  </li>
<li>Encode data  </li>
<li>Close the encoder</li>
</ol>
<h3 id="Creating-the-Encoder"><a href="#Creating-the-Encoder" class="headerlink" title="Creating the Encoder"></a>Creating the Encoder</h3><p>After creating the Lame encoder, set encoding parameters:  </p>
<ul>
<li>Input audio sampling rate  </li>
<li>Input audio channel count  </li>
<li>Output sampling rate  </li>
<li>Output bitrate  </li>
<li>Output quality</li>
</ul>
<p>Define the <code>initLame</code> method with five parameters:  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">size_t argc = 5;  </span><br><span class="line">napi_value args[5] = &#123;nullptr&#125;;  </span><br><span class="line">napi_get_cb_info(env, info, &amp;argc, args, nullptr, nullptr);  </span><br><span class="line">int inSamplerate;  </span><br><span class="line">napi_get_value_int32(env, args[0], &amp;inSamplerate);  </span><br><span class="line">  </span><br><span class="line">int inChannel;  </span><br><span class="line">napi_get_value_int32(env, args[1], &amp;inChannel);  </span><br><span class="line">  </span><br><span class="line">int outSamplerate;  </span><br><span class="line">napi_get_value_int32(env, args[2], &amp;outSamplerate);  </span><br><span class="line">  </span><br><span class="line">int outBitrate;  </span><br><span class="line">napi_get_value_int32(env, args[3], &amp;outBitrate);  </span><br><span class="line">  </span><br><span class="line">int quality;  </span><br><span class="line">napi_get_value_int32(env, args[4], &amp;quality);</span><br></pre></td></tr></table></figure>

<p>Next, configure the encoder: </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">lame = lame_init();  </span><br><span class="line">lame_set_in_samplerate(lame, inSamplerate);  </span><br><span class="line">lame_set_num_channels(lame, inChannel);// Input stream channels  </span><br><span class="line">lame_set_out_samplerate(lame, outSamplerate);  </span><br><span class="line">lame_set_brate(lame, outBitrate);  </span><br><span class="line">lame_set_quality(lame, quality);  </span><br><span class="line">lame_init_params(lame);</span><br></pre></td></tr></table></figure>

<h3 id="Encoding-Audio-Data"><a href="#Encoding-Audio-Data" class="headerlink" title="Encoding Audio Data"></a>Encoding Audio Data</h3><p>The Lame encoding function prototype is as follows:  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">/*  </span><br><span class="line"> * Input PCM data, output (maybe) MP3 frames.  </span><br><span class="line"> * This routine handles all buffering, resampling and filtering for you.  </span><br><span class="line"> *  </span><br><span class="line"> * Return code:  </span><br><span class="line"> *   - Number of bytes output in mp3buf (can be 0)  </span><br><span class="line"> *   - -1: mp3buf was too small  </span><br><span class="line"> *   - -2: malloc() problem  </span><br><span class="line"> *   - -3: lame_init_params() not called  </span><br><span class="line"> *   - -4: Psychoacoustic problems  </span><br><span class="line"> *  </span><br><span class="line"> * The required mp3buf_size can be computed from num_samples, samplerate, and encoding rate.  </span><br><span class="line"> * Here&#x27;s a worst-case estimate:  </span><br><span class="line"> *   mp3buf_size (bytes) = 1.25 * num_samples + 7200  </span><br><span class="line"> *  </span><br><span class="line"> * A tighter bound (mt, March 2000):  </span><br><span class="line"> *   MPEG1: num_samples * (bitrate/8) / samplerate + 4 * 1152 * (bitrate/8) / samplerate + 512  </span><br><span class="line"> *   MPEG2: num_samples * (bitrate/8) / samplerate + 4 * 576 * (bitrate/8) / samplerate + 256  </span><br><span class="line"> * Test first if using this!  </span><br><span class="line"> *  </span><br><span class="line"> * Set mp3buf_size = 0, and LAME will not check if mp3buf_size is large enough.  </span><br><span class="line"> *  </span><br><span class="line"> * NOTE: If gfp-&gt;num_channels=2 but gfp-&gt;mode=3 (mono), L &amp; R channels will be averaged into L  </span><br><span class="line"> * before encoding only the L channel. This overwrites data in buffer_l[] and buffer_r[].  </span><br><span class="line"> */  </span><br><span class="line">int CDECL lame_encode_buffer (  </span><br><span class="line">        lame_global_flags*  gfp,           /* Global context handle         */  </span><br><span class="line">        const short int     buffer_l [],   /* PCM data for left channel     */  </span><br><span class="line">        const short int     buffer_r [],   /* PCM data for right channel    */  </span><br><span class="line">        const int           nsamples,      /* Samples per channel           */  </span><br><span class="line">        unsigned char*      mp3buf,        /* Encoded MP3 stream            */  </span><br><span class="line">        const int           mp3buf_size ); /* Valid octets in mp3buf        */</span><br></pre></td></tr></table></figure>

<p>This requires left and right channel data, samples per channel, output buffer, and buffer size.  </p>
<p>The NAPI interface accepts three buffers:  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">static napi_value NAPI_Global_encodeLame(napi_env env, napi_callback_info info)  </span><br><span class="line">&#123;  </span><br><span class="line">    size_t argc = 4;  </span><br><span class="line">    napi_value args[4] = &#123;nullptr&#125;;  </span><br><span class="line">    napi_get_cb_info(env, info, &amp;argc, args, nullptr, nullptr);  </span><br><span class="line">  </span><br><span class="line">    napi_typedarray_type type; // Data type  </span><br><span class="line">    napi_value left_input_buffer;  </span><br><span class="line">    size_t byte_offset; // Data offset  </span><br><span class="line">    size_t length; // Byte size  </span><br><span class="line">    napi_get_typedarray_info(env, args[0], &amp;type, &amp;length, NULL, &amp;left_input_buffer, &amp;byte_offset);  </span><br><span class="line">    void* leftBuffer;   </span><br><span class="line">    size_t leftLength;   </span><br><span class="line">    napi_get_arraybuffer_info(env, left_input_buffer, &amp;leftBuffer, &amp;leftLength);   </span><br><span class="line">      </span><br><span class="line">    napi_value right_input_buffer;  </span><br><span class="line">    napi_get_typedarray_info(env, args[1], &amp;type, &amp;length, NULL, &amp;right_input_buffer, &amp;byte_offset);  </span><br><span class="line">    void* rightBuffer;   </span><br><span class="line">    size_t rightLength;   </span><br><span class="line">    napi_get_arraybuffer_info(env, right_input_buffer, &amp;rightBuffer, &amp;rightLength);   </span><br><span class="line">      </span><br><span class="line">    int samples;  </span><br><span class="line">    napi_get_value_int32(env, args[2], &amp;samples);  </span><br><span class="line">    napi_value mp3_output_buffer;  </span><br><span class="line">    napi_get_typedarray_info(env, args[3], &amp;type, &amp;length, NULL, &amp;mp3_output_buffer, &amp;byte_offset);  </span><br><span class="line">    void* mp3Buffer;   </span><br><span class="line">    size_t mp3Length;   </span><br><span class="line">    napi_get_arraybuffer_info(env, mp3_output_buffer, &amp;mp3Buffer, &amp;mp3Length);   </span><br><span class="line">      </span><br><span class="line">    int result = lame_encode_buffer(lame, (short int*)leftBuffer, (short int*)rightBuffer,  </span><br><span class="line">          samples, (unsigned char*)mp3Buffer, mp3Length);    </span><br><span class="line">    napi_value result_value;  </span><br><span class="line">    napi_create_int32(env, result, &amp;result_value);  </span><br><span class="line">    return result_value;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Key methods used: <code>napi_get_typedarray_info</code> and <code>napi_get_arraybuffer_info</code>:  </p>
<ul>
<li>The Native C++ side receives the ArkTS Array, uses <code>napi_get_typedarray_info</code> to obtain data for the <code>typedarray</code>, and then uses <code>napi_get_arraybuffer_info</code> to fetch array data.  </li>
<li>The ArkTS side receives the Array from the Native C++ side, creates an <code>arraybuffer</code> via <code>napi_create_arraybuffer</code>, generates a <code>typedarray</code> with <code>napi_create_typedarray</code>, stores the <code>arraybuffer</code> in <code>output_array</code>, assigns values to the <code>arraybuffer</code>, and returns <code>output_array</code>.</li>
</ul>
<h3 id="Closing-the-Encoder"><a href="#Closing-the-Encoder" class="headerlink" title="Closing the Encoder"></a>Closing the Encoder</h3><p>Call <code>lame_close</code> to close the encoder. Before closing, use <code>lame_encode_flush</code> to retrieve cached data and ensure data integrity:  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">static napi_value NAPI_Global_flushLame(napi_env env, napi_callback_info info)  </span><br><span class="line">&#123;  </span><br><span class="line">    size_t argc = 1;  </span><br><span class="line">    napi_value args[1] = &#123;nullptr&#125;;  </span><br><span class="line">    napi_get_cb_info(env, info, &amp;argc, args, nullptr, nullptr);  </span><br><span class="line">    napi_typedarray_type type; // Data type  </span><br><span class="line">    napi_value output_buffer;  </span><br><span class="line">    size_t byte_offset; // Data offset  </span><br><span class="line">    size_t length; // Byte size  </span><br><span class="line">    napi_get_typedarray_info(env, args[0], &amp;type, &amp;length, NULL, &amp;output_buffer, &amp;byte_offset);  </span><br><span class="line">    void* outBuffer;   </span><br><span class="line">    size_t outLength;   </span><br><span class="line">    napi_get_arraybuffer_info(env, output_buffer, &amp;outBuffer, &amp;outLength);   </span><br><span class="line">    int result = lame_encode_flush(lame, (unsigned char *)outBuffer, outLength);  </span><br><span class="line">    napi_value result_value;  </span><br><span class="line">    napi_create_int32(env, result, &amp;result_value);  </span><br><span class="line">    return result_value;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="Issues-Encountered"><a href="#Issues-Encountered" class="headerlink" title="Issues Encountered"></a>Issues Encountered</h2><ol>
<li>After linking the <code>mp3lame</code> library, calling a native method threw an error: <code>Cannot read property encodeLame of undefined</code>. The issue occurred because the compiled <code>mp3lame.so</code> included a version number, which was removed when copying to the project. The problem was resolved by retaining the highest bit of the version number.  </li>
<li>Threading issues: Encoding is a time-consuming operation that requires processing in a separate thread. Create threads and caches on the C++ side for interaction.</li>
</ol>
<h2 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h2><p>Due to copyright restrictions, Android and iOS devices do not directly provide MP3 hardware encoders, relying on the Lame third-party library for MP3 recording. This article introduces the full process of implementing MP3 software encoding on HarmonyOS—from third-party library compilation to project integration and interface encapsulation. Although HarmonyOS offers hardware MP3 encoding, this article provides best practices for integrating third-party C++ libraries using Lame as an example.</p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/HarmonyOS-Next/" rel="tag"># HarmonyOS Next</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2025/06/30/C-HarmonyOS-Audio-Video-Audio-Capture-Practice/" rel="prev" title="HarmonyOS Audio-Video: Audio Capture Practice">
      <i class="fa fa-chevron-left"></i> HarmonyOS Audio-Video: Audio Capture Practice
    </a></div>
      <div class="post-nav-item">
    <a href="/2025/06/30/C-HarmonyOS-Native-Intelligence-Face-Detection-Practice/" rel="next" title="HarmonyOS Native Intelligence: Face Detection Practice">
      HarmonyOS Native Intelligence: Face Detection Practice <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#HarmonyOS-Audio-Video-Lame-MP3-Encoding-Implementation"><span class="nav-number">1.</span> <span class="nav-text">HarmonyOS Audio-Video: Lame MP3 Encoding Implementation</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Background"><span class="nav-number">1.1.</span> <span class="nav-text">Background</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Compiling-Lame"><span class="nav-number">1.2.</span> <span class="nav-text">Compiling Lame</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Integrating-into-a-HarmonyOS-Project"><span class="nav-number">1.3.</span> <span class="nav-text">Integrating into a HarmonyOS Project</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Recording-MP3-Audio-Files"><span class="nav-number">1.4.</span> <span class="nav-text">Recording MP3 Audio Files</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Creating-the-Encoder"><span class="nav-number">1.4.1.</span> <span class="nav-text">Creating the Encoder</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Encoding-Audio-Data"><span class="nav-number">1.4.2.</span> <span class="nav-text">Encoding Audio Data</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Closing-the-Encoder"><span class="nav-number">1.4.3.</span> <span class="nav-text">Closing the Encoder</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Issues-Encountered"><span class="nav-number">1.5.</span> <span class="nav-text">Issues Encountered</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Summary"><span class="nav-number">1.6.</span> <span class="nav-text">Summary</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Qingkouwei</p>
  <div class="site-description" itemprop="description">Welcome to the HarmonyOS NEXT Knowledge Charging Station!  This is a hub for knowledge about HarmonyOS Next`s new-generation system. With its self-developed kernel, HarmonyOS NEXT achieves native smoothness, security, intelligence, and interconnectivity. We deeply analyze how its new distributed soft bus revolutionizes device connectivity experiences and explain the principles behind the enhanced perception and reasoning capabilities of the Xiaoyi intelligent agent based on the Pangu large model. Whether you are a developer exploring application development or an ordinary user eager to understand system features, you can "recharge" here and quickly grasp the essence of HarmonyOS NEXT.</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">364</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">5</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">1</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Qingkouwei</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
