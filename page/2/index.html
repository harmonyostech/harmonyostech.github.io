<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"harmonyostech.github.io","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="Welcome to the HarmonyOS NEXT Knowledge Charging Station!  This is a hub for knowledge about HarmonyOS Next&#96;s new-generation system. With its self-developed kernel, HarmonyOS NEXT achieves native smoo">
<meta property="og:type" content="website">
<meta property="og:title" content="HarmonyOS NEXT Knowledge Charging Station">
<meta property="og:url" content="https://harmonyostech.github.io/page/2/index.html">
<meta property="og:site_name" content="HarmonyOS NEXT Knowledge Charging Station">
<meta property="og:description" content="Welcome to the HarmonyOS NEXT Knowledge Charging Station!  This is a hub for knowledge about HarmonyOS Next&#96;s new-generation system. With its self-developed kernel, HarmonyOS NEXT achieves native smoo">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Qingkouwei">
<meta property="article:tag" content="HarmonyOSNext, HarmonyOS NEXT, HarmonyOS, Cangjie">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://harmonyostech.github.io/page/2/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>HarmonyOS NEXT Knowledge Charging Station</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">HarmonyOS NEXT Knowledge Charging Station</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">Analysis of Core Technologies and Application Scenarios of HarmonyOS NEXT</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://harmonyostech.github.io/2025/06/30/C-HarmonyOS-Next-Video-Compression-Coding-Principles-and-Best-Practices/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Qingkouwei">
      <meta itemprop="description" content="Welcome to the HarmonyOS NEXT Knowledge Charging Station!  This is a hub for knowledge about HarmonyOS Next`s new-generation system. With its self-developed kernel, HarmonyOS NEXT achieves native smoothness, security, intelligence, and interconnectivity. We deeply analyze how its new distributed soft bus revolutionizes device connectivity experiences and explain the principles behind the enhanced perception and reasoning capabilities of the Xiaoyi intelligent agent based on the Pangu large model. Whether you are a developer exploring application development or an ordinary user eager to understand system features, you can "recharge" here and quickly grasp the essence of HarmonyOS NEXT.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HarmonyOS NEXT Knowledge Charging Station">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/06/30/C-HarmonyOS-Next-Video-Compression-Coding-Principles-and-Best-Practices/" class="post-title-link" itemprop="url">HarmonyOS Next Video Compression Coding Principles and Best Practices</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2025-06-30 22:06:10 / Modified: 22:07:36" itemprop="dateCreated datePublished" datetime="2025-06-30T22:06:10+08:00">2025-06-30</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/HarmonyOS-Next-Tech/" itemprop="url" rel="index"><span itemprop="name">HarmonyOS Next Tech</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="HarmonyOS-Next-Video-Compression-Coding-Principles-and-Best-Practices"><a href="#HarmonyOS-Next-Video-Compression-Coding-Principles-and-Best-Practices" class="headerlink" title="HarmonyOS Next Video Compression Coding Principles and Best Practices"></a>HarmonyOS Next Video Compression Coding Principles and Best Practices</h1><h2 id="Background"><a href="#Background" class="headerlink" title="Background"></a>Background</h2><p>Previous articles introduced that HarmonyOS Next allows the system album and camera tools to acquire images and videos without special permissions. After acquiring these assets, we generally need to compress them to reduce bandwidth and storage resource consumption. For example, a 10-second video shot by the Huawei Mate60 Pro’s system camera generates a file of about 38MB, with an analysis showing a video bitrate as high as 30Mbps—significantly higher than required in many scenarios where video quality demands are lower:  </p>
<p><img src="/../images/HarmonyOS%20Next%20%E8%A7%86%E9%A2%91%E5%8E%8B%E7%BC%A9%E7%BC%96%E7%A0%81%E5%8E%9F%E7%90%86%E4%B8%8E%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5-2.png"></p>
<p>Image compression methods have been discussed previously. This article focuses on video compression coding based on the HarmonyOS Next platform.  </p>
<h2 id="Principles-of-Video-Compression"><a href="#Principles-of-Video-Compression" class="headerlink" title="Principles of Video Compression"></a>Principles of Video Compression</h2><h3 id="Related-Concepts"><a href="#Related-Concepts" class="headerlink" title="Related Concepts"></a>Related Concepts</h3><p><strong>What is a video?</strong><br>A video is a sequence of continuous images. Typically, a frame rate of 18 frames per second (fps) ensures smooth playback.  </p>
<p><strong>What is video compression?</strong><br>Video compression uses digital signal processing techniques and algorithms to reduce video data size, minimizing storage space and transmission bandwidth while maintaining original quality.  </p>
<p><strong>Why is compression possible?</strong><br>Because images and video sequences contain redundant information, compression aims to remove this redundancy:  </p>
<ul>
<li><strong>Intra-frame redundancy</strong>: Large areas of uniform color or blank spaces in an image can be stored with fewer bits.  </li>
<li><strong>Inter-frame redundancy</strong>: Adjacent frames in a video sequence (e.g., a person running) often differ only slightly (e.g., leg movements).</li>
</ul>
<p>Key compression techniques include:  </p>
<ol>
<li><strong>Intra-frame compression</strong>: Encodes individual frames without considering adjacent frames (e.g., DCT, Discrete Cosine Transform).  </li>
<li><strong>Inter-frame compression</strong>: Utilizes correlation between adjacent frames (e.g., motion estimation, motion compensation).  </li>
<li><strong>Transform coding</strong>: Converts spatial-domain image information to the frequency domain for efficient encoding.  </li>
<li><strong>Quantization</strong>: Reduces data volume by quantizing transformed coefficients.</li>
</ol>
<p><strong>What is compression transcoding?</strong><br>The degree of video compression is measured by <strong>bitrate</strong> (bit rate), the number of bits transmitted per unit time (e.g., kbps, Mbps). Higher bitrates generally mean higher resolution, smoother motion, and more accurate color reproduction.  </p>
<p>For example, a 1280×720 video at 18 fps in RGBA format would require:  </p>
<ul>
<li>1 second uncompressed: <code>1280×720×18</code> bytes &#x3D; <code>3,686,400×18</code> bytes &#x3D; <code>3,686,400×18×8</code> bits &#x3D; <strong>530 Mbps</strong>.<br>In contrast, high-quality 4K&#x2F;8K videos typically have bitrates of only a few Mbps, demonstrating the 100× compression achievable through coding.</li>
</ul>
<p>Videos captured by mobile phone cameras are often large, but we may need to reduce their size for scenarios where full quality isn’t necessary—hence the focus on video compression coding.  </p>
<h3 id="Introduction-to-Audio-Video-Processing-Flow"><a href="#Introduction-to-Audio-Video-Processing-Flow" class="headerlink" title="Introduction to Audio-Video Processing Flow"></a>Introduction to Audio-Video Processing Flow</h3><p>The typical audio-video processing flow in daily scenarios is as follows:<br><img src="/../images/HarmonyOS%20Next%20%E8%A7%86%E9%A2%91%E5%8E%8B%E7%BC%A9%E7%BC%96%E7%A0%81%E5%8E%9F%E7%90%86%E4%B8%8E%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5.png"></p>
<p>The main principle of video compression coding is to:  </p>
<ol>
<li>Decode and demultiplex the video into raw data.  </li>
<li>Optionally process the raw data.  </li>
<li>Re-encode it with a new <strong>bitrate</strong> to reduce file size.<br><img src="/../images/HarmonyOS%20Next%20%E8%A7%86%E9%A2%91%E5%8E%8B%E7%BC%A9%E7%BC%96%E7%A0%81%E5%8E%9F%E7%90%86%E4%B8%8E%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5-1.png"></li>
</ol>
<h2 id="Introduction-to-HarmonyOS-Next-Audio-Video-Codec-APIs"><a href="#Introduction-to-HarmonyOS-Next-Audio-Video-Codec-APIs" class="headerlink" title="Introduction to HarmonyOS Next Audio-Video Codec APIs"></a>Introduction to HarmonyOS Next Audio-Video Codec APIs</h2><p>Third-party libraries like FFmpeg can compress videos, but they rely on software codecs (CPU processing). Mobile phones often provide specialized hardware for audio-video processing, accessible via system-provided hardware codec interfaces. This section introduces HarmonyOS Next’s hardware audio-video codec APIs.  </p>
<p><strong>Software vs. Hardware Codecs</strong>:  </p>
<ul>
<li><strong>Software codecs</strong>: Run on CPU, offering flexible iteration, better compatibility, and easier protocol&#x2F;format extension.  </li>
<li><strong>Hardware codecs</strong>: Operate on dedicated hardware, delivering better power efficiency, lower latency, higher throughput, and reduced CPU load.</li>
</ul>
<p>HarmonyOS Next provides audio-video codec interfaces only via C APIs, covering demultiplexing, decoding, encoding, and muxing.  </p>
<h3 id="Demultiplexing"><a href="#Demultiplexing" class="headerlink" title="Demultiplexing"></a>Demultiplexing</h3><p>Demultiplexing operates on files (local or network), parsing them to extract DRM information and media samples (audio, video, subtitles).  </p>
<p>HarmonyOS Next supports data input types:  </p>
<ul>
<li>Remote connections (HTTP protocol, requires <code>ohos.permission.INTERNET</code>).  </li>
<li>File descriptors (FD, requires <code>ohos.permission.READ_MEDIA</code> for local files).</li>
</ul>
<p>Dynamic libraries for demultiplexing:  </p>
<ul>
<li><code>libnative_media_codecbase.so</code>: Codec base library  </li>
<li><code>libnative_media_avdemuxer.so</code>: Demultiplexer library  </li>
<li><code>libnative_media_avsource.so</code>: Media source library  </li>
<li><code>libnative_media_core.so</code>: Media core library</li>
</ul>
<p>Demultiplexing involves structured file reading (IO operations) with minimal CPU overhead.  </p>
<h4 id="1-Include-Header-Files"><a href="#1-Include-Header-Files" class="headerlink" title="1. Include Header Files"></a>1. Include Header Files</h4><pre><code class="language-c">#include &lt;multimedia/player_framework/native_avdemuxer.h&gt;
#include &lt;multimedia/player_framework/native_avsource.h&gt;
#include &lt;multimedia/player_framework/native_avcodec_base.h&gt;
#include &lt;multimedia/player_framework/native_avformat.h&gt;
#include &lt;multimedia/player_framework/native_avbuffer.h&gt;
#include &lt;fcntl.h&gt;
#include &lt;sys/stat.h&gt;
</code></pre>
<h4 id="2-Create-a-Resource-Management-Object"><a href="#2-Create-a-Resource-Management-Object" class="headerlink" title="2. Create a Resource Management Object"></a>2. Create a Resource Management Object</h4><pre><code class="language-c">// Create a source object for an FD resource file (offset=0, size=fileSize is recommended for completeness)
OH_AVSource *source = OH_AVSource_CreateWithFD(fd, 0, fileSize);
if (source == nullptr) &#123;
   printf(&quot;create source failed&quot;);
   return;
&#125;
</code></pre>
<p>For network resources:  </p>
<pre><code class="language-c">// Create a source object for a URI resource (optional)
OH_AVSource *source = OH_AVSource_CreateWithURI(uri);
</code></pre>
<p>For custom data sources (requires implementing <code>AVSourceReadAt</code>):  </p>
<pre><code class="language-c">g_filePath = filePath;
OH_AVDataSource dataSource = &#123;fileSize, AVSourceReadAt&#125;;
OH_AVSource *source = OH_AVSource_CreateWithDataSource(&amp;dataSource);
</code></pre>
<h4 id="3-Create-a-Demultiplexer-Instance"><a href="#3-Create-a-Demultiplexer-Instance" class="headerlink" title="3. Create a Demultiplexer Instance"></a>3. Create a Demultiplexer Instance</h4><pre><code class="language-c">// Create a demuxer for the source object
OH_AVDemuxer *demuxer = OH_AVDemuxer_CreateWithSource(source);
if (demuxer == nullptr) &#123;
   printf(&quot;create demuxer failed&quot;);
   return;
&#125;
</code></pre>
<h4 id="4-Get-the-Number-of-File-Tracks"><a href="#4-Get-the-Number-of-File-Tracks" class="headerlink" title="4. Get the Number of File Tracks"></a>4. Get the Number of File Tracks</h4><pre><code class="language-c">// Get the source format to obtain the track count
OH_AVFormat *sourceFormat = OH_AVSource_GetSourceFormat(source);
if (sourceFormat == nullptr) &#123;
   printf(&quot;get source format failed&quot;);
   return;
&#125;
int32_t trackCount = 0;
if (!OH_AVFormat_GetIntValue(sourceFormat, OH_MD_KEY_TRACK_COUNT, &amp;trackCount)) &#123;
   printf(&quot;get track count from source format failed&quot;);
   return;
&#125;
OH_AVFormat_Destroy(sourceFormat);
</code></pre>
<h4 id="5-Get-Track-Indices-and-Information"><a href="#5-Get-Track-Indices-and-Information" class="headerlink" title="5. Get Track Indices and Information"></a>5. Get Track Indices and Information</h4><pre><code class="language-c">uint32_t audioTrackIndex = 0;
uint32_t videoTrackIndex = 0;
int32_t w = 0, h = 0, trackType;
for (uint32_t index = 0; index &lt; static_cast&lt;uint32_t&gt;(trackCount); index++) &#123;
   OH_AVFormat *trackFormat = OH_AVSource_GetTrackFormat(source, index);
   if (trackFormat == nullptr) &#123;
      printf(&quot;get track format failed&quot;);
      return;
   &#125;
   if (!OH_AVFormat_GetIntValue(trackFormat, OH_MD_KEY_TRACK_TYPE, &amp;trackType)) &#123;
      printf(&quot;get track type from track format failed&quot;);
      return;
   &#125;
   // Classify tracks as audio or video
   if (static_cast&lt;OH_MediaType&gt;(trackType) == OH_MediaType::MEDIA_TYPE_AUD) &#123;
      audioTrackIndex = index;
   &#125; else &#123;
      videoTrackIndex = index;
      // Get video dimensions
      if (!OH_AVFormat_GetIntValue(trackFormat, OH_MD_KEY_WIDTH, &amp;w) ||
          !OH_AVFormat_GetIntValue(trackFormat, OH_MD_KEY_HEIGHT, &amp;h)) &#123;
         printf(&quot;get track dimensions failed&quot;);
         return;
      &#125;
   &#125;
   OH_AVFormat_Destroy(trackFormat);
&#125;
</code></pre>
<h4 id="6-Select-Tracks-for-the-Demuxer"><a href="#6-Select-Tracks-for-the-Demuxer" class="headerlink" title="6. Select Tracks for the Demuxer"></a>6. Select Tracks for the Demuxer</h4><pre><code class="language-c">if (OH_AVDemuxer_SelectTrackByID(demuxer, audioTrackIndex) != AV_ERR_OK) &#123;
   printf(&quot;select audio track failed: %d&quot;, audioTrackIndex);
   return;
&#125;
if (OH_AVDemuxer_SelectTrackByID(demuxer, videoTrackIndex) != AV_ERR_OK) &#123;
   printf(&quot;select video track failed: %d&quot;, videoTrackIndex);
   return;
&#125;
</code></pre>
<p>Use <code>OH_AVDemuxer_UnselectTrackByID</code> to deselect tracks when done.  </p>
<h4 id="7-Start-Demultiplexing-and-Read-Samples"><a href="#7-Start-Demultiplexing-and-Read-Samples" class="headerlink" title="7. Start Demultiplexing and Read Samples"></a>7. Start Demultiplexing and Read Samples</h4><pre><code class="language-c">// Create a buffer to hold demuxed data
OH_AVBuffer *buffer = OH_AVBuffer_Create(w * h * 3 &gt;&gt; 1);
if (buffer == nullptr) &#123;
   printf(&quot;build buffer failed&quot;);
   return;
&#125;
OH_AVCodecBufferAttr info;
bool videoIsEnd = false, audioIsEnd = false;
int32_t ret;
while (!audioIsEnd || !videoIsEnd) &#123;
   // Read audio samples
   if (!audioIsEnd) &#123;
      ret = OH_AVDemuxer_ReadSampleBuffer(demuxer, audioTrackIndex, buffer);
      if (ret == AV_ERR_OK) &#123;
         OH_AVBuffer_GetBufferAttr(buffer, &amp;info);
         printf(&quot;audio info.size: %d\n&quot;, info.size);
         if (info.flags == OH_AVCodecBufferFlags::AVCODEC_BUFFER_FLAGS_EOS) &#123;
            audioIsEnd = true;
         &#125;
      &#125;
   &#125;
   // Read video samples
   if (!videoIsEnd) &#123;
      ret = OH_AVDemuxer_ReadSampleBuffer(demuxer, videoTrackIndex, buffer);
      if (ret == AV_ERR_OK) &#123;
         OH_AVBuffer_GetBufferAttr(buffer, &amp;info);
         printf(&quot;video info.size: %d\n&quot;, info.size);
         if (info.flags == OH_AVCodecBufferFlags::AVCODEC_BUFFER_FLAGS_EOS) &#123;
            videoIsEnd = true;
         &#125;
      &#125;
   &#125;
&#125;
OH_AVBuffer_Destroy(buffer);
</code></pre>
<p>Use <code>OH_AVDemuxer_SeekToTime</code> to seek to a specific time (like scrubbing in a player).  </p>
<h4 id="8-Destroy-Demultiplexer-Resources"><a href="#8-Destroy-Demultiplexer-Resources" class="headerlink" title="8. Destroy Demultiplexer Resources"></a>8. Destroy Demultiplexer Resources</h4><pre><code class="language-c">OH_AVSource_Destroy(source);
OH_AVDemuxer_Destroy(demuxer);
</code></pre>
<h3 id="Decoding"><a href="#Decoding" class="headerlink" title="Decoding"></a>Decoding</h3><p>HarmonyOS Next supports AVC (H.264) and HEVC (H.265) for both software and hardware decoding.  </p>
<p>Decoded data can be output via:  </p>
<ul>
<li><strong>Surface</strong>: Uses <code>OHNativeWindow</code> for data transfer (e.g., to XComponent).  </li>
<li><strong>Buffer</strong>: Outputs decoded data via shared memory.</li>
</ul>
<p>Like Android’s MediaCodec, HarmonyOS Next decoders operate as state machines with six main states:<br><img src="/../images/HarmonyOS%20Next%20%E8%A7%86%E9%A2%91%E5%8E%8B%E7%BC%A9%E7%BC%96%E7%A0%81%E5%8E%9F%E7%90%86%E4%B8%8E%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5-3.png"> </p>
<p>State transitions:  </p>
<ul>
<li><code>OH_VideoDecoder_Reset</code> or creation → <code>Initialized</code>  </li>
<li><code>OH_VideoDecoder_Configure</code> → <code>Configured</code>  </li>
<li><code>OH_VideoDecoder_Prepare</code> → <code>Prepared</code>  </li>
<li><code>OH_VideoDecoder_Start</code> → <code>Executing</code>  </li>
<li><code>OH_VideoDecoder_Destroy</code> → <code>Released</code></li>
</ul>
<p>Refer to the official flow chart for the interaction process:<br>![[HarmonyOS Next 视频压缩编码原理与最佳实践-4.png]]  </p>
<p>Dynamic libraries for codecs:  </p>
<ul>
<li><code>libnative_media_codecbase.so</code>: Codec base library  </li>
<li><code>libnative_media_core.so</code>: Media processing core  </li>
<li><code>libnative_media_venc.so</code>: Video encoding  </li>
<li><code>libnative_media_vdec.so</code>: Video decoding</li>
</ul>
<p>For specific interfaces, see the official example:<br><a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/video-decoding-V5">https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/video-decoding-V5</a>  </p>
<p>Decoders accept buffers from demuxers and output YUV buffers or surface data. Use <code>OH_VideoDecoder_SetSurface(videoDec, window)</code> to set a surface for direct rendering (reducing data copy overhead). Data writing is triggered via callback functions registered with <code>OH_VideoDecoder_RegisterCallback</code>:  </p>
<pre><code class="language-c">// Error callback implementation
static void OnError(OH_AVCodec *codec, int32_t errorCode, void *userData)
&#123;
    (void)codec;
    (void)errorCode;
    (void)userData;
&#125;

// Stream change callback implementation
static void OnStreamChanged(OH_AVCodec *codec, OH_AVFormat *format, void *userData)
&#123;
    (void)codec;
    (void)userData;
    OH_AVFormat_GetIntValue(format, OH_MD_KEY_VIDEO_PIC_WIDTH, &amp;width);
    OH_AVFormat_GetIntValue(format, OH_MD_KEY_VIDEO_PIC_HEIGHT, &amp;height);
    OH_AVFormat_GetIntValue(format, OH_MD_KEY_VIDEO_STRIDE, &amp;widthStride);
    OH_AVFormat_GetIntValue(format, OH_MD_KEY_VIDEO_SLICE_HEIGHT, &amp;heightStride);
&#125;

// Input buffer request callback implementation
static void OnNeedInputBuffer(OH_AVCodec *codec, uint32_t index, OH_AVBuffer *buffer, void *userData)
&#123;
    // Process input buffer index and data
&#125;

// New output buffer callback implementation (buffer is null in Surface mode)
static void OnNewOutputBuffer(OH_AVCodec *codec, uint32_t index, OH_AVBuffer *buffer, void *userData)
&#123;
    // Process output buffer index and data
&#125;

// Register asynchronous callbacks
OH_AVCodecCallback cb = &#123;&amp;OnError, &amp;OnStreamChanged, &amp;OnNeedInputBuffer, &amp;OnNewOutputBuffer&#125;;
int32_t ret = OH_VideoDecoder_RegisterCallback(videoDec, cb, NULL);
if (ret != AV_ERR_OK) &#123;
    // Error handling
&#125;
</code></pre>
<p><strong>Software vs. Hardware Decoding Differences</strong>:  </p>
<ul>
<li>Software decoding (via MimeType) currently supports only H.264 (<code>OH_AVCODEC_MIMETYPE_VIDEO_AVC</code>).  </li>
<li>Hardware decoding supports H.264 and H.265 (<code>OH_AVCODEC_MIMETYPE_VIDEO_HEVC</code>).</li>
</ul>
<h3 id="Encoding"><a href="#Encoding" class="headerlink" title="Encoding"></a>Encoding</h3><p>Video encoding is the reverse of decoding, currently supporting only hardware encoding for H.264 and H.265.  </p>
<p>Encoders accept input via Surface or Buffer modes (e.g., screen rendering or camera capture data).  </p>
<p>Like decoders, encoders operate as state machines:<br><img src="/../images/HarmonyOS%20Next%20%E8%A7%86%E9%A2%91%E5%8E%8B%E7%BC%A9%E7%BC%96%E7%A0%81%E5%8E%9F%E7%90%86%E4%B8%8E%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5-5.png"></p>
<p>Refer to the official flow chart for the encoding process:<br><img src="/../images/HarmonyOS%20Next%20%E8%A7%86%E9%A2%91%E5%8E%8B%E7%BC%A9%E7%BC%96%E7%A0%81%E5%8E%9F%E7%90%86%E4%B8%8E%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5-6.png"></p>
<p>For specific interfaces, see:<br><a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/video-encoding-V5">https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/video-encoding-V5</a>  </p>
<p>To compress videos, focus on encoder configuration:  </p>
<pre><code class="language-c">// Configure encoder parameters
double frameRate = 30.0;
bool rangeFlag = false;
int32_t primary = static_cast&lt;int32_t&gt;(OH_ColorPrimary::COLOR_PRIMARY_BT709);
int32_t transfer = static_cast&lt;int32_t&gt;(OH_TransferCharacteristic::TRANSFER_CHARACTERISTIC_BT709);
int32_t matrix = static_cast&lt;int32_t&gt;(OH_MatrixCoefficient::MATRIX_COEFFICIENT_IDENTITY);
int32_t profile = static_cast&lt;int32_t&gt;(OH_AVCProfile::AVC_PROFILE_BASELINE);
int32_t rateMode = static_cast&lt;int32_t&gt;(OH_VideoEncodeBitrateMode::CBR);
int32_t iFrameInterval = 23000;
int64_t bitRate = 3000000;
int64_t quality = 0;

// Create and configure the format
OH_AVFormat *format = OH_AVFormat_Create();
OH_AVFormat_SetIntValue(format, OH_MD_KEY_WIDTH, width);       // Required
OH_AVFormat_SetIntValue(format, OH_MD_KEY_HEIGHT, height);     // Required
OH_AVFormat_SetIntValue(format, OH_MD_KEY_PIXEL_FORMAT, DEFAULT_PIXELFORMAT); // Required

OH_AVFormat_SetDoubleValue(format, OH_MD_KEY_FRAME_RATE, frameRate);
OH_AVFormat_SetIntValue(format, OH_MD_KEY_RANGE_FLAG, rangeFlag);
OH_AVFormat_SetIntValue(format, OH_MD_KEY_COLOR_PRIMARIES, primary);
OH_AVFormat_SetIntValue(format, OH_MD_KEY_TRANSFER_CHARACTERISTICS, transfer);
OH_AVFormat_SetIntValue(format, OH_MD_KEY_MATRIX_COEFFICIENTS, matrix);
OH_AVFormat_SetIntValue(format, OH_MD_KEY_I_FRAME_INTERVAL, iFrameInterval);
OH_AVFormat_SetIntValue(format, OH_MD_KEY_PROFILE, profile);

// Set bitrate based on rate mode
if (rateMode == static_cast&lt;int32_t&gt;(OH_VideoEncodeBitrateMode::CQ)) &#123;
    OH_AVFormat_SetIntValue(format, OH_MD_KEY_QUALITY, quality);
&#125; else if (rateMode == static_cast&lt;int32_t&gt;(OH_VideoEncodeBit
</code></pre>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://harmonyostech.github.io/2025/06/30/C-Mastering-HarmonyOS-Next-Logging-Knowledge/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Qingkouwei">
      <meta itemprop="description" content="Welcome to the HarmonyOS NEXT Knowledge Charging Station!  This is a hub for knowledge about HarmonyOS Next`s new-generation system. With its self-developed kernel, HarmonyOS NEXT achieves native smoothness, security, intelligence, and interconnectivity. We deeply analyze how its new distributed soft bus revolutionizes device connectivity experiences and explain the principles behind the enhanced perception and reasoning capabilities of the Xiaoyi intelligent agent based on the Pangu large model. Whether you are a developer exploring application development or an ordinary user eager to understand system features, you can "recharge" here and quickly grasp the essence of HarmonyOS NEXT.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HarmonyOS NEXT Knowledge Charging Station">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/06/30/C-Mastering-HarmonyOS-Next-Logging-Knowledge/" class="post-title-link" itemprop="url">Mastering HarmonyOS Next Logging Knowledge</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2025-06-30 22:03:28 / Modified: 22:04:10" itemprop="dateCreated datePublished" datetime="2025-06-30T22:03:28+08:00">2025-06-30</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/HarmonyOS-Next-Tech/" itemprop="url" rel="index"><span itemprop="name">HarmonyOS Next Tech</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Mastering-HarmonyOS-Next-Logging-Knowledge"><a href="#Mastering-HarmonyOS-Next-Logging-Knowledge" class="headerlink" title="Mastering HarmonyOS Next Logging Knowledge"></a>Mastering HarmonyOS Next Logging Knowledge</h1><p>Logs are essential debugging tools in daily development. Good logging tools and calls help quickly locate development or online issues, significantly improving development efficiency. In addition to supporting TS console logging, HarmonyOS Next provides the hilog tool for logging at both the ArkTS and C++ layers. We can also use encapsulated persistent logging tools to help resolve online issues.  </p>
<p>Below is a detailed introduction to these tools.  </p>
<h3 id="1-Console-Tool"><a href="#1-Console-Tool" class="headerlink" title="1. Console Tool"></a>1. Console Tool</h3><p>The Console module provides a simple debugging console, similar to the JavaScript console mechanism in browsers.<br>The console module offers log levels including:  </p>
<ul>
<li>console.debug  </li>
<li>console.info  </li>
<li>console.warn  </li>
<li>console.error  </li>
<li>console.assert  </li>
<li>console.log</li>
</ul>
<p>These functions print logs of different levels in a formatted manner. <code>console.info</code> and <code>console.log</code> have identical functions, with <code>console.info</code> being an alias for <code>console.log</code>. The function parameters are:  </p>
<table>
<thead>
<tr>
<th align="left">Parameter Name</th>
<th align="left">Type</th>
<th align="left">Required</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody><tr>
<td align="left">message</td>
<td align="left">string</td>
<td align="left">Yes</td>
<td align="left">The text information to print.</td>
</tr>
<tr>
<td align="left">arguments</td>
<td align="left">any[]</td>
<td align="left">No</td>
<td align="left">Additional information to print or replacement values for <code>message</code>.</td>
</tr>
</tbody></table>
<p><strong>Examples</strong>:  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">const number = 5;</span><br><span class="line">console.info(&#x27;count: %d&#x27;, number);  // Formatted output replaces text in message.</span><br><span class="line">// count: 5 </span><br><span class="line">console.info(&#x27;count:&#x27;, number);  // Prints message and additional info</span><br><span class="line">// count: 5 </span><br><span class="line">console.info(&#x27;count:&#x27;); // Only prints message</span><br><span class="line">// count: </span><br><span class="line"></span><br><span class="line">const str = &quot;name should be string&quot;;</span><br><span class="line">console.warn(&#x27;warn: %d&#x27;, str);  // Formatted output replaces text in message.</span><br><span class="line">// warn: name should be string</span><br><span class="line">console.warn(&#x27;warn:&#x27;, str);  // Prints message and additional info</span><br><span class="line">// warn: name should be string</span><br><span class="line">console.warn(&#x27;warn:&#x27;); // Only prints message</span><br><span class="line">// warn: </span><br><span class="line"></span><br><span class="line">const str = &quot;value is not defined&quot;;</span><br><span class="line">console.error(&#x27;error: %d&#x27;, str);  // Formatted output replaces text in message.</span><br><span class="line">// error: value is not defined</span><br><span class="line">console.error(&#x27;error:&#x27;, str);  // Prints message and additional info</span><br><span class="line">// error: value is not defined</span><br><span class="line">console.error(&#x27;error:&#x27;); // Only prints message</span><br><span class="line">// error: </span><br><span class="line">```  </span><br><span class="line"></span><br><span class="line">The `console.assert` function has slightly different parameters:  </span><br><span class="line"></span><br><span class="line">| Parameter Name | Type    | Required | Description                                                                 |</span><br><span class="line">| :------------- | :------ | :------- | :-------------------------------------------------------------------------- |</span><br><span class="line">| value          | Object  | No       | The result of the assertion. If `value` is false or omitted, outputs &quot;Assertion failed&quot;. If true, no output. |</span><br><span class="line">| arguments      | Object  | No       | Error message printed when `value` is false. Omitted for no output.         |</span><br><span class="line"></span><br><span class="line">**Examples**:  </span><br></pre></td></tr></table></figure>
<p>console.assert(true, ‘does nothing’);  &#x2F;&#x2F; Expression is true, no output.<br>console.assert(2 % 1 &#x3D;&#x3D; 0, ‘does nothing’);  &#x2F;&#x2F; Expression is true, no output.</p>
<p>console.assert(false, ‘console %s work’, ‘didn&#39;t’);<br>&#x2F;&#x2F; Assertion failed: console didn’t work</p>
<p>console.assert();<br>&#x2F;&#x2F; Assertion failed</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">The `console.count` function maintains an internal counter, printing the label and count each time it&#x27;s called:  </span><br></pre></td></tr></table></figure>
<p>console.count()<br>&#x2F;&#x2F; default: 1<br>console.count(‘default’)<br>&#x2F;&#x2F; default: 2<br>console.count(‘abc’)<br>&#x2F;&#x2F; abc: 1<br>console.count(‘xyz’)<br>&#x2F;&#x2F; xyz: 1<br>console.count(‘abc’)<br>&#x2F;&#x2F; abc: 2<br>console.count()<br>&#x2F;&#x2F; default: 3</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">Use `console.countReset` to clear the count for a specific label.  </span><br><span class="line"></span><br><span class="line">`console.dir` prints object contents:  </span><br></pre></td></tr></table></figure>
<p>class bar {<br>  baz: boolean &#x3D; true;<br>}<br>let b: bar &#x3D; {baz: true}<br>class foo{<br>  bar: bar &#x3D; b;<br>}<br>let c: foo &#x3D; {bar: b}<br>class  c1{<br>  foo: foo &#x3D; c;<br>}<br>let a: c1 &#x3D; {foo: c}<br>console.dir(a);<br>&#x2F;&#x2F; Object: {“foo”:{“bar”:{“baz”:true}}}</p>
<p>console.dir(); &#x2F;&#x2F; No output</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">`console.dirxml` is implemented by internally calling `console.log()`, producing no XML format. It functions as an alias for `console.log()`:  </span><br></pre></td></tr></table></figure>
<p>const number &#x3D; 5;<br>console.dirxml(‘count: %d’, number);<br>&#x2F;&#x2F; count: 5<br>console.dirxml(‘count:’, number);<br>&#x2F;&#x2F; count: 5<br>console.dirxml(‘count:’);<br>&#x2F;&#x2F; count: </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">`console.group` increases indentation by two spaces for subsequent lines. If a message is provided, it prints the message first without extra indentation:  </span><br></pre></td></tr></table></figure>
<p>console.log(“outter”);<br>&#x2F;&#x2F; outter<br>console.group();<br>console.log(“level 1”);<br>&#x2F;&#x2F;   level 1<br>console.group(“in level1”);<br>&#x2F;&#x2F;   in level1<br>console.log(“level 2”);<br>&#x2F;&#x2F;     level 2</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">`console.groupCollapsed` behaves the same as `console.group()`. `console.groupEnd` decreases indentation by two spaces:  </span><br></pre></td></tr></table></figure>
<p>console.log(“outter”);<br>&#x2F;&#x2F; outter<br>console.group();<br>console.log(“level 1”);<br>&#x2F;&#x2F;   level 1<br>console.groupEnd();<br>console.log(“outter”);<br>&#x2F;&#x2F; outter</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">`console.table` prints data in a table format:  </span><br></pre></td></tr></table></figure>
<p>console.table([1, 2, 3]);<br>&#x2F;&#x2F; ┌─────────┬────────┐<br>&#x2F;&#x2F; │ (index) │ Values │<br>&#x2F;&#x2F; ├─────────┼────────┤<br>&#x2F;&#x2F; │    0    │   1    │<br>&#x2F;&#x2F; │    1    │   2    │<br>&#x2F;&#x2F; │    2    │   3    │<br>&#x2F;&#x2F; └─────────┴────────┘</p>
<p>console.table({ a: [1, 2, 3, 4, 5], b: 5, c: { e: 5 } });</p>
<p>&#x2F;&#x2F; ┌─────────┬───┬───┬───┬───┬───┬───┬────────┐<br>&#x2F;&#x2F; │ (index) │ 0 │ 1 │ 2 │ 3 │ 4 │ e │ Values │<br>&#x2F;&#x2F; ├─────────┼───┼───┼───┼───┼───┼───┼────────┤<br>&#x2F;&#x2F; │    a    │ 1 │ 2 │ 3 │ 4 │ 5 │   │        │<br>&#x2F;&#x2F; │    b    │   │   │   │   │   │   │   5    │<br>&#x2F;&#x2F; │    c    │   │   │   │   │   │ 5 │        │<br>&#x2F;&#x2F; └─────────┴───┴───┴───┴───┴───┴───┴────────┘</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">`console.time` starts a timer to measure operation duration. Use `console.timeEnd()` to stop the timer and print the elapsed time (in ms):  </span><br></pre></td></tr></table></figure>
<p>console.time(‘abc’);<br>console.timeEnd(‘abc’);<br>&#x2F;&#x2F; abc: 225.438ms</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">`console.timeLog` prints the elapsed time and additional data for a timer started by `console.time()`:  </span><br></pre></td></tr></table></figure>
<p>console.time(‘timer1’);<br>console.timeLog(‘timer1’, 17);<br>&#x2F;&#x2F; timer1: 365.227ms 17<br>console.timeEnd(‘timer1’);<br>&#x2F;&#x2F; timer1: 513.22ms</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">`console.trace` prints the current stack:  </span><br></pre></td></tr></table></figure>
<p>console.trace();<br>&#x2F;&#x2F; Trace:<br>&#x2F;&#x2F;     xxxxxxxxxx(Current stack information)<br>console.trace(“Show the trace”);<br>&#x2F;&#x2F; Trace: Show the trace<br>&#x2F;&#x2F;     xxxxxxxxxx(Current stack information)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">`console.traceHybridStack` prints the hybrid stack information of the current thread in the main thread/worker thread:  </span><br></pre></td></tr></table></figure>
<p>console.traceHybridStack();<br>&#x2F;&#x2F; TraceHybridStack:<br>&#x2F;&#x2F;     xxxxxxxxxx(Current thread hybrid stack information)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">### 2. HiLog  </span><br><span class="line">The HiLog logging system allows applications/services to output logs with specified levels, identifiers, and format strings, helping developers understand runtime status and debug programs effectively.  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#### 2.1 HiLog in ArkTS  </span><br><span class="line">First, import the module:  </span><br></pre></td></tr></table></figure>
<p>import { hilog } from ‘@kit.PerformanceAnalysisKit’;</p>
<pre><code>
HiLog provides logging functions for different levels, similar to console:  
- `hilog.debug`: DEBUG-level logs are not printed by default in release versions, only in debug versions or when the debug switch is enabled.  
- `hilog.info`  
- `hilog.warn`  
- `hilog.error`  
- `hilog.fatal`  

**Parameter Description**:  

| Parameter Name | Type     | Required | Description                                                                 |
| :------------- | :------- | :------- | :-------------------------------------------------------------------------- |
| domain         | number   | Yes      | Domain identifier for logs, ranging from 0x0 to 0xFFFF.&lt;br&gt;&lt;br&gt;Developers should customize it based on application needs. |
| tag            | string   | Yes      | Log identifier, can be any string. Suggested to identify the calling class or business behavior. The tag is limited to 31 bytes (truncated if exceeded); Chinese characters are not recommended to avoid garbling or alignment issues. |
| format         | string   | Yes      | Format string for formatted log output. It can contain multiple parameters with type and privacy identifiers.&lt;br&gt;&lt;br&gt;Privacy identifiers are &#123;public&#125; and &#123;private&#125; (default is &#123;private&#125;). &#123;public&#125; content is output in plain text, while &#123;private&#125; content is filtered as &lt;private&gt;. |
| args           | any[]    | No       | Variable-length parameter list corresponding to `format`. The number and types of parameters must match the identifiers in the format string. |

**Privacy Identifier Example**:  
Output a FATAL message with the format string `&quot;%&#123;public&#125;s World %&#123;private&#125;d&quot;`, where `%&#123;public&#125;s` is a plain-text string and `%&#123;private&#125;d` is a private integer:  
```typescript
hilog.fatal(0x0001, &quot;testTag&quot;, &quot;%&#123;public&#125;s World %&#123;private&#125;d&quot;, &quot;hello&quot;, 3);
</code></pre>
<p>Output:<br><code>08-05 12:21:47.579  2695 2703 F A00001/testTag: hello World &lt;private&gt;</code><br><strong>If logs show <private>, check the privacy identifier configuration.</strong>  </p>
<p>HiLog also provides the <code>isLoggable</code> function to check if logs of a specified domain, tag, and level can be printed before logging. Parameter description:  </p>
<table>
<thead>
<tr>
<th align="left">Parameter Name</th>
<th align="left">Type</th>
<th align="left">Required</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody><tr>
<td align="left">domain</td>
<td align="left">number</td>
<td align="left">Yes</td>
<td align="left">Domain identifier for logs, ranging from 0x0 to 0xFFFF.<br><br>Developers should customize it based on application needs.</td>
</tr>
<tr>
<td align="left">tag</td>
<td align="left">string</td>
<td align="left">Yes</td>
<td align="left">Log identifier, can be any string. Suggested to identify the calling class or business behavior. The tag is limited to 31 bytes (truncated if exceeded); Chinese characters are not recommended to avoid garbling or alignment issues.</td>
</tr>
<tr>
<td align="left">level</td>
<td align="left">LogLevel</td>
<td align="left">Yes</td>
<td align="left">Log level.</td>
</tr>
</tbody></table>
<p>Returns <code>true</code> if logging is allowed, otherwise <code>false</code>.  </p>
<h4 id="2-2-HiLog-in-C"><a href="#2-2-HiLog-in-C" class="headerlink" title="2.2 HiLog in C++"></a>2.2 HiLog in C++</h4><p>In C++ code, developers can use these interfaces to implement logging, specifying log type, business domain, TAG, level, etc.  </p>
<p>During application development, log messages can be output at key code points. After running the application, analyze the logs to check execution (e.g., normal operation, timing, logical branches).  </p>
<p>The HiLog system provides logging for system frameworks, services, and applications to record user operations and system status.  </p>
<p>HiLog defines five log levels (DEBUG, INFO, WARN, ERROR, FATAL) with corresponding methods, as shown in the table:  </p>
<table>
<thead>
<tr>
<th align="left">Method&#x2F;Macro</th>
<th align="left">Interface Description</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><code>bool OH_LOG_IsLoggable(unsigned int domain, const char *tag, LogLevel level)</code></td>
<td align="left">Checks if logs with the specified domain, tag, and level can be printed.<br><br>Returns <code>true</code> if allowed; otherwise <code>false</code>.</td>
</tr>
<tr>
<td align="left"><code>int OH_LOG_Print(LogType type, LogLevel level, unsigned int domain, const char *tag, const char *fmt, ...)</code></td>
<td align="left">Outputs logs with the specified domain, tag, and level, and determines variable parameters for output based on printf format and privacy indicators.<br><br>Returns the total byte count on success; <code>-1</code> on failure.</td>
</tr>
<tr>
<td align="left"><code>#define OH_LOG_DEBUG(type, ...) ((void)OH_LOG_Print((type), LOG_DEBUG, LOG_DOMAIN, LOG_TAG, __VA_ARGS__))</code></td>
<td align="left">DEBUG-level logging (macro-wrapped interface).</td>
</tr>
<tr>
<td align="left"><code>#define OH_LOG_INFO(type, ...) ((void)OH_LOG_Print((type), LOG_INFO, LOG_DOMAIN, LOG_TAG, __VA_ARGS__))</code></td>
<td align="left">INFO-level logging (macro-wrapped interface).</td>
</tr>
<tr>
<td align="left"><code>#define OH_LOG_WARN(type, ...) ((void)OH_LOG_Print((type), LOG_WARN, LOG_DOMAIN, LOG_TAG, __VA_ARGS__))</code></td>
<td align="left">WARN-level logging (macro-wrapped interface).</td>
</tr>
<tr>
<td align="left"><code>#define OH_LOG_ERROR(type, ...) ((void)OH_LOG_Print((type), LOG_ERROR, LOG_DOMAIN, LOG_TAG, __VA_ARGS__))</code></td>
<td align="left">ERROR-level logging (macro-wrapped interface).</td>
</tr>
<tr>
<td align="left"><code>#define OH_LOG_FATAL(type, ...) ((void)OH_LOG_Print((type), LOG_FATAL, LOG_DOMAIN, LOG_TAG, __VA_ARGS__))</code></td>
<td align="left">FATAL-level logging (macro-wrapped interface).</td>
</tr>
<tr>
<td align="left"><code>void OH_LOG_SetCallback(LogCallback callback)</code></td>
<td align="left">Registers a function to obtain all HiLog logs of the process via the <code>LogCallback</code> callback.</td>
</tr>
</tbody></table>
<p><code>OH_LOG_IsLoggable()</code> and <code>OH_LOG_Print()</code> should use consistent <code>domain</code>, <code>tag</code>, and <code>level</code>:  </p>
<ul>
<li><code>domain</code>: Specifies the business domain for logs, ranging from 0x0000 to 0xFFFF (customizable by developers).  </li>
<li><code>tag</code>: Specifies the log identifier (any string, suggested to identify the calling class or behavior). Limited to 31 bytes (truncated if exceeded); Chinese characters are not recommended.  </li>
<li><code>level</code>: Specifies the log level (see <code>LogLevel</code>).  </li>
<li><code>fmt</code>: Format string for formatted log output. Log formatting parameters must follow the <code>%&#123;private flag&#125;specifier</code> format.</li>
</ul>
<table>
<thead>
<tr>
<th align="left">Privacy Indicator (private flag)</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody><tr>
<td align="left">private</td>
<td align="left">Log output is invisible (shows as <private>).</td>
</tr>
<tr>
<td align="left">public</td>
<td align="left">Log output is visible (plain text).</td>
</tr>
<tr>
<td align="left">None</td>
<td align="left">Defaults to private (invisible output).</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th align="left">Format Specifier (specifier)</th>
<th align="left">Description</th>
<th align="left">Example</th>
</tr>
</thead>
<tbody><tr>
<td align="left">d&#x2F;i</td>
<td align="left">Supports number, bool, and bigint.</td>
<td align="left">123</td>
</tr>
<tr>
<td align="left">s</td>
<td align="left">Supports string, undefined, and null.</td>
<td align="left">“123”</td>
</tr>
</tbody></table>
<ul>
<li>The format string can contain multiple parameters (e.g., <code>&quot;%s World&quot;</code>, where <code>%s</code> is a string parameter defined in <code>args</code>).  </li>
<li><code>args</code>: 0 or more parameters corresponding to the format string. The number and types must match the format specifiers.</li>
</ul>
<p><strong>Logs are limited to 4096 bytes; exceeding this will truncate the text.</strong>  </p>
<p>To use HiLog in C++, first link the dynamic library (e.g., in <code>CMakeLists.txt</code>):  </p>
<pre><code class="language-cmake">target_link_libraries(entry PUBLIC libhilog_ndk.z.so)
</code></pre>
<p>Import the header file:  </p>
<pre><code class="language-cpp">#include &quot;hilog/log.h&quot;
</code></pre>
<p>Define macros:  </p>
<pre><code class="language-cpp">#undef LOG_DOMAIN
#undef LOG_TAG
#define LOG_DOMAIN 0x3200  // Global domain macro for business domain
#define LOG_TAG &quot;MY_TAG&quot;   // Global tag macro for module logging
</code></pre>
<p>Then use logging:  </p>
<pre><code class="language-cpp">OH_LOG_ERROR(LOG_APP, &quot;Failed to visit %&#123;private&#125;s, reason:%&#123;public&#125;d.&quot;, url, errno);
</code></pre>
<h3 id="3-Best-Practices"><a href="#3-Best-Practices" class="headerlink" title="3. Best Practices"></a>3. Best Practices</h3><p>In application layers, we typically encapsulate logging tools to control log levels based on debug&#x2F;release environments, a mature practice in Android and iOS.  </p>
<p>However, logs from HiLog or console can only be viewed in the console. How to locate online issues via logs? Android and iOS have solutions using mmap to persist logs to device storage for later retrieval. We have ported the open-source library mars (which provides persistent logging) to HarmonyOS, but details are beyond this article’s scope.  </p>
<h3 id="4-Summary"><a href="#4-Summary" class="headerlink" title="4. Summary"></a>4. Summary</h3><p>This article introduces HarmonyOS’s console and HiLog logging frameworks, details their APIs, and outlines practical logging usage and persistent logging strategies in development.</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://harmonyostech.github.io/2025/06/30/C-Introduction-to-HarmonyOS-Next-Build-Tool-Lycium-Principles/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Qingkouwei">
      <meta itemprop="description" content="Welcome to the HarmonyOS NEXT Knowledge Charging Station!  This is a hub for knowledge about HarmonyOS Next`s new-generation system. With its self-developed kernel, HarmonyOS NEXT achieves native smoothness, security, intelligence, and interconnectivity. We deeply analyze how its new distributed soft bus revolutionizes device connectivity experiences and explain the principles behind the enhanced perception and reasoning capabilities of the Xiaoyi intelligent agent based on the Pangu large model. Whether you are a developer exploring application development or an ordinary user eager to understand system features, you can "recharge" here and quickly grasp the essence of HarmonyOS NEXT.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HarmonyOS NEXT Knowledge Charging Station">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/06/30/C-Introduction-to-HarmonyOS-Next-Build-Tool-Lycium-Principles/" class="post-title-link" itemprop="url">Introduction to HarmonyOS Next Build Tool Lycium Principles</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2025-06-30 22:01:45 / Modified: 22:48:30" itemprop="dateCreated datePublished" datetime="2025-06-30T22:01:45+08:00">2025-06-30</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/HarmonyOS-Next-Tech/" itemprop="url" rel="index"><span itemprop="name">HarmonyOS Next Tech</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Introduction-to-HarmonyOS-Next-Build-Tool-Lycium-Principles"><a href="#Introduction-to-HarmonyOS-Next-Build-Tool-Lycium-Principles" class="headerlink" title="Introduction to HarmonyOS Next Build Tool Lycium Principles"></a>Introduction to HarmonyOS Next Build Tool Lycium Principles</h1><p><img src="/../images/HarmonyOS%20Next%20%E6%9E%84%E5%BB%BA%E5%B7%A5%E5%85%B7%20lycium%20%E5%8E%9F%E7%90%86%E4%BB%8B%E7%BB%8D.png"></p>
<h3 id="Background-Introduction"><a href="#Background-Introduction" class="headerlink" title="Background Introduction"></a>Background Introduction</h3><p>Many system APIs in HarmonyOS Next are provided as C++ interfaces. To use C++ interfaces, NAPI must be used for interaction between ArkTS and C++. In such scenarios, the cross-compilation tools integrated in DevEco-Studio and the CMake build tool are fully sufficient. However, for scenarios involving third-party library migration, such as FFmpeg and OpenSSL, configuring the compilation environment and scripts independently can be cumbersome. Key concerns during cross-compilation include: how to perform cross-compilation with different build methods, how to configure cross-compilation environments for different build platforms, how to configure different cross-compilation architectures, and how to test and verify artifacts after cross-compilation. Currently, open-source C&#x2F;C++ third-party libraries have diverse compilation methods, with the following mainstream cross-compilation approaches:  </p>
<ul>
<li>CMake build  </li>
<li>Configure build  </li>
<li>Make build</li>
</ul>
<p>The official cross-compilation tool Lycium helps quickly build third-party libraries.  </p>
<h3 id="Introduction-to-Lycium-Tool"><a href="#Introduction-to-Lycium-Tool" class="headerlink" title="Introduction to Lycium Tool"></a>Introduction to Lycium Tool</h3><p>Lycium is a compilation framework tool that assists developers in achieving rapid cross-compilation of C&#x2F;C++ third-party libraries through shell scripts and quick verification on the OpenHarmony system. Developers only need to set the compilation method and parameters for the corresponding C&#x2F;C++ third-party library, and Lycium can quickly build binary files operable on the OpenHarmony system.  </p>
<p>The construction principle of Lycium is that the transplantation process must not modify source code (i.e., no patching of C&#x2F;C++ files or build scripts). If patching is necessary for transplantation, it must undergo review with sufficient justification. (Business patches are not accepted.)  </p>
<p>Lycium build tool address: <a target="_blank" rel="noopener" href="https://gitee.com/openharmony-sig/tpc_c_cplusplus">https://gitee.com/openharmony-sig/tpc_c_cplusplus</a>  </p>
<h3 id="Usage-Example"><a href="#Usage-Example" class="headerlink" title="Usage Example"></a>Usage Example</h3><ol>
<li><strong>Compilation Environment Preparation</strong>: The Lycium framework supports third-party libraries with various build methods. To ensure normal compilation, the environment must include basic compilation commands: <code>gcc</code>, <code>cmake</code>, <code>make</code>, <code>pkg-config</code>, <code>autoconf</code>, <code>autoreconf</code>, <code>automake</code>. If any command is missing, download the corresponding toolset from the official website or install it via commands on the build machine. For example, install CMake on Ubuntu with: <code>sudo apt install cmake</code>.  </li>
<li><strong>Modify Third-Party Library Compilation Methods and Parameters</strong>: The Lycium framework provides an HPKBUILD file for developers to configure compilation settings for corresponding C&#x2F;C++ third-party libraries. Specific steps:  <ul>
<li>Create a new directory for the third-party library named <code>pkgname</code> under the <code>thirdparty</code> directory.  </li>
<li>Copy the HPKBUILD template file to the new third-party library directory.  </li>
<li>Modify the HPKBUILD template based on the actual situation of the third-party library, referring to the minizip co-construction for file modification.</li>
</ul>
</li>
<li><strong>Quick Compilation of Third-Party Libraries</strong>: After configuring the compilation method parameters for the third-party library, execute <code>./build.sh pkgname</code> in the Lycium directory to automatically compile the library and package it into <code>usr/pkgname/ARCH/</code> in the current directory.  <ul>
<li><code>ARCH</code> directory: <code>./build.sh</code> (compiles all libraries in the <code>thirdparty</code> directory by default).  </li>
<li><code>./build.sh aaa bbb ccc ...</code> (compiles specified libraries <code>aaa</code>, <code>bbb</code>, <code>ccc</code>, etc., in the <code>thirdparty</code> directory; if <code>aaa</code> has dependencies, ensure they are included in the parameters, or <code>aaa</code> will not compile).</li>
</ul>
</li>
</ol>
<p><strong>The Lycium framework is written in Linux shell scripts</strong>. Next, we analyze the shell code of the build tool to understand the build process, which helps locate compilation failures.  </p>
<h3 id="Introduction-to-Build-Script-Principles"><a href="#Introduction-to-Build-Script-Principles" class="headerlink" title="Introduction to Build Script Principles"></a>Introduction to Build Script Principles</h3><p>The Lycium framework mainly consists of the following components:  </p>
<ol>
<li>HPKBUILD build configuration  </li>
<li>Top-level build script <code>build.sh</code>  </li>
<li>Cross-compilation toolchain  </li>
<li>Test verification environment</li>
</ol>
<h4 id="Build-Process"><a href="#Build-Process" class="headerlink" title="Build Process"></a>Build Process</h4><h5 id="1-Build-Configuration-Preparation"><a href="#1-Build-Configuration-Preparation" class="headerlink" title="1. Build Configuration Preparation"></a>1. Build Configuration Preparation</h5><p>Developers need to create a directory for the third-party library to be compiled under the <code>thirdparty</code> directory and write an HPKBUILD build configuration file. The HPKBUILD file defines:  </p>
<ul>
<li>Source code acquisition method  </li>
<li>Compilation parameter configuration  </li>
<li>Dependency declaration  </li>
<li>Installation rules</li>
</ul>
<p>HPKBUILD build configuration file example:  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br></pre></td><td class="code"><pre><span class="line"># Contributor: Jeff Han &lt;hanjinfei@foxmail.com&gt;</span><br><span class="line"># Maintainer: Jeff Han &lt;hanjinfei@foxmail.com&gt;</span><br><span class="line">pkgname=FFmpeg</span><br><span class="line">pkgver=n6.0</span><br><span class="line">pkgrel=0</span><br><span class="line">pkgdesc=&quot;FFmpeg is a collection of libraries and tools to process multimedia content such as audio, video, subtitles and related metadata.&quot;</span><br><span class="line">url=&quot;https://github.com/FFmpeg/FFmpeg/&quot;</span><br><span class="line">archs=(&quot;armeabi-v7a&quot; &quot;arm64-v8a&quot;)</span><br><span class="line">license=(&quot;GPL2&quot; &quot;GPL3&quot; &quot;LGPL3&quot; &quot;MIT&quot; &quot;X11&quot; &quot;BSD-styl&quot;)</span><br><span class="line">depends=(&quot;rtmpdump&quot; &quot;openssl_1_0_2u&quot;)</span><br><span class="line">makedepends=()</span><br><span class="line">source=&quot;https://github.com/FFmpeg/$pkgname/archive/refs/tags/$pkgver.tar.gz&quot;</span><br><span class="line"></span><br><span class="line">autounpack=false</span><br><span class="line">downloadpackage=true</span><br><span class="line">buildtools=&quot;configure&quot;</span><br><span class="line"></span><br><span class="line">builddir=$pkgname-$&#123;pkgver&#125;</span><br><span class="line">packagename=$builddir.tar.gz</span><br><span class="line">source envset.sh</span><br><span class="line">buildhost=true</span><br><span class="line">arch=</span><br><span class="line">ldflags=</span><br><span class="line"></span><br><span class="line">prepare() &#123;</span><br><span class="line">    if [ &quot;$LYCIUM_BUILD_OS&quot; == &quot;Linux&quot; ]</span><br><span class="line">    then</span><br><span class="line">        hostosname=linux</span><br><span class="line">    elif [ &quot;$LYCIUM_BUILD_OS&quot; == &quot;Darwi&quot; ]</span><br><span class="line">    then</span><br><span class="line">        hostosname=darwin</span><br><span class="line">    else</span><br><span class="line">        echo &quot;System cannot recognize, exiting&quot;</span><br><span class="line">        return -1</span><br><span class="line">    fi</span><br><span class="line">    if [ $buildhost == true ]</span><br><span class="line">    then</span><br><span class="line">        tar -zxf $packagename</span><br><span class="line">        cd $builddir</span><br><span class="line">        ./configure --enable-static --enable-shared --disable-doc --disable-htmlpages \</span><br><span class="line">            --target-os=$hostosname --disable-optimizations --prefix=`pwd`/hostbuild &gt; $publicbuildlog 2&gt;&amp;1</span><br><span class="line">        $MAKE &gt;&gt; $publicbuildlog 2&gt;&amp;1</span><br><span class="line">        $MAKE install &gt;&gt; $publicbuildlog 2&gt;&amp;1</span><br><span class="line">        export LD_LIBRARY_PATH=`pwd`/hostbuild/lib:$LD_LIBRARY_PATH</span><br><span class="line">        sed -i.bak &#x27;s/include $(SRC_PATH)\/tests\/fate\/source.mak/#include $(SRC_PATH)\/tests\/fate\/source.mak/g&#x27; tests/Makefile</span><br><span class="line">        $MAKE check &gt;&gt; $publicbuildlog 2&gt;&amp;1</span><br><span class="line">        ret=$?</span><br><span class="line">        buildhost=false</span><br><span class="line">        cd $OLDPWD</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    mkdir $pkgname-$ARCH-build</span><br><span class="line">    tar -zxf $packagename -C $pkgname-$ARCH-build</span><br><span class="line">    cd  $pkgname-$ARCH-build/$builddir</span><br><span class="line">    patch -p1 &lt; ../../FFmpeg_oh_test.patch</span><br><span class="line">    cd $OLDPWD</span><br><span class="line"></span><br><span class="line">    if [ $ARCH == &quot;armeabi-v7a&quot; ]</span><br><span class="line">    then</span><br><span class="line">        setarm32ENV</span><br><span class="line">        arch=arm</span><br><span class="line">        ldflags=&quot;-L$&#123;OHOS_SDK&#125;/native/sysroot/usr/lib/arm-linux-ohos&quot;</span><br><span class="line">    elif [ $ARCH == &quot;arm64-v8a&quot; ]</span><br><span class="line">    then</span><br><span class="line">        setarm64ENV</span><br><span class="line">        arch=aarch64</span><br><span class="line">        ldflags=&quot;-L$&#123;OHOS_SDK&#125;/native/sysroot/usr/lib/aarch64-linux-ohos&quot;</span><br><span class="line">    else</span><br><span class="line">        echo &quot;$&#123;ARCH&#125; not support&quot;</span><br><span class="line">        return -1</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    return $ret</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">build() &#123;</span><br><span class="line">    cd $pkgname-$ARCH-build/$builddir</span><br><span class="line">    PKG_CONFIG_LIBDIR=&quot;$&#123;pkgconfigpath&#125;&quot; ./configure &quot;$@&quot; --enable-neon --enable-asm --enable-network \</span><br><span class="line">    --disable-vulkan --enable-cross-compile --enable-librtmp --disable-x86asm --enable-openssl --enable-protocols \</span><br><span class="line">    --enable-static --enable-shared --disable-doc --disable-htmlpages --target-os=linux --arch=$arch \</span><br><span class="line">    --cc=$&#123;CC&#125; --ld=$&#123;CC&#125; --strip=$&#123;STRIP&#125; --host-cc=&quot;$&#123;CC&#125;&quot; --host-ld=&quot;$&#123;CC&#125;&quot; --host-os=linux \</span><br><span class="line">    --host-ldflags=$&#123;ldflags&#125; --sysroot=$&#123;OHOS_SDK&#125;/native/sysroot &gt; $buildlog 2&gt;&amp;1</span><br><span class="line">    $MAKE &gt;&gt; $buildlog 2&gt;&amp;1</span><br><span class="line">    ret=$?</span><br><span class="line">    cd $OLDPWD</span><br><span class="line">    return $ret</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">package() &#123;</span><br><span class="line">    cd $pkgname-$ARCH-build/$builddir</span><br><span class="line">    $MAKE install &gt;&gt; $buildlog 2&gt;&amp;1</span><br><span class="line">    cd $OLDPWD</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">checktestfiles() &#123;</span><br><span class="line">    cd $pkgname-$ARCH-build/$builddir/tests/ref</span><br><span class="line"></span><br><span class="line">    tmpdir=(&quot;fate&quot; &quot;acodec&quot; &quot;lavf&quot; &quot;lavf-fate&quot; &quot;pixfmt&quot; &quot;seek&quot; &quot;vsynth&quot;)</span><br><span class="line">    for dir in $&#123;tmpdir[*]&#125;</span><br><span class="line">    do</span><br><span class="line">        for file in `ls $dir`</span><br><span class="line">        do</span><br><span class="line">            if [ ! -f $dir/$file ]; then</span><br><span class="line">                continue</span><br><span class="line">            fi</span><br><span class="line">            str=`cat $dir/$file | grep &quot;\*tests&quot;`</span><br><span class="line">            if [ ! -z &quot;$str&quot; ]</span><br><span class="line">            then</span><br><span class="line">                sed -i.bak &#x27;s/\*tests/tests/g&#x27; $dir/$file</span><br><span class="line">            fi</span><br><span class="line">        done</span><br><span class="line">    done</span><br><span class="line"></span><br><span class="line">    cd $OLDPWD</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">copyhostbin() &#123;</span><br><span class="line">    file=$1</span><br><span class="line">    if [[ -f tests/$file ]] &amp;&amp; [[ ! -f tests/$file.$&#123;ARCH&#125; ]]</span><br><span class="line">    then</span><br><span class="line">        mv tests/$file tests/$file.$&#123;ARCH&#125;</span><br><span class="line">        cp ../../$builddir/tests/$file tests/$file</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">check() &#123;</span><br><span class="line">    cd $pkgname-$ARCH-build/$builddir</span><br><span class="line">    # disable running cmd</span><br><span class="line">    sed -i.bak &#x27;s/	$(Q)$(SRC_PATH)\/tests\/fate-run.sh/#	$(Q)$(SRC_PATH)\/tests\/fate-run.sh/g&#x27; tests/Makefile</span><br><span class="line">    # disable check git sources</span><br><span class="line">    sed -i.bak &#x27;s/include $(SRC_PATH)\/tests\/fate\/source.mak/#include $(SRC_PATH)\/tests\/fate\/source.mak/g&#x27; tests/Makefile</span><br><span class="line">    # disable check ffprobe,this use xmllint command, which ohos is not support</span><br><span class="line">    sed -i.bak &#x27;s/include $(SRC_PATH)\/tests\/fate\/ffprobe.mak/#include $(SRC_PATH)\/tests\/fate\/ffprobe.mak/g&#x27; tests/Makefile</span><br><span class="line"></span><br><span class="line">    # change x86 cmd for generate test target</span><br><span class="line">    mv ffmpeg ffmpeg.$&#123;ARCH&#125;</span><br><span class="line">    cp ../../$builddir/ffmpeg ./</span><br><span class="line">    retrytimes=0</span><br><span class="line">    ret=0</span><br><span class="line">    while true</span><br><span class="line">    do</span><br><span class="line">        $MAKE check &gt;&gt; $buildlog 2&gt;&amp;1</span><br><span class="line">        if [ $? -eq 0 ]</span><br><span class="line">        then</span><br><span class="line">            break;</span><br><span class="line">        fi</span><br><span class="line"></span><br><span class="line">        copyhostbin base64</span><br><span class="line">        copyhostbin audiomatch</span><br><span class="line">        copyhostbin audiogen</span><br><span class="line">        copyhostbin videogen</span><br><span class="line">        copyhostbin tiny_psnr</span><br><span class="line">        copyhostbin tiny_ssim</span><br><span class="line">        copyhostbin rotozoom</span><br><span class="line"></span><br><span class="line">        let retrytimes=$retrytimes+1</span><br><span class="line">        if [ $retrytimes -gt 4 ]</span><br><span class="line">        then</span><br><span class="line">            ret=1</span><br><span class="line">            break</span><br><span class="line">        fi</span><br><span class="line">    done</span><br><span class="line"></span><br><span class="line">    mv ffmpeg.$&#123;ARCH&#125; ffmpeg</span><br><span class="line">    for file in `ls tests/*.$&#123;ARCH&#125;`</span><br><span class="line">    do</span><br><span class="line">        tmpfile=$&#123;file%.*&#125;</span><br><span class="line">        mv $file $tmpfile</span><br><span class="line">    done</span><br><span class="line"></span><br><span class="line">    # reduction running cmd for real test</span><br><span class="line">    sed -i.bak &#x27;s/#	$(Q)$(SRC_PATH)\/tests\/fate-run.sh/	$(Q)$(SRC_PATH)\/tests\/fate-run.sh/g&#x27; tests/Makefile</span><br><span class="line">    cd $OLDPWD</span><br><span class="line">    checktestfiles</span><br><span class="line"></span><br><span class="line">    echo &quot;The test must be on an OpenHarmony device!&quot;</span><br><span class="line">    # skip running test on host</span><br><span class="line">    # real test CMD</span><br><span class="line">    # make check</span><br><span class="line"></span><br><span class="line">    return $ret</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">recoverpkgbuildenv() &#123;</span><br><span class="line">    unset arch</span><br><span class="line">    unset ldflags</span><br><span class="line">    if [ $ARCH == &quot;armeabi-v7a&quot; ]</span><br><span class="line">    then</span><br><span class="line">        unsetarm32ENV</span><br><span class="line">    elif [ $ARCH == &quot;arm64-v8a&quot; ]</span><br><span class="line">    then</span><br><span class="line">        unsetarm64ENV</span><br><span class="line">    else</span><br><span class="line">        echo &quot;$&#123;ARCH&#125; not support&quot;</span><br><span class="line">        return -1</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 清理环境</span><br><span class="line">cleanbuild() &#123;</span><br><span class="line">    rm -rf $&#123;PWD&#125;/$&#123;builddir&#125; $&#123;PWD&#125;/$pkgname-arm64-v8a-build $&#123;PWD&#125;/$pkgname-armeabi-v7a-build #$&#123;PWD&#125;/$packagename</span><br><span class="line">&#125;</span><br><span class="line">```  </span><br><span class="line"></span><br><span class="line">##### 2. Build Process  </span><br><span class="line">The main entry `build.sh` script executes the following steps:  </span><br><span class="line">1. Parse command-line parameters to determine the target library to compile.  </span><br><span class="line">2. Check the compilation environment (compilation toolchain, etc.).  </span><br><span class="line">3. Read the HPKBUILD configuration of the target library.  </span><br><span class="line">4. Compile each library in the order of dependencies.  </span><br><span class="line">5. For each library, execute:  </span><br><span class="line">   - Acquire source code  </span><br><span class="line">   - Configure compilation parameters  </span><br><span class="line">   - Perform compilation  </span><br><span class="line">   - Install to the specified directory  </span><br><span class="line"></span><br><span class="line">Compilation environment check code:  </span><br></pre></td></tr></table></figure>
<h1 id="检测操作系统类型"><a href="#检测操作系统类型" class="headerlink" title="检测操作系统类型"></a>检测操作系统类型</h1><p>unames&#x3D;<code>uname -s</code><br>osname&#x3D;${unames:0:5}</p>
<h1 id="设置根目录"><a href="#设置根目录" class="headerlink" title="设置根目录"></a>设置根目录</h1><p>LYCIUM_ROOT&#x3D;$(cd $(dirname ${BASH_SOURCE[0]}); pwd)</p>
<h1 id="检查-OHOS-SDK-环境"><a href="#检查-OHOS-SDK-环境" class="headerlink" title="检查 OHOS_SDK 环境"></a>检查 OHOS_SDK 环境</h1><p>if [ -z ${OHOS_SDK} ]<br>then<br>    echo “OHOS_SDK 未设置…”<br>    exit 1<br>fi</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">Dependency management check:  </span><br></pre></td></tr></table></figure>
<h1 id="依赖库暂存文件"><a href="#依赖库暂存文件" class="headerlink" title="依赖库暂存文件"></a>依赖库暂存文件</h1><p>depend_tmp_file&#x3D;”&#x2F;tmp&#x2F;$USER-lycium_deps-$build_time”<br>export LYCIUM_DEPEND_PKGNAMES&#x3D;$depend_tmp_file</p>
<h1 id="已完成库列表"><a href="#已完成库列表" class="headerlink" title="已完成库列表"></a>已完成库列表</h1><p>donelist&#x3D;()<br>donelibs&#x3D;()</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">The core function `buildhpk()` implements build process control:  </span><br><span class="line">1. Execute tasks in rounds.  </span><br><span class="line">2. Handle dependency relationships.  </span><br><span class="line">3. Implement error handling mechanisms.  </span><br><span class="line"></span><br><span class="line">Main variables:  </span><br><span class="line">- `nextroundlist`: Next round of tasks to build  </span><br><span class="line">- `notdonelist`: List of incomplete tasks  </span><br><span class="line">- `buildfalselist`: List of build failures  </span><br><span class="line"></span><br><span class="line">Key function descriptions:  </span><br><span class="line">- `checkbuildenv()`: Check if necessary build tools (e.g., `gcc`, `cmake`, `make`, `autoconf`, `automake`, `git`, `curl`) are installed.  </span><br><span class="line">- `prepareshell()`: Prepare necessary scripts for each build directory (e.g., `build_hpk.sh` for project building, `envset.sh` for environment setup).  </span><br><span class="line">- `makelibsdir()`: Manage build directories (check validity, filter built projects, and add to the build queue).  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">##### 3. Cross-Compilation Support  </span><br><span class="line">The framework achieves cross-compilation through:  </span><br><span class="line">1. Using the cross-compilation toolchain provided by the OpenHarmony NDK.  </span><br><span class="line">2. Configuring cross-compilation parameters in HPKBUILD.  </span><br><span class="line">3. Supporting multi-architecture compilation (arm32/arm64/x86, etc.).  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">##### 4. Artifact Output  </span><br><span class="line">Compilation artifacts are organized as follows:  </span><br></pre></td></tr></table></figure>
<p>usr&#x2F;<br>  └── ${pkgname}&#x2F;<br>       └── ${ARCH}&#x2F;<br>            ├── lib&#x2F;      # Library files<br>            ├── include&#x2F;  # Header files<br>            └── bin&#x2F;      # Executable files</p>
<pre><code>

#### build_hpk.sh Build Script Description  
Core build function descriptions:  
##### 1. `prepare()`: Prepare the build environment (host build when `buildhost=true`), extract the source package, apply patches, and set up the cross-compilation environment.  
##### 2. `build()`: Execute the build process (configure build parameters, run `configure`, execute `make`, and return build results).  
##### 3. `package()`: Install and package (run `make install` and generate the final installation package).  
##### 4. `check()`: Test and verify (modify test configurations, prepare the test environment, execute test cases, and process results).  
##### 5. Environment management functions:  
   - `recoverpkgbuildenv()`: Clean up compilation environment variables and restore the original environment.  
   - `cleanbuild()`: Clean up build directories and delete temporary files.  


### Summary  
This article introduces the functionality, usage, and principles of the HarmonyOS Next cross-platform build script, as well as the related shell code of the build script.
</code></pre>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://harmonyostech.github.io/2025/06/30/C-Floating-Window-Implementation-for-Call-Effect-in-HarmonyOS-Next/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Qingkouwei">
      <meta itemprop="description" content="Welcome to the HarmonyOS NEXT Knowledge Charging Station!  This is a hub for knowledge about HarmonyOS Next`s new-generation system. With its self-developed kernel, HarmonyOS NEXT achieves native smoothness, security, intelligence, and interconnectivity. We deeply analyze how its new distributed soft bus revolutionizes device connectivity experiences and explain the principles behind the enhanced perception and reasoning capabilities of the Xiaoyi intelligent agent based on the Pangu large model. Whether you are a developer exploring application development or an ordinary user eager to understand system features, you can "recharge" here and quickly grasp the essence of HarmonyOS NEXT.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HarmonyOS NEXT Knowledge Charging Station">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/06/30/C-Floating-Window-Implementation-for-Call-Effect-in-HarmonyOS-Next/" class="post-title-link" itemprop="url">Floating Window Implementation for Call Effect in HarmonyOS Next</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2025-06-30 21:58:33 / Modified: 22:01:26" itemprop="dateCreated datePublished" datetime="2025-06-30T21:58:33+08:00">2025-06-30</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/HarmonyOS-Next-Tech/" itemprop="url" rel="index"><span itemprop="name">HarmonyOS Next Tech</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Floating-Window-Implementation-for-Call-Effect-in-HarmonyOS-Next"><a href="#Floating-Window-Implementation-for-Call-Effect-in-HarmonyOS-Next" class="headerlink" title="Floating Window Implementation for Call Effect in HarmonyOS Next"></a>Floating Window Implementation for Call Effect in HarmonyOS Next</h1><p>In mobile application development, floating windows are a common feature. For example, during WeChat audio&#x2F;video calls, to ensure users can view and handle other functions while on a call, the call page can be displayed as a floating window. This article discusses how to implement such a floating window function for call effects in HarmonyOS Next.  </p>
<p>The window system is the core capability supporting floating windows. Let’s first introduce the window module of HarmonyOS Next.  </p>
<h3 id="Window-Module"><a href="#Window-Module" class="headerlink" title="Window Module"></a>Window Module</h3><h4 id="Fundamental-Role-of-the-Window-Module"><a href="#Fundamental-Role-of-the-Window-Module" class="headerlink" title="Fundamental Role of the Window Module"></a>Fundamental Role of the Window Module</h4><p>The window module plays a core role in HarmonyOS Next. For application developers, it provides a complete framework for interface display and interaction, facilitating the construction of creative applications. End users can use it to control application interfaces freely, focusing on single tasks or flexibly switching and coordinating multiple tasks. From an operating system perspective, the window module acts as a smart “dispatcher,” orderly organizing different application interfaces to ensure smooth and stable system operation.  </p>
<h4 id="Diverse-Uses-of-the-Window-Module"><a href="#Diverse-Uses-of-the-Window-Module" class="headerlink" title="Diverse Uses of the Window Module"></a>Diverse Uses of the Window Module</h4><ol>
<li><strong>Provider of Window Objects</strong>: The window module of HarmonyOS Next is the foundation for application and system interface presentation. Developers use it to load colorful UI interfaces, perfectly integrating application functions and visuals to let users intuitively experience the application’s charm.  </li>
<li><strong>Organizer of Display Relationships</strong>: The system has various window types. System windows such as volume bars, notification bars, etc., ensure system functions are accessible; application windows include main windows and sub-windows. The application main window is the “main stage” of the application, clearly visible in the task management interface; application sub-windows, like pop-ups and floating windows, assist the main window. The window module accurately maintains their stacking hierarchy and position attributes, and users can adjust them as needed to create a personalized desktop layout.  </li>
<li><strong>Giver of Window Decoration and Animation Effects</strong>: The default window title bar and border integrate practical operation buttons and convenient drag-and-resize functions, simplifying user operations. Window animations enhance interaction, with smooth animations during window display, hiding, and switching, presented automatically by the system without developer intervention.  </li>
<li><strong>Precise Dispatcher of Input Events</strong>: Touch and mouse events are delivered precisely by position and size based on window status and focus, while keyboard events go directly to the focused window. Developers can also customize a window’s touch and focus attributes through interfaces to meet diverse interaction needs.</li>
</ol>
<h4 id="Flexible-Switching-of-Application-Window-Modes"><a href="#Flexible-Switching-of-Application-Window-Modes" class="headerlink" title="Flexible Switching of Application Window Modes"></a>Flexible Switching of Application Window Modes</h4><p>HarmonyOS Next supports three application window modes—full-screen, split-screen, and free window—demonstrating powerful multi-window capabilities. The full-screen mode allows an application to occupy the entire view for an immersive experience; the split-screen mode lets two applications run side by side with a draggable dividing line for resource comparison and collaborative processing; the free window mode gives users ultimate freedom to adjust size and position, keeping multiple windows organized on the screen with quick focus on click, boosting multi-tasking efficiency.  </p>
<p><img src="/../images/HarmonyOS%20Next%20%E4%BB%BF%E5%BE%AE%E4%BF%A1%E8%A7%86%E9%A2%91%E9%80%9A%E8%AF%9D%E6%82%AC%E6%B5%AE%E7%AA%97%E6%95%88%E6%9E%9C%E5%AE%9E%E7%8E%B0.png"></p>
<h3 id="Introduction-to-Window-APIs"><a href="#Introduction-to-Window-APIs" class="headerlink" title="Introduction to Window APIs"></a>Introduction to Window APIs</h3><p>Windows provide basic capabilities for window management, including creating, destroying, setting attributes, and scheduling between windows. The window module offers the following common window-related functions:  </p>
<ul>
<li><code>Window</code>: The current window instance, the basic unit managed by the window manager.  </li>
<li><code>WindowStage</code>: The window manager, managing each basic window unit.<br>The following is a list of methods extracted from the link:</li>
</ul>
<h4 id="WindowStage-Methods"><a href="#WindowStage-Methods" class="headerlink" title="WindowStage Methods"></a>WindowStage Methods</h4><ul>
<li><code>getMainWindow(callback: AsyncCallback&lt;Window&gt;): void</code>: Get the main window under this WindowStage instance using an asynchronous callback.  </li>
<li><code>getMainWindow(): Promise&lt;Window&gt;</code>: Get the main window under this WindowStage instance using a Promise-based asynchronous callback.  </li>
<li><code>getMainWindowSync(): Window</code>: Get the main window under this WindowStage instance synchronously.  </li>
<li><code>createSubWindow(name: string, callback: AsyncCallback&lt;Window&gt;): void</code>: Create a subwindow under this WindowStage instance using an asynchronous callback.  </li>
<li><code>createSubWindow(name: string): Promise&lt;Window&gt;</code>: Create a subwindow under this WindowStage instance using a Promise-based asynchronous callback.  </li>
<li><code>createSubWindowWithOptions(name: string, options: SubWindowOptions): Promise&lt;Window&gt;</code>: Create a subwindow under this WindowStage instance with set parameters using a Promise-based asynchronous callback.  </li>
<li><code>getSubWindow(callback: AsyncCallback&lt;Array&lt;Window&gt;&gt;): void</code>: Get all subwindows under this WindowStage instance using an asynchronous callback.  </li>
<li><code>getSubWindow(): Promise&lt;Array&lt;Window&gt;&gt;</code>: Get all subwindows under this WindowStage instance using a Promise-based asynchronous callback.  </li>
<li><code>loadContent(path: string, storage: LocalStorage, callback: AsyncCallback&lt;void&gt;): void</code>: Load specific page content for the main window of the current WindowStage, passing state attributes via LocalStorage with an asynchronous callback.  </li>
<li><code>loadContent(path: string, storage?: LocalStorage): Promise&lt;void&gt;</code>: Load specific page content for the main window of the current WindowStage, passing state attributes via LocalStorage with a Promise-based asynchronous callback.  </li>
<li><code>loadContent(path: string, callback: AsyncCallback&lt;void&gt;): void</code>: Load specific page content for the main window of the current WindowStage using an asynchronous callback.  </li>
<li><code>loadContentByName(name: string, storage: LocalStorage, callback: AsyncCallback&lt;void&gt;): void</code>: Load a named route page for the current WindowStage, passing state attributes via LocalStorage with an asynchronous callback.  </li>
<li><code>loadContentByName(name: string, callback: AsyncCallback&lt;void&gt;): void</code>: Load a named route page for the current WindowStage using an asynchronous callback.  </li>
<li><code>loadContentByName(name: string, storage?: LocalStorage): Promise&lt;void&gt;</code>: Load a named route page for the current WindowStage, passing state attributes via LocalStorage with a Promise-based asynchronous callback.  </li>
<li><code>on(eventType: &#39;windowStageEvent&#39;, callback: Callback&lt;WindowStageEventType&gt;): void</code>: Enable listening for WindowStage lifecycle changes.  </li>
<li><code>off(eventType: &#39;windowStageEvent&#39;, callback?: Callback&lt;WindowStageEventType&gt;): void</code>: Disable listening for WindowStage lifecycle changes.  </li>
<li><code>setDefaultDensityEnabled(enabled: boolean): void</code>: Set whether the application uses the system’s default density.</li>
</ul>
<h4 id="Window-Methods"><a href="#Window-Methods" class="headerlink" title="Window Methods"></a>Window Methods</h4><ul>
<li><code>showWindow(callback: AsyncCallback&lt;void&gt;): void</code>: Show the current window using an asynchronous callback, supporting system windows, application subwindows, or elevating the hierarchy of a displayed application main window to the top.  </li>
<li><code>showWindow(): Promise&lt;void&gt;</code>: Show the current window using a Promise-based asynchronous callback.  </li>
<li><code>destroyWindow(callback: AsyncCallback&lt;void&gt;): void</code>: Destroy the current window using an asynchronous callback.  </li>
<li><code>destroyWindow(): Promise&lt;void&gt;</code>: Destroy the current window using a Promise-based asynchronous callback.  </li>
<li><code>moveWindowTo(x: number, y: number, callback: AsyncCallback&lt;void&gt;): void</code>: Move the window position using an asynchronous callback.  </li>
<li><code>moveWindowTo(x: number, y: number): Promise&lt;void&gt;</code>: Move the window position using a Promise-based asynchronous callback.  </li>
<li><code>resize(width: number, height: number, callback: AsyncCallback&lt;void&gt;): void</code>: Change the current window size using an asynchronous callback.  </li>
<li><code>resize(width: number, height: number): Promise&lt;void&gt;</code>: Change the current window size using a Promise-based asynchronous callback.  </li>
<li><code>getWindowProperties(): WindowProperties</code>: Get the properties of the current window.  </li>
<li><code>getWindowAvoidArea(type: AvoidAreaType): AvoidArea</code>: Get the area that the current window content should avoid.  </li>
<li><code>setWindowFocusable(isFocusable: boolean, callback: AsyncCallback&lt;void&gt;): void</code>: Set whether the window is touchable using an asynchronous callback.  </li>
<li><code>setWindowFocusable(isFocusable: boolean): Promise&lt;void&gt;</code>: Set whether the window is touchable using a Promise-based asynchronous callback.  </li>
<li><code>setWindowBackgroundColor(color: string): void</code>: Set the window background color.  </li>
<li><code>setWindowBrightness(brightness: number, callback: AsyncCallback&lt;void&gt;): void</code>: Allow the application main window to set the screen brightness using an asynchronous callback.  </li>
<li><code>setWindowBrightness(brightness: number): Promise&lt;void&gt;</code>: Allow the application main window to set the screen brightness using a Promise-based asynchronous callback.  </li>
<li><code>setWindowSystemBarProperties(systemBarProperties: SystemBarProperties, callback: AsyncCallback&lt;void&gt;): void</code>: Set the properties of the main window’s three-key navigation bar and status bar using an asynchronous callback.  </li>
<li><code>setWindowSystemBarProperties(systemBarProperties: SystemBarProperties): Promise&lt;void&gt;</code>: Set the properties of the main window’s three-key navigation bar and status bar using a Promise-based asynchronous callback.  </li>
<li><code>setWindowLayoutFullScreen(isLayoutFullScreen: boolean, callback: AsyncCallback&lt;void&gt;): void</code>: Set whether the main or subwindow layout is immersive using an asynchronous callback.  </li>
<li><code>setWindowLayoutFullScreen(isLayoutFullScreen: boolean): Promise&lt;void&gt;</code>: Set whether the main or subwindow layout is immersive using a Promise-based asynchronous callback.  </li>
<li><code>isWindowShowing(): boolean</code>: Check if the current window is displayed.  </li>
<li><code>on(type: &#39;windowSizeChange&#39;, callback: Callback&lt;Size&gt;): void</code>: Enable listening for window size changes.  </li>
<li><code>off(type: &#39;windowSizeChange&#39;, callback?: Callback&lt;Size&gt;): void</code>: Disable listening for window size changes.  </li>
<li><code>on(type: &#39;avoidAreaChange&#39;, callback: Callback&lt;AvoidAreaOptions&gt;): void</code>: Enable listening for changes in the current application window’s system avoidance area.  </li>
<li><code>off(type: &#39;avoidAreaChange&#39;, callback?: Callback&lt;AvoidAreaOptions&gt;): void</code>: Disable listening for changes in the current application window’s system avoidance area.  </li>
<li><code>on(type: &#39;keyboardHeightChange&#39;, callback: Callback&lt;number&gt;): void</code>: Enable listening for changes in the fixed soft keyboard height.  </li>
<li><code>off(type: &#39;keyboardHeightChange&#39;, callback?: Callback&lt;number&gt;): void</code>: Disable listening for changes in the fixed soft keyboard height.  </li>
<li><code>on(type: &#39;touchOutside&#39;, callback: Callback&lt;void&gt;): void</code>: Enable listening for click events outside the current window area.  </li>
<li><code>off(type: &#39;touchOutside&#39;, callback?: Callback&lt;void&gt;): void</code>: Disable listening for click events outside the current window area.  </li>
<li><code>on(type: &#39;screenshot&#39;, callback: Callback&lt;void&gt;): void</code>: Enable listening for screenshot events.  </li>
<li><code>off(type: &#39;screenshot&#39;, callback?: Callback&lt;void&gt;): void</code>: Disable listening for screenshot events.  </li>
<li><code>on(type: &#39;windowEvent&#39;, callback: Callback&lt;WindowEventType&gt;): void</code>: Enable listening for window lifecycle changes.  </li>
<li><code>off(type: &#39;windowEvent&#39;, callback?: Callback&lt;WindowEventType&gt;): void</code>: Disable listening for window lifecycle changes.  </li>
<li><code>on(type: &#39;windowVisibilityChange&#39;, callback: Callback&lt;boolean&gt;): void</code>: Enable listening for changes in the current window’s visibility status.  </li>
<li><code>off(type: &#39;windowVisibilityChange&#39;, callback?: Callback&lt;boolean&gt;): void</code>: Disable listening for changes in the current window’s visibility status.  </li>
<li><code>on(type: &#39;noInteractionDetected&#39;, timeout: number, callback: Callback&lt;void&gt;): void</code>: Enable listening for no interaction events within a specified timeout for the current window.  </li>
<li><code>off(type: &#39;noInteractionDetected&#39;, callback?: Callback&lt;void&gt;): void</code>: Disable listening for no interaction events within a specified timeout for the current window.  </li>
<li><code>on(type: &#39;windowStatusChange&#39;, callback: Callback&lt;WindowStatusType&gt;): void</code>: Enable listening for window mode changes.  </li>
<li><code>off(type: &#39;windowStatusChange&#39;, callback?: Callback&lt;WindowStatusType&gt;): void</code>: Disable listening for window mode changes.  </li>
<li><code>on(type: &#39;windowRectChange&#39;, callback: Callback&lt;RectChangeOptions&gt;): void</code>: Enable listening for window rectangle changes.  </li>
<li><code>off(type: &#39;windowRectChange&#39;, callback?: Callback&lt;RectChangeOptions&gt;): void</code>: Disable listening for window rectangle changes.  </li>
<li><code>on(type: &#39;subWindowClose&#39;, callback: Callback&lt;void&gt;): void</code>: Trigger this event when a subwindow closes.  </li>
<li><code>off(type: &#39;subWindowClose&#39;, callback?: Callback&lt;void&gt;): void</code>: Disable listening for subwindow close events.  </li>
<li><code>minimize(callback: AsyncCallback&lt;void&gt;): void</code>: Minimize the window using an asynchronous callback.  </li>
<li><code>minimize(): Promise&lt;void&gt;</code>: Minimize the window using a Promise-based asynchronous callback.  </li>
<li><code>maximize(presentation?: MaximizePresentation): Promise&lt;void&gt;</code>: Called by the main window to maximize, using a Promise-based asynchronous callback.  </li>
<li><code>recover(): Promise&lt;void&gt;</code>: Restore the main window from full-screen, maximized, or split-screen mode to a floating window, resuming its size and position before entering the mode.  </li>
<li><code>getWindowLimits(): WindowLimits</code>: Get the size limits of the current application window.  </li>
<li><code>setWindowLimits(windowLimits: WindowLimits): Promise&lt;WindowLimits&gt;</code>: Set the size limits of the current application window.  </li>
<li><code>setWindowMask(windowMask: Array&lt;Array&lt;number&gt;&gt;): Promise&lt;void&gt;</code>: Set the mask for an irregular window.  </li>
<li><code>keepKeyboardOnFocus(keepKeyboardFlag: boolean): void</code>: Retain the soft keyboard created by other windows when the window gains focus.  </li>
<li><code>setWindowDecorVisible(isVisible: boolean): void</code>: Set whether the window title bar is visible.  </li>
<li><code>setSubWindowModal(isModal: boolean): Promise&lt;void&gt;</code>: Set whether the subwindow’s modal attribute is enabled.  </li>
<li><code>setWindowDecorHeight(height: number): void</code>: Set the height of the window title bar.  </li>
<li><code>getTitleButtonRect(): TitleButtonRect</code>: Get the rectangular area of the minimize, maximize, and close buttons on the title bar of the main window or a decorated subwindow.  </li>
<li><code>getWindowStatus(): WindowStatusType</code>: Get the mode of the current application window.  </li>
<li><code>isFocused(): boolean</code>: Check if the current window has focus.  </li>
<li><code>createSubWindowWithOptions(name: string, options: SubWindowOptions): Promise&lt;Window&gt;</code>: Create a subwindow under the main window or subwindow.  </li>
<li><code>enableLandscapeMultiWindow(): Promise&lt;void&gt;</code>: Enable landscape multi-window support when entering an interface that supports landscape layout.  </li>
<li><code>disableLandscapeMultiWindow(): Promise&lt;void&gt;</code>: Disable landscape multi-window support when exiting an interface that supports landscape layout.  </li>
<li><code>setDialogBackGestureEnabled(enabled: boolean): Promise&lt;void&gt;</code>: Set whether a modal window responds to gesture back events.</li>
</ul>
<h3 id="Implementation-Methods-for-Floating-Window-Capabilities-in-HarmonyOS-Next"><a href="#Implementation-Methods-for-Floating-Window-Capabilities-in-HarmonyOS-Next" class="headerlink" title="Implementation Methods for Floating Window Capabilities in HarmonyOS Next"></a>Implementation Methods for Floating Window Capabilities in HarmonyOS Next</h3><p>Before introducing floating window implementation, let’s understand the window types provided by HarmonyOS Next.  </p>
<h4 id="Window-Types"><a href="#Window-Types" class="headerlink" title="Window Types"></a>Window Types</h4><p>The window module of HarmonyOS divides window interfaces into two basic types: system windows and application windows.  </p>
<ul>
<li><strong>System Windows</strong>: These refer to windows that complete specific system functions, such as volume bars, wallpapers, notification bars, status bars, and navigation bars.  </li>
<li><strong>Application Windows</strong>: Different from system windows, these refer to windows related to application display. Depending on the displayed content, application windows are further divided into application main windows and application subwindows.  <ul>
<li>Application Main Window: Displays the application interface and appears in the “task management interface.”  </li>
<li>Application Subwindow: Displays application pop-ups.</li>
</ul>
</li>
</ul>
<p>System restrictions on application windows are as follows:  </p>
<ul>
<li>Application main and subwindows have size limits: width range <code>[320, 2560]</code> vp, height range <code>[240, 2560]</code> vp.  </li>
<li>System windows have size limits: width range <code>(0, 2560]</code> vp, height range <code>(0, 2560]</code> vp.</li>
</ul>
<p>Management of application windows is mainly reflected in:  </p>
<ul>
<li>Window Immersive Capability: Controls system windows like status bars and navigation bars to reduce their abruptness, providing the best user experience. This capability only takes effect when the application main window is in full-screen mode. Typically, application subwindows (auxiliary windows like pop-ups and floating windows) and application main windows in free window mode cannot use immersive capabilities.  </li>
<li>Floating Window: A global floating window is a special application window that can remain visible in the foreground even when the application main window and corresponding Ability go to the background. It can be used for continuing video playback in a small window after the application goes to the background or creating quick entrances like floating balls for specific applications. Applications need to apply for corresponding permissions before creating floating windows.</li>
</ul>
<h4 id="Smart-Multi-Window"><a href="#Smart-Multi-Window" class="headerlink" title="Smart Multi-Window"></a>Smart Multi-Window</h4><p>Smart multi-window is a multi-tasking solution allowing users to run multiple application windows simultaneously in floating or split-screen mode on the same screen. In smart multi-window display mode, users can arrange application window positions and sizes as needed, mainly in two forms:  </p>
<ul>
<li>Floating Window: A non-full-screen application window floating on the device screen, typically used for temporarily handling another task or short-term multi-tasking while a full-screen task is running, such as replying to messages while browsing the web.  <ul>
<li><img src="/../images/HarmonyOS%20Next%20%E4%BB%BF%E5%BE%AE%E4%BF%A1%E8%A7%86%E9%A2%91%E9%80%9A%E8%AF%9D%E6%82%AC%E6%B5%AE%E7%AA%97%E6%95%88%E6%9E%9C%E5%AE%9E%E7%8E%B0-3.png"></li>
</ul>
</li>
<li>Split-Screen: Usually used for long-term parallel use of two applications, such as viewing shopping guides while browsing products, watching videos while playing games, or taking notes while watching educational videos.  <ul>
<li><img src="/../images/HarmonyOS%20Next%20%E4%BB%BF%E5%BE%AE%E4%BF%A1%E8%A7%86%E9%A2%91%E9%80%9A%E8%AF%9D%E6%82%AC%E6%B5%AE%E7%AA%97%E6%95%88%E6%9E%9C%E5%AE%9E%E7%8E%B0-2.png"><br>Smart multi-window is a system capability that can be set and adapted for the entire APP, not suitable for our page-level floating window scenario.</li>
</ul>
</li>
</ul>
<h4 id="Picture-in-Picture-PiP"><a href="#Picture-in-Picture-PiP" class="headerlink" title="Picture-in-Picture (PiP)"></a>Picture-in-Picture (PiP)</h4><p>In scenarios like video playback, video conferences, and video calls, applications can use PiP capability to present video content in a small window (PiP mode). After switching to PiP mode, users can perform other interface operations to enhance the experience. Common use cases for PiP include:  </p>
<ul>
<li>Video playback  </li>
<li>Video calls  </li>
<li>Video conferences  </li>
<li>Live broadcasts</li>
</ul>
<p>Effect display:<br><img src="/../images/HarmonyOS%20Next%20%E4%BB%BF%E5%BE%AE%E4%BF%A1%E8%A7%86%E9%A2%91%E9%80%9A%E8%AF%9D%E6%82%AC%E6%B5%AE%E7%AA%97%E6%95%88%E6%9E%9C%E5%AE%9E%E7%8E%B0-1.png"></p>
<p>PiP windows provide the following interaction methods:  </p>
<ul>
<li>Single-click: If the PiP control layer is not displayed, show it; if displayed, hide it (auto-hide after 3 seconds).  </li>
<li>Double-click: Enlarge or reduce the PiP window.  </li>
<li>Drag: Move the PiP window anywhere on the screen. Dragging to the left&#x2F;right edge hides the window, which can be restored by clicking the hidden icon on the edge.</li>
</ul>
<p>PiP restrictions:  </p>
<ul>
<li>Requires a system supporting the SystemCapability.Window.SessionManager capability (refer to the system capability usage guide).  </li>
<li>For security, applications cannot start PiP via <code>startPiP</code> when in the background. For scenarios requiring starting PiP when the application returns to the background, use <code>setAutoStartEnabled(true)</code> for automatic start.<br>Additionally, PiP is suitable for video scenes. Voice call scenes without video are unsuitable, and PiP has minimum width&#x2F;height requirements that may not meet our needs.</li>
</ul>
<h4 id="Floating-Window"><a href="#Floating-Window" class="headerlink" title="Floating Window"></a>Floating Window</h4><p>Based on window capabilities, a floating window can be created as a foreground window on top of existing tasks. Even if the task creating the floating window goes to the background, the floating window remains in the foreground, usually above all application windows. Developers can</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://harmonyostech.github.io/2025/06/30/C-HarmonyOS-Native-Intelligence-Speech-Recognition-Practice/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Qingkouwei">
      <meta itemprop="description" content="Welcome to the HarmonyOS NEXT Knowledge Charging Station!  This is a hub for knowledge about HarmonyOS Next`s new-generation system. With its self-developed kernel, HarmonyOS NEXT achieves native smoothness, security, intelligence, and interconnectivity. We deeply analyze how its new distributed soft bus revolutionizes device connectivity experiences and explain the principles behind the enhanced perception and reasoning capabilities of the Xiaoyi intelligent agent based on the Pangu large model. Whether you are a developer exploring application development or an ordinary user eager to understand system features, you can "recharge" here and quickly grasp the essence of HarmonyOS NEXT.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HarmonyOS NEXT Knowledge Charging Station">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/06/30/C-HarmonyOS-Native-Intelligence-Speech-Recognition-Practice/" class="post-title-link" itemprop="url">HarmonyOS Native Intelligence: Speech Recognition Practice</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2025-06-30 21:57:19 / Modified: 21:58:13" itemprop="dateCreated datePublished" datetime="2025-06-30T21:57:19+08:00">2025-06-30</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/HarmonyOS-Next-Tech/" itemprop="url" rel="index"><span itemprop="name">HarmonyOS Next Tech</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="HarmonyOS-Native-Intelligence-Speech-Recognition-Practice"><a href="#HarmonyOS-Native-Intelligence-Speech-Recognition-Practice" class="headerlink" title="HarmonyOS Native Intelligence: Speech Recognition Practice"></a>HarmonyOS Native Intelligence: Speech Recognition Practice</h1><h2 id="Background"><a href="#Background" class="headerlink" title="Background"></a>Background</h2><p>Many business scenarios in our company utilize speech recognition. At the time, our speech team developed a self-research speech recognition model with a solution involving cloud-based models interacting with edge-side SDKs. The edge side handles speech collection, VAD (Voice Activity Detection), Opus encoding, and real-time transmission to the cloud, which then returns recognition results. During HarmonyOS adaptation, we discovered that HarmonyOS Native Intelligence provides a local speech recognition SDK, prompting us to encapsulate its capabilities.  </p>
<h2 id="Scenario-Introduction"><a href="#Scenario-Introduction" class="headerlink" title="Scenario Introduction"></a>Scenario Introduction</h2><p>Native speech recognition supports two modes:  </p>
<ul>
<li>Short speech mode (≤60s)  </li>
<li>Long speech mode (≤8h)</li>
</ul>
<h2 id="API-Interface-Introduction"><a href="#API-Interface-Introduction" class="headerlink" title="API Interface Introduction"></a>API Interface Introduction</h2><h3 id="1-Engine-Initialization"><a href="#1-Engine-Initialization" class="headerlink" title="1. Engine Initialization"></a>1. Engine Initialization</h3><p><code>speechRecognizer.createEngine</code>  </p>
<pre><code class="language-typescript">let asrEngine: speechRecognizer.SpeechRecognitionEngine;
// Create the engine and return via callback
// Set engine creation parameters
let extraParam: Record&lt;string, Object&gt; = &#123;&quot;locate&quot;: &quot;CN&quot;, &quot;recognizerMode&quot;: &quot;short&quot;&#125;;
let initParamsInfo: speechRecognizer.CreateEngineParams = &#123;
  language: &#39;zh-CN&#39;,
  online: 1,
  extraParams: extraParam
&#125;;
// Invoke createEngine method
speechRecognizer.createEngine(initParamsInfo, (err: BusinessError, speechRecognitionEngine: speechRecognizer.SpeechRecognitionEngine) =&gt; &#123;
  if (!err) &#123;
    console.info(&#39;Succeeded in creating engine.&#39;);
    // Receive the created engine instance
    asrEngine = speechRecognitionEngine;
  &#125; else &#123;
    // Error code 1002200008 when unable to create engine: Engine is being destroyed
    console.error(`Failed to create engine. Code: $&#123;err.code&#125;, message: $&#123;err.message&#125;.`);
  &#125;
&#125;);
</code></pre>
<p>Mainly need to construct <code>speechRecognizer.CreateEngineParams</code>:  </p>
<ul>
<li><code>language</code>: Language  </li>
<li><code>online</code>: Mode (1 for offline; currently only offline engine is supported)  </li>
<li><code>extraParams</code>: Regional information, etc.  <ul>
<li><code>locate</code>: Regional info (optional, defaults to “CN”; currently only “CN” is supported)  </li>
<li><code>recognizerMode</code>: Recognition mode (“short” for short speech, “long” for long speech)</li>
</ul>
</li>
</ul>
<p>Error information in callbacks:  </p>
<ol>
<li>Error code 1002200001: Engine creation failed due to unsupported language, mode, initialization timeout, or missing resources.  </li>
<li>Error code 1002200006: Engine is busy (typically triggered when multiple apps call the speech recognition engine simultaneously).  </li>
<li>Error code 1002200008: Engine is being destroyed.</li>
</ol>
<h3 id="2-Set-RecognitionListener-Callback"><a href="#2-Set-RecognitionListener-Callback" class="headerlink" title="2. Set RecognitionListener Callback"></a>2. Set RecognitionListener Callback</h3><p>The callback handles events during recognition. The most important is <strong>onResult</strong> for processing recognized content, with different sessions corresponding to unique sessionIds:  </p>
<pre><code class="language-typescript">// Create callback object
let setListener: speechRecognizer.RecognitionListener = &#123;
  // Callback when recognition starts successfully
  onStart(sessionId: string, eventMessage: string) &#123;
    
  &#125;,
  // Event callback
  onEvent(sessionId: string, eventCode: number, eventMessage: string) &#123;
    
  &#125;,
  // Recognition result callback (includes intermediate and final results)
  onResult(sessionId: string, result: speechRecognizer.SpeechRecognitionResult) &#123;
    
  &#125;,
  // Recognition completion callback
  onComplete(sessionId: string, eventMessage: string) &#123;
    
  &#125;,
  // Error callback (error codes returned here, e.g., 1002200006: Engine is busy)
  onError(sessionId: string, errorCode: number, errorMessage: string) &#123;
    
  &#125;
&#125;
// Set callback
asrEngine.setListener(setListener);
</code></pre>
<h3 id="3-Start-Recognition"><a href="#3-Start-Recognition" class="headerlink" title="3. Start Recognition"></a>3. Start Recognition</h3><pre><code class="language-typescript">let audioParam: speechRecognizer.AudioInfo = &#123;audioType: &#39;pcm&#39;, sampleRate: 16000, soundChannel: 1, sampleBit: 16&#125;;
let extraParam: Record&lt;string, Object&gt; = &#123;&quot;vadBegin&quot;: 2000, &quot;vadEnd&quot;: 3000, &quot;maxAudioDuration&quot;: 40000&#125;;
let recognizerParams: speechRecognizer.StartParams = &#123;
  sessionId: sessionId,
  audioInfo: audioParam,
  extraParams: extraParam
&#125;;
// Invoke start recognition method
asrEngine.startListening(recognizerParams);
</code></pre>
<p>Main parameters for starting recognition:  </p>
<ul>
<li><code>sessionId</code>: Session ID (must correspond to the sessionId in <code>onResult</code> callbacks)  </li>
<li><code>audioInfo</code>: Audio configuration (optional)  <ul>
<li><code>audioType</code>: Currently only supports PCM (decode MP3 files before passing to the engine)  </li>
<li><code>sampleRate</code>: Audio sampling rate (currently only 16000 is supported)  </li>
<li><code>sampleBit</code>: Sampling bit depth (currently only 16-bit is supported)  </li>
<li><code>soundChannel</code>: Audio channels (currently only mono&#x2F;1 channel is supported)  </li>
<li><code>extraParams</code>: Audio compression rate (defaults to 0 for PCM)</li>
</ul>
</li>
<li><code>extraParams</code>: Additional configuration  <ul>
<li><code>recognitionMode</code>: Real-time speech recognition mode (defaults to 1 if unspecified)  <ul>
<li>0: Real-time recording recognition (requires <code>ohos.permission.MICROPHONE</code>; call <code>finish</code> to stop)  </li>
<li>1: Real-time audio-to-text (call <code>writeAudio</code> to pass audio stream)</li>
</ul>
</li>
<li><code>vadBegin</code>: VAD (Voice Activity Detection) front-end point (range: <code>[500,10000]</code>ms; default 10000ms)  </li>
<li><code>vadEnd</code>: VAD back-end point (range: <code>[500,10000]</code>ms; default 800ms)  </li>
<li><code>maxAudioDuration</code>: Maximum supported audio duration  <ul>
<li>Short speech mode: <code>[20000-60000]</code>ms (default 20000ms)  </li>
<li>Long speech mode: <code>[20000 - 8*60*60*1000]</code>ms</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>VAD primarily detects speech activity and skips silent segments.  </p>
<h3 id="4-Pass-Audio-Stream"><a href="#4-Pass-Audio-Stream" class="headerlink" title="4. Pass Audio Stream"></a>4. Pass Audio Stream</h3><pre><code class="language-typescript">asrEngine.writeAudio(sessionId, uint8Array);
</code></pre>
<p>Write audio data to the engine (can be from a microphone or audio file).<br><strong>Note</strong>: Audio stream length must be 640 or 1280 bytes.  </p>
<h3 id="5-Other-Interfaces"><a href="#5-Other-Interfaces" class="headerlink" title="5. Other Interfaces"></a>5. Other Interfaces</h3><ol>
<li><code>listLanguages</code>: Query supported languages  </li>
<li><code>finish</code>: End recognition  </li>
<li><code>cancel</code>: Cancel recognition  </li>
<li><code>shutdown</code>: Release engine resources</li>
</ol>
<h2 id="Best-Practices"><a href="#Best-Practices" class="headerlink" title="Best Practices"></a>Best Practices</h2><p>For real-time recognition, read audio from the microphone and pass it to <code>asrEngine</code>, then handle results in the <code>onResult</code> callback.  </p>
<p>Configure audio capture parameters and create an <code>AudioCapturer</code> instance:  </p>
<pre><code class="language-typescript">import &#123; audio &#125; from &#39;@kit.AudioKit&#39;;

let audioStreamInfo: audio.AudioStreamInfo = &#123;
  samplingRate: audio.AudioSamplingRate.SAMPLE_RATE_16000, // Sampling rate
  channels: audio.AudioChannel.CHANNEL_1, // Channels
  sampleFormat: audio.AudioSampleFormat.SAMPLE_FORMAT_S16LE, // Sample format
  encodingType: audio.AudioEncodingType.ENCODING_TYPE_RAW // Encoding type
&#125;;

let audioCapturerInfo: audio.AudioCapturerInfo = &#123;
  source: audio.SourceType.SOURCE_TYPE_MIC,
  capturerFlags: 0
&#125;;

let audioCapturerOptions: audio.AudioCapturerOptions = &#123;
  streamInfo: audioStreamInfo,
  capturerInfo: audioCapturerInfo
&#125;;

audio.createAudioCapturer(audioCapturerOptions, (err, data) =&gt; &#123;
  if (err) &#123;
    console.error(`Invoke createAudioCapturer failed, code is $&#123;err.code&#125;, message is $&#123;err.message&#125;`);
  &#125; else &#123;
    console.info(&#39;Invoke createAudioCapturer succeeded.&#39;);
    let audioCapturer = data;
  &#125;
&#125;);
</code></pre>
<p><strong>Note</strong>: Sampling rate, channels, and bit depth must match ASR engine requirements (16k, mono, 16-bit).  </p>
<p>Next, subscribe to audio data read events:  </p>
<pre><code class="language-typescript">import &#123; BusinessError &#125; from &#39;@kit.BasicServicesKit&#39;;
import &#123; fileIo &#125; from &#39;@kit.CoreFileKit&#39;;

let bufferSize: number = 0;
class Options &#123;
  offset?: number;
  length?: number;
&#125;

let readDataCallback = (buffer: ArrayBuffer) =&gt; &#123;
  // Write buffer to ASR engine
  asrEngine.writeAudio(sessionId, new Uint8Array(buffer));
&#125;
audioCapturer.on(&#39;readData&#39;, readDataCallback);
</code></pre>
<p><strong>Note</strong>: Buffer size must be 640 or 1280 bytes (ASR engine restriction).  </p>
<h2 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h2><p>This article introduces HarmonyOS’ official speech recognition capabilities, details ASR engine interfaces, and demonstrates real-time microphone speech recognition by capturing audio data and processing results.</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://harmonyostech.github.io/2025/06/30/C-HarmonyOS-Native-Intelligence-Face-Detection-Practice/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Qingkouwei">
      <meta itemprop="description" content="Welcome to the HarmonyOS NEXT Knowledge Charging Station!  This is a hub for knowledge about HarmonyOS Next`s new-generation system. With its self-developed kernel, HarmonyOS NEXT achieves native smoothness, security, intelligence, and interconnectivity. We deeply analyze how its new distributed soft bus revolutionizes device connectivity experiences and explain the principles behind the enhanced perception and reasoning capabilities of the Xiaoyi intelligent agent based on the Pangu large model. Whether you are a developer exploring application development or an ordinary user eager to understand system features, you can "recharge" here and quickly grasp the essence of HarmonyOS NEXT.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HarmonyOS NEXT Knowledge Charging Station">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/06/30/C-HarmonyOS-Native-Intelligence-Face-Detection-Practice/" class="post-title-link" itemprop="url">HarmonyOS Native Intelligence: Face Detection Practice</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2025-06-30 21:56:03 / Modified: 21:56:55" itemprop="dateCreated datePublished" datetime="2025-06-30T21:56:03+08:00">2025-06-30</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/HarmonyOS-Next-Tech/" itemprop="url" rel="index"><span itemprop="name">HarmonyOS Next Tech</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="HarmonyOS-Native-Intelligence-Face-Detection-Practice"><a href="#HarmonyOS-Native-Intelligence-Face-Detection-Practice" class="headerlink" title="HarmonyOS Native Intelligence: Face Detection Practice"></a>HarmonyOS Native Intelligence: Face Detection Practice</h1><h3 id="Background"><a href="#Background" class="headerlink" title="Background"></a>Background</h3><p>Many scenarios in our company require face detection and recognition functions. Our image team has developed self-research models for face recognition and detection, where face recognition and pose recognition run on mobile devices, leveraging the TensorFlow engine for inference. After detecting a face, the data is sent to the server for face matching. Special scenarios like empty room detection also apply image technologies. Although HarmonyOS provides face detection interfaces, aligning with the effects on Android and iOS requires running self-developed models.  </p>
<p>The initial approach to run local models was to compile the open-source TensorFlow Lite inference engine into a HarmonyOS version and load existing models for inference. This requires compiling the TFLite open-source C++ library for HarmonyOS. Additionally, TFLite on Android supports GPU acceleration through Android’s GPU inference APIs, but HarmonyOS currently lacks such adaptation and has no announced plans. Relying solely on CPU may result in poor performance.  </p>
<p>Later, we discovered that HarmonyOS’ official edge AI framework, MindSpore Lite, supports inference with converted TFLite models. MindSpore Lite is a lightweight, high-performance edge AI engine that provides standard model inference and training interfaces, built-in high-performance operator libraries for general hardware, and native support for Neural Network Runtime Kit (NNRT) to enable AI-dedicated chip acceleration for inference, facilitating the creation of full-scenario intelligent applications.  </p>
<p>This article introduces practical face detection inference using MindSpore Lite for TFLite models.  </p>
<h3 id="Model-Conversion"><a href="#Model-Conversion" class="headerlink" title="Model Conversion"></a>Model Conversion</h3><p>MindSpore Lite uses .ms format models for inference. For third-party framework models like TensorFlow, TensorFlow Lite, Caffe, and ONNX, MindSpore Lite’s model conversion tools can convert them to .ms models. Thus, we first convert the TFLite model to .ms. For demonstration, we use the open-source face detection model from Google MediaPipe.  </p>
<p>First, install the model conversion tool (also obtainable via source code compilation; here, we use the ready-made tool):  </p>
<table>
<thead>
<tr>
<th align="left">Component</th>
<th align="left">Hardware Platform</th>
<th align="left">OS</th>
<th align="left">Link</th>
<th align="left">SHA-256</th>
</tr>
</thead>
<tbody><tr>
<td align="left">Edge Inference &amp; Training Benchmark Tool, Converter Tool, Cropper Tool</td>
<td align="left">CPU</td>
<td align="left">Linux-x86_64</td>
<td align="left"><a target="_blank" rel="noopener" href="https://ms-release.obs.cn-north-4.myhuaweicloud.com/2.1.0/MindSpore/lite/release/linux/x86_64/mindspore-lite-2.1.0-linux-x64.tar.gz">mindspore-lite-2.1.0-linux-x64.tar.gz</a></td>
<td align="left">b267e5726720329200389e47a178c4f882bf526833b714ba6e630c8e2920fe89</td>
</tr>
</tbody></table>
<p>MindSpore Lite’s model conversion tool offers various parameter settings. Run <code>./converter_lite --help</code> to get command parameters. Convert the TFLite model to .ms using:  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">1. ./converter_lite --fmk=TFLITE --modelFile=facedetech.tflite --outputFile=facedetech</span><br><span class="line">```  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">### Model Deployment and Inference  </span><br><span class="line">HarmonyOS MindSpore Lite inference engine provides C++ and ArkTS APIs. Here, we use C++ interfaces to demonstrate model deployment.  </span><br><span class="line"></span><br><span class="line">First, create the context environment:  </span><br></pre></td></tr></table></figure>
<p>&#x2F;&#x2F; Create and configure context, set runtime thread count to 2 with big-core priority binding<br>OH_AI_ContextHandle context &#x3D; OH_AI_ContextCreate();<br>if (context &#x3D;&#x3D; NULL) {<br>  printf(“OH_AI_ContextCreate failed.\n”);<br>  return OH_AI_STATUS_LITE_ERROR;<br>}<br>&#x2F;&#x2F; Prioritize NNRT inference.<br>&#x2F;&#x2F; Use the first found NNRT hardware of type ACCELERATORS to create device info with high-performance mode.<br>&#x2F;&#x2F; Alternatively, use OH_AI_GetAllNNRTDeviceDescs() to get all NNRT hardware descriptions and select by name&#x2F;type.<br>OH_AI_DeviceInfoHandle nnrt_device_info &#x3D; OH_AI_CreateNNRTDeviceInfoByType(OH_AI_NNRTDEVICE_ACCELERATOR);<br>if (nnrt_device_info &#x3D;&#x3D; NULL) {<br>  printf(“OH_AI_DeviceInfoCreate failed.\n”);<br>  OH_AI_ContextDestroy(&amp;context);<br>  return OH_AI_STATUS_LITE_ERROR;<br>}<br>OH_AI_DeviceInfoSetPerformanceMode(nnrt_device_info, OH_AI_PERFORMANCE_HIGH);<br>OH_AI_ContextAddDeviceInfo(context, nnrt_device_info);</p>
<p>&#x2F;&#x2F; Then set up CPU inference.<br>OH_AI_DeviceInfoHandle cpu_device_info &#x3D; OH_AI_DeviceInfoCreate(OH_AI_DEVICETYPE_CPU);<br>if (cpu_device_info &#x3D;&#x3D; NULL) {<br>  printf(“OH_AI_DeviceInfoCreate failed.\n”);<br>  OH_AI_ContextDestroy(&amp;context);<br>  return OH_AI_STATUS_LITE_ERROR;<br>}<br>OH_AI_ContextAddDeviceInfo(context, cpu_device_info);</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">This creates a heterogeneous inference context for NNRT (Neural Network Runtime) and CPU. NNRT interfaces with acceleration hardware like NPU for strong inference but limited operator support; CPU offers weaker inference but broader operator coverage. MindSpore Lite supports heterogeneous inference: operators are scheduled to NNRT first, and unsupported ones fall back to CPU.  </span><br><span class="line"></span><br><span class="line">Next, create and load the model:  </span><br></pre></td></tr></table></figure>
<p>&#x2F;&#x2F; Create model<br>OH_AI_ModelHandle model &#x3D; OH_AI_ModelCreate();<br>if (model &#x3D;&#x3D; NULL) {<br>  printf(“OH_AI_ModelCreate failed.\n”);<br>  OH_AI_ContextDestroy(&amp;context);<br>  return OH_AI_STATUS_LITE_ERROR;<br>}</p>
<p>&#x2F;&#x2F; Load and compile model (model type: OH_AI_MODELTYPE_MINDIR)<br>int ret &#x3D; OH_AI_ModelBuildFromFile(model, argv[1], OH_AI_MODELTYPE_MINDIR, context);<br>if (ret !&#x3D; OH_AI_STATUS_SUCCESS) {<br>  printf(“OH_AI_ModelBuildFromFile failed, ret: %d.\n”, ret);<br>  OH_AI_ModelDestroy(&amp;model);<br>  return ret;<br>}</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">Load the model file via `OH_AI_ModelBuildFromFile` to create the Model.  </span><br><span class="line"></span><br><span class="line">Next, feed data to the model:  </span><br></pre></td></tr></table></figure>
<p>&#x2F;&#x2F; Get input tensors<br>OH_AI_TensorHandleArray inputs &#x3D; OH_AI_ModelGetInputs(model);<br>if (inputs.handle_list &#x3D;&#x3D; NULL) {<br>  printf(“OH_AI_ModelGetInputs failed, ret: %d.\n”, ret);<br>  OH_AI_ModelDestroy(&amp;model);<br>  return ret;<br>}</p>
<p>&#x2F;&#x2F;TODO Write camera data to inputs</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">Retrieve the memory address representing the tensor space and write camera data into it. Camera data acquisition is detailed below.  </span><br><span class="line"></span><br><span class="line">Perform inference:  </span><br></pre></td></tr></table></figure>
<p>&#x2F;&#x2F; Execute model inference<br>OH_AI_TensorHandleArray outputs;<br>ret &#x3D; OH_AI_ModelPredict(model, inputs, &amp;outputs, NULL, NULL);<br>if (ret !&#x3D; OH_AI_STATUS_SUCCESS) {<br>  printf(“OH_AI_ModelPredict failed, ret: %d.\n”, ret);<br>  OH_AI_ModelDestroy(&amp;model);<br>  return ret;<br>}</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">Use `OH_AI_ModelPredict` for inference.  </span><br><span class="line"></span><br><span class="line">Finally, get inference results:  </span><br></pre></td></tr></table></figure>
<p>&#x2F;&#x2F; Get and print model output tensors<br>for (size_t i &#x3D; 0; i &lt; outputs.handle_num; ++i) {<br>  OH_AI_TensorHandle tensor &#x3D; outputs.handle_list[i];<br>  int64_t element_num &#x3D; OH_AI_TensorGetElementNum(tensor);<br>  printf(“Tensor name: %s, tensor size is %zu ,elements num: %lld.\n”, OH_AI_TensorGetName(tensor),<br>        OH_AI_TensorGetDataSize(tensor), element_num);<br>  const float *data &#x3D; (const float *)OH_AI_TensorGetData(tensor);</p>
<pre><code>float* out1 = outputs[1];
std::vector&lt;float&gt; scores(out1, out1 + 16 * 16);
float* out2 = outputs[0];
std::vector&lt;float&gt; boxes(out2, out2 + 16 * 16);
std::vector&lt;float&gt; highBox;

for (size_t j = 0; j &lt; scores.size(); j++) &#123;
    scores[j] = 1.0f / (1.0f + std::exp(-scores[j]));
    if (scores[j] &gt; 0.9) &#123;
        for (size_t i = 0; i &lt; 16; i++) &#123;
            highBox.push_back(boxes[i * 16 + i]);
        &#125;
        float sx = highBox[0];
        float sy = highBox[1];
        float w = highBox[2];
        float h = highBox[3];
        std::cout &lt;&lt; &quot;MS_LITE_LOG_AI: score： sx = &quot; &lt;&lt; sx &lt;&lt; &quot;,sy = &quot; &lt;&lt; sy &lt;&lt; &quot;, w = &quot; &lt;&lt; w &lt;&lt; &quot;, h = &quot; &lt;&lt; h &lt;&lt; std::endl;
        float cx = sx;
        float cy = sy;

        cx /= 100.0f; // Assume modelInputWidth is 100
        cy /= 100.0f; // Assume modelInputHeight is 100

        float topleftX = cx - w * 0.5f;
        float topleftY = cy - h * 0.5f;
        float btmrightX = cx + w * 0.5f;
        float btmrightY = cy + h * 0.5f;

        std::cout &lt;&lt; &quot;MS_LITE_LOG_AI: score： &quot; &lt;&lt; scores[j] &lt;&lt; std::endl;
        std::cout &lt;&lt; &quot;MS_LITE_LOG_AI: topleft： &quot; &lt;&lt; topleftX &lt;&lt; &quot;,&quot; &lt;&lt; topleftY &lt;&lt; std::endl;
        std::cout &lt;&lt; &quot;MS_LITE_LOG_AI: btmright： &quot; &lt;&lt; btmrightX &lt;&lt; &quot;,&quot; &lt;&lt; btmrightY &lt;&lt; std::endl;
        for (size_t j = 0; j &lt; 6; j++) &#123;
            float lx = highBox[4 + (2 * j) + 0];
            float ly = highBox[4 + (2 * j) + 1];
            lx /= 100.0f;
            ly /= 100.0f;
            std::cout &lt;&lt; &quot;MS_LITE_LOG_AI: key[&quot; &lt;&lt; j &lt;&lt; &quot;]:&quot; &lt;&lt; lx &lt;&lt; &quot;,&quot; &lt;&lt; ly &lt;&lt; std::endl;
        &#125;
        break;
    &#125;
&#125;

// Release memory
for (float* ptr : outputs) &#123;
    delete[] ptr;
&#125;
</code></pre>
<p>}</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">Obtain inference results via output tensors.  </span><br><span class="line"></span><br><span class="line">For real-time face detection, continuously read from the camera and invoke the inference engine. Use HarmonyOS Media API&#x27;s camera to open and configure the camera:  </span><br></pre></td></tr></table></figure>
<p>let cameraManager &#x3D; camera.getCameraManager(context);<br>let camerasInfo &#x3D; this.cameraManager.getSupportedCameras();</p>
<p> cameraInput &#x3D; this.cameraManager.createCameraInput(cameraDevice);<br>await this.cameraInput?.open()<br>let captureSession &#x3D; this.cameraManager.createCaptureSession();<br>captureSession.beginConfig();<br>captureSession.addInput(this.cameraInput);<br>let previewProfile &#x3D; previewProfiles[previewProfileIndex];<br>let componentSurfacePreviewOutput &#x3D; this.cameraManager.createPreviewOutput(previewProfile, this.surfaceId);<br>captureSession.addOutput(this.componentSurfacePreviewOutput);<br>let mReceiver &#x3D; image.createImageReceiver(<br>  previewProfile.size.width,<br>  previewProfile.size.height,<br>  image.ImageFormat.JPEG,<br>  8<br>);<br>let receivingSurfaceId &#x3D; await mReceiver.getReceivingSurfaceId();<br>let imageReceiverPreviewOutput &#x3D; this.cameraManager.createPreviewOutput(previewProfile, receivingSurfaceId);<br>captureSession.addOutput(this.imageReceiverPreviewOutput);<br>mReceiver.on(‘imageArrival’, async () &#x3D;&gt; {<br>  let imageData &#x3D; await mReceiver.readNextImage();<br>  let imageJPEGComponent &#x3D; await imageData.getComponent(image.ComponentType.JPEG);<br>  &#x2F;&#x2F; Pass imageJPEGComponent.byteBuffer data to the inference engine<br>  await imageData.release();<br>})<br>await captureSession.commitConfig()<br>await startPreview()</p>
<pre><code>

### References  
- [Model Conversion with MindSpore Lite](https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/mindspore-lite-converter-guidelines-V5)  
- [Model Inference with MindSpore Lite Engine (C/C++)](https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/mindspore-lite-guidelines-V5)  


### Summary  
This article introduces HarmonyOS&#39; MindSpore Lite inference engine, how to convert legacy TFLite models to .ms format, and uses HarmonyOS camera APIs to open, configure, and create a capture session for real-time video streaming. Image receivers capture camera data, which is passed to the inference engine for processing. Completing the full flow requires camera permission application, etc., which are omitted here for brevity. The project will be open-sourced after code organization for shared learning.
</code></pre>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://harmonyostech.github.io/2025/06/30/C-HarmonyOS-Audio-Video-Lame-MP3-Encoding-Implementation/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Qingkouwei">
      <meta itemprop="description" content="Welcome to the HarmonyOS NEXT Knowledge Charging Station!  This is a hub for knowledge about HarmonyOS Next`s new-generation system. With its self-developed kernel, HarmonyOS NEXT achieves native smoothness, security, intelligence, and interconnectivity. We deeply analyze how its new distributed soft bus revolutionizes device connectivity experiences and explain the principles behind the enhanced perception and reasoning capabilities of the Xiaoyi intelligent agent based on the Pangu large model. Whether you are a developer exploring application development or an ordinary user eager to understand system features, you can "recharge" here and quickly grasp the essence of HarmonyOS NEXT.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HarmonyOS NEXT Knowledge Charging Station">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/06/30/C-HarmonyOS-Audio-Video-Lame-MP3-Encoding-Implementation/" class="post-title-link" itemprop="url">HarmonyOS Audio-Video: Lame MP3 Encoding Implementation</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2025-06-30 21:53:45 / Modified: 21:55:33" itemprop="dateCreated datePublished" datetime="2025-06-30T21:53:45+08:00">2025-06-30</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/HarmonyOS-Next-Tech/" itemprop="url" rel="index"><span itemprop="name">HarmonyOS Next Tech</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="HarmonyOS-Audio-Video-Lame-MP3-Encoding-Implementation"><a href="#HarmonyOS-Audio-Video-Lame-MP3-Encoding-Implementation" class="headerlink" title="HarmonyOS Audio-Video: Lame MP3 Encoding Implementation"></a>HarmonyOS Audio-Video: Lame MP3 Encoding Implementation</h1><h2 id="Background"><a href="#Background" class="headerlink" title="Background"></a>Background</h2><p>MP3 is a widely used audio compression format, renowned for its efficient compression algorithm and broad compatibility. It is one of the most popular audio formats, supported by almost all audio playback devices, mobile devices, computers, and audio software. This makes MP3 a de facto standard format—compatibility, rather than compression performance, is the key to MP3’s market dominance.  </p>
<p>However, MP3 is a copyrighted encoding. Most mobile phone manufacturers do not include MP3 hardware encoders, only hardware decoders. The most commonly used open-source MP3 software encoder is Lame. This article takes Lame as an example to implement an MP3 software encoder based on Lame, covering the full process from cross-platform compilation to application integration.  </p>
<h2 id="Compiling-Lame"><a href="#Compiling-Lame" class="headerlink" title="Compiling Lame"></a>Compiling Lame</h2><p>There are three common compilation methods for third-party open-source C&#x2F;C++ libraries:  </p>
<ul>
<li>cmake  </li>
<li>make  </li>
<li>configure</li>
</ul>
<p>Different build scripts require configuring different variables. Lame uses the Configure build script, and configuration parameters can be viewed via <code>./Configure -h</code>. OpenHarmony provides a cross-compilation framework called lycium. After configuring third-party library information using a template, execute the build script. The lame module is already included in the <code>tpc_c_cplusplus</code> project’s <code>thirdparty</code> directory, allowing direct compilation.  </p>
<p>To compile, enter the lycium directory and run: <code>./build.sh lame</code>. Upon completion, the <code>user/lame</code> directory in lycium will contain the compiled dynamic libraries.  </p>
<p>When compiling on a macOS ARM-based computer, the following error occurred (viewed in <code>tpc_c_cplusplus/thirdparty/lame/lame-3.100/armeabi-v7a-build/build.log</code>):  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">1 error generated.</span><br><span class="line">1 error generated.</span><br><span class="line">1 error generated.</span><br><span class="line">../../mpglib/dct64_i386.c:34:10: fatal error: &#x27;config.h&#x27; file not found</span><br><span class="line">#include &lt;config.h&gt;</span><br><span class="line">         ^~~~~~~~~~</span><br><span class="line">make[2]: *** [tabinit.lo] Error 1</span><br><span class="line">make[2]: *** Waiting for unfinished jobs....</span><br><span class="line">make[2]: *** [common.lo] Error 1</span><br><span class="line">make[2]: *** [interface.lo] Error 1</span><br><span class="line">make[2]: *** [decode_i386.lo] Error 1</span><br><span class="line">make[2]: *** [layer1.lo] Error 1</span><br><span class="line">1 error generated.</span><br><span class="line">1 error generated.</span><br><span class="line">make[2]: *** [layer2.lo] Error 1</span><br><span class="line">make[2]: *** [dct64_i386.lo] Error 1</span><br><span class="line">1 error generated.</span><br><span class="line">make[2]: *** [layer3.lo] Error 1</span><br><span class="line">make[1]: *** [all-recursive] Error 1</span><br><span class="line">** [tabinit.lo] Error 1</span><br><span class="line">make[2]: *** Waiting for unfinished jobs....</span><br><span class="line">make[2]: *** [common.lo] Error 1</span><br><span class="line">make[2]: *** [interface.lo] Error 1</span><br><span class="line">make[2]: *** [decode_i386.lo] Error 1</span><br><span class="line">make[2]: *** [layer1.lo] Error 1</span><br><span class="line">1 error generated.</span><br><span class="line">1 error generated.</span><br><span class="line">make[2]: *** [layer2.lo] Error 1</span><br><span class="line">make[2]: *** [dct64_i386.lo] Error 1</span><br><span class="line">1 error generated.</span><br><span class="line">make[2]: *** [layer3.lo] Error 1</span><br><span class="line">make[1]: *** [all-recursive] Error 1</span><br><span class="line">make: *** [all] Error 2</span><br><span class="line">&quot;build.log&quot; 310L, 21047Bmake: *** [all] Error 2</span><br><span class="line">```  </span><br><span class="line">The error indicated a failure to generate the `config.h` header file, caused by version mismatches in tools依赖 (dependencies) for the Configure-based Lame. Compilation succeeded after switching to an Intel-based computer:  </span><br><span class="line">![](../images/HarmonyOS%20音视频之Lame%20MP3编码实现.png)</span><br><span class="line"></span><br><span class="line">## Integrating into a HarmonyOS Project  </span><br><span class="line">Next, integrate the compiled Lame dynamic library into the project via precompilation.  </span><br><span class="line"></span><br><span class="line">First, create a native C++ project:  </span><br><span class="line">![](../images/HarmonyOS%20音视频之Lame%20MP3编码实现-1.png)</span><br><span class="line"></span><br><span class="line">Create a `third_party/lame` folder under the `cpp` directory, and copy the compiled SO files and exported header files to this path:  </span><br><span class="line">![](../images/HarmonyOS%20音视频之Lame%20MP3编码实现-2.png)</span><br><span class="line"></span><br><span class="line">Modify `CMakeLists.txt` to import the precompiled Lame dynamic library and add linking:  </span><br></pre></td></tr></table></figure>
<p>add_library(lame SHARED IMPORTED)<br>set_target_properties(lame<br>    PROPERTIES<br>    IMPORTED_LOCATION ${CMAKE_CURRENT_SOURCE_DIR}&#x2F;third_party&#x2F;lame&#x2F;libs&#x2F;${OHOS_ARCH}&#x2F;libmp3lame.so)  </p>
<p>add_library(audio_engine SHARED napi_init.cpp)<br>target_link_libraries(audio_engine PUBLIC libace_napi.z.so lame)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Configure header file search paths to use Lame&#x27;s headers:  </span><br></pre></td></tr></table></figure>
<p>include_directories(${NATIVERENDER_ROOT_PATH}<br>                    ${NATIVERENDER_ROOT_PATH}&#x2F;include<br>                   ${NATIVERENDER_ROOT_PATH}&#x2F;third_party&#x2F;lame&#x2F;include<br>                    )</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">The library is now ready for use after integration.  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">## Recording MP3 Audio Files  </span><br><span class="line">After integrating the encoding library, encapsulate C++ interfaces for TS-side calling. Here, we provide three basic interfaces:  </span><br><span class="line">1. Create an encoder  </span><br><span class="line">2. Encode data  </span><br><span class="line">3. Close the encoder  </span><br><span class="line"></span><br><span class="line">### Creating the Encoder  </span><br><span class="line">After creating the Lame encoder, set encoding parameters:  </span><br><span class="line">- Input audio sampling rate  </span><br><span class="line">- Input audio channel count  </span><br><span class="line">- Output sampling rate  </span><br><span class="line">- Output bitrate  </span><br><span class="line">- Output quality  </span><br><span class="line"></span><br><span class="line">Define the `initLame` method with five parameters:  </span><br></pre></td></tr></table></figure>
<p>size_t argc &#x3D; 5;<br>napi_value args[5] &#x3D; {nullptr};<br>napi_get_cb_info(env, info, &amp;argc, args, nullptr, nullptr);<br>int inSamplerate;<br>napi_get_value_int32(env, args[0], &amp;inSamplerate);  </p>
<p>int inChannel;<br>napi_get_value_int32(env, args[1], &amp;inChannel);  </p>
<p>int outSamplerate;<br>napi_get_value_int32(env, args[2], &amp;outSamplerate);  </p>
<p>int outBitrate;<br>napi_get_value_int32(env, args[3], &amp;outBitrate);  </p>
<p>int quality;<br>napi_get_value_int32(env, args[4], &amp;quality);</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">Next, configure the encoder:  </span><br></pre></td></tr></table></figure>
<p>lame &#x3D; lame_init();<br>lame_set_in_samplerate(lame, inSamplerate);<br>lame_set_num_channels(lame, inChannel);&#x2F;&#x2F; Input stream channels<br>lame_set_out_samplerate(lame, outSamplerate);<br>lame_set_brate(lame, outBitrate);<br>lame_set_quality(lame, quality);<br>lame_init_params(lame);</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">### Encoding Audio Data  </span><br><span class="line">The Lame encoding function prototype is as follows:  </span><br></pre></td></tr></table></figure>
<p>&#x2F;*  </p>
<ul>
<li>Input PCM data, output (maybe) MP3 frames.  </li>
<li>This routine handles all buffering, resampling and filtering for you.  </li>
<li></li>
<li>Return code:  </li>
<li><ul>
<li>Number of bytes output in mp3buf (can be 0)</li>
</ul>
</li>
<li><ul>
<li>-1: mp3buf was too small</li>
</ul>
</li>
<li><ul>
<li>-2: malloc() problem</li>
</ul>
</li>
<li><ul>
<li>-3: lame_init_params() not called</li>
</ul>
</li>
<li><ul>
<li>-4: Psychoacoustic problems</li>
</ul>
</li>
<li></li>
<li>The required mp3buf_size can be computed from num_samples, samplerate, and encoding rate.  </li>
<li>Here’s a worst-case estimate:  </li>
<li>mp3buf_size (bytes) &#x3D; 1.25 * num_samples + 7200  </li>
<li></li>
<li>A tighter bound (mt, March 2000):  </li>
<li>MPEG1: num_samples * (bitrate&#x2F;8) &#x2F; samplerate + 4 * 1152 * (bitrate&#x2F;8) &#x2F; samplerate + 512  </li>
<li>MPEG2: num_samples * (bitrate&#x2F;8) &#x2F; samplerate + 4 * 576 * (bitrate&#x2F;8) &#x2F; samplerate + 256  </li>
<li>Test first if using this!  </li>
<li></li>
<li>Set mp3buf_size &#x3D; 0, and LAME will not check if mp3buf_size is large enough.  </li>
<li></li>
<li>NOTE: If gfp-&gt;num_channels&#x3D;2 but gfp-&gt;mode&#x3D;3 (mono), L &amp; R channels will be averaged into L  </li>
<li>before encoding only the L channel. This overwrites data in buffer_l[] and buffer_r[].<br> <em>&#x2F;<br>int CDECL lame_encode_buffer (<br> lame_global_flags</em>  gfp,           &#x2F;* Global context handle         <em>&#x2F;<br> const short int     buffer_l [],   &#x2F;</em> PCM data for left channel     <em>&#x2F;<br> const short int     buffer_r [],   &#x2F;</em> PCM data for right channel    <em>&#x2F;<br> const int           nsamples,      &#x2F;</em> Samples per channel           <em>&#x2F;<br> unsigned char</em>      mp3buf,        &#x2F;* Encoded MP3 stream            <em>&#x2F;<br> const int           mp3buf_size ); &#x2F;</em> Valid octets in mp3buf        *&#x2F;</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">This requires left and right channel data, samples per channel, output buffer, and buffer size.  </span><br><span class="line"></span><br><span class="line">The NAPI interface accepts three buffers:  </span><br></pre></td></tr></table></figure>
<p>static napi_value NAPI_Global_encodeLame(napi_env env, napi_callback_info info)<br>{<br>    size_t argc &#x3D; 4;<br>    napi_value args[4] &#x3D; {nullptr};<br>    napi_get_cb_info(env, info, &amp;argc, args, nullptr, nullptr);  </p>
<pre><code>napi_typedarray_type type; // Data type  
napi_value left_input_buffer;  
size_t byte_offset; // Data offset  
size_t length; // Byte size  
napi_get_typedarray_info(env, args[0], &amp;type, &amp;length, NULL, &amp;left_input_buffer, &amp;byte_offset);  
void* leftBuffer;   
size_t leftLength;   
napi_get_arraybuffer_info(env, left_input_buffer, &amp;leftBuffer, &amp;leftLength);   
  
napi_value right_input_buffer;  
napi_get_typedarray_info(env, args[1], &amp;type, &amp;length, NULL, &amp;right_input_buffer, &amp;byte_offset);  
void* rightBuffer;   
size_t rightLength;   
napi_get_arraybuffer_info(env, right_input_buffer, &amp;rightBuffer, &amp;rightLength);   
  
int samples;  
napi_get_value_int32(env, args[2], &amp;samples);  
napi_value mp3_output_buffer;  
napi_get_typedarray_info(env, args[3], &amp;type, &amp;length, NULL, &amp;mp3_output_buffer, &amp;byte_offset);  
void* mp3Buffer;   
size_t mp3Length;   
napi_get_arraybuffer_info(env, mp3_output_buffer, &amp;mp3Buffer, &amp;mp3Length);   
  
int result = lame_encode_buffer(lame, (short int*)leftBuffer, (short int*)rightBuffer,  
      samples, (unsigned char*)mp3Buffer, mp3Length);    
napi_value result_value;  
napi_create_int32(env, result, &amp;result_value);  
return result_value;  
</code></pre>
<p>}</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">Key methods used: `napi_get_typedarray_info` and `napi_get_arraybuffer_info`:  </span><br><span class="line">- The Native C++ side receives the ArkTS Array, uses `napi_get_typedarray_info` to obtain data for the `typedarray`, and then uses `napi_get_arraybuffer_info` to fetch array data.  </span><br><span class="line">- The ArkTS side receives the Array from the Native C++ side, creates an `arraybuffer` via `napi_create_arraybuffer`, generates a `typedarray` with `napi_create_typedarray`, stores the `arraybuffer` in `output_array`, assigns values to the `arraybuffer`, and returns `output_array`.  </span><br><span class="line"></span><br><span class="line">### Closing the Encoder  </span><br><span class="line">Call `lame_close` to close the encoder. Before closing, use `lame_encode_flush` to retrieve cached data and ensure data integrity:  </span><br></pre></td></tr></table></figure>
<p>static napi_value NAPI_Global_flushLame(napi_env env, napi_callback_info info)<br>{<br>    size_t argc &#x3D; 1;<br>    napi_value args[1] &#x3D; {nullptr};<br>    napi_get_cb_info(env, info, &amp;argc, args, nullptr, nullptr);<br>    napi_typedarray_type type; &#x2F;&#x2F; Data type<br>    napi_value output_buffer;<br>    size_t byte_offset; &#x2F;&#x2F; Data offset<br>    size_t length; &#x2F;&#x2F; Byte size<br>    napi_get_typedarray_info(env, args[0], &amp;type, &amp;length, NULL, &amp;output_buffer, &amp;byte_offset);<br>    void* outBuffer;<br>    size_t outLength;<br>    napi_get_arraybuffer_info(env, output_buffer, &amp;outBuffer, &amp;outLength);<br>    int result &#x3D; lame_encode_flush(lame, (unsigned char *)outBuffer, outLength);<br>    napi_value result_value;<br>    napi_create_int32(env, result, &amp;result_value);<br>    return result_value;<br>}</p>
<pre><code>

## Issues Encountered  
1. After linking the `mp3lame` library, calling a native method threw an error: `Cannot read property encodeLame of undefined`. The issue occurred because the compiled `mp3lame.so` included a version number, which was removed when copying to the project. The problem was resolved by retaining the highest bit of the version number.  
2. Threading issues: Encoding is a time-consuming operation that requires processing in a separate thread. Create threads and caches on the C++ side for interaction.  


## Summary  
Due to copyright restrictions, Android and iOS devices do not directly provide MP3 hardware encoders, relying on the Lame third-party library for MP3 recording. This article introduces the full process of implementing MP3 software encoding on HarmonyOS—from third-party library compilation to project integration and interface encapsulation. Although HarmonyOS offers hardware MP3 encoding, this article provides best practices for integrating third-party C++ libraries using Lame as an example.
</code></pre>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://harmonyostech.github.io/2025/06/30/C-HarmonyOS-Audio-Video-Audio-Capture-Practice/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Qingkouwei">
      <meta itemprop="description" content="Welcome to the HarmonyOS NEXT Knowledge Charging Station!  This is a hub for knowledge about HarmonyOS Next`s new-generation system. With its self-developed kernel, HarmonyOS NEXT achieves native smoothness, security, intelligence, and interconnectivity. We deeply analyze how its new distributed soft bus revolutionizes device connectivity experiences and explain the principles behind the enhanced perception and reasoning capabilities of the Xiaoyi intelligent agent based on the Pangu large model. Whether you are a developer exploring application development or an ordinary user eager to understand system features, you can "recharge" here and quickly grasp the essence of HarmonyOS NEXT.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HarmonyOS NEXT Knowledge Charging Station">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/06/30/C-HarmonyOS-Audio-Video-Audio-Capture-Practice/" class="post-title-link" itemprop="url">HarmonyOS Audio-Video: Audio Capture Practice</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2025-06-30 21:51:33 / Modified: 21:52:52" itemprop="dateCreated datePublished" datetime="2025-06-30T21:51:33+08:00">2025-06-30</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/HarmonyOS-Next-Tech/" itemprop="url" rel="index"><span itemprop="name">HarmonyOS Next Tech</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="HarmonyOS-Audio-Video-Audio-Capture-Practice"><a href="#HarmonyOS-Audio-Video-Audio-Capture-Practice" class="headerlink" title="HarmonyOS Audio-Video: Audio Capture Practice"></a>HarmonyOS Audio-Video: Audio Capture Practice</h1><h2 id="Background"><a href="#Background" class="headerlink" title="Background"></a>Background</h2><p>Many scenarios in application development require audio capture, such as voice messaging in chat functions, real-time speech-to-text conversion, voice calls, and video calls. On Android and iOS, the system provides two forms of audio capture:  </p>
<ul>
<li>Real-time audio stream capture  </li>
<li>Audio file recording</li>
</ul>
<p>The system also offers different API forms. For example, on Android:  </p>
<ul>
<li>AudioRecorder Java interface  </li>
<li>MediaRecorder Java interface  </li>
<li>OpenSLES C++ interface  </li>
<li>AAudio C++ interface</li>
</ul>
<p>During HarmonyOS adaptation, audio capture is also necessary. This article guides you through implementing audio capture step by step.  </p>
<h2 id="Introduction-to-Audio-Recording-Interfaces"><a href="#Introduction-to-Audio-Recording-Interfaces" class="headerlink" title="Introduction to Audio Recording Interfaces"></a>Introduction to Audio Recording Interfaces</h2><p>HarmonyOS provides two audio capture interfaces for TS and C++:  </p>
<ul>
<li>AudioCapture  </li>
<li>OHAudio</li>
</ul>
<p>Below is an introduction to the APIs for both languages.  </p>
<h3 id="AudioCapture"><a href="#AudioCapture" class="headerlink" title="AudioCapture"></a>AudioCapture</h3><p>Using AudioCapturer for audio recording involves creating an AudioCapturer instance, configuring audio capture parameters, starting and stopping capture, and releasing resources. The official state diagram clearly marks method calls and state transitions:<br>![[HarmonyOS 音视频之音频采集实战.png]]<br><img src="/../images/HarmonyOS%20%E9%9F%B3%E8%A7%86%E9%A2%91%E4%B9%8B%E9%9F%B3%E9%A2%91%E9%87%87%E9%9B%86%E5%AE%9E%E6%88%98.png"></p>
<h4 id="createAudioCapture"><a href="#createAudioCapture" class="headerlink" title="createAudioCapture"></a>createAudioCapture</h4><p>Creating a capturer mainly involves parameter configuration:  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">import &#123; audio &#125; from &#x27;@kit.AudioKit&#x27;;</span><br><span class="line"> </span><br><span class="line">let audioStreamInfo: audio.AudioStreamInfo = &#123;</span><br><span class="line">  samplingRate: audio.AudioSamplingRate.SAMPLE_RATE_48000, // Sampling rate</span><br><span class="line">  channels: audio.AudioChannel.CHANNEL_2, // Number of channels</span><br><span class="line">  sampleFormat: audio.AudioSampleFormat.SAMPLE_FORMAT_S16LE, // Sample format</span><br><span class="line">  encodingType: audio.AudioEncodingType.ENCODING_TYPE_RAW // Encoding format</span><br><span class="line">&#125;;</span><br><span class="line"> </span><br><span class="line">let audioCapturerInfo: audio.AudioCapturerInfo = &#123;</span><br><span class="line">  source: audio.SourceType.SOURCE_TYPE_MIC,</span><br><span class="line">  capturerFlags: 0</span><br><span class="line">&#125;;</span><br><span class="line"> </span><br><span class="line">let audioCapturerOptions: audio.AudioCapturerOptions = &#123;</span><br><span class="line">  streamInfo: audioStreamInfo,</span><br><span class="line">  capturerInfo: audioCapturerInfo</span><br><span class="line">&#125;;</span><br><span class="line"> </span><br><span class="line">audio.createAudioCapturer(audioCapturerOptions, (err, data) =&gt; &#123;</span><br><span class="line">  if (err) &#123;</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    let audioCapturer = data;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line">```  </span><br><span class="line">Parameters include two main sections:  </span><br><span class="line">- **AudioStreamInfo**: Audio format configuration  </span><br><span class="line">  - `samplingRate`: Sampling rate  </span><br><span class="line">  - `channels`: Number of channels  </span><br><span class="line">  - `sampleFormat`: Sample format  </span><br><span class="line">  - `encodingType`: Audio encoding type (only PCM&#x27;s `ENCODING_TYPE_RAW` is supported currently)  </span><br><span class="line">- **AudioCapturerInfo**: Capture configuration  </span><br><span class="line">  - `source`: Audio source type, including:  </span><br><span class="line">    - `SOURCE_TYPE_INVALID`: Invalid audio source  </span><br><span class="line">    - `SOURCE_TYPE_MIC`: Microphone audio source  </span><br><span class="line">    - `SOURCE_TYPE_VOICE_RECOGNITION`: Speech recognition source  </span><br><span class="line">    - `SOURCE_TYPE_PLAYBACK_CAPTURE`: Playback audio stream (internal recording)  </span><br><span class="line">    - `SOURCE_TYPE_VOICE_COMMUNICATION`: Voice call scenario source  </span><br><span class="line">    - `SOURCE_TYPE_VOICE_MESSAGE`: Short voice message source  </span><br><span class="line">  - `capturerFlags`: Audio capturer flags (0 represents an audio capturer)  </span><br><span class="line"></span><br><span class="line">#### on(&#x27;readData&#x27;)  </span><br><span class="line">The `on(&#x27;readData&#x27;)` method subscribes to audio data read callbacks:  </span><br></pre></td></tr></table></figure>
<p>let readDataCallback &#x3D; (buffer: ArrayBuffer) &#x3D;&gt; {<br>  &#x2F;&#x2F; Process the audio stream<br>}<br>audioCapturer.on(‘readData’, readDataCallback);</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">#### start  </span><br><span class="line">The `start` method begins recording:  </span><br></pre></td></tr></table></figure>
<p>import { BusinessError } from ‘@kit.BasicServicesKit’;<br>audioCapturer.start((err: BusinessError) &#x3D;&gt; {<br>  if (err) {<br>    &#x2F;&#x2F; Handle error<br>  } else {<br>    &#x2F;&#x2F; Recording started<br>  }<br>});</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">#### stop  </span><br><span class="line">The `stop` method stops recording:  </span><br></pre></td></tr></table></figure>
<p>import { BusinessError } from ‘@kit.BasicServicesKit’;<br>audioCapturer.stop((err: BusinessError) &#x3D;&gt; {<br>  if (err) {<br>    &#x2F;&#x2F; Handle error<br>  } else {<br>    &#x2F;&#x2F; Recording stopped<br>  }<br>});</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">#### release  </span><br><span class="line">The `release` method destroys the instance and releases resources:  </span><br></pre></td></tr></table></figure>
<p>import { BusinessError } from ‘@kit.BasicServicesKit’;<br>audioCapturer.release((err: BusinessError) &#x3D;&gt; {<br>  if (err) {<br>    &#x2F;&#x2F; Handle error<br>  } else {<br>    &#x2F;&#x2F; Resources released<br>  }<br>});</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">### OHAudio  </span><br><span class="line">OHAudio is a set of C APIs introduced in API version 10. These APIs are designed to be unified, supporting both normal and low-latency audio paths. They only support PCM format and are suitable for scenarios where native-layer audio input is required. Since many audio encoding libraries are implemented in C/C++, using OHAudio C++ interfaces on HarmonyOS reduces data transfer overhead between TS and C++ layers, improving efficiency.  </span><br><span class="line"></span><br><span class="line">OHAudio depends on the `libohaudio.so` dynamic library. Import the header files `&lt;native_audiostreambuilder.h&gt;` and `&lt;native_audiocapturer.h&gt;` to use audio recording-related APIs.  </span><br><span class="line"></span><br><span class="line">#### Create a Builder  </span><br></pre></td></tr></table></figure>
<p>OH_AudioStreamBuilder* builder;<br>OH_AudioStreamBuilder_Create(&amp;builder, AUDIOSTREAM_TYPE_CAPTURER);</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">#### Configure Audio Stream Parameters  </span><br><span class="line">Refer to the following example:  </span><br></pre></td></tr></table></figure>
<p>&#x2F;&#x2F; Set audio sampling rate<br>OH_AudioStreamBuilder_SetSamplingRate(builder, 48000);<br>&#x2F;&#x2F; Set audio channel count<br>OH_AudioStreamBuilder_SetChannelCount(builder, 2);<br>&#x2F;&#x2F; Set audio sample format<br>OH_AudioStreamBuilder_SetSampleFormat(builder, AUDIOSTREAM_SAMPLE_S16LE);<br>&#x2F;&#x2F; Set audio stream encoding type<br>OH_AudioStreamBuilder_SetEncodingType(builder, AUDIOSTREAM_ENCODING_TYPE_RAW);<br>&#x2F;&#x2F; Set the working scenario for the input audio stream<br>OH_AudioStreamBuilder_SetCapturerInfo(builder, AUDIOSTREAM_SOURCE_TYPE_MIC);</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Parameters function similarly to those in AudioCapture.  </span><br><span class="line"></span><br><span class="line">#### Set Audio Callback Functions  </span><br></pre></td></tr></table></figure>
<p>&#x2F;&#x2F; Custom data write function<br>int32_t MyOnReadData(<br>    OH_AudioCapturer* capturer,<br>    void* userData,<br>    void* buffer,<br>    int32_t length)<br>{<br>    &#x2F;&#x2F; Extract ‘length’ bytes of recording data from ‘buffer’<br>    return 0;<br>}<br>&#x2F;&#x2F; Custom audio stream event function<br>int32_t MyOnStreamEvent(<br>    OH_AudioCapturer* capturer,<br>    void* userData,<br>    OH_AudioStream_Event event)<br>{<br>    &#x2F;&#x2F; Update player state and UI based on the audio stream event<br>    return 0;<br>}<br>&#x2F;&#x2F; Custom audio interrupt event function<br>int32_t MyOnInterruptEvent(<br>    OH_AudioCapturer* capturer,<br>    void* userData,<br>    OH_AudioInterrupt_ForceType type,<br>    OH_AudioInterrupt_Hint hint)<br>{<br>    &#x2F;&#x2F; Update recorder state and UI based on the audio interrupt info<br>    return 0;<br>}<br>&#x2F;&#x2F; Custom error callback function<br>int32_t MyOnError(<br>    OH_AudioCapturer* capturer,<br>    void* userData,<br>    OH_AudioStream_Result error)<br>{<br>    &#x2F;&#x2F; Handle the audio error based on ‘error’<br>    return 0;<br>}</p>
<p>OH_AudioCapturer_Callbacks callbacks;<br>&#x2F;&#x2F; Configure callback functions<br>callbacks.OH_AudioCapturer_OnReadData &#x3D; MyOnReadData;<br>callbacks.OH_AudioCapturer_OnStreamEvent &#x3D; MyOnStreamEvent;<br>callbacks.OH_AudioCapturer_OnInterruptEvent &#x3D; MyOnInterruptEvent;<br>callbacks.OH_AudioCapturer_OnError &#x3D; MyOnError;</p>
<p>&#x2F;&#x2F; Set the callback for the audio input stream<br>OH_AudioStreamBuilder_SetCapturerCallback(builder, callbacks, nullptr);</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Configure callback functions via `OH_AudioStreamBuilder_SetCapturerCallback`.  </span><br><span class="line"></span><br><span class="line">#### Construct the Recording Audio Stream  </span><br></pre></td></tr></table></figure>
<p>OH_AudioCapturer* audioCapturer;<br>OH_AudioStreamBuilder_GenerateCapturer(builder, &amp;audioCapturer);</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">#### Use the Audio Stream  </span><br><span class="line">- `OH_AudioStream_Result OH_AudioCapturer_Start(OH_AudioCapturer* capturer)`: Start recording  </span><br><span class="line">- `OH_AudioStream_Result OH_AudioCapturer_Pause(OH_AudioCapturer* capturer)`: Pause recording  </span><br><span class="line">- `OH_AudioStream_Result OH_AudioCapturer_Stop(OH_AudioCapturer* capturer)`: Stop recording  </span><br><span class="line">- `OH_AudioStream_Result OH_AudioCapturer_Flush(OH_AudioCapturer* capturer)`: Release cached data  </span><br><span class="line">- `OH_AudioStream_Result OH_AudioCapturer_Release(OH_AudioCapturer* capturer)`: Release the recording instance  </span><br><span class="line"></span><br><span class="line">#### Release the Builder  </span><br></pre></td></tr></table></figure>
<p>OH_AudioStreamBuilder_Destroy(builder);</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">## Audio Recording Best Practices  </span><br><span class="line">Let&#x27;s implement a full-process audio capture example by recording to an MP3 file.  </span><br><span class="line"></span><br><span class="line">#### Permission Application  </span><br><span class="line">Audio capture requires dynamic permission application. First, declare the permission in `module.json5`:  </span><br></pre></td></tr></table></figure>
<p>“requestPermissions”: [<br>  {<br>    “name”: “ohos.permission.MICROPHONE”,<br>    “reason”: “$string:reason”,<br>    “usedScene”: {<br>      “abilities”: [<br>        “FormAbility”<br>      ],<br>      “when”: “inuse”<br>    }<br>  }<br>],</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">Dynamic permission application:  </span><br></pre></td></tr></table></figure>
<p>function reqPermissionsFromUser(permissions: Array<Permissions>, context: common.UIAbilityContext): void {<br>  let atManager: abilityAccessCtrl.AtManager &#x3D; abilityAccessCtrl.createAtManager();<br>  atManager.requestPermissionsFromUser(context, permissions).then((data) &#x3D;&gt; {<br>    let grantStatus: Array<number> &#x3D; data.authResults;<br>    let length: number &#x3D; grantStatus.length;<br>    for (let i &#x3D; 0; i &lt; length; i++) {<br>      if (grantStatus[i] !&#x3D;&#x3D; 0) {<br>        &#x2F;&#x2F; User denied permission; prompt and guide to settings<br>        return;<br>      }<br>    }<br>    &#x2F;&#x2F; Permission granted successfully<br>  }).catch((err: BusinessError) &#x3D;&gt; {<br>    console.error(<code>Failed to request permissions. Code: $&#123;err.code&#125;, Message: $&#123;err.message&#125;</code>);<br>  })<br>}</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">Call the permission application method in `aboutToAppear` and start recording after authorization:  </span><br></pre></td></tr></table></figure>
<p>const context: common.UIAbilityContext &#x3D; getContext(this) as common.UIAbilityContext;<br>reqPermissionsFromUser(permissions, context);  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">#### Configure C++ Project  </span><br><span class="line">After creating a C++ module, configure the ohaudio dynamic library dependency:  </span><br></pre></td></tr></table></figure>
<p>cmake_minimum_required(VERSION 3.5.0)<br>project(audiorecorderdemo)  </p>
<p>set(NATIVERENDER_ROOT_PATH ${CMAKE_CURRENT_SOURCE_DIR})  </p>
<p>if(DEFINED PACKAGE_FIND_FILE)<br>    include(${PACKAGE_FIND_FILE})<br>endif()  </p>
<p>include_directories(${NATIVERENDER_ROOT_PATH}<br>                    ${NATIVERENDER_ROOT_PATH}&#x2F;include)  </p>
<p>add_library(capture SHARED napi_init.cpp)<br>target_link_libraries(capture PUBLIC libace_napi.z.so)<br>target_link_libraries(capture PUBLIC libohaudio.so)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">Configure NAPI methods:  </span><br></pre></td></tr></table></figure>
<p>static napi_value start(napi_env env, napi_callback_info info)<br>{<br>    &#x2F;&#x2F; Implementation omitted<br>    return nullptr;<br>}<br>static napi_value stop(napi_env env, napi_callback_info info)<br>{<br>    &#x2F;&#x2F; Implementation omitted<br>    return nullptr;<br>}<br>EXTERN_C_START<br>static napi_value Init(napi_env env, napi_value exports)<br>{<br>    napi_property_descriptor desc[] &#x3D; {<br>        { “start”, nullptr, start, nullptr, nullptr, nullptr, napi_default, nullptr },<br>        { “stop”, nullptr, stop, nullptr, nullptr, nullptr, napi_default, nullptr }<br>    };<br>    napi_define_properties(env, exports, sizeof(desc) &#x2F; sizeof(desc[0]), desc);<br>    return exports;<br>}</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">#### Implement Start Recording  </span><br></pre></td></tr></table></figure>
<p>&#x2F;&#x2F; Custom data read function<br>int32_t MyOnReadData(<br>    OH_AudioCapturer* capturer,<br>    void* userData,<br>    void* buffer,<br>    int32_t length)<br>{<br>    &#x2F;&#x2F; TODO: Extract recording data from buffer<br>    return 0;<br>}<br>&#x2F;&#x2F; Custom audio stream event function<br>int32_t MyOnStreamEvent(<br>    OH_AudioCapturer* capturer,<br>    void* userData,<br>    OH_AudioStream_Event event)<br>{<br>    &#x2F;&#x2F; TODO: Update state&#x2F;UI based on event<br>    return 0;<br>}<br>&#x2F;&#x2F; Custom audio interrupt event function<br>int32_t MyOnInterruptEvent(<br>    OH_AudioCapturer* capturer,<br>    void* userData,<br>    OH_AudioInterrupt_ForceType type,<br>    OH_AudioInterrupt_Hint hint)<br>{<br>    &#x2F;&#x2F; TODO: Update state&#x2F;UI based on interrupt info<br>    return 0;<br>}<br>&#x2F;&#x2F; Custom error callback function<br>int32_t MyOnError(<br>    OH_AudioCapturer* capturer,<br>    void* userData,<br>    OH_AudioStream_Result error)<br>{<br>    &#x2F;&#x2F; TODO: Handle error based on ‘error’<br>    return 0;<br>}<br>static napi_value start(napi_env env, napi_callback_info info)<br>{<br>    OH_AudioStreamBuilder* builder;<br>    OH_AudioStreamBuilder_Create(&amp;builder, AUDIOSTREAM_TYPE_CAPTURER);<br>    &#x2F;&#x2F; Set audio parameters<br>    OH_AudioStreamBuilder_SetSamplingRate(builder, 48000);<br>    OH_AudioStreamBuilder_SetChannelCount(builder, 2);<br>    OH_AudioStreamBuilder_SetSampleFormat(builder, AUDIOSTREAM_SAMPLE_S16LE);<br>    OH_AudioStreamBuilder_SetEncodingType(builder, AUDIOSTREAM_ENCODING_TYPE_RAW);<br>    OH_AudioStreamBuilder_SetCapturerInfo(builder, AUDIOSTREAM_SOURCE_TYPE_MIC);  </p>
<pre><code>OH_AudioCapturer_Callbacks callbacks;  
// Configure callbacks  
callbacks.OH_AudioCapturer_OnReadData = MyOnReadData;  
callbacks.OH_AudioCapturer_OnStreamEvent = MyOnStreamEvent;  
callbacks.OH_AudioCapturer_OnInterruptEvent = MyOnInterruptEvent;  
callbacks.OH_AudioCapturer_OnError = MyOnError;  
OH_AudioStreamBuilder_SetCapturerCallback(builder, callbacks, nullptr);  

OH_AudioCapturer* audioCapturer;  
OH_AudioStreamBuilder_GenerateCapturer(builder, &amp;audioCapturer);  
return nullptr;  
</code></pre>
<p>}</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">**Best Practice 1:**  </span><br><span class="line">To avoid unexpected behavior, ensure each callback in `OH_AudioCapturer_Callbacks` is initialized with a custom callback or a null pointer. For example:  </span><br></pre></td></tr></table></figure>
<p>OH_AudioCapturer_Callbacks callbacks;</p>
<p>&#x2F;&#x2F; Configure needed callbacks<br>callbacks.OH_AudioCapturer_OnReadData &#x3D; MyOnReadData;<br>callbacks.OH_AudioCapturer_OnInterruptEvent &#x3D; MyOnInterruptEvent;</p>
<p>&#x2F;&#x2F; (Mandatory) Initialize unused callbacks with null<br>callbacks.OH_AudioCapturer_OnStreamEvent &#x3D; nullptr;<br>callbacks.OH_AudioCapturer_OnError &#x3D; nullptr;</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">**Best Practice 2:**  </span><br><span class="line">For devices supporting low-latency mode, use low-latency mode to create the audio recording builder for scenarios with strict latency requirements (e.g., voice calls) to achieve higher-quality audio:  </span><br></pre></td></tr></table></figure>
<p>OH_AudioStream_LatencyMode latencyMode &#x3D; AUDIOSTREAM_LATENCY_MODE_FAST;<br>OH_AudioStreamBuilder_SetLatencyMode(builder, latencyMode);</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">#### Audio File Processing  </span><br><span class="line">Process audio data in the audio callback, which can be passed to ASR or written to a file directly. The next article will cover encoding to MP3 and writing to a file.  </span><br><span class="line"></span><br><span class="line">#### Stop and Release  </span><br></pre></td></tr></table></figure>
<p>OH_AudioCapturer_Stop(audioCapturer);<br>OH_AudioStreamBuilder_Destroy(builder);</p>
<pre><code>
## Summary  
This article introduces two audio capture methods in HarmonyOS: AudioCapture at the TS layer and OHAudio at the C++ layer, and implements real-time audio capture using OHAudio interfaces.
</code></pre>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://harmonyostech.github.io/2025/06/30/C-HarmonyOS-Private-Repository-Construction-Practice/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Qingkouwei">
      <meta itemprop="description" content="Welcome to the HarmonyOS NEXT Knowledge Charging Station!  This is a hub for knowledge about HarmonyOS Next`s new-generation system. With its self-developed kernel, HarmonyOS NEXT achieves native smoothness, security, intelligence, and interconnectivity. We deeply analyze how its new distributed soft bus revolutionizes device connectivity experiences and explain the principles behind the enhanced perception and reasoning capabilities of the Xiaoyi intelligent agent based on the Pangu large model. Whether you are a developer exploring application development or an ordinary user eager to understand system features, you can "recharge" here and quickly grasp the essence of HarmonyOS NEXT.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HarmonyOS NEXT Knowledge Charging Station">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/06/30/C-HarmonyOS-Private-Repository-Construction-Practice/" class="post-title-link" itemprop="url">HarmonyOS Private Repository Construction Practice</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2025-06-30 21:50:17 / Modified: 21:51:16" itemprop="dateCreated datePublished" datetime="2025-06-30T21:50:17+08:00">2025-06-30</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/HarmonyOS-Next-Tech/" itemprop="url" rel="index"><span itemprop="name">HarmonyOS Next Tech</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="HarmonyOS-Private-Repository-Construction-Practice"><a href="#HarmonyOS-Private-Repository-Construction-Practice" class="headerlink" title="HarmonyOS Private Repository Construction Practice"></a>HarmonyOS Private Repository Construction Practice</h1><h2 id="Background"><a href="#Background" class="headerlink" title="Background"></a>Background</h2><p>In Android and iOS development, dependencies and collaboration often rely on binary artifacts. Android uses Maven as the repository, while iOS uses CocoaPods. Developers can leverage open-source libraries on official platforms, significantly improving development efficiency. However, some company-specific business libraries are not intended for external use, making it unsafe to upload them to public repositories. Many companies build internal private repositories, which enhance security and accelerate artifact management.  </p>
<p>HarmonyOS faces similar challenges. While developers can easily use third-party artifacts from official repositories, internal business dependencies require private repositories. This article describes how to build a private repository using official tools.  </p>
<h2 id="Introduction-to-HarmonyOS-Shared-Packages"><a href="#Introduction-to-HarmonyOS-Shared-Packages" class="headerlink" title="Introduction to HarmonyOS Shared Packages"></a>Introduction to HarmonyOS Shared Packages</h2><p>HarmonyOS shared packages are categorized into static and dynamic types:  </p>
<ul>
<li><strong>HAR (Harmony Archive)</strong>: A static shared package containing code, C++ libraries, resources, and configuration files. HAR enables multiple modules or projects to share ArkUI components, resources, and related code. Unlike HAP, HAR cannot be independently installed or run on devices and can only be referenced as a dependency of application modules.  </li>
<li><strong>HSP (Harmony Shared Package)</strong>: A dynamic shared package. Static shared packages are packaged into each dependent HAP, leading to larger package sizes and duplicate resources&#x2F;code. Dynamic shared packages allow multiple HAPs to share common resources and code. HSP only supports in-application sharing, not cross-application sharing.</li>
</ul>
<h2 id="Building-a-Private-Repository-with-ohpm-repo"><a href="#Building-a-Private-Repository-with-ohpm-repo" class="headerlink" title="Building a Private Repository with ohpm-repo"></a>Building a Private Repository with ohpm-repo</h2><p>The official ohpm-repo tool helps developers quickly set up a lightweight ohpm private repository, compatible with the ohpm package manager. It caches dependencies on demand to accelerate installations in private networks.  </p>
<p>ohpm-repo supports single-point and multi-instance deployments:  </p>
<ul>
<li><strong>Single-point deployment</strong>: ohpm-repo runs on a single machine.  </li>
<li><strong>Multi-instance deployment</strong>: ohpm-repo is deployed across multiple machines with identical configurations and shared data storage.</li>
</ul>
<h3 id="Dependent-Environment-Installation"><a href="#Dependent-Environment-Installation" class="headerlink" title="Dependent Environment Installation"></a>Dependent Environment Installation</h3><ol>
<li>ohpm-repo relies on Node.js (version 16.x or higher). Install Node.js and configure the environment. Download Node.js from the official website (<a target="_blank" rel="noopener" href="https://nodejs.org/download/release/latest/">https://nodejs.org/download/release/latest/</a>).</li>
</ol>
<h3 id="Downloading-ohpm-repo"><a href="#Downloading-ohpm-repo" class="headerlink" title="Downloading ohpm-repo"></a>Downloading ohpm-repo</h3><ol>
<li>Download the ohpm-repo tool from: <a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ide-software-download-0000001507075446">https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ide-software-download-0000001507075446</a>  </li>
<li>Unzip the ohpm-repo package.</li>
</ol>
<h3 id="Configuring-ohpm-repo-Environment-Variables"><a href="#Configuring-ohpm-repo-Environment-Variables" class="headerlink" title="Configuring ohpm-repo Environment Variables"></a>Configuring ohpm-repo Environment Variables</h3><ol>
<li>Add the path to the <code>bin</code> directory in the unzipped ohpm-repo package to the system environment variable <code>PATH</code>:<br><code>export PATH=$OHPM-REPO-PATH/bin:$PATH</code>  </li>
<li>Verify the installation by running <code>ohpm-repo -v</code> to check the version.</li>
</ol>
<h3 id="Configuring-the-ohpm-repo-Service-Configuration-File"><a href="#Configuring-the-ohpm-repo-Service-Configuration-File" class="headerlink" title="Configuring the ohpm-repo Service Configuration File"></a>Configuring the ohpm-repo Service Configuration File</h3><p>Go to the <code>conf</code> directory in the unzipped package and open <code>config.yaml</code>. The default configuration is as follows:  </p>
<pre><code class="language-yaml">##### server configuration section #####
listen: 0.0.0.0:8088
# listen:
# - localhost:8088            # 监听本机环回地址
# - http://localhost:8088     # 监听本机环回地址
# - 0.0.0.0:8088              # 监听本机所有地址 (INADDR_ANY)
# 协议可配置 http 或者 https，默认为 http
# port: 1-65535(Windows系统)/ 1024-65535(Linux或Mac系统）

# 可选 (listen 为 https 协议时必须配置)
https_key: &#39;&#39;                 # https 服务使用的 key 的路径  (不配置默认为&#39;&#39;)
https_cert: &#39;&#39;                # https 服务使用的 crt 的路径  (不配置默认为&#39;&#39;)

##### server deploy root section #####
deploy_root: &#39;&#39;                # 安装根目录 (不配置默认为 `&lt;现有用户home目录&gt;/ohpm-repo`)，只支持绝对路径，且路径目录必须存在

##### server numeric limit section #####
max_package_size: 100          # 上传包大小限制，单位是MB (0, 100]，不配置默认为 100
max_extract_size: 500          # 压缩包解压后大小限制，单位是MB [max_package_size, 500]，不配置默认为 500
max_extract_file_num: 10240    # 压缩包解压后文件个数限制 (0, 102400]，不配置默认为 10240
user_rate_limit: 100           # 用户访问频率控制，单位是次/s (0, 10000]，不配置默认为 100
fetch_timeout: 60              # 请求/响应的超时时间，单位是秒 (0, 3600]，不配置默认为 60
keep_alive_timeout: 60         # TCP 保持连接的超时时间，单位是秒 (0, 3600]，不配置默认为 60
api_timeout: 60                # api超时时间，单位是秒(0, 3600]，不配置默认为 60
upload_lock_hour: 24           # 下架某一三方包所有版本后，限时禁止同名三方包上传，单位是小时 (0, 168]，不配置，默认为 24
upload_max_times: 100          # 单用户24小时内上传次数限制 (0, 10000]，不配置默认为 100

##### metadata storage section #####
## 数据存储类型 filedb 和 mysql 二选一，不可都配置
db:                         # 必须用 yaml 数组形式写法
  type: filedb
  config:                   # 如果想修改存储路径且保留旧的数据，则需要把旧路径下的数据文件迁移至新路径
    path: ./db              # 本地数据存储路径，不配置默认为&lt;deploy_root&gt;/db;

#db:                        # 必须用yaml数组形式写法
#  type: mysql
#  config:
#    host: &quot;localhost&quot;      # 数据库主机地址
#    port: 3306             # 数据库端口 (0,65535]
#    username: root         # 数据库的用户名
#    password: &quot;password&quot;   # 数据库的用户密码（请配置明文, 最终在部署目录中会转换为密文）
#    database: &quot;repo&quot;       # 数据库名

##### storage section #####
## 文件存储类型fs,sftp 和 custom 三选一，不可多选。

store:                               # 必须用 yaml 数组形式写法
  type: fs
  config:                            # 上传资源后如若要修改存储路径，则需要把旧路径下的数据迁移至新路径中
    path: ./storage                  # 已上架三方库存储路径，不配置默认为 &lt;deploy_root&gt;/storage;
    #server: http://localhost:8088   # 三方库下载链接，不配置默认取值

# 文件存储类型为 sftp 时，最多配置三个 sftp服务
#store:                               # 必须用 yaml 数组形式写法
#  type: sftp                         # 当且仅当 db 的类型为 mysql 时，store 的类型才能为 sftp
#  config:
#    location:
#      -
#        name: test_one_sftp          # 主机名字，名字不能与其他sftp配置重复
#        host: &quot;localhost&quot;            # 主机地址
#        port: 22                     # 主机端口 (0,65535]
#        read_username: &quot;read&quot;        # 主机有读权限的用户名字
#        read_password: &quot;password&quot;    # 主机有读权限的用户密码（请配置明文, 最终在部署目录中会转换为密文）
#        write_username: &quot;write&quot;      # 主机有写权限的用户名字
#        write_password: &quot;password&quot;   # 主机有写权限的用户密码（请配置明文, 最终在部署目录中会转换为密文）
#        path: /source22              # 相对 sftp 根目录的文件路径，仅限/开头，且路径文件夹必须存在
#      -
#        name: test_two_sftp
#        host: &quot;localhost&quot;
#        port: 24
#        read_username: &quot;read&quot;
#        read_password: &quot;password&quot;
#        write_username: &quot;write&quot;
#        write_password: &quot;password&quot;
#        path: /source24
#    #server: http://localhost:8088   # 本地仓库下载链接地址，不配置默认取 listen 的值、

#store:
#  type: custom                                            # custom是自定义存储插件类型，自定义存储插件开发流程见指导文档
#  config:
#    export_name: CustomStorage                            # 插件export的类名
#    plugin_path: ../plugins/CustomStorage.js              # 插件的绝对路径或者相对于ohpm-repo软件包的路径，建议将插件放在软件包的plugins目录下
#    custom_field: &quot;test&quot;                                  # 自定义字段，通过引入libs/common/getStorageConfigInfo.js的getStorageConfigInfo方法获取自定义字段的值
#    #server: http://localhost:8088                        # 本地仓库下载链接地址，不配置默认取listen的值
##### uplink section #####
uplink_cache_path: ./uplink      # 缓存路径，不配置默认为 &lt;deploy_root&gt;/uplink
uplink_cache_time: 168           # 远程包 metadata 缓存时间，单位为小时，默认 168 小时，取值范围为 (0, 8760]

##### log section #####
logs_path: ./logs                # 日志路径，不配置默认为 &lt;deploy_root&gt;/logs

##### log level section #####
# 日志级别: 级别由低到高分别是 all、trace、debug、info、warn、error、fatal、mark、off
# run，operate 和 access 不配置或者配置错误，默认为 info
loglevel_run: info
loglevel_operate: info
loglevel_access: info
</code></pre>
<p>The configuration includes listening ports, HTTPS settings, private repository deployment directory <code>deploy_root</code>, server configurations, storage settings <code>db</code>, logs, etc. Configure them according to actual needs.  </p>
<p><strong>Storage module notes</strong>:  </p>
<ul>
<li><code>db</code> configures metadata storage, supporting fileDB (local) or MySQL.  </li>
<li><code>store</code> configures file storage, supporting local storage, SFTP storage, or custom plugin storage.</li>
</ul>
<p><strong>How to modify the configuration file after the private repository starts successfully</strong>:  </p>
<ul>
<li>If the configuration file was specified during the first startup with the <code>install</code> command: Modify the specified configuration file, then re-run <code>install</code> with the updated file and start the repository.  </li>
<li>If no configuration file was specified during the first startup: Modify the configuration file in the <code>conf</code> directory of the unzipped package, then re-run <code>install</code> and <code>start</code>.</li>
</ul>
<h3 id="Installation-and-Startup"><a href="#Installation-and-Startup" class="headerlink" title="Installation and Startup"></a>Installation and Startup</h3><p>Run <code>ohpm-repo install</code> to install. After installation, configure environment variables as needed, then start the service with <code>ohpm-repo start</code>.  </p>
<h2 id="Using-Private-Repository-Shared-Packages"><a href="#Using-Private-Repository-Shared-Packages" class="headerlink" title="Using Private Repository Shared Packages"></a>Using Private Repository Shared Packages</h2><p>By default, the ohpm client pulls dependencies only from the official public repository. To pull from a private repository, use one of the following configurations:  </p>
<ol>
<li>Configure the private repository for all projects:<br><code>ohpm config set registry &lt;private_repo_address&gt;/repos/ohpm</code>  </li>
<li>Configure for a specific dependency installation:<br><code>ohpm install @ohos/lottie --registry &lt;private_repo_address&gt;/repos/ohpm</code></li>
</ol>
<p>The <strong>private_repo_address</strong> is the <code>store.config.server</code> address in the configuration file. For example, if <code>store.config.server</code> is <code>http://127.0.0.1:8088</code>, the registry is <code>http://127.0.0.1:8088/repos/ohpm</code>. If <code>store.config.server</code> is not configured, use the default value.  </p>
<h2 id="Publishing-Shared-Packages"><a href="#Publishing-Shared-Packages" class="headerlink" title="Publishing Shared Packages"></a>Publishing Shared Packages</h2><p>Local shared packages (both static and dynamic) can be published via ohpm commands or a web interface. Command-line publishing is typically preferred for efficiency:  </p>
<ol>
<li>Generate an SSH key locally:<br><code>ssh-keygen -m PEM -t RSA -b 4096 -f &lt;your_key_path&gt;</code>  </li>
<li>Log in to the ohpm-repo management interface, go to Profile, add a public key, and paste the content of <code>&lt;your_key_path&gt;.pub</code>.  </li>
<li>Set the private key path:<br><code>ohpm config set key_path &lt;your_key_path&gt;</code>  </li>
<li>Log in to the ohpm-repo management interface, copy the publish ID from Profile.  </li>
<li>Configure the publish ID in <code>.ohpmrc</code>:<br><code>ohpm config set publish_id &lt;your_publish_id&gt;</code>  </li>
<li>Publish a static shared library:<br><code>ohpm publish demo.har</code>  </li>
<li>Publish a dynamic shared package:<br><code>ohpm publish demo.tgz</code>  <ul>
<li>HSP packages cannot be published directly; convert them to <code>.tgz</code> first.  </li>
<li>Switch to release mode during compilation to generate <code>.tgz</code> packages.</li>
</ul>
</li>
</ol>
<h3 id="Module-Configuration"><a href="#Module-Configuration" class="headerlink" title="Module Configuration"></a>Module Configuration</h3><p>In the library module (at the same level as the <code>src</code> folder), add the following files:  </p>
<ul>
<li><strong>README.md</strong>: Must include package introduction and usage. Add detailed descriptions as needed.  </li>
<li><strong>CHANGELOG.md</strong>: Record version updates for the HAR.  </li>
<li><strong>LICENSE</strong>: License file.</li>
</ul>
<p>The README.md is displayed on the private repository web platform, so clear documentation is essential.  </p>
<p><strong>oh_package.json5 configuration example</strong>:  </p>
<pre><code class="language-json5">&#123;  
    &quot;parameterFile&quot;: &quot;../dependencies.json5&quot;,  
    &quot;keywords&quot;: [  
        &quot;asr&quot;  
    ],  
    &quot;name&quot;: &quot;@xx/base-asr&quot;,  
    &quot;version&quot;: &quot;1.0.0-rc.9&quot;,  
    &quot;repository&quot;: &quot;http://gerrit.google.com/mobile_harmony/base_asr&quot;,  
    &quot;description&quot;: &quot;asr sdk&quot;,  
    &quot;main&quot;: &quot;Index.ets&quot;,  
    &quot;author&quot;: &quot;qingkouwei&quot;,  
    &quot;license&quot;: &quot;Apache-2.0&quot;,  
    &quot;dependencies&quot;: &#123;  
        
    &#125;  
&#125;
</code></pre>
<p>Module name, version, and description must meet requirements; otherwise, uploads will fail. Version numbers must increase sequentially (unlike Android’s SNAPSHOT overwrite capability).  </p>
<h2 id="Best-Practices"><a href="#Best-Practices" class="headerlink" title="Best Practices"></a>Best Practices</h2><p>In practical development, projects with multiple SDKs may require frequent uploads to the private repository for debugging. Manually compiling and uploading each SDK is tedious, especially when SDKs have dependencies.  </p>
<p>The optimal solution is to use scripts for one-click compilation, upload, and dependency-ordered publishing:  </p>
<ol>
<li>Create <code>version.json5</code> to store SDK versions:</li>
</ol>
<pre><code class="language-json5">&#123;  
  &quot;project&quot;: &#123;  
    &quot;sdk_version&quot;: &quot;1.1.0-rc.1&quot;,  
  &#125;  
&#125;
</code></pre>
<ol start="2">
<li>Automatic packaging script:</li>
</ol>
<pre><code class="language-python">def run_commands(modulename, productname):  
    hvigor_home = &#39;/Applications/DevEco-Studio.app/Contents/tools/hvigor&#39;  
  
    # 打包命令
    command1 = &#39;node %s/bin/hvigorw.js --mode module -p product=default -p module=%s@default -p buildMode=debug assembleHar --analyze --parallel --incremental --daemon&#39; %(hvigor_home,modulename)  
  
    # 等待第一个命令执行完成  
    process1.wait()  
  
    # 上传命令  
    ohpm publish productname
    process2.wait()
</code></pre>
<ol start="3">
<li>Automatic version update script:</li>
</ol>
<pre><code class="language-python">def changeVersionAModule():  
    with open(&#39;version.json5&#39;, &#39;r&#39;) as f:  
        data = json5.load(f)  
        versionName = data[&#39;project&#39;][&#39;sdk_version&#39;]  
  
        with open(&#39;AModule/oh-package.json5&#39;, &#39;r&#39;) as f:  
            aData = json5.load(f)  
            aData[&#39;version&#39;] = versionName  
            with open(&#39;AModule/oh-package.json5&#39;, &#39;w&#39;) as f:  
                json.dump(aData, f, indent=4)  
  
        with open(&#39;dependencies.json5&#39;, &#39;r&#39;) as depf:  
            depData = json5.load(depf)  
            depData[&#39;version_base&#39;][&#39;base-a&#39;] = versionName  
            with open(&#39;dependencies.json5&#39;, &#39;w&#39;) as depf:  
                json.dump(depData, depf, indent=4)
</code></pre>
<h2 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h2><p>This article introduces the construction of HarmonyOS private repositories, the dependency and publishing process for shared packages, and best practices for one-click packaging&#x2F;uploading in complex module dependency scenarios.  </p>
<h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><ul>
<li><a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/ide-har-publish-0000001597973129-V5">Publishing Shared Packages</a>  </li>
<li><a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/ide-ohpm-repo-0000001749596668-V5">ohpm-repo Private Repository Tool</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://harmonyostech.github.io/2025/06/30/C-HarmonyOS-Next-Layout-Practice-1-Implementation-of-Common-TitleBar/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Qingkouwei">
      <meta itemprop="description" content="Welcome to the HarmonyOS NEXT Knowledge Charging Station!  This is a hub for knowledge about HarmonyOS Next`s new-generation system. With its self-developed kernel, HarmonyOS NEXT achieves native smoothness, security, intelligence, and interconnectivity. We deeply analyze how its new distributed soft bus revolutionizes device connectivity experiences and explain the principles behind the enhanced perception and reasoning capabilities of the Xiaoyi intelligent agent based on the Pangu large model. Whether you are a developer exploring application development or an ordinary user eager to understand system features, you can "recharge" here and quickly grasp the essence of HarmonyOS NEXT.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HarmonyOS NEXT Knowledge Charging Station">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/06/30/C-HarmonyOS-Next-Layout-Practice-1-Implementation-of-Common-TitleBar/" class="post-title-link" itemprop="url">HarmonyOS Next Layout Practice 1: Implementation of Common TitleBar</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2025-06-30 21:46:54" itemprop="dateCreated datePublished" datetime="2025-06-30T21:46:54+08:00">2025-06-30</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-07-13 17:13:52" itemprop="dateModified" datetime="2025-07-13T17:13:52+08:00">2025-07-13</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/HarmonyOS-Next-Tech/" itemprop="url" rel="index"><span itemprop="name">HarmonyOS Next Tech</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="HarmonyOS-Layout-Practice-1-Implementation-of-Common-TitleBar"><a href="#HarmonyOS-Layout-Practice-1-Implementation-of-Common-TitleBar" class="headerlink" title="HarmonyOS Layout Practice 1: Implementation of Common TitleBar"></a>HarmonyOS Layout Practice 1: Implementation of Common TitleBar</h1><h2 id="Background"><a href="#Background" class="headerlink" title="Background"></a>Background</h2><p>TitleBar is the most commonly used component in daily development. Although each application may have a different style, the overall layout generally consists of three areas:  </p>
<ol>
<li>Left return area  </li>
<li>Middle title area  </li>
<li>Right button area</li>
</ol>
<p>Below are screenshots of the TitleBar effects from WeChat and My Huawei applications:  </p>
<p><img src="/../images/HarmonyOS%20%E5%B8%83%E5%B1%80%E5%AE%9E%E8%B7%B51%20%E5%B8%B8%E7%94%A8TitleBar%E5%AE%9E%E7%8E%B0.png"><br><img src="/../images/HarmonyOS%20%E5%B8%83%E5%B1%80%E5%AE%9E%E8%B7%B51%20%E5%B8%B8%E7%94%A8TitleBar%E5%AE%9E%E7%8E%B0-1.png"></p>
<p>In WeChat, the content area is centered, while in My Huawei, it is left-aligned. In practical development, we may encounter both scenarios. Let’s encapsulate a TitleBar to achieve the following functions:  </p>
<ol>
<li>The far left supports a return button + text.  </li>
<li>The right side can have up to two buttons.  </li>
<li>The middle title area should adaptively occupy space without exceeding the left and right areas, and can be controlled to align left or center.</li>
</ol>
<h2 id="Selection-of-Layout-Container"><a href="#Selection-of-Layout-Container" class="headerlink" title="Selection of Layout Container"></a>Selection of Layout Container</h2><p>The overall effect requires fixed left and right areas with the middle area expanding. In Android, we would first think of RelativeLayout, and HarmonyOS provides a similar relative layout called RelativeContainer. RelativeContainer supports setting relative position relationships for child elements, making it suitable for complex interface scenarios to align and arrange multiple sub-components. Child elements can specify siblings or the parent container as anchors for relative positioning.  </p>
<p>RelativeContainer introduces two concepts: anchors and alignment methods:  </p>
<ul>
<li><strong>Anchors</strong>: Set the position of the current element based on another element. Anchor settings define the positional dependency of child elements relative to the parent or siblings. Horizontally, left, middle, and right anchors can be set; vertically, top, center, and bottom anchors are supported. IDs must be set for the RelativeContainer and its child elements to specify anchor information. The RelativeContainer’s default ID is “<strong>container</strong>“, and other child elements use the <code>id</code> attribute. Components without an ID can still be displayed but cannot be used as anchors by other children. The framework will generate an ID for them, but the pattern is unpredictable and cannot be directly used.  </li>
<li><strong>Alignment Methods</strong>: Define whether the current element aligns top&#x2F;middle&#x2F;bottom or left&#x2F;middle&#x2F;right relative to the anchor.</li>
</ul>
<p><strong>Notes</strong>: Avoid circular dependencies, as they will cause all child components in the container to fail to render. If more than two position anchors are set in the same direction, and the anchor positions are out of order, the child component will have a size of 0 (i.e., not render).  </p>
<h2 id="Layout-Implementation"><a href="#Layout-Implementation" class="headerlink" title="Layout Implementation"></a>Layout Implementation</h2><p>The parent layout uses RelativeContainer. The left and right buttons are positioned relative to the parent’s left and right sides, while the middle container is positioned relative to the right of the left layout and the left of the right layout. The overall structure is as follows:  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">build() &#123;  </span><br><span class="line">  RelativeContainer() &#123;  </span><br><span class="line">    Text(&#x27;左侧&#x27;)  </span><br><span class="line">      .fontSize(10)  </span><br><span class="line">      .fontWeight(FontWeight.Bold)  </span><br><span class="line">      .id(&quot;base_title_left_container&quot;)  </span><br><span class="line">      .alignRules(&#123;  </span><br><span class="line">        bottom: &#123; anchor: &quot;__container__&quot;, align: VerticalAlign.Bottom &#125;,  </span><br><span class="line">        left: &#123; anchor: &quot;__container__&quot;, align: HorizontalAlign.Start &#125;  </span><br><span class="line">      &#125;)  </span><br><span class="line">  </span><br><span class="line">    Text(&#x27;右侧&#x27;)  </span><br><span class="line">        .fontSize(10)  </span><br><span class="line">        .fontWeight(FontWeight.Bold)  </span><br><span class="line">    .id(&quot;base_title_right_container&quot;)  </span><br><span class="line">      .alignRules(&#123;  </span><br><span class="line">        bottom: &#123; anchor: &quot;__container__&quot;, align: VerticalAlign.Bottom &#125;,  </span><br><span class="line">        right: &#123; anchor: &quot;__container__&quot;, align: HorizontalAlign.End &#125;  </span><br><span class="line">      &#125;)  </span><br><span class="line">      // .backgroundColor(&#x27;#00ff00&#x27;)  </span><br><span class="line">    Row()&#123;  </span><br><span class="line">      Text(&#x27;中间内容&#x27;)  </span><br><span class="line">        .fontSize(10)  </span><br><span class="line">        .fontWeight(FontWeight.Bold)  </span><br><span class="line">  </span><br><span class="line">    &#125;.alignRules(&#123;  </span><br><span class="line">      bottom: &#123; anchor: &quot;__container__&quot;, align: VerticalAlign.Bottom &#125;,  </span><br><span class="line">      left: &#123; anchor: &quot;base_title_left_container&quot;, align: HorizontalAlign.End &#125;,  </span><br><span class="line">      right: &#123; anchor: &quot;base_title_right_container&quot;, align: HorizontalAlign.Start &#125;  </span><br><span class="line">    &#125;).backgroundColor(&#x27;#ff0000&#x27;)  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">  &#125;  </span><br><span class="line">  .height(&#x27;40&#x27;)  </span><br><span class="line">  .width(&#x27;100%&#x27;)  </span><br><span class="line">  .backgroundColor(&#x27;#ccc&#x27;)  </span><br><span class="line">  .margin(&#123;top:100&#125;)  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The display effect is as follows:<br><img src="/../images/HarmonyOS%20%E5%B8%83%E5%B1%80%E5%AE%9E%E8%B7%B51%20%E5%B8%B8%E7%94%A8TitleBar%E5%AE%9E%E7%8E%B0-2.png"><br>This meets expectations. When the right side needs to display two buttons, wrap them in a container:  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">build() &#123;  </span><br><span class="line">  RelativeContainer() &#123;  </span><br><span class="line">    Text(&#x27;左侧&#x27;)  </span><br><span class="line">      .fontSize(10)  </span><br><span class="line">      .fontWeight(FontWeight.Bold)  </span><br><span class="line">      .id(&quot;base_title_left_container&quot;)  </span><br><span class="line">      .alignRules(&#123;  </span><br><span class="line">        bottom: &#123; anchor: &quot;__container__&quot;, align: VerticalAlign.Bottom &#125;,  </span><br><span class="line">        left: &#123; anchor: &quot;__container__&quot;, align: HorizontalAlign.Start &#125;  </span><br><span class="line">      &#125;)  </span><br><span class="line">  </span><br><span class="line">    Flex(&#123; justifyContent: FlexAlign.End, alignItems: ItemAlign.Center &#125;) &#123;  </span><br><span class="line">      Text(&#x27;右侧2&#x27;)  </span><br><span class="line">        .fontSize(10)  </span><br><span class="line">        .fontWeight(FontWeight.Bold)  </span><br><span class="line">      Text(&#x27;右侧1&#x27;)  </span><br><span class="line">        .fontSize(10)  </span><br><span class="line">        .fontWeight(FontWeight.Bold)  </span><br><span class="line">    &#125;  </span><br><span class="line">    .id(&quot;base_title_right_container&quot;)  </span><br><span class="line">      .alignRules(&#123;  </span><br><span class="line">        bottom: &#123; anchor: &quot;__container__&quot;, align: VerticalAlign.Bottom &#125;,  </span><br><span class="line">        right: &#123; anchor: &quot;__container__&quot;, align: HorizontalAlign.End &#125;  </span><br><span class="line">      &#125;)  </span><br><span class="line">      // .backgroundColor(&#x27;#00ff00&#x27;)  </span><br><span class="line">    Row()&#123;  </span><br><span class="line">      Text(&#x27;中间内容&#x27;)  </span><br><span class="line">        .fontSize(10)  </span><br><span class="line">        .fontWeight(FontWeight.Bold)  </span><br><span class="line">  </span><br><span class="line">    &#125;.alignRules(&#123;  </span><br><span class="line">      bottom: &#123; anchor: &quot;__container__&quot;, align: VerticalAlign.Bottom &#125;,  </span><br><span class="line">      left: &#123; anchor: &quot;base_title_left_container&quot;, align: HorizontalAlign.End &#125;,  </span><br><span class="line">      right: &#123; anchor: &quot;base_title_right_container&quot;, align: HorizontalAlign.Start &#125;  </span><br><span class="line">    &#125;).backgroundColor(&#x27;#ff0000&#x27;)  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">  &#125;  </span><br><span class="line">  .height(&#x27;40&#x27;)  </span><br><span class="line">  .width(&#x27;100%&#x27;)  </span><br><span class="line">  .backgroundColor(&#x27;#ccc&#x27;)  </span><br><span class="line">  .margin(&#123;top:100&#125;)  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Effect:<br><img src="/../images/HarmonyOS%20%E5%B8%83%E5%B1%80%E5%AE%9E%E8%B7%B51%20%E5%B8%B8%E7%94%A8TitleBar%E5%AE%9E%E7%8E%B0-3.png"><br>The middle content disappears. After adding a background color to the right container:<br><img src="/../images/HarmonyOS%20%E5%B8%83%E5%B1%80%E5%AE%9E%E8%B7%B51%20%E5%B8%B8%E7%94%A8TitleBar%E5%AE%9E%E7%8E%B0-4.png"></p>
<p>It is found that the right layout occupies the entire width. Why?<br>The issue is that Flex cannot adapt to child node sizes. Switch to the Row container instead:  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">build() &#123;  </span><br><span class="line">  RelativeContainer() &#123;  </span><br><span class="line">    Text(&#x27;左侧&#x27;)  </span><br><span class="line">      .fontSize(10)  </span><br><span class="line">      .fontWeight(FontWeight.Bold)  </span><br><span class="line">      .id(&quot;base_title_left_container&quot;)  </span><br><span class="line">      .alignRules(&#123;  </span><br><span class="line">        bottom: &#123; anchor: &quot;__container__&quot;, align: VerticalAlign.Bottom &#125;,  </span><br><span class="line">        left: &#123; anchor: &quot;__container__&quot;, align: HorizontalAlign.Start &#125;  </span><br><span class="line">      &#125;)  </span><br><span class="line">  </span><br><span class="line">    Row() &#123;  </span><br><span class="line">      Text(&#x27;右侧2&#x27;)  </span><br><span class="line">        .fontSize(10)  </span><br><span class="line">        .fontWeight(FontWeight.Bold)  </span><br><span class="line">      Text(&#x27;右侧1&#x27;)  </span><br><span class="line">        .fontSize(10)  </span><br><span class="line">        .fontWeight(FontWeight.Bold)  </span><br><span class="line">    &#125;  </span><br><span class="line">    .id(&quot;base_title_right_container&quot;)  </span><br><span class="line">      .alignRules(&#123;  </span><br><span class="line">        bottom: &#123; anchor: &quot;__container__&quot;, align: VerticalAlign.Bottom &#125;,  </span><br><span class="line">        right: &#123; anchor: &quot;__container__&quot;, align: HorizontalAlign.End &#125;  </span><br><span class="line">      &#125;)  </span><br><span class="line">      .backgroundColor(&#x27;#00ff00&#x27;)  </span><br><span class="line">    Row()&#123;  </span><br><span class="line">      Text(&#x27;中间内容&#x27;)  </span><br><span class="line">        .fontSize(10)  </span><br><span class="line">        .fontWeight(FontWeight.Bold)  </span><br><span class="line">  </span><br><span class="line">    &#125;.alignRules(&#123;  </span><br><span class="line">      bottom: &#123; anchor: &quot;__container__&quot;, align: VerticalAlign.Bottom &#125;,  </span><br><span class="line">      left: &#123; anchor: &quot;base_title_left_container&quot;, align: HorizontalAlign.End &#125;,  </span><br><span class="line">      right: &#123; anchor: &quot;base_title_right_container&quot;, align: HorizontalAlign.Start &#125;  </span><br><span class="line">    &#125;).backgroundColor(&#x27;#ff0000&#x27;)  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">  &#125;  </span><br><span class="line">  .height(&#x27;40&#x27;)  </span><br><span class="line">  .width(&#x27;100%&#x27;)  </span><br><span class="line">  .backgroundColor(&#x27;#ccc&#x27;)  </span><br><span class="line">  .margin(&#123;top:100&#125;)  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The effect returns to normal:<br><img src="/../images/HarmonyOS%20%E5%B8%83%E5%B1%80%E5%AE%9E%E8%B7%B51%20%E5%B8%B8%E7%94%A8TitleBar%E5%AE%9E%E7%8E%B0-5.png"></p>
<h2 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h2><p>This article introduces the characteristics and attributes of HarmonyOS’s RelativeContainer through the layout implementation of the common TitleBar control. It also highlights the difference in adaptive child node capabilities between Flex and Row: Row can adapt to child node widths, while Flex will fill the entire parent layout width.</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/37/">37</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Qingkouwei</p>
  <div class="site-description" itemprop="description">Welcome to the HarmonyOS NEXT Knowledge Charging Station!  This is a hub for knowledge about HarmonyOS Next`s new-generation system. With its self-developed kernel, HarmonyOS NEXT achieves native smoothness, security, intelligence, and interconnectivity. We deeply analyze how its new distributed soft bus revolutionizes device connectivity experiences and explain the principles behind the enhanced perception and reasoning capabilities of the Xiaoyi intelligent agent based on the Pangu large model. Whether you are a developer exploring application development or an ordinary user eager to understand system features, you can "recharge" here and quickly grasp the essence of HarmonyOS NEXT.</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">364</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">5</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">1</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Qingkouwei</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
