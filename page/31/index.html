<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"harmonyostech.github.io","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="Welcome to the HarmonyOS NEXT Knowledge Charging Station!  This is a hub for knowledge about HarmonyOS Next&#96;s new-generation system. With its self-developed kernel, HarmonyOS NEXT achieves native smoo">
<meta property="og:type" content="website">
<meta property="og:title" content="HarmonyOS NEXT Knowledge Charging Station">
<meta property="og:url" content="https://harmonyostech.github.io/page/31/index.html">
<meta property="og:site_name" content="HarmonyOS NEXT Knowledge Charging Station">
<meta property="og:description" content="Welcome to the HarmonyOS NEXT Knowledge Charging Station!  This is a hub for knowledge about HarmonyOS Next&#96;s new-generation system. With its self-developed kernel, HarmonyOS NEXT achieves native smoo">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Qingkouwei">
<meta property="article:tag" content="HarmonyOSNext, HarmonyOS NEXT, HarmonyOS, Cangjie">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://harmonyostech.github.io/page/31/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>HarmonyOS NEXT Knowledge Charging Station</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">HarmonyOS NEXT Knowledge Charging Station</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">Analysis of Core Technologies and Application Scenarios of HarmonyOS NEXT</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://harmonyostech.github.io/2025/06/24/HarmonyOS%20Next%20IM%20Combat:%20Functional%20Anomaly%20of%20Event%20Cancellation%20Caused%20by%20Dual%20Navigation%20Lifecycles/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Qingkouwei">
      <meta itemprop="description" content="Welcome to the HarmonyOS NEXT Knowledge Charging Station!  This is a hub for knowledge about HarmonyOS Next`s new-generation system. With its self-developed kernel, HarmonyOS NEXT achieves native smoothness, security, intelligence, and interconnectivity. We deeply analyze how its new distributed soft bus revolutionizes device connectivity experiences and explain the principles behind the enhanced perception and reasoning capabilities of the Xiaoyi intelligent agent based on the Pangu large model. Whether you are a developer exploring application development or an ordinary user eager to understand system features, you can "recharge" here and quickly grasp the essence of HarmonyOS NEXT.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HarmonyOS NEXT Knowledge Charging Station">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/06/24/HarmonyOS%20Next%20IM%20Combat:%20Functional%20Anomaly%20of%20Event%20Cancellation%20Caused%20by%20Dual%20Navigation%20Lifecycles/" class="post-title-link" itemprop="url">HarmonyOS Next IM Combat: Functional Anomaly of Event Cancellation Caused by Dual Navigation Lifecycles</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2025-06-24 15:09:32 / Modified: 16:09:29" itemprop="dateCreated datePublished" datetime="2025-06-24T15:09:32+08:00">2025-06-24</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="HarmonyOS-Next-IM-Combat-Functional-Anomaly-of-Event-Cancellation-Caused-by-Dual-Navigation-Lifecycles"><a href="#HarmonyOS-Next-IM-Combat-Functional-Anomaly-of-Event-Cancellation-Caused-by-Dual-Navigation-Lifecycles" class="headerlink" title="HarmonyOS Next IM Combat: Functional Anomaly of Event Cancellation Caused by Dual Navigation Lifecycles"></a>HarmonyOS Next IM Combat: Functional Anomaly of Event Cancellation Caused by Dual Navigation Lifecycles</h1><h4 id="Background-Introduction"><a href="#Background-Introduction" class="headerlink" title="Background Introduction"></a>Background Introduction</h4><p>Users of the IM application’s chat page reported being unable to view large images by clicking on them. Code review showed that the large image click used the <code>ohos.events.emitter</code> event mechanism. Further investigation revealed that events were emitted but not consumed. Logs indicated successful event registration, but no event reception.  </p>
<h4 id="Problem-Diagnosis"><a href="#Problem-Diagnosis" class="headerlink" title="Problem Diagnosis"></a>Problem Diagnosis</h4><p>Further analysis showed the issue consistently occurred when cold-starting the app by clicking a notification, while hot-starting via a push notification worked normally. Both company apps integrated HarmonyOS’s PushKit to receive notifications when backgrounded or closed, but only one exhibited the problem.  </p>
<p>Log analysis revealed that cold-starting the app from a notification and entering the chat page triggered one <code>aboutToAppear</code> and one proactive <code>aboutToDisappear</code> in the chat page. Further inspection showed the chat page’s lifecycle was executed twice: Chat Page 1 <code>aboutToAppear</code> → Chat Page 2 <code>aboutToAppear</code> → Chat Page 2 <code>aboutToDisappear</code>.  </p>
<p>Initially suspected to relate to PushKit, the hypothesis was dismissed when the other app functioned normally. Clicking a notification triggers navigation to the chat page via <code>onNewWant</code>. Expert consultation suggested the issue might stem from multiple <code>Navigation</code> instances in the app.  </p>
<p>Code review revealed that after a cold start, the app did not immediately navigate to the chat page in <code>onNewWant</code> but waited for the home page to load, then navigated to the chat page in the home page’s <code>aboutToAppear</code>. The app loads a splash screen in <code>onWindowStageCreate</code>, navigates from the splash screen’s <code>aboutToAppear</code> to the home page, and then from the home page’s <code>aboutToAppear</code> to the chat page. The splash screen and home page are two <code>Navigation</code> instances sharing a <code>NavPathStack</code>.  </p>
<p>Understanding <code>Navigation</code> lifecycles: As a routing container, <code>Navigation</code> lifecycles are hosted on <code>NavDestination</code> components, exposed as component events. Lifecycles fall into three categories: custom component lifecycles, universal component lifecycles, and proprietary lifecycles. <code>aboutToAppear</code> and <code>aboutToDisappear</code> are custom component lifecycles (for the custom component wrapping <code>NavDestination</code>), while <code>onAppear</code> and <code>onDisappear</code> are universal component lifecycles. The remaining lifecycles are unique to <code>NavDestination</code>.  </p>
<p>Lifecycle timeline:<br><img src="/../images/HarmonyOS%20Next%20IM%E5%AE%9E%E6%88%98%EF%BC%9A%E5%8F%8CNavigation%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E5%BC%95%E8%B5%B7%E7%9A%84%E4%BA%8B%E4%BB%B6%E8%A2%AB%E5%8F%96%E6%B6%88%E5%8A%9F%E8%83%BD%E5%BC%82%E5%B8%B8%E9%97%AE%E9%A2%98.png" alt="text"></p>
<ul>
<li><strong>aboutToAppear</strong>: Executed after creating a custom component and before its <code>build()</code> function (before <code>NavDestination</code> creation). Allows modifying state variables, which take effect in the subsequent <code>build()</code> execution.  </li>
<li><strong>onWillAppear</strong>: Executed after <code>NavDestination</code> creation and before mounting to the component tree. State changes here take effect in the current frame.  </li>
<li><strong>onAppear</strong>: Universal lifecycle event triggered when <code>NavDestination</code> mounts to the component tree.  </li>
<li><strong>onWillShow</strong>: Executed before <code>NavDestination</code> is layout-displayed (not triggered when the app switches to the foreground).  </li>
<li><strong>onShown</strong>: Executed after <code>NavDestination</code> is layout-displayed, indicating layout completion.  </li>
<li><strong>onActive</strong>: Triggered when <code>NavDestination</code> is active (at the stack top and operable, with no special components obscuring it).  </li>
<li><strong>onWillHide</strong>: Executed before <code>NavDestination</code> is hidden (not triggered when the app switches to the background).  </li>
<li><strong>onInactive</strong>: Triggered when <code>NavDestination</code> is inactive (not at the stack top or obscured by special components when at the stack top).  </li>
<li><strong>onHidden</strong>: Executed after <code>NavDestination</code> is hidden (when a new page is pushed, the top page is popped, or the app switches to the background).  </li>
<li><strong>onWillDisappear</strong>: Executed before <code>NavDestination</code> is destroyed. If there is a transition animation, it triggers before the animation (when the top page is popped).  </li>
<li><strong>onDisappear</strong>: Universal lifecycle event triggered when <code>NavDestination</code> is unmounted and destroyed from the component tree.  </li>
<li><strong>aboutToDisappear</strong>: Executed before a custom component is destructed; state variable modifications are prohibited.</li>
</ul>
<p>The lifecycle when navigating from Page A to Page B is: A <code>aboutToAppear</code> → B <code>aboutToAppear</code> → A <code>aboutToDisappear</code>.  </p>
<p>The root cause was identified: When navigating to the chat page in the home page’s <code>aboutToAppear</code>, the splash screen’s <code>aboutToDisappear</code> had not completed, leaving both <code>Navigation</code> instances active. This caused the chat page to execute <code>aboutToAppear</code> twice. After the splash screen’s <code>aboutToDisappear</code>, the second chat page instance was automatically <code>aboutToDisappear</code>ed, canceling event subscriptions.  </p>
<h4 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h4><p>After identifying the problem, the fix involved adding a 20ms delay to the chat page navigation, resolving the issue. A more elegant solution is to navigate to the chat page after the splash screen’s <code>aboutDisappear</code> or modify the splash screen to a non-<code>Navigation</code> structure.  </p>
<h4 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h4><p>Step-by-step troubleshooting revealed the root cause: Cold-starting the app with two <code>Navigation</code> components (splash screen and home page) sharing a <code>NavPathStack</code> caused the chat page to be repeatedly created and destroyed when navigating from the home page’s <code>aboutToAppear</code> before the splash screen’s <code>aboutToDisappear</code> completed. This invalidated event subscriptions (as the second page instance did not register event consumption logic). Solutions include delaying navigation, adjusting navigation timing until the splash screen is destroyed, or restructuring the splash screen as a non-<code>Navigation</code> to eliminate multi-<code>Navigation</code> coexistence. This case highlights the complexity of <code>Navigation</code> lifecycle management in HarmonyOS, emphasizing the need to strictly follow component mounting&#x2F;unmounting order in multi-page navigation to avoid lifecycle conflicts.  </p>
<blockquote>
<p>Reference: Component Navigation (Navigation) (Recommended): <a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-navigation-navigation#%E9%A1%B5%E9%9D%A2%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F">https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-navigation-navigation#%E9%A1%B5%E9%9D%A2%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F</a>  </p>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://harmonyostech.github.io/2025/06/24/HarmonyOS%20Next%20IM%20Combat:%20Sharing%20the%20Optimization%20Process%20for%20Slow%20Database%20Queries/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Qingkouwei">
      <meta itemprop="description" content="Welcome to the HarmonyOS NEXT Knowledge Charging Station!  This is a hub for knowledge about HarmonyOS Next`s new-generation system. With its self-developed kernel, HarmonyOS NEXT achieves native smoothness, security, intelligence, and interconnectivity. We deeply analyze how its new distributed soft bus revolutionizes device connectivity experiences and explain the principles behind the enhanced perception and reasoning capabilities of the Xiaoyi intelligent agent based on the Pangu large model. Whether you are a developer exploring application development or an ordinary user eager to understand system features, you can "recharge" here and quickly grasp the essence of HarmonyOS NEXT.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HarmonyOS NEXT Knowledge Charging Station">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/06/24/HarmonyOS%20Next%20IM%20Combat:%20Sharing%20the%20Optimization%20Process%20for%20Slow%20Database%20Queries/" class="post-title-link" itemprop="url">HarmonyOS Next IM Combat: Sharing the Optimization Process for Slow Database Queries</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2025-06-24 14:09:32 / Modified: 15:03:00" itemprop="dateCreated datePublished" datetime="2025-06-24T14:09:32+08:00">2025-06-24</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="HarmonyOS-Next-IM-Combat-Sharing-the-Optimization-Process-for-Slow-Database-Queries"><a href="#HarmonyOS-Next-IM-Combat-Sharing-the-Optimization-Process-for-Slow-Database-Queries" class="headerlink" title="HarmonyOS Next IM Combat: Sharing the Optimization Process for Slow Database Queries"></a>HarmonyOS Next IM Combat: Sharing the Optimization Process for Slow Database Queries</h1><h4 id="1-Background-Introduction"><a href="#1-Background-Introduction" class="headerlink" title="1. Background Introduction"></a>1. Background Introduction</h4><p>In the development of IMSDK, the client uses a relational database to store data such as conversations, users, and messages. Initially, when developing consumer (C-end) applications, no issues were found. However, this year, when business (B-end) users started using the application, they reported lags and message delays. Through troubleshooting, it was found that B-end users have more conversations and messages, leading to slower database queries. Since previous operations were all performed on the main thread, this caused application lags and delays. This article shares the problems encountered during the entire optimization process, problem-solving approaches, and final effects.  </p>
<h4 id="2-Introduction-to-HarmonyOS-Next-Relational-Database"><a href="#2-Introduction-to-HarmonyOS-Next-Relational-Database" class="headerlink" title="2. Introduction to HarmonyOS Next Relational Database"></a>2. Introduction to HarmonyOS Next Relational Database</h4><p>The HarmonyOS Next relational database is based on the SQLite component, suitable for scenarios requiring storage of data with complex relationships. For example, a user’s conversation information needs to include the conversation name, type, ID, etc., while chat information in conversations needs to include message IDs, types, contents, etc. Due to the strong correspondence between data elements—with complexity higher than key-value data—a relational database is required for persistent storage.  </p>
<p>The relational database provides universal operation interfaces for applications, using SQLite as the underlying persistent storage engine. It supports database features of SQLite, including but not limited to transactions, indexes, views, triggers, foreign keys, parameterized queries, and precompiled SQL statements.  </p>
<p>To implement data persistence using a relational database, a RdbStore must be obtained, which includes operations such as database creation, table creation, and version upgrades&#x2F;downgrades. Sample code is as follows:  </p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; relationalStore &#125; <span class="keyword">from</span> <span class="string">&#x27;@kit.ArkData&#x27;</span>; <span class="comment">// Import the module</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">UIAbility</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@kit.AbilityKit&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">BusinessError</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@kit.BasicServicesKit&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="variable language_">window</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@kit.ArkUI&#x27;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// This example is implemented in an Ability, but users can also use it in other reasonable scenarios</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">EntryAbility</span> <span class="keyword">extends</span> <span class="title class_ inherited__">UIAbility</span> &#123;</span><br><span class="line">  <span class="title function_">onWindowStageCreate</span>(<span class="params"><span class="attr">windowStage</span>: <span class="variable language_">window</span>.<span class="title class_">WindowStage</span></span>) &#123;</span><br><span class="line">    <span class="comment">// If a tokenizer is desired, call isStorageTypeSupported to check if the desired tokenizer is supported on the current platform.</span></span><br><span class="line">    <span class="keyword">let</span> tokenType = relationalStore.<span class="property">Tokenizer</span>.<span class="property">ICU_TOKENIZER</span>;</span><br><span class="line">    <span class="keyword">let</span> tokenTypeSupported = relationalStore.<span class="title function_">isTokenizerSupported</span>(tokenType);</span><br><span class="line">    <span class="keyword">if</span> (!tokenTypeSupported) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">`ICU_TOKENIZER is not supported on this platform.`</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> <span class="attr">STORE_CONFIG</span>: relationalStore.<span class="property">StoreConfig</span> = &#123;</span><br><span class="line">      <span class="attr">name</span>: <span class="string">&#x27;RdbTest.db&#x27;</span>, <span class="comment">// Database file name</span></span><br><span class="line">      <span class="attr">securityLevel</span>: relationalStore.<span class="property">SecurityLevel</span>.<span class="property">S3</span>, <span class="comment">// Database security level</span></span><br><span class="line">      <span class="attr">encrypt</span>: <span class="literal">false</span>, <span class="comment">// Optional parameter to specify if the database is encrypted (default: not encrypted)</span></span><br><span class="line">      <span class="attr">customDir</span>: <span class="string">&#x27;customDir/subCustomDir&#x27;</span>, <span class="comment">// Optional parameter for the database custom path. The database will be created in the directory structure: context.databaseDir + &#x27;/rdb/&#x27; + customDir, where context.databaseDir is the app sandbox path, &#x27;/rdb/&#x27; indicates a relational database, and customDir is the custom path. If this parameter is not provided, the RdbStore instance is created in the app sandbox directory by default.</span></span><br><span class="line">      <span class="attr">isReadOnly</span>: <span class="literal">false</span>, <span class="comment">// Optional parameter to specify if the database is opened in read-only mode (default: false, readable and writable). When true, only data reading is allowed; write operations will return error code 801.</span></span><br><span class="line">      <span class="attr">tokenizer</span>: tokenType <span class="comment">// Optional parameter to specify the tokenizer used in full-text search (FTS) scenarios. If not provided, only English tokenization is supported in FTS, not other languages.</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Determine the database version and perform upgrade/downgrade operations if it does not match</span></span><br><span class="line">    <span class="comment">// Assume the current database version is 3, with table structure: EMPLOYEE (NAME, AGE, SALARY, CODES, IDENTITY)</span></span><br><span class="line">    <span class="keyword">const</span> <span class="variable constant_">SQL_CREATE_TABLE</span> = <span class="string">&#x27;CREATE TABLE IF NOT EXISTS EMPLOYEE (ID INTEGER PRIMARY KEY AUTOINCREMENT, NAME TEXT NOT NULL, AGE INTEGER, SALARY REAL, CODES BLOB, IDENTITY UNLIMITED INT)&#x27;</span>; <span class="comment">// Table creation SQL statement, where IDENTITY is a bigint type specified as UNLIMITED INT in SQL</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    relationalStore.<span class="title function_">getRdbStore</span>(<span class="variable language_">this</span>.<span class="property">context</span>, <span class="variable constant_">STORE_CONFIG</span>, <span class="function">(<span class="params">err, store</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (err) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">`Failed to get RdbStore. Code:<span class="subst">$&#123;err.code&#125;</span>, message:<span class="subst">$&#123;err.message&#125;</span>`</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">info</span>(<span class="string">&#x27;Succeeded in getting RdbStore.&#x27;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">      <span class="comment">// When the database is created, the default version is 0</span></span><br><span class="line">      <span class="keyword">if</span> (store.<span class="property">version</span> === <span class="number">0</span>) &#123;</span><br><span class="line">        store.<span class="title function_">executeSql</span>(<span class="variable constant_">SQL_CREATE_TABLE</span>) <span class="comment">// Create the data table for subsequent insert operations</span></span><br><span class="line">          .<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">            <span class="comment">// Set the database version to an integer greater than 0</span></span><br><span class="line">            store.<span class="property">version</span> = <span class="number">3</span>;</span><br><span class="line">          &#125;)</span><br><span class="line">          .<span class="title function_">catch</span>(<span class="function">(<span class="params"><span class="attr">err</span>: <span class="title class_">BusinessError</span></span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">`Failed to executeSql. Code:<span class="subst">$&#123;err.code&#125;</span>, message:<span class="subst">$&#123;err.message&#125;</span>`</span>);</span><br><span class="line">          &#125;);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">      <span class="comment">// If the database version is not 0 and does not match the current version, upgrade/downgrade operations are required</span></span><br><span class="line">      <span class="comment">// When the database exists and is assumed to be version 1 (e.g., the app upgrades to the current version, requiring the database to upgrade from version 1 to 2)</span></span><br><span class="line">      <span class="keyword">if</span> (store.<span class="property">version</span> === <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">// version = 1: Table structure: EMPLOYEE (NAME, SALARY, CODES, ADDRESS) =&gt; version = 2: Table structure: EMPLOYEE (NAME, AGE, SALARY, CODES, ADDRESS)</span></span><br><span class="line">        store.<span class="title function_">executeSql</span>(<span class="string">&#x27;ALTER TABLE EMPLOYEE ADD COLUMN AGE INTEGER&#x27;</span>)</span><br><span class="line">          .<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">            store.<span class="property">version</span> = <span class="number">2</span>;</span><br><span class="line">          &#125;).<span class="title function_">catch</span>(<span class="function">(<span class="params"><span class="attr">err</span>: <span class="title class_">BusinessError</span></span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">`Failed to executeSql. Code:<span class="subst">$&#123;err.code&#125;</span>, message:<span class="subst">$&#123;err.message&#125;</span>`</span>);</span><br><span class="line">          &#125;);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">      <span class="comment">// When the database exists and is assumed to be version 2 (e.g., the app upgrades to the current version, requiring the database to upgrade from version 2 to 3)</span></span><br><span class="line">      <span class="keyword">if</span> (store.<span class="property">version</span> === <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="comment">// version = 2: Table structure: EMPLOYEE (NAME, AGE, SALARY, CODES, ADDRESS) =&gt; version = 3: Table structure: EMPLOYEE (NAME, AGE, SALARY, CODES)</span></span><br><span class="line">        store.<span class="title function_">executeSql</span>(<span class="string">&#x27;ALTER TABLE EMPLOYEE DROP COLUMN ADDRESS&#x27;</span>)</span><br><span class="line">          .<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">            store.<span class="property">version</span> = <span class="number">3</span>;</span><br><span class="line">          &#125;).<span class="title function_">catch</span>(<span class="function">(<span class="params"><span class="attr">err</span>: <span class="title class_">BusinessError</span></span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">`Failed to executeSql. Code:<span class="subst">$&#123;err.code&#125;</span>, message:<span class="subst">$&#123;err.message&#125;</span>`</span>);</span><br><span class="line">          &#125;);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// Ensure that after obtaining the RdbStore instance and completing data table creation, perform database operations such as insert, delete, update, and query</span></span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="string">``</span><span class="string">`  </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">HarmonyOS Next provides `</span>relationalStore<span class="string">` for database operations, but in CRUD (Create, Read, Update, Delete) operations, we generally implement a layer of encapsulation to convert database result sets to actual objects.  </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#### 3. Introduction to ORM Frameworks  </span></span><br><span class="line"><span class="string">HarmonyOS Next provides the `</span>dataORM<span class="string">` library for data relationship mapping. `</span>dataORM<span class="string">` is a lightweight ORM (Object-Relational Mapping) library that simplifies local database operations, offering high database access performance and low memory consumption. It supports features such as multi-threading, chain calls, backup, upgrade, caching, etc. Designed to be lightweight, fast, and easy to use, it helps developers quickly build high-performance applications. However, `</span>dataORM<span class="string">` has some limitations (e.g., no support for composite primary keys in database tables), and the official maintenance of this library has been discontinued.  </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Later, ByteDance open-sourced `</span>rdbStore<span class="string">`, which performs database operations in the form of DTO (Data Transfer Object) objects. It encapsulates capabilities such as database creation and automatic upgrade, database predicate construction, query result deserialization, and quality optimization, enabling simple and efficient database operations. In terms of operation and maintenance, it features comprehensive unit testing, quality data tracking and reporting, full-link logging, etc. Due to issues encountered in database upgrades, we switched to `</span>rdbStore<span class="string">` for data relationship mapping.  </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#### 4. Multi-Threading Optimization  </span></span><br><span class="line"><span class="string">In scenarios with large data volumes, querying data may cause long processing times or even application freezes. General recommendations include:  </span></span><br><span class="line"><span class="string">- Limit single query data volume to no more than 5,000 records.  </span></span><br><span class="line"><span class="string">- Perform queries in a TaskPool.  </span></span><br><span class="line"><span class="string">- Keep SQL statement concatenation concise.  </span></span><br><span class="line"><span class="string">- Implement reasonable batch querying.  </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">When the number of user conversations reached a certain level, due to a join query involving 50 columns after expansion, the query took 6-7 seconds, causing severe application lags and even freeze exceptions. Therefore, complex and time-consuming queries were moved to child threads.  </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">`</span><span class="string">``</span>ts</span><br><span class="line"><span class="meta">@Concurrent</span>  </span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getConvDetailObservableThread</span>(<span class="params"><span class="attr">context</span>: <span class="title class_">Context</span>, <span class="attr">param</span>: <span class="title class_">Param</span>, <span class="attr">convId</span>: <span class="built_in">number</span></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">ConvBean</span> | <span class="literal">undefined</span>&gt; &#123;  </span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;ConvImpl&#x27;</span>, <span class="string">&quot;getConvDetailObservableThread,convId=&quot;</span> + convId);  </span><br><span class="line">  <span class="comment">// Store parameters, context, etc., in the thread</span></span><br><span class="line">  <span class="keyword">await</span> <span class="title class_">DBManager</span>.<span class="title function_">getInstance</span>().<span class="title function_">initDB</span>();  </span><br><span class="line">  <span class="keyword">const</span> conv = <span class="keyword">await</span> <span class="title class_">DBManager</span>.<span class="title function_">getInstance</span>()  </span><br><span class="line">    .<span class="title function_">getConvDaoHelper</span>()  </span><br><span class="line">    .<span class="title function_">getConvById</span>(convId);  </span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> result = <span class="keyword">await</span> taskpool.<span class="title function_">execute</span>(getConvDetailObservableThread,  </span><br><span class="line">  context,</span><br><span class="line">  param,</span><br><span class="line">  convId);</span><br></pre></td></tr></table></figure>


<p>By default, data transfer between threads uses a copy method. For ultimate performance, it can be changed to the <code>Sendable</code> method.  </p>
<h4 id="5-Optimization-for-Slow-Data-Queries"><a href="#5-Optimization-for-Slow-Data-Queries" class="headerlink" title="5. Optimization for Slow Data Queries"></a>5. Optimization for Slow Data Queries</h4><p>Although the lag was basically resolved after the above optimizations, the issue of long query times persisted. The first entry into the conversation list took 7-8 seconds, resulting in poor user experience. Additionally, a strange phenomenon occurred: the Mac version simulator took tens of milliseconds, while real devices took 6-7 seconds.  </p>
<p>Analyzing the query process step by step, since it involved a join query, using <code>relationalStore</code> interfaces for direct query execution was fast, but the process of <code>resultSet.goToNextRow()</code> in the result set was time-consuming.  </p>
<p>Initially, traversal read data row by column: <code>resultSet.getLong(resultSet.getColumnIndex(&#39;unreadMsgCount&#39;));</code>. The official API12 provided the <code>getRow</code> interface, which can read an entire column at once. After switching to the <code>getRow</code> method, the query time was optimized from 7-8 seconds to 700-800 milliseconds—ten times faster.  </p>
<p>In API18, a new <code>getRows</code> interface was added, which can read all specified rows directly, yielding even better results.  </p>
<h3 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h3><p>This article focuses on the optimization process for database query lags caused by large conversation and message data volumes among B-end users in IMSDK development based on HarmonyOS Next. It first introduces the SQLite-based features of the HarmonyOS Next relational database, including transactions, indexes, and other functions, as well as the usage of RdbStore. It then compares two ORM frameworks, <code>dataORM</code> and <code>rdbStore</code>, and switches to the more efficient <code>rdbStore</code> due to <code>dataORM</code> being discontinued and upgrade-related issues.  </p>
<p>In terms of performance optimization, a multi-threading solution moves complex queries to child threads to avoid main thread blocking, while adhering to principles such as limiting single query data to under 5,000 records and concise SQL concatenation. For query latency issues, analysis revealed low result set traversal efficiency, which was improved by using HarmonyOS-provided new interfaces like <code>getRow</code> and <code>getRows</code>, reducing query time from 7-8 seconds to 700-800 milliseconds and significantly enhancing data reading efficiency. This optimization not only resolves application lags and message delays but also provides referable practical experience for database operations in large data volume scenarios on the HarmonyOS platform.</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://harmonyostech.github.io/2025/06/08/HarmonyOS-Next-IM-Practical-Combat-Handling-So-Dynamic-Library-Crash-Issues-Caused-by-Worker-Threads/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Qingkouwei">
      <meta itemprop="description" content="Welcome to the HarmonyOS NEXT Knowledge Charging Station!  This is a hub for knowledge about HarmonyOS Next`s new-generation system. With its self-developed kernel, HarmonyOS NEXT achieves native smoothness, security, intelligence, and interconnectivity. We deeply analyze how its new distributed soft bus revolutionizes device connectivity experiences and explain the principles behind the enhanced perception and reasoning capabilities of the Xiaoyi intelligent agent based on the Pangu large model. Whether you are a developer exploring application development or an ordinary user eager to understand system features, you can "recharge" here and quickly grasp the essence of HarmonyOS NEXT.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HarmonyOS NEXT Knowledge Charging Station">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/06/08/HarmonyOS-Next-IM-Practical-Combat-Handling-So-Dynamic-Library-Crash-Issues-Caused-by-Worker-Threads/" class="post-title-link" itemprop="url">HarmonyOS Next IM Practical Combat: Handling So Dynamic Library Crash Issues Caused by Worker Threads</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2025-06-08 17:15:15" itemprop="dateCreated datePublished" datetime="2025-06-08T17:15:15+08:00">2025-06-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-06-24 16:09:14" itemprop="dateModified" datetime="2025-06-24T16:09:14+08:00">2025-06-24</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h4 id="Background-Introduction"><a href="#Background-Introduction" class="headerlink" title="Background Introduction"></a>Background Introduction</h4><p>After the IM SDK for HarmonyOS Next was integrated into the application and launched, many users reported significant app lag, particularly those with a large number of conversations and messages. Due to design flaws in the SDK’s logic, receiving a message triggered a full refresh of the conversation list, which involved querying the entire database. This operation was time-consuming when there were many conversations and was originally performed on the main thread, causing the app to freeze.</p>
<p>To address this issue, we decided to leverage HarmonyOS’s Worker threads. We introduced two worker threads during app initialization: one for fetching the conversation list and another for message retrieval. This approach aimed to offload database operations from the main thread. Workers were chosen because these operations are complex, involve multiple tasks, and require background thread support.</p>
<h4 id="Problem-Description"><a href="#Problem-Description" class="headerlink" title="Problem Description"></a>Problem Description</h4><p>After creating the worker thread as per the standard procedure and starting it during SDK initialization:</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">this</span>.<span class="property">syncConfigWorkerInstance</span> = <span class="keyword">new</span> worker.<span class="title class_">ThreadWorker</span>(<span class="string">&quot;../workers/SyncConfigAndConvWorker.ets&quot;</span>);  </span><br><span class="line"><span class="variable language_">this</span>.<span class="property">syncConfigWorkerInstance</span>.<span class="property">onmessage</span> = <span class="title function_">async</span> (event) =&gt; &#123;</span><br><span class="line">  <span class="comment">// Event handler</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The application crashed or froze immediately after starting the worker, even though the worker thread itself did nothing. The crash occurred in a C++ shared library (<code>.so</code>) unrelated to the worker’s logic, which was puzzling:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Timestamp: 2025-05-07 17:12:54:794</span><br><span class="line">Tid: 8025, Name: beike.imsdk.tob</span><br><span class="line">#00 pc 00000000001b6344 /system/lib/ld-musl-aarch64.so.1(fcf57c313493609e8c78a5f07477c358)</span><br><span class="line">#01 pc 00000000001b834c /system/lib/ld-musl-aarch64.so.1(pthread_cond_timedwait+188)(fcf57c313493609e8c78a5f07477c358)</span><br><span class="line">#02 pc 00000000000c430c /data/storage/el1/bundle/libs/arm64/libc++_shared.so(std::__n1::condition_variable::wait(std::__n1::unique_lock&lt;std::__n1::mutex&gt;&amp;)+20)(cdf97be9396a35e8f4806f252f90a11320d26ec6)</span><br><span class="line">#03 pc 00000000000c4e9c /data/storage/el1/bundle/libs/arm64/libc++_shared.so(std::__n1::__assoc_sub_state::__sub_wait(std::__n1::unique_lock&lt;std::__n1::mutex&gt;&amp;)+48)(cdf97be9396a35e8f4806f252f90a11320d26ec6)</span><br><span class="line">#04 pc 00000000000447f4 /data/storage/el1/bundle/libs/arm64/libmarsstn.so(4ed6d779cb9585f42f228dfc8a706399ce60a56f)</span><br><span class="line">#05 pc 0000000000044344 /data/storage/el1/bundle/libs/arm64/libmarsstn.so(4ed6d779cb9585f42f228dfc8a706399ce60a56f)</span><br><span class="line">#06 pc 00000000000d7cf0 /data/storage/el1/bundle/libs/arm64/libmarsstn.so(4ed6d779cb9585f42f228dfc8a706399ce60a56f)</span><br><span class="line">#07 pc 000000000006983c /data/storage/el1/bundle/libs/arm64/libmarsstn.so(4ed6d779cb9585f42f228dfc8a706399ce60a56f)</span><br></pre></td></tr></table></figure>

<h4 id="Problem-Diagnosis"><a href="#Problem-Diagnosis" class="headerlink" title="Problem Diagnosis"></a>Problem Diagnosis</h4><p>Initially, the crash was reproducible in a specific scenario but later became random. Disabling the dynamic library initialization or the worker thread resolved the issue. To identify the root cause, we enabled multithreading detection on a physical device:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hdc shell param <span class="built_in">set</span> persist.ark.properties 0x107c</span><br></pre></td></tr></table></figure>

<p>After rebooting the device and reproducing the crash, we obtained the following details:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Process name: com.beike.imsdk.tob</span><br><span class="line">Process life time: 34s</span><br><span class="line">Reason: Signal: SIGABRT(SI_TKILL)@0x01317b4e00004e2a from: 20010:20020046</span><br><span class="line">LastFatalMessage: [(ark_native_reference.cpp:117)(Get)] param env is not equal to its owner</span><br><span class="line">Fault thread info:</span><br><span class="line">Tid: 20010, Name: kou.imsdk.tob</span><br><span class="line">#00 pc 0000000000199e1c /system/lib/ld-musl-aarch64.so.1(raise+228)(6b9883f518515f73e093bce9a89a2548)</span><br><span class="line">#01 pc 0000000000146f8c /system/lib/ld-musl-aarch64.so.1(abort+20)(6b9883f518515f73e093bce9a89a2548)</span><br><span class="line">#02 pc 0000000000056fac /system/lib64/platformsdk/libace_napi.z.so(ArkNativeReference::Get(NativeEngine*)+476)(edf034e044dbf26f955142c343577527)</span><br><span class="line">#03 pc 000000000005f0a0 /system/lib64/platformsdk/libace_napi.z.so(napi_get_reference_value+48)(edf034e044dbf26f955142c343577527)</span><br><span class="line">#04 pc 00000000000ea354 /data/storage/el1/bundle/libs/arm64/libmarsstn.so(160beef25288e9539a33ed6f307aa362ceb17fc1)</span><br><span class="line">#05 pc 0000000000070754 /system/lib64/platformsdk/libace_napi.z.so(NativeSafeAsyncWork::ProcessAsyncHandle()+596)</span><br></pre></td></tr></table></figure>

<p>Using the <code>addr2line</code> tool, we traced the crash to the <code>napi_get_reference_value</code> call in <code>libmarsstn.so</code>, where the <code>env</code> parameter was invalid.</p>
<p>Further investigation revealed that the <code>env</code> was cached from the main thread during SO initialization (performed on the main thread). Adding logs confirmed that the crash occurred when the main thread used this cached <code>env</code>, which had been overwritten by a worker thread:</p>
<p><img src="/../images/HarmonyOS%20Next%20IM%E5%AE%9E%E6%88%98%EF%BC%9AWorker%E7%BA%BF%E7%A8%8B%E4%B8%AD%E5%BC%95%E8%B5%B7%E7%9A%84so%E5%8A%A8%E6%80%81%E5%BA%93%E5%B4%A9%E6%BA%83%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86.png" alt="text"></p>
<p>Logs showed that the <code>napi_module_register</code> function in the SO library was being called from worker threads, overwriting the cached <code>mainEnv_</code> (a singleton in C++). </p>
<p>In HarmonyOS Next, Worker threads are isolated with their own memory spaces, similar to separate processes. Each Worker thread loads the SO library independently, leading to multiple initializations.</p>
<h4 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h4><p>To resolve the issue, we ensured that <code>mainEnv_</code> is initialized only once, during the first call from the main thread. We used <code>std::atomic</code> for thread-safe initialization:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">std::atomic&lt;<span class="type">bool</span>&gt; flag&#123;<span class="literal">false</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">bool</span> expected = <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">if</span> (flag.<span class="built_in">compare_exchange_strong</span>(expected, <span class="literal">true</span>)) &#123;</span><br><span class="line">    napi_status status;</span><br><span class="line">    <span class="type">int32_t</span> ret;</span><br><span class="line">    <span class="keyword">auto</span> context = MarsNapiManager::<span class="built_in">getInstance</span>();</span><br><span class="line">    <span class="keyword">if</span> (context) &#123;</span><br><span class="line">        context-&gt;mainEnv_ = env;</span><br><span class="line">        context-&gt;mainThreadId = std::this_thread::<span class="built_in">get_id</span>();</span><br><span class="line">        <span class="keyword">auto</span> marsNapi = context-&gt;<span class="built_in">getMarsNapi</span>();</span><br><span class="line">        marsNapi-&gt;<span class="built_in">Export</span>(env, exports);</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">xdebug2</span>(TSF<span class="string">&quot;napi--&gt;initXComponent not first&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Another-Multithreading-Issue"><a href="#Another-Multithreading-Issue" class="headerlink" title="Another Multithreading Issue"></a>Another Multithreading Issue</h4><p>When passing SDK configuration parameters to the worker thread using HarmonyOS Next’s Sendable mechanism, the application crashed with the error:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TypeError: Cannot set sendable property with mismatched type</span><br></pre></td></tr></table></figure>

<p>The crash occurred during <code>postMessage</code>. Initially, we serialized the object to JSON to bypass the issue. Further investigation revealed that the demo used class instances (which implemented Sendable), while the app used Record objects, which lacked Sendable implementation.</p>
<h4 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h4><p>This case highlights critical differences between HarmonyOS Next’s Worker threads and traditional thread models: each Worker thread loads SO libraries independently, causing the main thread’s <code>env</code> cached in C++ singletons to be overwritten. Key findings:</p>
<ol>
<li><strong>Root Cause</strong>: The main thread’s cached <code>env</code> (<code>mainEnv_</code>) was overwritten by worker threads during <code>napi_module_register</code>, leading to invalid <code>env</code> usage in <code>napi_get_reference_value</code>.</li>
<li><strong>Thread Characteristics</strong>: Worker threads have strong memory isolation, similar to separate processes, causing SO libraries to be reloaded.</li>
<li><strong>Solution</strong>: Use <code>std::atomic</code> to ensure <code>mainEnv_</code> is initialized only once on the main thread, with <code>compare_exchange_strong</code> for thread safety.</li>
<li><strong>Derived Issue</strong>: Cross-thread data transfer must strictly follow the Sendable protocol; non-Sendable objects (e.g., Record) should be serialized to JSON.</li>
</ol>
<p>This case underscores two critical considerations in HarmonyOS multithreading: <strong>thread safety during SO library initialization</strong> and <strong>strict adherence to cross-thread data transfer protocols</strong>.</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://harmonyostech.github.io/2025/06/08/HarmonyOS-Next-IM-Practical-Combat-Handling-Logical-Error-Bugs-Caused-by-the-Lack-of-await-in-Asynchronous-Operations/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Qingkouwei">
      <meta itemprop="description" content="Welcome to the HarmonyOS NEXT Knowledge Charging Station!  This is a hub for knowledge about HarmonyOS Next`s new-generation system. With its self-developed kernel, HarmonyOS NEXT achieves native smoothness, security, intelligence, and interconnectivity. We deeply analyze how its new distributed soft bus revolutionizes device connectivity experiences and explain the principles behind the enhanced perception and reasoning capabilities of the Xiaoyi intelligent agent based on the Pangu large model. Whether you are a developer exploring application development or an ordinary user eager to understand system features, you can "recharge" here and quickly grasp the essence of HarmonyOS NEXT.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HarmonyOS NEXT Knowledge Charging Station">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/06/08/HarmonyOS-Next-IM-Practical-Combat-Handling-Logical-Error-Bugs-Caused-by-the-Lack-of-await-in-Asynchronous-Operations/" class="post-title-link" itemprop="url">HarmonyOS Next IM Practical Combat: Handling Logical Error Bugs Caused by the Lack of await in Asynchronous Operations</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2025-06-08 17:09:32" itemprop="dateCreated datePublished" datetime="2025-06-08T17:09:32+08:00">2025-06-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-06-24 15:55:34" itemprop="dateModified" datetime="2025-06-24T15:55:34+08:00">2025-06-24</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h4 id="Background-Introduction"><a href="#Background-Introduction" class="headerlink" title="Background Introduction"></a>Background Introduction</h4><p>During the development of IMSDK, the logic is extremely intricate. Take the message retrieval logic as an example: first, retrieve the hot message list by sequence number, then process the messages by iterating through their contents and handling different message types accordingly. Insert the final messages into the message table. If a message initiates a new conversation, insert the conversation information into the conversation table, user information into the user table and user member table, etc. Finally, notify the UI to update with new messages. Many network requests and database operations are asynchronous. In this entire process, numerous asynchronous operations must complete before the next step can proceed. Often, developers inadvertently forget to use <code>await</code>, leading to inexplicable logical bugs.</p>
<p>When such bugs occur, it is challenging to pinpoint the root cause based solely on the symptoms. Developers must reexamine the logic to check for missing <code>await</code> statements. This approach is not only inefficient but also prone to oversight. Is there a better solution?</p>
<h4 id="Enter-Code-Linter"><a href="#Enter-Code-Linter" class="headerlink" title="Enter Code Linter"></a>Enter Code Linter</h4><p>This is where Code Linter comes in handy. It scans your code to help identify potential issues. Run Code Linter before each code submission to check for possible risks.</p>
<h5 id="Using-Code-Linter"><a href="#Using-Code-Linter" class="headerlink" title="Using Code Linter"></a>Using Code Linter</h5><p>Create a <code>code-linter.json</code> file in the root directory of your project with the following configuration format:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span>  </span><br><span class="line">  <span class="attr">&quot;files&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>  </span><br><span class="line">    <span class="string">&quot;**/*.ets&quot;</span>  </span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span>  </span><br><span class="line">  <span class="attr">&quot;ignore&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>  </span><br><span class="line">    <span class="string">&quot;**/src/ohosTest/**/*&quot;</span><span class="punctuation">,</span>  </span><br><span class="line">    <span class="string">&quot;**/src/test/**/*&quot;</span><span class="punctuation">,</span>  </span><br><span class="line">    <span class="string">&quot;**/src/mock/**/*&quot;</span><span class="punctuation">,</span>  </span><br><span class="line">    <span class="string">&quot;**/node_modules/**/*&quot;</span><span class="punctuation">,</span>  </span><br><span class="line">    <span class="string">&quot;**/oh_modules/**/*&quot;</span><span class="punctuation">,</span>  </span><br><span class="line">    <span class="string">&quot;**/build/**/*&quot;</span><span class="punctuation">,</span>  </span><br><span class="line">    <span class="string">&quot;**/.preview/**/*&quot;</span>  </span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span>  </span><br><span class="line">  <span class="attr">&quot;ruleSet&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>  </span><br><span class="line">    <span class="string">&quot;plugin:@performance/recommended&quot;</span><span class="punctuation">,</span>  </span><br><span class="line">    <span class="string">&quot;plugin:@typescript-eslint/recommended&quot;</span>  </span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span>  </span><br><span class="line">  <span class="attr">&quot;rules&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span>  </span><br><span class="line">    <span class="attr">&quot;@typescript-eslint/return-await&quot;</span><span class="punctuation">:</span> <span class="string">&quot;error&quot;</span><span class="punctuation">,</span>  </span><br><span class="line">    <span class="attr">&quot;@typescript-eslint/require-await&quot;</span><span class="punctuation">:</span> <span class="string">&quot;error&quot;</span><span class="punctuation">,</span>  </span><br><span class="line">    <span class="attr">&quot;@typescript-eslint/await-thenable&quot;</span><span class="punctuation">:</span> <span class="string">&quot;error&quot;</span><span class="punctuation">,</span>  </span><br><span class="line">    <span class="attr">&quot;@typescript-eslint/promise-function-async&quot;</span><span class="punctuation">:</span> <span class="string">&quot;error&quot;</span>  </span><br><span class="line">  <span class="punctuation">&#125;</span>  </span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>This configuration has three main sections:</p>
<ul>
<li><strong>files</strong>: Specifies which files to inspect (typically all <code>.ets</code> files).</li>
<li><strong>ignore</strong>: Lists files to exclude (e.g., build artifacts, test files).</li>
<li><strong>ruleSet</strong>: Aggregates rule collections (performance recommendations and general rules in this example).</li>
<li><strong>rules</strong>: Defines specific linting rules.</li>
</ul>
<p>After configuration, right-click on the module to be inspected in your IDE, then select <strong>Code Linter &gt; Full Linter</strong>:<br><img src="/../images/HarmonyOS%20Next%20IM%E5%AE%9E%E6%88%98%EF%BC%9A%E5%BC%82%E6%AD%A5%E7%BC%BA%E4%B9%8Fawait%E5%AF%BC%E8%87%B4%E7%9A%84%E9%80%BB%E8%BE%91%E9%94%99%E8%AF%AFBug%E5%A4%84%E7%90%86.png"></p>
<p>The inspection results will appear in the Code Linter output:<br><img src="/../images/HarmonyOS%20Next%20IM%E5%AE%9E%E6%88%98%EF%BC%9A%E5%BC%82%E6%AD%A5%E7%BC%BA%E4%B9%8Fawait%E5%AF%BC%E8%87%B4%E7%9A%84%E9%80%BB%E8%BE%91%E9%94%99%E8%AF%AFBug%E5%A4%84%E7%90%86-1.png"></p>
<p>Modify the non-compliant code based on these results.</p>
<h5 id="Introduction-to-Asynchronous-Rules"><a href="#Introduction-to-Asynchronous-Rules" class="headerlink" title="Introduction to Asynchronous Rules"></a>Introduction to Asynchronous Rules</h5><p>We use three asynchronous-specific Code Linter rules:</p>
<h6 id="promise-function-async"><a href="#promise-function-async" class="headerlink" title="promise-function-async"></a>promise-function-async</h6><p>The <code>@typescript-eslint/promise-function-async</code> rule mandates that any function or method returning a <code>Promise</code> must be marked as <code>async</code>. This ensures that functions either:</p>
<ul>
<li>Return a rejected promise, or</li>
<li>Throw an <code>Error</code> object.</li>
</ul>
<p>In contrast, non-<code>async</code> functions returning <code>Promise</code> can technically do both, complicating error handling. This rule simplifies code by eliminating the need to handle both cases.</p>
<p>Key benefits of <code>promise-function-async</code>:</p>
<ol>
<li><strong>Improves code clarity</strong>: Explicitly marks Promise-returning functions.</li>
<li><strong>Prevents common errors</strong>: Avoids overlooked asynchronous operations.</li>
<li><strong>Standardizes code style</strong>: Ensures consistent declaration of Promise-returning functions.</li>
<li><strong>Simplifies error handling</strong>: Leverages <code>async</code> function’s automatic error propagation.</li>
<li><strong>Enhances type safety</strong>: Validates asynchronous behavior through TypeScript’s type system.</li>
</ol>
<p>Correct usage examples (all Promise-returning functions are marked <code>async</code>):</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">arrowFunctionReturnsPromise</span> = <span class="keyword">async</span> (<span class="params"></span>) =&gt; <span class="title class_">Promise</span>.<span class="title function_">resolve</span>(<span class="string">&#x27;value&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">functionReturnsPromise</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">resolve</span>(<span class="string">&#x27;value&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Explicit return type including non-Promise allows non-async function</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">functionReturnsUnionWithPromiseExplicitly</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">p</span>: <span class="built_in">boolean</span></span></span><br><span class="line"><span class="params"></span>): <span class="built_in">string</span> | <span class="title class_">Promise</span>&lt;<span class="built_in">string</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> p ? <span class="string">&#x27;value&#x27;</span> : <span class="title class_">Promise</span>.<span class="title function_">resolve</span>(<span class="string">&#x27;value&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">functionReturnsUnionWithPromiseImplicitly</span>(<span class="params"><span class="attr">p</span>: <span class="built_in">boolean</span></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> p ? <span class="string">&#x27;value&#x27;</span> : <span class="title class_">Promise</span>.<span class="title function_">resolve</span>(<span class="string">&#x27;value&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Non-compliant examples:</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">arrowFunctionReturnsPromise</span> = (<span class="params"></span>) =&gt; <span class="title class_">Promise</span>.<span class="title function_">resolve</span>(<span class="string">&#x27;value&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">functionReturnsPromise</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">resolve</span>(<span class="string">&#x27;value&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">functionReturnsUnionWithPromiseImplicitly</span>(<span class="params"><span class="attr">p</span>: <span class="built_in">boolean</span></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> p ? <span class="string">&#x27;value&#x27;</span> : <span class="title class_">Promise</span>.<span class="title function_">resolve</span>(<span class="string">&#x27;value&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Full documentation: <a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/ide_promise-function-async-V5">Promise Function Async Rule</a></p>
<h6 id="await-thenable"><a href="#await-thenable" class="headerlink" title="await-thenable"></a>await-thenable</h6><p>The <code>@typescript-eslint/await-thenable</code> rule prohibits using the <code>await</code> keyword on non-“Thenable” values. A “Thenable” object has a <code>.then()</code> method (e.g., <code>Promise</code>).</p>
<p>Correct usage:</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">test</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">await</span> <span class="title class_">Promise</span>.<span class="title function_">resolve</span>(<span class="string">&#x27;value&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> &#123; test &#125;;</span><br></pre></td></tr></table></figure>

<p>Non-compliant code:</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">test</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">await</span> <span class="string">&#x27;value&#x27;</span>; <span class="comment">// Error: &#x27;value&#x27; is not a Thenable</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> &#123; test &#125;;</span><br></pre></td></tr></table></figure>

<p>Full documentation: <a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/ide_await-thenable-V5">Await Thenable Rule</a></p>
<h6 id="require-await"><a href="#require-await" class="headerlink" title="require-await"></a>require-await</h6><p>The <code>@typescript-eslint/require-await</code> rule is critical. It mandates that <code>async</code> functions must contain at least one <code>await</code> expression.</p>
<p>Key objectives:</p>
<ol>
<li><strong>Prevent misuse</strong>: Avoid <code>await</code> on non-asynchronous values, which is often a mistake.</li>
<li><strong>Improve clarity</strong>: Ensure <code>await</code> is used only for genuine asynchronous operations.</li>
<li><strong>Optimize performance</strong>: Eliminate unnecessary asynchronous overhead (microtask queue).</li>
<li><strong>Enhance type safety</strong>: Detect invalid <code>await</code> usage via TypeScript types.</li>
</ol>
<p>Example of missing <code>await</code>:</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">doSomething</span>(<span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="built_in">void</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">resolve</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="title function_">doSomething</span>(); <span class="comment">// Linter error: Missing `await`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The linter flags <code>foo()</code> for missing <code>await</code>, helping uncover potential bugs.</p>
<p>Full documentation: <a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/ide_require-await-V5">Require Await Rule</a></p>
<h6 id="return-await"><a href="#return-await" class="headerlink" title="return-await"></a>return-await</h6><p>The <code>@typescript-eslint/return-await</code> rule dictates when to use <code>await</code> in <code>return</code> statements of <code>async</code> functions.</p>
<p>In <code>async</code> functions, both <code>return await promise;</code> and <code>return promise;</code> are valid, but <code>return await</code> offers advantages:</p>
<ul>
<li>Improves stack trace readability.</li>
<li>Captures promise rejections in <code>try...catch</code> blocks.</li>
<li>Has negligible performance impact.</li>
</ul>
<p>This rule enforces consistent handling of returned promises with four configurations:</p>
<ul>
<li><strong>never</strong>: Prohibit <code>await</code> on returned promises.</li>
<li><strong>error-handling-correctness-only</strong>: Require <code>await</code> in error-handling contexts (e.g., <code>try</code>&#x2F;<code>catch</code> blocks).</li>
<li><strong>in-try-catch</strong>: Require <code>await</code> in error-handling; prohibit elsewhere.</li>
<li><strong>always</strong>: Always use <code>await</code> when returning promises.</li>
</ul>
<p>The rule distinguishes between “normal contexts” and “error-handling contexts”:</p>
<ul>
<li><strong>Error-handling contexts</strong>: Use <code>return await</code> to ensure <code>catch</code>&#x2F;<code>finally</code> blocks execute correctly (e.g., inside <code>try</code>&#x2F;<code>catch</code>).</li>
<li><strong>Normal contexts</strong>: Style preference; direct <code>return promise</code> is acceptable.</li>
</ul>
<table>
<thead>
<tr>
<th>Option</th>
<th>Normal Context (Style)</th>
<th>Error-Handling Context (Bug Prevention)</th>
<th>Recommended?</th>
</tr>
</thead>
<tbody><tr>
<td><code>always</code></td>
<td><code>return await</code></td>
<td><code>return await</code></td>
<td>✅ Yes</td>
</tr>
<tr>
<td><code>in-try-catch</code></td>
<td><code>return promise</code></td>
<td><code>return await</code></td>
<td>✅ Yes</td>
</tr>
<tr>
<td><code>error-handling-only</code></td>
<td>No preference</td>
<td><code>return await</code></td>
<td>🟡 Okay</td>
</tr>
<tr>
<td><code>never</code></td>
<td><code>return promise</code></td>
<td><code>return promise</code> (⚠️ Risky)</td>
<td>❌ Deprecated</td>
</tr>
</tbody></table>
<p>Example requiring <code>return await</code> in <code>try...catch</code>:</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">validInTryCatch1</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">resolve</span>(<span class="string">&#x27;try&#x27;</span>); <span class="comment">// Linter error: Missing `await`</span></span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">resolve</span>(<span class="string">&#x27;catch&#x27;</span>); <span class="comment">// Linter error: Missing `await`</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Best practices:</p>
<ol>
<li>Use <code>&quot;in-try-catch&quot;</code> for a balanced approach.</li>
<li>Always use <code>return await</code> inside <code>try-catch</code> blocks.</li>
<li>Return promises directly elsewhere.</li>
<li>Avoid redundant <code>await</code> where error handling isn’t needed.</li>
</ol>
<p>Full documentation: <a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/ide_return-await-V5">Return Await Rule</a></p>
<h6 id="no-floating-promises"><a href="#no-floating-promises" class="headerlink" title="no-floating-promises"></a>no-floating-promises</h6><p>The <code>@typescript-eslint/no-floating-promises</code> rule ensures proper handling of Promise expressions. A “floating promise” is one created without error handling, leading to silent failures, incorrect execution order, or uncaught rejections.</p>
<p>The rule flags unhandled Promise expressions unless they are:</p>
<ul>
<li>Handled with <code>.then(onFulfilled, onRejected)</code>.</li>
<li>Caught with <code>.catch()</code>.</li>
<li>Awaited with <code>await</code>.</li>
<li>Returned from a function.</li>
<li>Explicitly ignored with <code>void</code>.</li>
</ul>
<p>It also detects unhandled Promises in arrays. Use Promise combinators like <code>Promise.all()</code> to handle them collectively.</p>
<p>Examples of unhandled promises:</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">bar</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> promise = <span class="keyword">new</span> <span class="title class_">Promise</span>&lt;<span class="built_in">string</span>&gt;(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">resolve</span>(<span class="string">&#x27;value&#x27;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;finish&#x27;</span>;</span><br><span class="line">  &#125;);</span><br><span class="line">  promise; <span class="comment">// Linter error: Unhandled promise</span></span><br><span class="line">  <span class="title class_">Promise</span>.<span class="title function_">reject</span>(<span class="string">&#x27;value&#x27;</span>).<span class="title function_">catch</span>(); <span class="comment">// Linter error: Empty catch</span></span><br><span class="line">  <span class="keyword">await</span> <span class="title class_">Promise</span>.<span class="title function_">reject</span>(<span class="string">&#x27;value&#x27;</span>).<span class="title function_">finally</span>(); <span class="comment">// Linter error: No catch</span></span><br><span class="line">  [<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;3&#x27;</span>].<span class="title function_">map</span>(<span class="keyword">async</span> x =&gt; x + <span class="string">&#x27;1&#x27;</span>); <span class="comment">// Linter error: Unhandled Promise array</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Key benefits:</p>
<ol>
<li><strong>Prevent silent failures</strong>: Ensure Promise rejections aren’t ignored.</li>
<li><strong>Improve reliability</strong>: Force explicit error handling.</li>
<li><strong>Simplify debugging</strong>: Trace all asynchronous errors.</li>
<li><strong>Enhance maintainability</strong>: Clarify asynchronous data flow.</li>
</ol>
<p>Full documentation: <a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/ide_no-floating-promises-V5">No Floating Promises Rule</a></p>
<h6 id="no-misused-promises"><a href="#no-misused-promises" class="headerlink" title="no-misused-promises"></a>no-misused-promises</h6><p>The <code>@typescript-eslint/no-misused-promises</code> rule prevents Promise misuse in non-asynchronous contexts, ensuring Promises are used only where appropriate.</p>
<p>Core objectives:</p>
<ol>
<li><strong>Block conditional misuse</strong>: Flag Promises used directly in conditions (e.g., <code>if (promise)</code>).</li>
<li><strong>Prevent logical operator misuse</strong>: Prohibit Promises in <code>&amp;&amp;</code>, <code>||</code>, <code>??</code> operations.</li>
<li><strong>Ensure correct callbacks</strong>: Prevent async callbacks in synchronous contexts (e.g., <code>forEach</code>).</li>
<li><strong>Protect void return types</strong>: Block Promises in functions expected to return <code>void</code> (e.g., event handlers).</li>
</ol>
<p>Problem scenarios and fixes:</p>
<p><strong>Scenario 1: Conditional misuse</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ❌ Error: Using Promise directly in condition</span></span><br><span class="line"><span class="keyword">if</span> (<span class="title function_">fetchUserData</span>()) &#123; </span><br><span class="line">  <span class="comment">// Always executes (Promise is always truthy)</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Fetching user data...&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ✅ Correct: Resolve Promise first</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">checkUser</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> userData = <span class="keyword">await</span> <span class="title function_">fetchUserData</span>();</span><br><span class="line">  <span class="keyword">if</span> (userData) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;User data loaded&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Scenario 2: Logical operator misuse</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ❌ Error: Using Promise in logical operator</span></span><br><span class="line"><span class="keyword">const</span> config = <span class="title function_">loadConfig</span>() || defaultConfig; <span class="comment">// Always uses loadConfig()</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ✅ Correct: Resolve Promise before comparison</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getConfig</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> loadedConfig = <span class="keyword">await</span> <span class="title function_">loadConfig</span>();</span><br><span class="line">  <span class="keyword">return</span> loadedConfig ?? defaultConfig;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Scenario 3: Callback misuse</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ❌ Error: Async callback in array method</span></span><br><span class="line">[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>].<span class="title function_">forEach</span>(<span class="title function_">async</span> (id) =&gt; &#123;</span><br><span class="line">  <span class="keyword">await</span> <span class="title function_">deleteRecord</span>(id); <span class="comment">// Unintended concurrency</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ✅ Correct: Sequential processing with for...of</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">deleteRecords</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> id <span class="keyword">of</span> [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]) &#123;</span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">deleteRecord</span>(id);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ✅ Correct: Parallel processing with Promise.all</span></span><br><span class="line"><span class="keyword">await</span> <span class="title class_">Promise</span>.<span class="title function_">all</span>([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>].<span class="title function_">map</span>(<span class="function"><span class="params">id</span> =&gt;</span> <span class="title function_">deleteRecord</span>(id)));</span><br></pre></td></tr></table></figure>

<p><strong>Scenario 4: Void return type misuse</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ❌ Error: Returning Promise from event handler</span></span><br><span class="line"><span class="keyword">const</span> button = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;submit&#x27;</span>);</span><br><span class="line">button.<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">submitForm</span>(); <span class="comment">// Event handlers should return void</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ✅ Correct: Explicitly ignore Promise</span></span><br><span class="line">button.<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">void</span> <span class="title function_">submitForm</span>(); <span class="comment">// Indicate Promise is intentionally unhandled</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ✅ Correct: Handle errors with async/await</span></span><br><span class="line">button.<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>, <span class="title function_">async</span> () =&gt; &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">submitForm</span>();</span><br><span class="line">  &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">    <span class="title function_">showError</span>(error);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>Full documentation: <a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/ide_no-misused-promises-V5">No Misused Promises Rule</a></p>
<h4 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h4><p>This article addressed issues caused by improper asynchronous operations in HarmonyOS development. By leveraging five specific Code Linter rules, we can effectively mitigate problems related to missing <code>await</code> keywords and other asynchronous pitfalls.</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://harmonyostech.github.io/2025/06/08/HarmonyOS-Next-IM-Practical-Combat-Handling-Module-Uninitialized-Exceptions-in-Worker-Threads/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Qingkouwei">
      <meta itemprop="description" content="Welcome to the HarmonyOS NEXT Knowledge Charging Station!  This is a hub for knowledge about HarmonyOS Next`s new-generation system. With its self-developed kernel, HarmonyOS NEXT achieves native smoothness, security, intelligence, and interconnectivity. We deeply analyze how its new distributed soft bus revolutionizes device connectivity experiences and explain the principles behind the enhanced perception and reasoning capabilities of the Xiaoyi intelligent agent based on the Pangu large model. Whether you are a developer exploring application development or an ordinary user eager to understand system features, you can "recharge" here and quickly grasp the essence of HarmonyOS NEXT.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HarmonyOS NEXT Knowledge Charging Station">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/06/08/HarmonyOS-Next-IM-Practical-Combat-Handling-Module-Uninitialized-Exceptions-in-Worker-Threads/" class="post-title-link" itemprop="url">HarmonyOS Next IM Practical Combat: Handling Module Uninitialized Exceptions in Worker Threads</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2025-06-08 16:59:39 / Modified: 17:14:24" itemprop="dateCreated datePublished" datetime="2025-06-08T16:59:39+08:00">2025-06-08</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h4 id="Background-Introduction"><a href="#Background-Introduction" class="headerlink" title="Background Introduction"></a>Background Introduction</h4><p>During the development of the instant messaging (IM) SDK, users reported issues such as delayed message reception and page卡顿 (freezing) when opening interfaces. Since IM involves numerous network requests and database operations, all of which were previously handled on the main thread, heavy I&#x2F;O operations caused app卡顿 and frame drops when there were many chat messages or sessions. Initially, the design considered using multi-threading mechanisms like HarmonyOS-provided Worker and TaskPool, but due to time constraints and complex logic, the non-shared memory multi-threading approach had high refactoring costs. Now that the production environment has hit a bottleneck, resolving this through multi-threading has become imperative.  </p>
<h4 id="Implementation-Approach"><a href="#Implementation-Approach" class="headerlink" title="Implementation Approach"></a>Implementation Approach</h4><p>The message reception mechanism uses a combination of push and pull. When new messages arrive, they are delivered to the client via long connections, and the client then requests specific message content via HTTP. On Android and iOS, daemon threads are employed: a dedicated thread for pulling new messages, which triggers the message-pulling interface when events occur and blocks to wait when no events are present.  </p>
<h5 id="Selection-Between-Worker-and-TaskPool"><a href="#Selection-Between-Worker-and-TaskPool" class="headerlink" title="Selection Between Worker and TaskPool"></a>Selection Between Worker and TaskPool</h5><p>The memory-sharing concurrency model refers to multiple threads executing tasks simultaneously while relying on and having access to the same memory. Threads must抢占 (compete for) and lock memory usage before accessing it, with threads that fail to acquire the lock waiting for others to release it. Common concurrency models include memory-sharing and message-communication-based models. The Actor concurrency model is a typical example of the latter, widely adopted because it eliminates complex lock-handling for developers and offers high concurrency. Currently, ArkTS provides two concurrency capabilities—TaskPool and Worker—both based on the Actor model.  </p>
<p>In the Actor model, each thread is an independent Actor with its own isolated memory. Actors trigger each other’s behaviors through message-passing and cannot directly access each other’s memory. Compared to memory-sharing models, the Actor model isolates memory between threads, eliminating thread contention for shared resources. This allows developers to avoid memory-locking issues and improves development efficiency.  </p>
<p>The following diagram illustrates how to solve the producer-consumer problem using a memory-sharing model:<br><img src="/../images/HarmonyOS%20Next%20Worker%E7%BA%BF%E7%A8%8B%E4%B8%AD%E6%A8%A1%E5%9D%97%E6%9C%AA%E5%88%9D%E5%A7%8B%E5%8C%96%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E5%AE%9E%E6%88%98.png" alt="alt text"> </p>
<p>The example below briefly demonstrates using the Actor-based TaskPool concurrency capability to solve the producer-consumer problem:<br><img src="/../images/HarmonyOS%20Next%20Worker%E7%BA%BF%E7%A8%8B%E4%B8%AD%E6%A8%A1%E5%9D%97%E6%9C%AA%E5%88%9D%E5%A7%8B%E5%8C%96%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E5%AE%9E%E6%88%98.png" alt="alt text"> </p>
<p>In the Actor model, threads do not share memory and must use inter-thread communication to pass tasks and results. Non-shared memory threads are analogous to traditional system processes, with independent memory and high inter-thread interaction costs.  </p>
<p>TaskPool and Worker provide multi-threaded environments for applications to handle time-consuming computational or intensive tasks, preventing task blocking on the main thread and improving system performance and resource utilization.  </p>
<p>A comparison of TaskPool and Worker implementation characteristics is as follows:  </p>
<table>
<thead>
<tr>
<th align="left">Implementation</th>
<th align="left">TaskPool</th>
<th align="left">Worker</th>
</tr>
</thead>
<tbody><tr>
<td align="left">Memory Model</td>
<td align="left">Thread-isolated, no shared memory.</td>
<td align="left">Thread-isolated, no shared memory.</td>
</tr>
<tr>
<td align="left">Parameter Passing</td>
<td align="left">Uses structured cloning for serialization&#x2F;deserialization.<br><br>Supports ArrayBuffer transfer and SharedArrayBuffer sharing.</td>
<td align="left">Same as TaskPool.</td>
</tr>
<tr>
<td align="left">Argument Handling</td>
<td align="left">Directly passed, no encapsulation needed (transfer by default).</td>
<td align="left">Requires encapsulating messages as the sole parameter.</td>
</tr>
<tr>
<td align="left">Method Invocation</td>
<td align="left">Methods are directly passed for invocation.</td>
<td align="left">Messages must be parsed in the Worker thread to invoke corresponding methods.</td>
</tr>
<tr>
<td align="left">Return Values</td>
<td align="left">Asynchronous calls return values by default.</td>
<td align="left">Messages must be actively sent and parsed in <code>onmessage</code> for assignment.</td>
</tr>
<tr>
<td align="left">Lifecycle</td>
<td align="left">Self-managed; no need to monitor task load.</td>
<td align="left">Developers manage Worker count and lifecycle.</td>
</tr>
<tr>
<td align="left">Max Pool Size</td>
<td align="left">Automatically managed; no configuration required.</td>
<td align="left">Up to 64 Workers per process (limited by memory).</td>
</tr>
<tr>
<td align="left">Task Duration Limit</td>
<td align="left">3 minutes (excluding async operations like I&#x2F;O). Long tasks have no limit.</td>
<td align="left">No limit.</td>
</tr>
<tr>
<td align="left">Priority Configuration</td>
<td align="left">Supports setting task priorities.</td>
<td align="left">Does not support.</td>
</tr>
<tr>
<td align="left">Task Cancellation</td>
<td align="left">Supports canceling pending tasks.</td>
<td align="left">Does not support.</td>
</tr>
<tr>
<td align="left">Thread Reuse</td>
<td align="left">Supports.</td>
<td align="left">Does not support.</td>
</tr>
<tr>
<td align="left">Delayed Execution</td>
<td align="left">Supports.</td>
<td align="left">Does not support.</td>
</tr>
<tr>
<td align="left">Task Dependencies</td>
<td align="left">Supports.</td>
<td align="left">Does not support.</td>
</tr>
<tr>
<td align="left">Serial Queues</td>
<td align="left">Supports.</td>
<td align="left">Does not support.</td>
</tr>
<tr>
<td align="left">Task Groups</td>
<td align="left">Supports.</td>
<td align="left">Does not support.</td>
</tr>
</tbody></table>
<p>TaskPool’s worker threads bind to system scheduling priorities and support load balancing (automatic scaling), whereas Worker requires manual creation, incurs creation overhead, and lacks priority settings. Thus, TaskPool outperforms Worker in performance, and the official recommendation is to use TaskPool for most scenarios.  </p>
<p>TaskPool focuses on independent tasks, with no need to manage thread lifecycles (超长任务 (ultra-long tasks &gt;3 minutes, excluding long tasks) are auto-recycled by the system). Worker focuses on thread persistence, requiring developers to actively manage lifecycles.  </p>
<p>Common use cases and recommendations:  </p>
<ul>
<li><strong>Tasks longer than 3 minutes</strong> (excluding async I&#x2F;O): e.g., 1-hour background CPU-intensive prediction model training → use Worker.  </li>
<li><strong>Dependent synchronous tasks</strong>: e.g., scenarios requiring persistent handles (each handle is unique and must be preserved for operations) → use Worker.  </li>
<li><strong>Priority-based tasks</strong>: e.g., gallery histogram rendering (background calculations affect UI performance, requiring high priority) → use TaskPool.  </li>
<li><strong>Frequent task cancellation</strong>: e.g., large image browsing in galleries (canceling cached tasks when sliding) → use TaskPool.  </li>
<li><strong>Massive or distributed tasks</strong>: e.g., bulk database writes in large apps (difficult to manage with Worker) → use TaskPool.</li>
</ul>
<p>For our requirement to implement a daemon-like thread, we use Worker to manually manage thread lifecycles.  </p>
<h5 id="Implementing-a-Daemon-Thread-with-Worker"><a href="#Implementing-a-Daemon-Thread-with-Worker" class="headerlink" title="Implementing a Daemon Thread with Worker"></a>Implementing a Daemon Thread with Worker</h5><p>DevEco Studio supports one-click Worker generation. In the {moduleName} directory, right-click &gt; New &gt; Worker to auto-generate template files and configurations. We create <code>MsgSyncWorker</code> as follows:  </p>
<pre><code class="language-typescript">// worker.ets  
import &#123; ErrorEvent, MessageEvents, ThreadWorkerGlobalScope, worker &#125; from &#39;@kit.ArkTS&#39;;  

const workerPort: ThreadWorkerGlobalScope = worker.workerPort;  

// Register onmessage callback: triggered when the Worker receives messages from the main thread via postMessage, executed in the Worker thread  
workerPort.onmessage = (e: MessageEvents) =&gt; &#123;  
  let data: string = e.data;  
  console.info(&#39;workerPort onmessage is: &#39;, data);  

  // Send messages to the main thread  
  workerPort.postMessage(&#39;2&#39;);  
&#125;;  

// Register onmessageerror callback: triggered for unserializable messages  
workerPort.onmessageerror = () =&gt; &#123;  
  console.info(&#39;workerPort onmessageerror&#39;);  
&#125;;  

// Register onerror callback: triggered on Worker execution errors  
workerPort.onerror = (err: ErrorEvent) =&gt; &#123;  
  console.info(&#39;workerPort onerror err is: &#39;, err.message);  
&#125;;  
</code></pre>
<p>The IDE-generated Worker includes default callback implementations. Key steps involve registering <code>onmessage</code> to receive main thread commands (executed in the child thread) and using <code>workerPort.postMessage</code> to send replies.  </p>
<p>Next, start the Worker in the main thread:  </p>
<pre><code class="language-typescript">// Create a Worker instance  
let workerInstance = new worker.ThreadWorker(&#39;entry/ets/workers/worker.ets&#39;);  

// Register onmessage callback: triggered when the main thread receives messages from the Worker  
workerInstance.onmessage = (e: MessageEvents) =&gt; &#123;  
  let data: string = e.data;  
  console.info(&quot;workerInstance onmessage is: &quot;, data);  
&#125;;  

// Register onerror callback: triggered on Worker errors  
workerInstance.onerror = (err: ErrorEvent) =&gt; &#123;  
  console.info(&quot;workerInstance onerror message is: &quot; + err.message);  
&#125;;  

// Register onmessageerror callback: triggered for unserializable messages  
workerInstance.onmessageerror = () =&gt; &#123;  
  console.info(&#39;workerInstance onmessageerror&#39;);  
&#125;;  

// Register onexit callback: triggered when the Worker is destroyed  
workerInstance.onexit = (e: number) =&gt; &#123;  
  // Exit code 0 for normal termination, 1 for errors  
  console.info(&quot;workerInstance onexit code is: &quot;, e);  
&#125;;  

// Send a message to the Worker thread  
workerInstance.postMessage(&#39;1&#39;);  
</code></pre>
<h4 id="Issues-Encountered"><a href="#Issues-Encountered" class="headerlink" title="Issues Encountered"></a>Issues Encountered</h4><p>Due to memory isolation between threads in HarmonyOS, database and network singleton classes initialized on the main thread needed re-initialization in the Worker. However, initializing the database caused a crash with the error: <strong>Error message: UserDaoHelper is not initialized</strong>.  </p>
<p><code>UserDaoHelper</code> is a singleton, and the crash occurred before calling <code>getInstance</code>, indicating a failure to import the module.  </p>
<h5 id="Root-Cause-Analysis"><a href="#Root-Cause-Analysis" class="headerlink" title="Root Cause Analysis"></a>Root Cause Analysis</h5><p>The “module not initialized” error stemmed from circular dependencies between modules. Circular dependencies can cause runtime initialization failures, as seen in the example below. Before executing <code>index.ets</code>, the dependent <code>page.ets</code> runs first, which in turn depends on <code>foo</code> exported by <code>index.ets</code>. Since <code>index.ets</code> has not executed yet, <code>foo</code> is uninitialized, leading to a runtime exception.  </p>
<pre><code class="language-typescript">// index.ets  
import &#123; bar &#125; from &#39;./page&#39;;  
export function foo() &#123;  
  bar();  
&#125;  

// page.ets  
import &#123; foo &#125; from &#39;./index&#39;;  
export function bar() &#123;  
  foo();  
&#125;  
bar();  
</code></pre>
<h5 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h5><p>Use DevEco Studio’s Code Linter to identify circular dependencies and refactor the code:  </p>
<ol>
<li>Create a <code>code-linter.json5</code> configuration file in the project root with:</li>
</ol>
<pre><code class="language-json5">&#123;  
  &quot;files&quot;: [  
    &quot;**/*.js&quot;,  
    &quot;**/*.ts&quot;,  
    &quot;**/*.ets&quot;  
  ],  
  &quot;rules&quot;: &#123;  
    &quot;@security/no-cycle&quot;: &quot;error&quot; // Enable circular dependency checking  
  &#125;  
&#125;  
</code></pre>
<ol start="2">
<li>Right-click the project root in the workspace and select <strong>Code Linter &gt; Full Linter</strong> to perform a full code scan.<br><img src="/../images/HarmonyOS%20Next%20Worker%E7%BA%BF%E7%A8%8B%E4%B8%AD%E6%A8%A1%E5%9D%97%E6%9C%AA%E5%88%9D%E5%A7%8B%E5%8C%96%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E5%AE%9E%E6%88%98-2.png" alt="alt text"></li>
<li>Refactor the code based on the linter’s circular dependency warnings to eliminate the issue.</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/30/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/30/">30</a><span class="page-number current">31</span>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Qingkouwei</p>
  <div class="site-description" itemprop="description">Welcome to the HarmonyOS NEXT Knowledge Charging Station!  This is a hub for knowledge about HarmonyOS Next`s new-generation system. With its self-developed kernel, HarmonyOS NEXT achieves native smoothness, security, intelligence, and interconnectivity. We deeply analyze how its new distributed soft bus revolutionizes device connectivity experiences and explain the principles behind the enhanced perception and reasoning capabilities of the Xiaoyi intelligent agent based on the Pangu large model. Whether you are a developer exploring application development or an ordinary user eager to understand system features, you can "recharge" here and quickly grasp the essence of HarmonyOS NEXT.</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">305</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">3</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">1</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Qingkouwei</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
