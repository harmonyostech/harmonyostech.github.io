<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"harmonyostech.github.io","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="Welcome to the HarmonyOS NEXT Knowledge Charging Station!  This is a hub for knowledge about HarmonyOS Next&#96;s new-generation system. With its self-developed kernel, HarmonyOS NEXT achieves native smoo">
<meta property="og:type" content="website">
<meta property="og:title" content="HarmonyOS NEXT Knowledge Charging Station">
<meta property="og:url" content="https://harmonyostech.github.io/page/34/index.html">
<meta property="og:site_name" content="HarmonyOS NEXT Knowledge Charging Station">
<meta property="og:description" content="Welcome to the HarmonyOS NEXT Knowledge Charging Station!  This is a hub for knowledge about HarmonyOS Next&#96;s new-generation system. With its self-developed kernel, HarmonyOS NEXT achieves native smoo">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Qingkouwei">
<meta property="article:tag" content="HarmonyOSNext, HarmonyOS NEXT, HarmonyOS, Cangjie">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://harmonyostech.github.io/page/34/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>HarmonyOS NEXT Knowledge Charging Station</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">HarmonyOS NEXT Knowledge Charging Station</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">Analysis of Core Technologies and Application Scenarios of HarmonyOS NEXT</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://harmonyostech.github.io/2025/06/24/Daily-HarmonyOS-Next-Knowledge-Global-Prompts-Text-Size-Changes-Tab-Subpage-Lifecycle-Routing-Parameter-Acquisition-State-Monitoring/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Qingkouwei">
      <meta itemprop="description" content="Welcome to the HarmonyOS NEXT Knowledge Charging Station!  This is a hub for knowledge about HarmonyOS Next`s new-generation system. With its self-developed kernel, HarmonyOS NEXT achieves native smoothness, security, intelligence, and interconnectivity. We deeply analyze how its new distributed soft bus revolutionizes device connectivity experiences and explain the principles behind the enhanced perception and reasoning capabilities of the Xiaoyi intelligent agent based on the Pangu large model. Whether you are a developer exploring application development or an ordinary user eager to understand system features, you can "recharge" here and quickly grasp the essence of HarmonyOS NEXT.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HarmonyOS NEXT Knowledge Charging Station">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/06/24/Daily-HarmonyOS-Next-Knowledge-Global-Prompts-Text-Size-Changes-Tab-Subpage-Lifecycle-Routing-Parameter-Acquisition-State-Monitoring/" class="post-title-link" itemprop="url">[Daily HarmonyOS Next Knowledge] Global Prompts, Text Size Changes, Tab Subpage Lifecycle, Routing Parameter Acquisition, State Monitoring</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2025-06-24 23:42:37 / Modified: 23:43:04" itemprop="dateCreated datePublished" datetime="2025-06-24T23:42:37+08:00">2025-06-24</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Daily-HarmonyOS-Next-Knowledge/" itemprop="url" rel="index"><span itemprop="name">Daily HarmonyOS Next Knowledge</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="Daily-HarmonyOS-Next-Knowledge-Global-Prompts-Text-Size-Changes-Tab-Subpage-Lifecycle-Routing-Parameter-Acquisition-State-Monitoring"><a href="#Daily-HarmonyOS-Next-Knowledge-Global-Prompts-Text-Size-Changes-Tab-Subpage-Lifecycle-Routing-Parameter-Acquisition-State-Monitoring" class="headerlink" title="[Daily HarmonyOS Next Knowledge] Global Prompts, Text Size Changes, Tab Subpage Lifecycle, Routing Parameter Acquisition, State Monitoring"></a>[Daily HarmonyOS Next Knowledge] Global Prompts, Text Size Changes, Tab Subpage Lifecycle, Routing Parameter Acquisition, State Monitoring</h3><h4 id="1-Does-HarmonyOS-support-a-global-toast-like-pop-up-window-that-allows-custom-layouts-and-entry-exit-animations"><a href="#1-Does-HarmonyOS-support-a-global-toast-like-pop-up-window-that-allows-custom-layouts-and-entry-exit-animations" class="headerlink" title="1. Does HarmonyOS support a global toast-like pop-up window that allows custom layouts and entry&#x2F;exit animations?"></a>1. Does HarmonyOS support a global toast-like pop-up window that allows custom layouts and entry&#x2F;exit animations?</h4><p>Is there a pop-up window similar to a global toast that supports custom layouts and entry&#x2F;exit animations?<br>Since the default toast has limited customization, it is recommended to use <code>promptAction.openCustomDialog</code> to implement a transparent toast-like effect with custom layouts.<br><strong>Reference Documentation</strong>: <a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references-V5/js-apis-promptaction-V5#promptactionopencustomdialog11">https://developer.huawei.com/consumer/cn/doc/harmonyos-references-V5/js-apis-promptaction-V5#promptactionopencustomdialog11</a>  </p>
<p><code>openCustomDialog(options: CustomDialogOptions): Promise&lt;number&gt;</code>  </p>
<ul>
<li>Opens a custom pop-up window.  </li>
<li>Currently, <code>isModal = true</code> and <code>showInSubWindow = true</code> cannot be used simultaneously.  </li>
<li>The pop-up width in portrait mode defaults to <code>window width - left/right margin (16vp, 40vp for 2-in-1 devices)</code>, with a maximum default width of 400vp.</li>
</ul>
<h4 id="2-How-to-convert-the-component-size-obtained-via-the-onSizeChange-interface-to-pixels-in-HarmonyOS"><a href="#2-How-to-convert-the-component-size-obtained-via-the-onSizeChange-interface-to-pixels-in-HarmonyOS" class="headerlink" title="2. How to convert the component size obtained via the onSizeChange interface to pixels in HarmonyOS?"></a>2. How to convert the component size obtained via the <code>onSizeChange</code> interface to pixels in HarmonyOS?</h4><p>When obtaining the component size through the <code>onSizeChange</code> interface, how to convert the <code>sizeoptions</code> to pixels?<br><strong>Reference for pixel unit conversion</strong>: <a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references-V5/ts-pixel-units-V5">https://developer.huawei.com/consumer/cn/doc/harmonyos-references-V5/ts-pixel-units-V5</a><br>ArkUI provides 4 pixel units, with <code>vp</code> as the base unit.  </p>
<table>
<thead>
<tr>
<th align="left">Name</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody><tr>
<td align="left">px</td>
<td align="left">Physical screen pixel unit.</td>
</tr>
<tr>
<td align="left">vp</td>
<td align="left">Density-related pixel unit, converted to physical pixels based on screen density. Default unit when no unit is specified. <br><br><strong>Note</strong>: The vp-to-px ratio depends on screen density.</td>
</tr>
<tr>
<td align="left">fp</td>
<td align="left">Font pixel unit, similar to vp but adapts to system font size settings.</td>
</tr>
<tr>
<td align="left">lpx</td>
<td align="left">Logical pixel unit relative to the viewport, calculated as <code>actual screen width / logical width (configured by designWidth)</code>. The default <code>designWidth</code> is 720. For a screen with 1440 physical pixels, 1lpx equals 2px when <code>designWidth = 720</code>.</td>
</tr>
</tbody></table>
<h4 id="3-When-loading-multiple-entry-pages-via-Tab-in-HarmonyOS-why-are-the-lifecycle-methods-onPageShow-and-onPageHide-not-called-for-tab-subpages"><a href="#3-When-loading-multiple-entry-pages-via-Tab-in-HarmonyOS-why-are-the-lifecycle-methods-onPageShow-and-onPageHide-not-called-for-tab-subpages" class="headerlink" title="3. When loading multiple @entry pages via Tab in HarmonyOS, why are the lifecycle methods onPageShow and onPageHide not called for tab subpages?"></a>3. When loading multiple @entry pages via Tab in HarmonyOS, why are the lifecycle methods <code>onPageShow</code> and <code>onPageHide</code> not called for tab subpages?</h4><p><code>onPageShow</code> and <code>onPageHide</code> are page-level lifecycle methods, but <code>TabContent</code> is a subcomponent and does not trigger these lifecycles. To implement monitoring, use the <code>@Watch</code> decorator: change the watched variable in the tab click callback and implement monitoring in the subcomponent.<br><strong>Reference</strong>: <a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/arkts-watch-V5">https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/arkts-watch-V5</a>  </p>
<h4 id="4-How-to-convert-the-type-of-results-from-getParamByName-in-HarmonyOS"><a href="#4-How-to-convert-the-type-of-results-from-getParamByName-in-HarmonyOS" class="headerlink" title="4. How to convert the type of results from getParamByName in HarmonyOS?"></a>4. How to convert the type of results from <code>getParamByName</code> in HarmonyOS?</h4><p>When passing parameters between components via Navigation, <code>getParamByName</code> returns <code>Array&lt;unknown&gt;</code>. Even if a string is passed, type casting (e.g., <code>as string</code>) fails.<br><strong>Solution</strong>: Use <code>String(XXX.getParamByName())</code> to cast the unknown type to a string.  </p>
<h4 id="5-In-HarmonyOS-state-management-how-can-watch-monitor-a-specific-property-within-an-observed-class-object"><a href="#5-In-HarmonyOS-state-management-how-can-watch-monitor-a-specific-property-within-an-observed-class-object" class="headerlink" title="5. In HarmonyOS state management, how can @watch monitor a specific property within an observed class object?"></a>5. In HarmonyOS state management, how can <code>@watch</code> monitor a specific property within an observed class object?</h4><p>Currently, <code>@watch</code> can only monitor a single property. If there is a class <code>A</code> decorated with <code>@observe</code>, how to monitor only the <code>a</code> property of <code>A</code>?<br><strong>Reference</strong>: <a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/arkts-new-observedv2-and-trace-V5">https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/arkts-new-observedv2-and-trace-V5</a><br>To enhance state management for nested object properties, use the <code>@ObservedV2</code> and <code>@Trace</code> decorators:  </p>
<ul>
<li><code>@ObservedV2</code> and <code>@Trace</code> enable direct monitoring of nested property changes, a core capability of State Management V2.</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://harmonyostech.github.io/2025/06/24/%E3%80%90Daily-HarmonyOS-Next-Knowledge%E3%80%91Page-Parameter-Passing-Popup-Disable-Blank-Click-to-Close-Two-way-Binding-Data-Error-Destroy-Custom-Components-Image-Blur-Setting/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Qingkouwei">
      <meta itemprop="description" content="Welcome to the HarmonyOS NEXT Knowledge Charging Station!  This is a hub for knowledge about HarmonyOS Next`s new-generation system. With its self-developed kernel, HarmonyOS NEXT achieves native smoothness, security, intelligence, and interconnectivity. We deeply analyze how its new distributed soft bus revolutionizes device connectivity experiences and explain the principles behind the enhanced perception and reasoning capabilities of the Xiaoyi intelligent agent based on the Pangu large model. Whether you are a developer exploring application development or an ordinary user eager to understand system features, you can "recharge" here and quickly grasp the essence of HarmonyOS NEXT.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HarmonyOS NEXT Knowledge Charging Station">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/06/24/%E3%80%90Daily-HarmonyOS-Next-Knowledge%E3%80%91Page-Parameter-Passing-Popup-Disable-Blank-Click-to-Close-Two-way-Binding-Data-Error-Destroy-Custom-Components-Image-Blur-Setting/" class="post-title-link" itemprop="url">【Daily HarmonyOS Next Knowledge】Page Parameter Passing, Popup Disable Blank Click to Close, Two-way Binding Data Error, Destroy Custom Components, Image Blur Setting</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2025-06-24 23:40:44 / Modified: 23:41:09" itemprop="dateCreated datePublished" datetime="2025-06-24T23:40:44+08:00">2025-06-24</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Daily-HarmonyOS-Next-Knowledge/" itemprop="url" rel="index"><span itemprop="name">Daily HarmonyOS Next Knowledge</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="【Daily-HarmonyOS-Next-Knowledge】Page-Parameter-Passing-Popup-Disable-Blank-Click-to-Close-Two-way-Binding-Data-Error-Destroy-Custom-Components-Image-Blur-Setting"><a href="#【Daily-HarmonyOS-Next-Knowledge】Page-Parameter-Passing-Popup-Disable-Blank-Click-to-Close-Two-way-Binding-Data-Error-Destroy-Custom-Components-Image-Blur-Setting" class="headerlink" title="【Daily HarmonyOS Next Knowledge】Page Parameter Passing, Popup Disable Blank Click to Close, Two-way Binding Data Error, Destroy Custom Components, Image Blur Setting"></a>【Daily HarmonyOS Next Knowledge】Page Parameter Passing, Popup Disable Blank Click to Close, Two-way Binding Data Error, Destroy Custom Components, Image Blur Setting</h3><h4 id="1-How-to-pass-parameters-to-the-corresponding-Page-when-using-window-setUIContent-in-HarmonyOS"><a href="#1-How-to-pass-parameters-to-the-corresponding-Page-when-using-window-setUIContent-in-HarmonyOS" class="headerlink" title="1. How to pass parameters to the corresponding Page when using window.setUIContent in HarmonyOS?"></a>1. How to pass parameters to the corresponding Page when using window.setUIContent in HarmonyOS?</h4><p>How to pass parameters to WindowContent through window.setUIContent?  </p>
<p>Try the following interface: <code>loadContent(path: string, storage: LocalStorage): Promise&lt;void&gt;</code>. This loads specific page content for the window based on the path of a page in the current project and passes state attributes to the loaded page via LocalStorage using a Promise asynchronous callback.<br>Specific documentation: <a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references-V5/js-apis-window-V5#loadcontent9">https://developer.huawei.com/consumer/cn/doc/harmonyos-references-V5/js-apis-window-V5#loadcontent9</a>  </p>
<h4 id="2-How-to-disable-the-function-of-closing-a-custom-popup-by-clicking-the-blank-area-in-HarmonyOS"><a href="#2-How-to-disable-the-function-of-closing-a-custom-popup-by-clicking-the-blank-area-in-HarmonyOS" class="headerlink" title="2. How to disable the function of closing a custom popup by clicking the blank area in HarmonyOS?"></a>2. How to disable the function of closing a custom popup by clicking the blank area in HarmonyOS?</h4><p>Reference documentation: <a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references-V5/js-apis-promptaction-V5#ZH-CN_TOPIC_0000001884757698__basedialogoptions11">https://developer.huawei.com/consumer/cn/doc/harmonyos-references-V5/js-apis-promptaction-V5#ZH-CN_TOPIC_0000001884757698__basedialogoptions11</a>  </p>
<h4 id="3-Compilation-error-occurs-when-using-two-way-binding-with-the-Slider-component-in-an-HSP-package-in-HarmonyOS"><a href="#3-Compilation-error-occurs-when-using-two-way-binding-with-the-Slider-component-in-an-HSP-package-in-HarmonyOS" class="headerlink" title="3. Compilation error occurs when using $$ two-way binding with the Slider component in an HSP package in HarmonyOS?"></a>3. Compilation error occurs when using <code>$$</code> two-way binding with the Slider component in an HSP package in HarmonyOS?</h4><p>In an HSP package page, using two-way data binding with the Slider component throws a compilation error <code>Cannot find name &#39;this&#39;</code>. This works normally in a HAP package. The page code is as follows:  </p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entry</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line">struct <span class="title class_">SliderPage</span> &#123;</span><br><span class="line">  <span class="meta">@State</span> <span class="attr">value</span>: <span class="built_in">number</span> = <span class="number">0</span></span><br><span class="line">  <span class="title function_">build</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">RelativeContainer</span>() &#123;</span><br><span class="line">      <span class="comment">// Using $$ two-way binding here causes a compilation error</span></span><br><span class="line">      <span class="title class_">Slider</span>(&#123; <span class="attr">value</span>: $$this.<span class="property">value</span>, <span class="attr">step</span>: <span class="number">0.01</span> &#125;)</span><br><span class="line">        .<span class="title function_">id</span>(<span class="string">&#x27;slider&#x27;</span>)</span><br><span class="line">        .<span class="title function_">alignRules</span>(&#123;</span><br><span class="line">          <span class="attr">center</span>: &#123; <span class="attr">anchor</span>: <span class="string">&#x27;__container__&#x27;</span>, <span class="attr">align</span>: <span class="title class_">VerticalAlign</span>.<span class="property">Center</span> &#125;,</span><br><span class="line">          <span class="attr">middle</span>: &#123; <span class="attr">anchor</span>: <span class="string">&#x27;__container__&#x27;</span>, <span class="attr">align</span>: <span class="title class_">HorizontalAlign</span>.<span class="property">Center</span> &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">        .<span class="title function_">blockSize</span>(&#123; <span class="attr">width</span>: <span class="string">&#x27;20&#x27;</span>, <span class="attr">height</span>: <span class="string">&#x27;20&#x27;</span> &#125;)</span><br><span class="line">        .<span class="title function_">onChange</span>(<span class="function">(<span class="params">value, mode</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (mode === <span class="title class_">SliderChangeMode</span>.<span class="property">End</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;end&#x27;</span>)</span><br><span class="line">            <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">              <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;settimeout&#x27;</span>)</span><br><span class="line">              <span class="variable language_">this</span>.<span class="property">value</span> = <span class="number">90</span></span><br><span class="line">              <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`this.value <span class="subst">$&#123;<span class="variable language_">this</span>.value&#125;</span>`</span>)</span><br><span class="line">            &#125;, <span class="number">1000</span>)</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`<span class="subst">$&#123;value&#125;</span>`</span>)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    .<span class="title function_">height</span>(<span class="string">&#x27;100%&#x27;</span>)</span><br><span class="line">    .<span class="title function_">width</span>(<span class="string">&#x27;100%&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="string">``</span><span class="string">`  </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Variables decorated with @State do not require `</span>$$<span class="string">` operation—use `</span><span class="variable language_">this</span>.<span class="property">value</span><span class="string">` directly. Remove the `</span>$$<span class="string">` attempt or use @Link.  </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#### 4. How to actively destroy a custom component in HarmonyOS?  </span></span><br><span class="line"><span class="string">How to actively destroy a custom component? Add a destruction method `</span>destroy<span class="string">` to the component. How to implement this method to destroy the component itself?  </span></span><br><span class="line"><span class="string">`</span><span class="string">``</span>typescript</span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line">struct <span class="title class_">Demo</span> &#123;</span><br><span class="line">  <span class="meta">@State</span> <span class="attr">switch</span>: <span class="built_in">boolean</span> = <span class="literal">true</span></span><br><span class="line">  <span class="title function_">build</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Column</span>() &#123;</span><br><span class="line">      <span class="title class_">Button</span>(<span class="string">&#x27;Hello World&#x27;</span>)</span><br><span class="line">        .<span class="title function_">fontSize</span>(<span class="number">50</span>)</span><br><span class="line">        .<span class="title function_">fontWeight</span>(<span class="title class_">FontWeight</span>.<span class="property">Bold</span>)</span><br><span class="line">        .<span class="title function_">onClick</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">switch</span> = !<span class="variable language_">this</span>.<span class="property">switch</span></span><br><span class="line">        &#125;)</span><br><span class="line">      <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">switch</span>) &#123;</span><br><span class="line">        <span class="title class_">Child</span>(&#123; <span class="attr">message</span>: <span class="keyword">new</span> <span class="title class_">Message</span>(<span class="string">&#x27;Child&#x27;</span>) &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    .<span class="title function_">height</span>(<span class="string">&quot;100%&quot;</span>)</span><br><span class="line">    .<span class="title function_">width</span>(<span class="string">&#x27;100%&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="string">``</span><span class="string">`  </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Refer to the lifecycle and deletion of custom components: https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/arkts-page-custom-components-lifecycle-V5#%E8%87%AA%E5%AE%9A%E4%B9%89%E7%BB%84%E4%BB%B6%E7%9A%84%E5%88%A0%E9%99%A4  </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">A component will be deleted if:  </span></span><br><span class="line"><span class="string">- The branch of an if statement changes.  </span></span><br><span class="line"><span class="string">- The number of elements in a ForEach loop changes.  </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Before deletion, the `</span>aboutToDisappear<span class="string">` lifecycle function is called, marking that the node will be destroyed. ArkUI&#x27;s node deletion mechanism:  </span></span><br><span class="line"><span class="string">- Backend nodes are directly removed from the component tree and destroyed.  </span></span><br><span class="line"><span class="string">- Frontend nodes are dereferenced and garbage-collected by the JS virtual machine when no references remain.  </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Custom components and their variables are deleted. If they have synchronized variables (e.g., @Link, @Prop, @StorageLink), they are unregistered from the synchronization source.  </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">**Note**: Avoid using `</span><span class="keyword">async</span>/<span class="keyword">await</span><span class="string">` in `</span>aboutToDisappear<span class="string">`. Asynchronous operations (Promises or callback methods) in `</span>aboutToDisappear<span class="string">` keep the component in the Promise closure until the callback completes, preventing garbage collection.  </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#### 5. How to set Gaussian blur for an Image in HarmonyOS?  </span></span><br><span class="line"><span class="string">Reference demo:  </span></span><br><span class="line"><span class="string">`</span><span class="string">``</span>typescript</span><br><span class="line"><span class="title class_">Text</span>(<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">  .<span class="title function_">width</span>(<span class="string">&#x27;90%&#x27;</span>)</span><br><span class="line">  .<span class="title function_">height</span>(<span class="string">&#x27;30%&#x27;</span>)</span><br><span class="line">  .<span class="title function_">fontSize</span>(<span class="number">20</span>)</span><br><span class="line">  .<span class="title function_">fontColor</span>(<span class="title class_">Color</span>.<span class="property">White</span>)</span><br><span class="line">  .<span class="title function_">textAlign</span>(<span class="title class_">TextAlign</span>.<span class="property">Center</span>)</span><br><span class="line">  .<span class="title function_">backdropBlur</span>(<span class="number">50</span>) <span class="comment">// Apply blur to the background</span></span><br><span class="line">  .<span class="title function_">backgroundImage</span>($r(<span class="string">&#x27;app.media.image1&#x27;</span>))</span><br><span class="line">  .<span class="title function_">backgroundImageSize</span>(&#123; <span class="attr">width</span>: <span class="number">400</span>, <span class="attr">height</span>: <span class="number">300</span> &#125;)</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://harmonyostech.github.io/2025/06/24/%E3%80%90Daily-HarmonyOS-Next-Knowledge%E3%80%91Listening-to-Returns-in-HSP-Title-Being-Pushed-Up-List-Swipe-Parameters-Canvas-Text-Alignment-Build-Parameter-Crash/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Qingkouwei">
      <meta itemprop="description" content="Welcome to the HarmonyOS NEXT Knowledge Charging Station!  This is a hub for knowledge about HarmonyOS Next`s new-generation system. With its self-developed kernel, HarmonyOS NEXT achieves native smoothness, security, intelligence, and interconnectivity. We deeply analyze how its new distributed soft bus revolutionizes device connectivity experiences and explain the principles behind the enhanced perception and reasoning capabilities of the Xiaoyi intelligent agent based on the Pangu large model. Whether you are a developer exploring application development or an ordinary user eager to understand system features, you can "recharge" here and quickly grasp the essence of HarmonyOS NEXT.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HarmonyOS NEXT Knowledge Charging Station">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/06/24/%E3%80%90Daily-HarmonyOS-Next-Knowledge%E3%80%91Listening-to-Returns-in-HSP-Title-Being-Pushed-Up-List-Swipe-Parameters-Canvas-Text-Alignment-Build-Parameter-Crash/" class="post-title-link" itemprop="url">【Daily HarmonyOS Next Knowledge】Listening to Returns in HSP, Title Being Pushed Up, List Swipe Parameters, Canvas Text Alignment, Build Parameter Crash</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2025-06-24 23:38:47 / Modified: 23:39:19" itemprop="dateCreated datePublished" datetime="2025-06-24T23:38:47+08:00">2025-06-24</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Daily-HarmonyOS-Next-Knowledge/" itemprop="url" rel="index"><span itemprop="name">Daily HarmonyOS Next Knowledge</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="【Daily-HarmonyOS-Next-Knowledge】Listening-to-Returns-in-HSP-Title-Being-Pushed-Up-List-Swipe-Parameters-Canvas-Text-Alignment-Build-Parameter-Crash"><a href="#【Daily-HarmonyOS-Next-Knowledge】Listening-to-Returns-in-HSP-Title-Being-Pushed-Up-List-Swipe-Parameters-Canvas-Text-Alignment-Build-Parameter-Crash" class="headerlink" title="【Daily HarmonyOS Next Knowledge】Listening to Returns in HSP, Title Being Pushed Up, List Swipe Parameters, Canvas Text Alignment, Build Parameter Crash"></a>【Daily HarmonyOS Next Knowledge】Listening to Returns in HSP, Title Being Pushed Up, List Swipe Parameters, Canvas Text Alignment, Build Parameter Crash</h3><h4 id="1-How-to-listen-for-system-back-button-and-Navigation-return-events-in-a-Component-of-an-HSP-module-in-HarmonyOS"><a href="#1-How-to-listen-for-system-back-button-and-Navigation-return-events-in-a-Component-of-an-HSP-module-in-HarmonyOS" class="headerlink" title="1. How to listen for system back button and Navigation return events in a Component of an HSP module in HarmonyOS?"></a>1. How to listen for system back button and Navigation return events in a Component of an HSP module in HarmonyOS?</h4><p>Reference demo:  </p>
<pre><code class="language-typescript">import &#123; PageOneTmp &#125; from &#39;./PageOne&#39;
import &#123; pageTwoTmp &#125; from &#39;library&#39;
import &#123; Pages &#125; from &#39;library&#39;

@Entry
@Component
struct NavigationExample &#123;
  @Provide(&#39;pageInfos&#39;) pageInfos: NavPathStack = new NavPathStack()

  onPageShow(): void &#123;
    console.log(&#39;Navigation Index show&#39;)
  &#125;

  onPageHide(): void &#123;
    console.log(&#39;Navigation Index hide&#39;)
  &#125;

  @Builder
  PageMap(name: string) &#123;
    if (name === &#39;pageOne&#39;) &#123;
      PageOneTmp()
    &#125; else if (name === &#39;pageTwo&#39;) &#123;
      pageTwoTmp(&#123; names: name, values: this.pageInfos &#125; as Pages)
    &#125;
  &#125;

  build() &#123;
    Navigation(this.pageInfos) &#123;
      Column() &#123;
        Button(&#39;pushPath&#39;, &#123; stateEffect: true, type: ButtonType.Capsule &#125;)
          .width(&#39;80%&#39;)
          .height(40)
          .margin(20)
          .onClick(() =&gt; &#123;
            this.pageInfos.pushPath(&#123;
              name: &#39;pageOne&#39;
            &#125;)
            // Push the page information of the NavDestination specified by name onto the stack
          &#125;)
      &#125;
    &#125;
    .hideNavBar(true)
    .onNavBarStateChange((flag: boolean) =&gt; &#123;
      if (flag) &#123;
        console.log(&#39;Navigation Index change,now is show&#39;)
      &#125; else &#123;
        console.log(&#39;Navigation Index change,now is hide&#39;)
      &#125;
    &#125;).title(&#39;NavIndex&#39;).navDestination(this.PageMap)
  &#125;
&#125;
</code></pre>
<h4 id="2-The-HarmonyOS-navigation-title-is-pushed-up-by-the-keyboard"><a href="#2-The-HarmonyOS-navigation-title-is-pushed-up-by-the-keyboard" class="headerlink" title="2. The HarmonyOS navigation title is pushed up by the keyboard?"></a>2. The HarmonyOS navigation title is pushed up by the keyboard?</h4><p>When there is a large amount of text, opening the keyboard pushes up the title in the non-scrollable area. How to avoid this?  </p>
<pre><code class="language-typescript">Navigation()&#123;
  Scroll()&#123;
    Column()&#123;
      ......
      TextArea()...
    &#125;
  &#125;
&#125;.title(appbar()...)
</code></pre>
<p>Solution: Use the <code>expandSafeArea</code> attribute to allow components to extend their safe area.<br>Reference documentation: <a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references-V5/ts-universal-attributes-expand-safe-area-V5">https://developer.huawei.com/consumer/cn/doc/harmonyos-references-V5/ts-universal-attributes-expand-safe-area-V5</a>  </p>
<ul>
<li>The safe area refers to the page display area, which does not overlap with system-set non-safe areas (e.g., status bar, navigation bar) by default.  </li>
<li>The <code>expandSafeArea</code> attribute allows components to extend their drawing area beyond the safe area without changing the layout.  </li>
<li>Use <code>setKeyboardAvoidMode</code> to configure the avoidance mode when the virtual keyboard pops up. For titles that should not overlap with non-safe areas, set <code>expandSafeArea</code> for an immersive effect, or use the window interface <code>setWindowLayoutFullScreen</code>.</li>
</ul>
<h4 id="3-The-second-parameter-edgeEffect-of-HarmonyOS-ListItem-swipeAction-is-not-working"><a href="#3-The-second-parameter-edgeEffect-of-HarmonyOS-ListItem-swipeAction-is-not-working" class="headerlink" title="3. The second parameter edgeEffect of HarmonyOS ListItem.swipeAction() is not working?"></a>3. The second parameter <code>edgeEffect</code> of HarmonyOS ListItem.swipeAction() is not working?</h4><pre><code class="language-typescript">@Entry
@Component
struct ListItemExample2 &#123;
  @State arr: number[] = [0, 1, 2, 3, 4]
  @State enterEndDeleteAreaString: string = &quot;not enterEndDeleteArea&quot;
  @State exitEndDeleteAreaString: string = &quot;not exitEndDeleteArea&quot;
  @State isShow: boolean = true;

  @Builder itemEnd() &#123;
    Row() &#123;
      Button(&quot;Delete&quot;).margin(&quot;4vp&quot;)
      Button(&quot;Set&quot;).margin(&quot;4vp&quot;)
    &#125;.padding(&quot;4vp&quot;).justifyContent(FlexAlign.SpaceEvenly)
  &#125;
  build() &#123;
    Column() &#123;
      Button(&quot;Click&quot;).onClick(() =&gt; &#123;
        this.isShow = !this.isShow
        console.log(this.isShow + &quot;111111111&quot;)
      &#125;)
      List(&#123; space: 10 &#125;) &#123;
        ForEach(this.arr, (item: number) =&gt; &#123;
          ListItem() &#123;
            Text(&quot;item&quot; + item)
              .width(&#39;100%&#39;)
              .height(100)
              .fontSize(16)
              .textAlign(TextAlign.Center)
              .borderRadius(10)
              .backgroundColor(0xFFFFFF)
          &#125;
          .transition(&#123; type: TransitionType.Delete, opacity: 0 &#125;)
          .swipeAction(&#123;
            end: this.isShow ? &#123;
              builder: () =&gt; &#123; this.itemEnd() &#125;,
              onAction: () =&gt; &#123;
                animateTo(&#123; duration: 1000 &#125;, () =&gt; &#123;
                  let index = this.arr.indexOf(item)
                  this.arr.splice(index, 1)
                &#125;)
              &#125;,
              actionAreaDistance: 56,
              onEnterActionArea: () =&gt; &#123;
                this.enterEndDeleteAreaString = &quot;enterEndDeleteArea&quot;
                this.exitEndDeleteAreaString = &quot;not exitEndDeleteArea&quot;
              &#125;,
              onExitActionArea: () =&gt; &#123;
                this.enterEndDeleteAreaString = &quot;not enterEndDeleteArea&quot;
                this.exitEndDeleteAreaString = &quot;exitEndDeleteArea&quot;
              &#125;
            &#125; : undefined
          , edgeEffect: SwipeEdgeEffect.None
          &#125;)
        &#125;, (item: string) =&gt; item)
      &#125;
      Text(this.enterEndDeleteAreaString).fontSize(20)
      Text(this.exitEndDeleteAreaString).fontSize(20)
    &#125;
    .padding(10)
    .backgroundColor(0xDCDCDC)
    .width(&#39;100%&#39;)
    .height(&#39;100%&#39;)
  &#125;
&#125;
</code></pre>
<p><strong>Key points</strong>:  </p>
<ol>
<li><code>SwipeEdgeEffect.None</code>: Restricts the swipe distance to the size of the swiped component. If a delete area is set, the swipe distance cannot exceed the delete threshold, and releasing the touch after reaching the threshold triggers the delete callback.  </li>
<li><code>SwipeEdgeEffect.Spring</code>: Allows swiping beyond the component size. After exceeding the delete threshold, releasing the touch causes the list item to rebound with a spring damping effect.</li>
</ol>
<p><strong>Solution</strong>: The <code>actionAreaDistance: 56</code> is too small, leading to accidental deletions. Increase this value for better control.  </p>
<h4 id="4-How-to-solve-the-issue-that-the-textAlign-method-for-setting-text-alignment-in-HarmonyOS-Canvas-is-not-effective"><a href="#4-How-to-solve-the-issue-that-the-textAlign-method-for-setting-text-alignment-in-HarmonyOS-Canvas-is-not-effective" class="headerlink" title="4. How to solve the issue that the textAlign method for setting text alignment in HarmonyOS Canvas is not effective?"></a>4. How to solve the issue that the textAlign method for setting text alignment in HarmonyOS Canvas is not effective?</h4><p>Reference demo:  </p>
<pre><code class="language-typescript">// xxx.ets
@Entry
@Component
struct CanvasExample &#123;
  private settings: RenderingContextSettings = new RenderingContextSettings(true)
  private context: CanvasRenderingContext2D = new CanvasRenderingContext2D(this.settings)

  build() &#123;
    Flex(&#123; direction: FlexDirection.Column, alignItems: ItemAlign.Center, justifyContent: FlexAlign.Center &#125;) &#123;
      Canvas(this.context)
        .width(&#39;100%&#39;)
        .height(&#39;100%&#39;)
        .backgroundColor(&#39;#ffff00&#39;)
        .onReady(() =&gt; &#123;
          this.context.fillStyle = &#39;#0000ff&#39;
          this.context.font = &#39;18vp&#39;
          this.context.fillStyle = Color.Black
          this.context.textAlign = &#39;center&#39;
          this.context.textBaseline = &#39;middle&#39;
          let str = (-10.3456).toFixed(2)
          let metrics = this.context.measureText(str)
          this.context.fillStyle = Color.Green // Draw the text display area
          this.context.fillRect(10, (this.context.height - metrics.height) / 2, metrics.width, metrics.height)
          this.context.fillStyle = Color.Black // Draw the text
          this.context.fillText(str, 10 + (metrics.width / 2), (this.context.height) / 2)
        &#125;)
    &#125;
    .width(&#39;100%&#39;)
    .height(&#39;100%&#39;)
  &#125;
&#125;
</code></pre>
<h4 id="5-After-passing-components-using-BuilderParam-in-HarmonyOS-calling-methods-causes-a-crash"><a href="#5-After-passing-components-using-BuilderParam-in-HarmonyOS-calling-methods-causes-a-crash" class="headerlink" title="5. After passing components using BuilderParam in HarmonyOS, calling methods causes a crash?"></a>5. After passing components using BuilderParam in HarmonyOS, calling methods causes a crash?</h4><p>When passing a component to a child control via BuilderParam and handling its click events on the current page, the <code>this</code> keyword in the event method refers to the child control instead of the current page, causing a crash.  </p>
<p><strong>Solution</strong>: Modify how custom components pass parameters:  </p>
<pre><code class="language-typescript">NavigationView(&#123;title:&quot;小标题&quot;,rightRowElement:() =&gt; &#123;this.navRightBtn()&#125;&#125;)
</code></pre>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://harmonyostech.github.io/2025/06/24/Daily-HarmonyOS-Next-Knowledge-Tab-Area-Occlusion-System-Cropping-Function-JSON-Conversion-Issues-Click-Events-Animation-Continuous-Execution-Problem/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Qingkouwei">
      <meta itemprop="description" content="Welcome to the HarmonyOS NEXT Knowledge Charging Station!  This is a hub for knowledge about HarmonyOS Next`s new-generation system. With its self-developed kernel, HarmonyOS NEXT achieves native smoothness, security, intelligence, and interconnectivity. We deeply analyze how its new distributed soft bus revolutionizes device connectivity experiences and explain the principles behind the enhanced perception and reasoning capabilities of the Xiaoyi intelligent agent based on the Pangu large model. Whether you are a developer exploring application development or an ordinary user eager to understand system features, you can "recharge" here and quickly grasp the essence of HarmonyOS NEXT.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HarmonyOS NEXT Knowledge Charging Station">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/06/24/Daily-HarmonyOS-Next-Knowledge-Tab-Area-Occlusion-System-Cropping-Function-JSON-Conversion-Issues-Click-Events-Animation-Continuous-Execution-Problem/" class="post-title-link" itemprop="url">[Daily HarmonyOS Next Knowledge] Tab Area Occlusion, System Cropping Function, JSON Conversion Issues, Click Events, Animation Continuous Execution Problem</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2025-06-24 23:37:14 / Modified: 23:37:54" itemprop="dateCreated datePublished" datetime="2025-06-24T23:37:14+08:00">2025-06-24</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Daily-HarmonyOS-Next-Knowledge/" itemprop="url" rel="index"><span itemprop="name">Daily HarmonyOS Next Knowledge</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Daily-HarmonyOS-Next-Knowledge-Tab-Area-Occlusion-System-Cropping-Function-JSON-Conversion-Issues-Click-Events-Animation-Continuous-Execution-Problem"><a href="#Daily-HarmonyOS-Next-Knowledge-Tab-Area-Occlusion-System-Cropping-Function-JSON-Conversion-Issues-Click-Events-Animation-Continuous-Execution-Problem" class="headerlink" title="[Daily HarmonyOS Next Knowledge] Tab Area Occlusion, System Cropping Function, JSON Conversion Issues, Click Events, Animation Continuous Execution Problem"></a>[Daily HarmonyOS Next Knowledge] Tab Area Occlusion, System Cropping Function, JSON Conversion Issues, Click Events, Animation Continuous Execution Problem</h1><h4 id="1-HarmonyOS-Tabbar-area-occlusion-problem"><a href="#1-HarmonyOS-Tabbar-area-occlusion-problem" class="headerlink" title="1. HarmonyOS Tabbar area occlusion problem?"></a>1. HarmonyOS Tabbar area occlusion problem?</h4><p>When using Tabbar as the bottom navigation with a List inside, occlusion occurs.<br><strong>Solution</strong>: Set the <code>barOverlap</code> attribute to <code>false</code> to eliminate occlusion.  </p>
<h4 id="2-How-to-invoke-the-system-cropping-function-for-images-in-HarmonyOS"><a href="#2-How-to-invoke-the-system-cropping-function-for-images-in-HarmonyOS" class="headerlink" title="2. How to invoke the system cropping function for images in HarmonyOS?"></a>2. How to invoke the system cropping function for images in HarmonyOS?</h4><p>Image cropping requires operations on <code>PixelMap</code>.<br><strong>Reference documentation</strong>: <a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/image-arkts-dev-V5">https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/image-arkts-dev-V5</a>  </p>
<pre><code class="language-typescript">Button(&#39;Image Crop&#39;).fancy()
  .onClick(() =&gt; &#123;
    let region: image.Region = &#123; x: 300, y: 0, size: &#123; height: 500, width: 700 &#125; &#125;;
    if (this.imagePixelMap !== undefined) &#123;
      this.imagePixelMap.crop(region).then(async () =&gt; &#123;
        if (this.imagePixelMap !== undefined) &#123;
          let pixel = await copyPixelMap(this.imagePixelMap);
          this.imagePixelMap.release();
          this.imagePixelMap = pixel;
          console.info(&#39;Sucessed in setting crop.&#39;);
        &#125;
      &#125;).catch((err: BusinessError) =&gt; &#123;
        console.error(&#39;Failed to crop pixelmap.&#39;);
      &#125;)
    &#125;
  &#125;)

async function copyPixelMap(imagePixel: PixelMap): Promise&lt;image.PixelMap&gt; &#123;
  let imageInfo: image.ImageInfo = await imagePixel.getImageInfo();
  console.info(`copyPixelMapSize: width:$&#123;imageInfo?.size.width&#125; height：$&#123;imageInfo?.size.height&#125;`);
  let newRegion: image.Region = &#123;
    size: &#123; height: imageInfo.size.height, width: imageInfo.size.width &#125;,
    x: 0,
    y: 0
  &#125;
  let newArea: image.PositionArea = &#123;
    pixels: new ArrayBuffer(imageInfo.size.height * imageInfo.size.width * 4),
    offset: 0,
    stride: imageInfo.stride,
    region: newRegion
  &#125;
  await imagePixel.readPixels(newArea);
  let opts: image.InitializationOptions = &#123; editable: true, pixelFormat: 4, size: imageInfo.size &#125;;
  let imagePixelCache = await image.createPixelMap(newArea.pixels, opts);
  return imagePixelCache;
&#125;
</code></pre>
<p><strong>Simple example reference</strong>: For third-party library image cropping, refer to ImageKnife, which provides a cropping interface <code>request.crop()</code>.<br><strong>Documentation</strong>: <a target="_blank" rel="noopener" href="https://gitee.com/openharmony-tpc/ImageKnife">https://gitee.com/openharmony-tpc/ImageKnife</a>  </p>
<pre><code class="language-typescript">import &#123; photoAccessHelper &#125; from &#39;@kit.MediaLibraryKit&#39;;
import &#123; fileIo, picker &#125; from &#39;@kit.CoreFileKit&#39;;
import &#123; BusinessError &#125; from &#39;@kit.BasicServicesKit&#39;;
import &#123; image &#125; from &#39;@kit.ImageKit&#39;;

@Entry
@Component
struct Index &#123;
  @State origin: PixelMap | undefined = undefined
  @State origin2: PixelMap | undefined = undefined
  private uri:string = &#39;&#39;

  private async decodeImage(uri: string) &#123;
    try &#123;
      let file = fileIo.openSync(uri, fileIo.OpenMode.READ_ONLY)
      const imageSourceApi = image.createImageSource(file.fd)
      imageSourceApi.getImageInfo(0, (error: BusinessError, imageInfo) =&gt; &#123;
        if (imageInfo === undefined) &#123;
          // log.e(error)
        &#125;
        console.log(`imageInfo:  $&#123;JSON.stringify(imageInfo)&#125;`)
      &#125;)
      return await imageSourceApi.createPixelMap()
    &#125; catch (error) &#123;
      // log.e(error)
      return undefined
    &#125;
  &#125;
  build() &#123;
    Column() &#123;
      Button(&#39;Add Photo&#39;)
        .onClick(async () =&gt; &#123;
          let uris = await selectPhoto(&#123;
            MIMEType: picker.PhotoViewMIMETypes.IMAGE_TYPE,
            maxSelectNumber: 1,
            isPhotoTakingSupported: false,
            recommendationOptions: &#123;
              recommendationType: photoAccessHelper.RecommendationType.PROFILE_PICTURE,
            &#125;
          &#125;)
          if (uris.length === 0) &#123;
            return
          &#125;
          this.uri = uris[0];
          this.origin = await this.decodeImage(uris[0])

        &#125;)
      Image(this.origin)
        .width(&#39;100%&#39;)
        .height(&#39;100%&#39;)
        .layoutWeight(1)
        .objectFit(ImageFit.Contain)


      Button(&#39;Crop Photo&#39;)
        .onClick(async () =&gt; &#123;
          this.origin2 = await this.decodeImage(this.uri)
          if (this.origin2) &#123;
            let info = await this.origin2.getImageInfo()
            this.origin2.crop(&#123;
              x: 0, y: 0,
              size: &#123;
                width: info.size.width,
                height: info.size.height / 2
              &#125;
            &#125;)
            let pixel = await copyPixelMap(this.origin2);
            this.origin2.release();
            this.origin2 = pixel;
          &#125;
        &#125;)

      Image(this.origin2)
        .width(&#39;100%&#39;)
        .height(&#39;100%&#39;)
        .layoutWeight(1)
        .objectFit(ImageFit.Contain)
    &#125;
    .width(`100%`)
  &#125;
&#125;


const PHOTO_DEFAULT_SELECT_NUMBER: number = 9; // Quantity

async function copyPixelMap(imagePixel: PixelMap): Promise&lt;image.PixelMap&gt; &#123;
  let imageInfo: image.ImageInfo = await imagePixel.getImageInfo();
  console.info(`copyPixelMapSize: width:$&#123;imageInfo?.size.width&#125; height：$&#123;imageInfo?.size.height&#125;`);
  let newRegion: image.Region = &#123;
    size: &#123; height: imageInfo.size.height, width: imageInfo.size.width &#125;,
    x: 0,
    y: 0
  &#125;
  let newArea: image.PositionArea = &#123;
    pixels: new ArrayBuffer(imageInfo.size.height * imageInfo.size.width * 4),
    offset: 0,
    stride: imageInfo.stride,
    region: newRegion
  &#125;
  await imagePixel.readPixels(newArea);
  let opts: image.InitializationOptions = &#123; editable: true, pixelFormat: 4, size: imageInfo.size &#125;;
  let imagePixelCache = await image.createPixelMap(newArea.pixels, opts);
  return imagePixelCache;
&#125;

/**
Launches the photoPicker interface in selection mode, allowing users to select one or more images/videos.
@param options
@returns
*/
async function selectPhoto(options?: PhotoSelectOptions): Promise&lt;Array&lt;string&gt;&gt; &#123;
  try &#123;
    if (!options) &#123;
      options = new PhotoSelectOptions();
    &#125;
    if (!options.MIMEType) &#123; // Allowed media file types; defaults to images and videos if not specified.
      options.MIMEType = photoAccessHelper.PhotoViewMIMETypes.IMAGE_TYPE;
    &#125;
    if (!options.maxSelectNumber) &#123; // Maximum number of media files to select, default is 9
      options.maxSelectNumber = PHOTO_DEFAULT_SELECT_NUMBER;
    &#125;
    if (options.isPhotoTakingSupported === undefined) &#123;
      options.isPhotoTakingSupported = true; // Enables photo taking.
    &#125;
    if (options.isEditSupported === undefined) &#123;
      options.isEditSupported = true; // Enables photo editing.
    &#125;
    if (options.isSearchSupported === undefined) &#123;
      options.isSearchSupported = true; // Enables search.
    &#125;
    let photoSelectOptions: photoAccessHelper.PhotoSelectOptions = &#123;
      MIMEType: options.MIMEType,
      maxSelectNumber: options.maxSelectNumber,
      isPhotoTakingSupported: options.isPhotoTakingSupported,
      isEditSupported: options.isEditSupported,
      isSearchSupported: options.isSearchSupported,
      recommendationOptions: options.recommendationOptions,
      preselectedUris: options.preselectedUris
    &#125;
    let photoPicker = new photoAccessHelper.PhotoViewPicker();
    let photoSelectResult: photoAccessHelper.PhotoSelectResult = await photoPicker.select(photoSelectOptions)
    if (photoSelectResult &amp;&amp; photoSelectResult.photoUris &amp;&amp; photoSelectResult.photoUris.length &gt; 0) &#123;
      return photoSelectResult.photoUris
    &#125; else &#123;
      return [];
    &#125;
  &#125; catch (err) &#123;
    console.error(err)
    return [];
  &#125;
&#125;
class PhotoSelectOptions &#123;
  MIMEType?: photoAccessHelper.PhotoViewMIMETypes = photoAccessHelper.PhotoViewMIMETypes.IMAGE_TYPE; // Allowed media file types; defaults to images and videos if not specified.
  maxSelectNumber?: number = PHOTO_DEFAULT_SELECT_NUMBER; // Maximum number of media files to select (default is 50, maximum is 500).
  isPhotoTakingSupported?: boolean = true; // Enables photo taking.
  isEditSupported?: boolean = true; // Enables photo editing.
  isSearchSupported?: boolean = true; // Enables search.
  recommendationOptions?: photoAccessHelper.RecommendationOptions; // Enables photo recommendations.
  preselectedUris?: Array&lt;string&gt;; // URIs of preselected images.
&#125;
</code></pre>
<ul>
<li>Use <code>gesture</code> to implement image zooming: Refer to the demo <a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/cn/codelabsPortal/carddetails/tutorials_NEXT-ElectronicAlbum">https://developer.huawei.com/consumer/cn/codelabsPortal/carddetails/tutorials_NEXT-ElectronicAlbum</a>.  </li>
<li>Implement image cropping with ImageKnife: <a target="_blank" rel="noopener" href="https://gitee.com/openharmony-tpc/ImageKnife">https://gitee.com/openharmony-tpc/ImageKnife</a>.</li>
</ul>
<h4 id="3-HarmonyOS-JSON-conversion-issues-in-release-mode-parameter-names-are-modified"><a href="#3-HarmonyOS-JSON-conversion-issues-in-release-mode-parameter-names-are-modified" class="headerlink" title="3. HarmonyOS JSON conversion issues in release mode (parameter names are modified)?"></a>3. HarmonyOS JSON conversion issues in release mode (parameter names are modified)?</h4><p>When converting data to a JSON string, it works in <code>test</code> build mode but fails in <code>release</code> mode, as parameter names are altered.<br><strong>Reason</strong>: DevEco Studio enables code obfuscation by default for Stage models (API 10 and above) in release mode.<br><strong>Solution</strong>: Disable code obfuscation for debugging in release mode.<br><strong>Reference</strong>: <a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/source-obfuscation-V5">https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/source-obfuscation-V5</a>  </p>
<h4 id="4-The-global-click-event-listener-in-HarmonyOS-has-x-and-y-properties-in-GestureEvent-but-they-are-not-exposed-as-external-properties-or-methods"><a href="#4-The-global-click-event-listener-in-HarmonyOS-has-x-and-y-properties-in-GestureEvent-but-they-are-not-exposed-as-external-properties-or-methods" class="headerlink" title="4. The global click event listener in HarmonyOS has x and y properties in GestureEvent, but they are not exposed as external properties or methods?"></a>4. The global click event listener in HarmonyOS has <code>x</code> and <code>y</code> properties in <code>GestureEvent</code>, but they are not exposed as external properties or methods?</h4><pre><code class="language-typescript">let callback = (event: GestureEvent, frameNode: FrameNode) =&gt; &#123;
  console.error(&quot;PageEvent didClick, event: &#123;&#125;&quot;, JSON.stringify(frameNode))
&#125;
</code></pre>
<p><strong>Solution</strong>: Use <code>ClickEvent</code> to access <code>x</code> and <code>y</code> properties.<br><strong>Reference documentation</strong>: <a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references-V5/js-apis-arkui-uicontext-V5#ZH-CN_TOPIC_0000001884757690__onwillclick12-1">https://developer.huawei.com/consumer/cn/doc/harmonyos-references-V5/js-apis-arkui-uicontext-V5#ZH-CN_TOPIC_0000001884757690__onwillclick12-1</a>  </p>
<h4 id="5-The-Lottie-animation-on-the-HarmonyOS-home-page-continues-running-even-after-page-navigation"><a href="#5-The-Lottie-animation-on-the-HarmonyOS-home-page-continues-running-even-after-page-navigation" class="headerlink" title="5. The Lottie animation on the HarmonyOS home page continues running even after page navigation?"></a>5. The Lottie animation on the HarmonyOS home page continues running even after page navigation?</h4><p>The home page’s cube card (e.g., live broadcast card) has a Lottie animation that persists after switching pages, causing device overheating.<br><strong>Solution</strong>: Manually control animations during page navigation using:  </p>
<ul>
<li><code>lottie.pause(&#39;name&#39;)</code> to pause the animation.  </li>
<li><code>lottie.play(&#39;name&#39;)</code> to resume the animation.</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://harmonyostech.github.io/2025/06/24/%E3%80%90Daily-HarmonyOS-Next-Knowledge%E3%80%91Swiper-Style-WaterFlow-Clipboard-Manual-Tracing/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Qingkouwei">
      <meta itemprop="description" content="Welcome to the HarmonyOS NEXT Knowledge Charging Station!  This is a hub for knowledge about HarmonyOS Next`s new-generation system. With its self-developed kernel, HarmonyOS NEXT achieves native smoothness, security, intelligence, and interconnectivity. We deeply analyze how its new distributed soft bus revolutionizes device connectivity experiences and explain the principles behind the enhanced perception and reasoning capabilities of the Xiaoyi intelligent agent based on the Pangu large model. Whether you are a developer exploring application development or an ordinary user eager to understand system features, you can "recharge" here and quickly grasp the essence of HarmonyOS NEXT.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HarmonyOS NEXT Knowledge Charging Station">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/06/24/%E3%80%90Daily-HarmonyOS-Next-Knowledge%E3%80%91Swiper-Style-WaterFlow-Clipboard-Manual-Tracing/" class="post-title-link" itemprop="url">【Daily HarmonyOS Next Knowledge】Swiper Style, WaterFlow, Clipboard, Manual Tracing</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2025-06-24 23:32:00 / Modified: 23:32:54" itemprop="dateCreated datePublished" datetime="2025-06-24T23:32:00+08:00">2025-06-24</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Daily-HarmonyOS-Next-Knowledge/" itemprop="url" rel="index"><span itemprop="name">Daily HarmonyOS Next Knowledge</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="【Daily-HarmonyOS-Next-Knowledge】Swiper-Style-WaterFlow-Clipboard-Manual-Tracing"><a href="#【Daily-HarmonyOS-Next-Knowledge】Swiper-Style-WaterFlow-Clipboard-Manual-Tracing" class="headerlink" title="【Daily HarmonyOS Next Knowledge】Swiper Style, WaterFlow, Clipboard, Manual Tracing"></a>【Daily HarmonyOS Next Knowledge】Swiper Style, WaterFlow, Clipboard, Manual Tracing</h1><h4 id="1-Conflict-when-setting-both-the-indicator-style-and-visibility-in-HarmonyOS-Swiper"><a href="#1-Conflict-when-setting-both-the-indicator-style-and-visibility-in-HarmonyOS-Swiper" class="headerlink" title="1. Conflict when setting both the indicator style and visibility in HarmonyOS Swiper?"></a>1. Conflict when setting both the indicator style and visibility in HarmonyOS Swiper?</h4><p>When setting code in Swiper to control both the visibility of the indicator and its style, it was found that the style set later would override the visibility logic. How can we achieve both?</p>
<p>Refer to the following implementation:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">.indicator( // Set the dot navigation style</span><br><span class="line">  this.data.totalCount()&gt;1?</span><br><span class="line">  new DotIndicator()</span><br><span class="line">    .itemWidth(15)</span><br><span class="line">    .itemHeight(15)</span><br><span class="line">    .selectedItemWidth(15)</span><br><span class="line">    .selectedItemHeight(15)</span><br><span class="line">    .color(Color.Gray)</span><br><span class="line">    .selectedColor(Color.Blue)</span><br><span class="line">    : false</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h4 id="2-WaterFlow-nested-in-a-List-causes-full-data-loading-in-HarmonyOS"><a href="#2-WaterFlow-nested-in-a-List-causes-full-data-loading-in-HarmonyOS" class="headerlink" title="2. WaterFlow nested in a List causes full data loading in HarmonyOS?"></a>2. WaterFlow nested in a List causes full data loading in HarmonyOS?</h4><p>It was found that nesting a WaterFlow inside a List causes all data in the WaterFlow to be loaded at once, which impacts performance.</p>
<p>If the WaterFlow does not have a height set and the parent component imposes infinite constraints in the main axis direction, the WaterFlow will adapt to the size of its child nodes, loading all data. Setting a height for the WaterFlow, such as 100%, resolves this.</p>
<h4 id="3-System-clipboard-returns-empty-data-in-HarmonyOS"><a href="#3-System-clipboard-returns-empty-data-in-HarmonyOS" class="headerlink" title="3. System clipboard returns empty data in HarmonyOS?"></a>3. System clipboard returns empty data in HarmonyOS?</h4><p>The system clipboard returns empty data.</p>
<p>Refer to this demo:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">import pasteboard from &#x27;@ohos.pasteboard&#x27;</span><br><span class="line">import promptAction from &#x27;@ohos.promptAction&#x27;</span><br><span class="line"></span><br><span class="line">@Entry</span><br><span class="line">@Component</span><br><span class="line">export struct CopyText &#123;</span><br><span class="line">  private textContent: string = &quot;Copy Me&quot;</span><br><span class="line"></span><br><span class="line">  build() &#123;</span><br><span class="line">    Column() &#123;</span><br><span class="line">      Button(this.textContent)</span><br><span class="line">        .fontSize($r(&quot;sys.float.ohos_id_text_size_body3&quot;))</span><br><span class="line">        .borderRadius(9)</span><br><span class="line">        .borderWidth(1)</span><br><span class="line">        .padding(&#123; left: 8, right:8&#125;)</span><br><span class="line">        .fontColor($r(&#x27;sys.color.ohos_id_color_text_primary&#x27;))</span><br><span class="line">        .fontWeight(FontWeight.Medium)</span><br><span class="line">        .opacity($r(&quot;sys.float.ohos_id_alpha_content_secondary&quot;))</span><br><span class="line">        .onClick(() =&gt; copyText(&quot;www.huawei.com&quot;))</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function copyText(text: string) &#123;</span><br><span class="line">  const pasteboardData = pasteboard.createData(pasteboard.MIMETYPE_TEXT_PLAIN, text)</span><br><span class="line">  const systemPasteboard = pasteboard.getSystemPasteboard()</span><br><span class="line">  systemPasteboard.setData(pasteboardData) // Place data into clipboard</span><br><span class="line">  systemPasteboard.getData().then((data) =&gt; &#123;</span><br><span class="line">    if (data) &#123;</span><br><span class="line">      promptAction.showToast(&#123; message: &quot;Copy Success&quot; &#125;)</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      promptAction.showToast(&#123; message: &quot;Copy Failed&quot; &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="4-How-to-set-custom-images-for-selected-and-unselected-states-of-Swiper-indicators-in-HarmonyOS"><a href="#4-How-to-set-custom-images-for-selected-and-unselected-states-of-Swiper-indicators-in-HarmonyOS" class="headerlink" title="4. How to set custom images for selected and unselected states of Swiper indicators in HarmonyOS?"></a>4. How to set custom images for selected and unselected states of Swiper indicators in HarmonyOS?</h4><p>How can custom images be set for the selected and unselected states of Swiper indicators?</p>
<p>Swiper’s built-in indicator does not support custom images. You can create a custom UI for the indicator and bind animations using the onAnimationStart, onAnimationEnd, and onGestureSwipe event callbacks. Alternatively, you can use third-party libraries. Refer to: <a target="_blank" rel="noopener" href="https://gitee.com/openharmony-sig/ohos_banner">https://gitee.com/openharmony-sig/ohos_banner</a></p>
<h4 id="5-How-to-manually-add-traces-to-code-in-HarmonyOS"><a href="#5-How-to-manually-add-traces-to-code-in-HarmonyOS" class="headerlink" title="5. How to manually add traces to code in HarmonyOS?"></a>5. How to manually add traces to code in HarmonyOS?</h4><p>Refer to: <a target="_blank" rel="noopener" href="https://gitee.com/openharmony/docs/blob/master/zh-cn/application-dev/dfx/hitracemeter-guidelines-arkts.md">https://gitee.com/openharmony/docs/blob/master/zh-cn/application-dev/dfx/hitracemeter-guidelines-arkts.md</a></p>
<p>HiTraceMeter provides system performance tracing APIs. Developers can effectively track process trajectories and view system performance by calling HiTraceMeter APIs at key code positions.</p>
<p><strong>HiTraceMeter Tag</strong>: The category for tracing data is called a HiTraceMeter Tag. Generally, each software subsystem corresponds to one tag. The hitrace command-line tool only collects tracing data for specified tags. The tag for HiTraceMeter in applications is HITRACE_TAG_APP, corresponding to “app” in the tag list displayed by the <code>hitrace -l</code> command.</p>
<ol>
<li>The application uses HiTraceMeter function interfaces to insert trace points. HiTraceMeter inputs tracing data into the kernel’s ftrace buffer via kernel sysfs file interfaces.</li>
<li>The hitrace command-line tool reads tracing data from the kernel ftrace buffer and outputs it to device files.</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://harmonyostech.github.io/2025/06/24/HarmonyOS-Next-Network-Packet-Capture-Configuration-Practice/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Qingkouwei">
      <meta itemprop="description" content="Welcome to the HarmonyOS NEXT Knowledge Charging Station!  This is a hub for knowledge about HarmonyOS Next`s new-generation system. With its self-developed kernel, HarmonyOS NEXT achieves native smoothness, security, intelligence, and interconnectivity. We deeply analyze how its new distributed soft bus revolutionizes device connectivity experiences and explain the principles behind the enhanced perception and reasoning capabilities of the Xiaoyi intelligent agent based on the Pangu large model. Whether you are a developer exploring application development or an ordinary user eager to understand system features, you can "recharge" here and quickly grasp the essence of HarmonyOS NEXT.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HarmonyOS NEXT Knowledge Charging Station">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/06/24/HarmonyOS-Next-Network-Packet-Capture-Configuration-Practice/" class="post-title-link" itemprop="url">HarmonyOS Next Network Packet Capture Configuration Practice</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2025-06-24 16:15:41 / Modified: 16:19:37" itemprop="dateCreated datePublished" datetime="2025-06-24T16:15:41+08:00">2025-06-24</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="HarmonyOS-Next-Network-Packet-Capture-Configuration-Practice"><a href="#HarmonyOS-Next-Network-Packet-Capture-Configuration-Practice" class="headerlink" title="HarmonyOS Next Network Packet Capture Configuration Practice"></a>HarmonyOS Next Network Packet Capture Configuration Practice</h1><h4 id="Background-Introduction"><a href="#Background-Introduction" class="headerlink" title="Background Introduction"></a>Background Introduction</h4><p>In mobile application development, packet capture is the best way to debug network requests. Charles, a mainstream packet capture tool in the market, encountered some configuration issues when debugging IM network requests due to HTTPS requests in the testing environment. This article records the entire network request packet capture configuration for HarmonyOS Next.  </p>
<h4 id="Introduction-to-Charles"><a href="#Introduction-to-Charles" class="headerlink" title="Introduction to Charles"></a>Introduction to Charles</h4><p>Charles is a network debugging and analysis proxy tool used to intercept and view communications between devices and servers. It supports monitoring network traffic of applications, modifying requests and responses, and simulating different network conditions. Key functions include:  </p>
<ul>
<li>Intercepting HTTP and HTTPS network packets.  </li>
<li>Supporting retransmission of network requests for backend debugging.  </li>
<li>Enabling modification of network request parameters.  </li>
<li>Allowing interception and dynamic modification of network requests.  </li>
<li>Simulating slow network conditions.</li>
</ul>
<p>To use Charles, configure the application’s requests to be forwarded through the Charles client proxy to the server, enabling packet capture in the Charles client. After starting Charles, it automatically sets the browser to use the proxy without additional configuration. When sending network requests via the browser, Charles directly captures request and response information.  </p>
<p>The latest version of Charles is 5.0.1, supporting packet capture on Mac, Windows, and Linux systems:<br><img src="/../images/HarmonyOS%20Next%E7%BD%91%E7%BB%9C%E6%8A%93%E5%8C%85%E9%85%8D%E7%BD%AE%E5%AE%9E%E8%B7%B5.png" alt="Charles运行界面">  </p>
<h4 id="Charles-Installation"><a href="#Charles-Installation" class="headerlink" title="Charles Installation"></a>Charles Installation</h4><p>Charles installation address: <a target="_blank" rel="noopener" href="https://www.charlesproxy.com/">https://www.charlesproxy.com/</a><br><img src="/../images/HarmonyOS%20Next%E7%BD%91%E7%BB%9C%E6%8A%93%E5%8C%85%E9%85%8D%E7%BD%AE%E5%AE%9E%E8%B7%B5-1.png" alt="Charles下载页面">  </p>
<h4 id="Charles-Usage-Steps"><a href="#Charles-Usage-Steps" class="headerlink" title="Charles Usage Steps"></a>Charles Usage Steps</h4><p><strong>Device proxy settings after installation:</strong>  </p>
<ol>
<li><p><strong>View Charles IP address</strong> (typically the same as the PC host IP):  </p>
<ul>
<li>For Charles IP: Click <strong>Help</strong> → <strong>Local IP Address</strong>.  </li>
<li>For PC IP (Windows): Open “Run” (Win+R or search in the taskbar), enter “cmd” to open the command line, then type “ipconfig”.  </li>
<li>For Mac: Obtain from Network Settings.<br><img src="/../images/HarmonyOS%20Next%E7%BD%91%E7%BB%9C%E6%8A%93%E5%8C%85%E9%85%8D%E7%BD%AE%E5%AE%9E%E8%B7%B5-2.png" alt="查看Charles IP地址"></li>
</ul>
</li>
<li><p><strong>Set Charles debugging port number:</strong>  </p>
<ul>
<li>Click <strong>Proxy</strong> → <strong>SSL Proxy Settings</strong> → Click “Add” under Include → Add <code>“*:*”</code> (Host: <code>“*”</code>, Port: <code>“*”</code>) and <code>“*:443”</code> (Host: <code>“*”</code>, Port: <code>443</code>) → Click “OK”.<br><img src="/../images/HarmonyOS%20Next%E7%BD%91%E7%BB%9C%E6%8A%93%E5%8C%85%E9%85%8D%E7%BD%AE%E5%AE%9E%E8%B7%B5-3.png" alt="SSL代理设置">  </li>
<li>Click <strong>Proxy</strong> → <strong>Proxy Settings</strong> → Set “Port” under “HTTP Proxy” (default: 8888) → Check “Enable transparent HTTP proxying” → Click “OK”.<br><img src="/../images/HarmonyOS%20Next%E7%BD%91%E7%BB%9C%E6%8A%93%E5%8C%85%E9%85%8D%E7%BD%AE%E5%AE%9E%E8%B7%B5-4.png" alt="HTTP代理设置"></li>
</ul>
</li>
<li><p><strong>Connect the phone and PC to the same LAN</strong> and set Wi-Fi to manual proxy with Charles’ IP and port:  </p>
<ul>
<li>On the phone, enter the Wi-Fi password page, click “Proxy” before inputting the password, select “Manual”, set “Proxy server hostname” to Charles’ IP and “Server port” to 8888, then connect to Wi-Fi.</li>
</ul>
</li>
</ol>
<p>At this point, HTTP packets can be captured normally. To capture HTTPS packets, continue with certificate configuration.  </p>
<h4 id="Certificate-Installation"><a href="#Certificate-Installation" class="headerlink" title="Certificate Installation"></a>Certificate Installation</h4><p><strong>Install Charles root certificate into the PC trust directory:</strong>  </p>
<ul>
<li><p>Click <strong>Help</strong> → <strong>SSL Proxying</strong> → <strong>Install Charles Root Certificate</strong> → Click “Install Certificate” → Select storage location (current user or local computer) → Click “Next” → Select “Place all certificates in the following store” → Click “Browse” → Set the certificate storage path to “Trusted Root Certification Authorities”.<br><img src="/../images/HarmonyOS%20Next%E7%BD%91%E7%BB%9C%E6%8A%93%E5%8C%85%E9%85%8D%E7%BD%AE%E5%AE%9E%E8%B7%B5-5.png" alt="PC证书安装步骤">  </p>
</li>
<li><p>Double-click the certificate, select “Trust” and “Always trust”:<br><img src="/../images/HarmonyOS%20Next%E7%BD%91%E7%BB%9C%E6%8A%93%E5%8C%85%E9%85%8D%E7%BD%AE%E5%AE%9E%E8%B7%B5-6.png" alt="证书信任设置"></p>
</li>
</ul>
<p><strong>Import the system root certificate to the phone:</strong><br><strong>Method 1:</strong>  </p>
<ul>
<li>Click <strong>Help</strong> → <strong>SSL Proxying</strong> → <strong>Install Charles Root Certificate on a Mobile Device or Remote Browser</strong> → Access <a target="_blank" rel="noopener" href="http://chls.pro/ssl">http://chls.pro/ssl</a> on the phone’s browser → Click “Download Now” to save the certificate to the phone memory.<br><img src="/../images/HarmonyOS%20Next%E7%BD%91%E7%BB%9C%E6%8A%93%E5%8C%85%E9%85%8D%E7%BD%AE%E5%AE%9E%E8%B7%B5-7.png" alt="手机证书下载页面"></li>
</ul>
<p><strong>Method 2:</strong>  </p>
<ul>
<li>On PC, click <strong>Help</strong> → <strong>SSL Proxying</strong> → <strong>Save Charles Root Certificate…</strong> to save the certificate locally as a PEM file. Connect the phone to the PC, upload the PEM file to the phone via DevEco (right-click the target folder, select “Upload…”, then choose the PEM file).<br><img src="/../images/HarmonyOS%20Next%E7%BD%91%E7%BB%9C%E6%8A%93%E5%8C%85%E9%85%8D%E7%BD%AE%E5%AE%9E%E8%B7%B5-8.png" alt="证书文件保存界面"></li>
</ul>
<p><strong>Certificate installation steps on the phone:</strong>  </p>
<ul>
<li>Go to <strong>Settings</strong> → <strong>Privacy &amp; Security</strong> → Scroll down to click “Advanced” → Select “Certificates &amp; Credentials” → Enter certificate installation options → Choose “Install from storage device” → Click “CA Certificates” → Click “Continue” → Browse to the downloaded certificate location → Select the certificate → Confirm “Certificate installed successfully”.<br><img src="/../images/HarmonyOS%20Next%E7%BD%91%E7%BB%9C%E6%8A%93%E5%8C%85%E9%85%8D%E7%BD%AE%E5%AE%9E%E8%B7%B5-9.png" alt="手机证书安装操作界面"><br><img src="/../images/HarmonyOS%20Next%E7%BD%91%E7%BB%9C%E6%8A%93%E5%8C%85%E9%85%8D%E7%BD%AE%E5%AE%9E%E8%B7%B5-10.png" alt="证书安装成功提示"></li>
</ul>
<p>HTTPS network requests can now be captured normally. If issues persist, restart Charles and retry.  </p>
<blockquote>
<p><strong>Notes:</strong>  </p>
<ol>
<li>When configuring the environment, select “Allow” in Charles’ pop-up window to ensure connection with the phone.  </li>
<li>CRT format certificates are not supported; convert them to PEM format.</li>
</ol>
</blockquote>
<h4 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h4><p>This article introduces capturing mobile network requests (including HTTP and HTTPS) via Charles on HarmonyOS Next, detailing SSL certificate installation steps and best practices.  </p>
<p>##HarmonyOS Core Technology##HarmonyOS Development Tools##DevEco Studio##<br>##Social##</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://harmonyostech.github.io/2025/06/24/HarmonyOS-Next-IM-Combat-Best-Practices-for-PushKit-in-Assisting-IM-Message-Notification-Scenarios/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Qingkouwei">
      <meta itemprop="description" content="Welcome to the HarmonyOS NEXT Knowledge Charging Station!  This is a hub for knowledge about HarmonyOS Next`s new-generation system. With its self-developed kernel, HarmonyOS NEXT achieves native smoothness, security, intelligence, and interconnectivity. We deeply analyze how its new distributed soft bus revolutionizes device connectivity experiences and explain the principles behind the enhanced perception and reasoning capabilities of the Xiaoyi intelligent agent based on the Pangu large model. Whether you are a developer exploring application development or an ordinary user eager to understand system features, you can "recharge" here and quickly grasp the essence of HarmonyOS NEXT.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HarmonyOS NEXT Knowledge Charging Station">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/06/24/HarmonyOS-Next-IM-Combat-Best-Practices-for-PushKit-in-Assisting-IM-Message-Notification-Scenarios/" class="post-title-link" itemprop="url">HarmonyOS Next IM Combat: Best Practices for PushKit in Assisting IM Message Notification Scenarios</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2025-06-24 15:09:57 / Modified: 16:09:47" itemprop="dateCreated datePublished" datetime="2025-06-24T15:09:57+08:00">2025-06-24</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="HarmonyOS-Next-IM-Combat-Best-Practices-for-PushKit-in-Assisting-IM-Message-Notification-Scenarios"><a href="#HarmonyOS-Next-IM-Combat-Best-Practices-for-PushKit-in-Assisting-IM-Message-Notification-Scenarios" class="headerlink" title="HarmonyOS Next IM Combat: Best Practices for PushKit in Assisting IM Message Notification Scenarios"></a>HarmonyOS Next IM Combat: Best Practices for PushKit in Assisting IM Message Notification Scenarios</h1><h4 id="Background-Introduction"><a href="#Background-Introduction" class="headerlink" title="Background Introduction"></a>Background Introduction</h4><p>In IM development, besides sending and receiving messages, message reminders constitute a crucial component. In the traditional Android era, with no access to GMS in China, developers explored various keep-alive solutions to prevent apps from being killed in the background and enable continuous message reception. As Android systems evolved, these keep-alive methods were gradually blocked by the system, while manufacturers introduced system Push services, allowing apps to receive messages even when closed.  </p>
<p>In the HarmonyOS Next system, similar to iOS, apps are not allowed to stay alive indefinitely. However, the system provides a PushKit notification service, enabling apps to apply for integration with PushKit to implement message pushing.  </p>
<h4 id="Introduction-to-HarmonyOS-Next-System-Push-Status"><a href="#Introduction-to-HarmonyOS-Next-System-Push-Status" class="headerlink" title="Introduction to HarmonyOS Next System Push Status"></a>Introduction to HarmonyOS Next System Push Status</h4><p>PushKit (Push Service) is a message pushing platform provided by Huawei, establishing a message push channel from the cloud to the terminal. All HarmonyOS apps can integrate PushKit to push real-time messages, making messages visible, building good user relationships, and enhancing user awareness and activity. Display scenarios mainly include the notification center, lock screen, banners, desktop icon badges, and notification icons.<br><img src="/../images/HarmonyOS%20Next%20IM%E5%AE%9E%E6%88%98%EF%BC%9APushKit%E5%9C%A8%E8%BE%85%E5%8A%A9IM%E6%B6%88%E6%81%AF%E9%80%9A%E7%9F%A5%E5%9C%BA%E6%99%AF%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5.png" alt="text"></p>
<p>PushKit supports not only notification messages but also authorized subscription messages, notification extension messages, card refresh messages, background messages, live window messages, in-app call messages, etc.  </p>
<p>PushKit offers three key advantages:  </p>
<ul>
<li><strong>Stable message sending channel</strong>: PushKit provides a system-level long connection, enabling real-time message pushing even when the app process is inactive.  </li>
<li><strong>Rich message presentation styles</strong>: Supports multiple display modes such as text, notification large icons, multi-line text, and badge styles to meet diverse and personalized message sending needs.  </li>
<li><strong>Flexible scenario-based messages</strong>: Developers can flexibly integrate scenario-based messages according to actual needs. For example, implement audio&#x2F;video calls via in-app call messages, voice broadcasting via notification extension messages, and configuration updates via background messages.</li>
</ul>
<p>The overall usage process is as follows:<br><img src="/../images/HarmonyOS%20Next%20IM%E5%AE%9E%E6%88%98%EF%BC%9APushKit%E5%9C%A8%E8%BE%85%E5%8A%A9IM%E6%B6%88%E6%81%AF%E9%80%9A%E7%9F%A5%E5%9C%BA%E6%99%AF%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5-1.png" alt="text"></p>
<ol>
<li>The app calls PushKit to obtain a Push Token.  </li>
<li>After successfully acquiring the Token, the app should promptly report the Token and other information to the app server.  </li>
<li>The app server sends a push message request to Huawei’s PushKit server (Push Cloud). The app’s notification switch is closed by default; request notification authorization before sending the request.  </li>
<li>The PushKit server delivers the message to PushKit.  </li>
<li>PushKit processes the message.</li>
</ol>
<p>Despite PushKit’s powerful capabilities and effects, a challenge arises in IM scenarios: when chatting with a specific user, new messages from that user should not trigger notifications, while notifications should function normally otherwise.  </p>
<p>In iOS, PushKit allows apps to intervene in notification display when active. When in the foreground, the app can determine if it is on the chat page and if the message is from the corresponding user, preventing continuous notifications during active chat. HarmonyOS does not provide this capability directly, but it offers a way to handle notification messages when the app is in the foreground. The server can call the REST API to push notification messages with a <code>foregroundShow</code> field set to <code>false</code> in the message body (default is <code>true</code>, meaning display in both foreground and background), which prevents notification display when the app is in the foreground:  </p>
<pre><code class="language-json">// Request Body
&#123;
  &quot;payload&quot;: &#123;
    &quot;notification&quot;: &#123;
      &quot;category&quot;: &quot;MARKETING&quot;,
      &quot;title&quot;: &quot;普通通知标题&quot;,
      &quot;body&quot;: &quot;普通通知内容&quot;,
      &quot;profileId&quot;: &quot;111***222&quot;,
      &quot;clickAction&quot;: &#123;
        &quot;actionType&quot;: 0
      &#125;,
      &quot;foregroundShow&quot;: false  // Set to false to disable notification display when the app is in the foreground
    &#125;
  &#125;,
  &quot;target&quot;: &#123;
    &quot;token&quot;: [&quot;IQAAAA**********4Tw&quot;]
  &#125;
&#125;
</code></pre>
<p>In the client project’s <strong>src&#x2F;main&#x2F;module.json5</strong> file, configure the <code>actions</code> attribute in the <code>skills</code> tag of the corresponding Ability (e.g., <code>PushMessageAbility</code>) as <strong>action.ohos.push.listener</strong> (only one Ability in the project should define this action):  </p>
<pre><code class="language-json">&#123;
  &quot;name&quot;: &quot;PushMessageAbility&quot;,
  &quot;srcEntry&quot;: &quot;./ets/abilities/PushMessageAbility.ets&quot;,
  &quot;launchType&quot;: &quot;singleton&quot;,
  &quot;startWindowIcon&quot;: &quot;$media:startIcon&quot;,
  &quot;startWindowBackground&quot;: &quot;$color:start_window_background&quot;,
  &quot;exported&quot;: false,
  &quot;skills&quot;: [
    &#123;
      &quot;actions&quot;: [
        &quot;action.ohos.push.listener&quot;
      ]
    &#125;
  ]
&#125;
</code></pre>
<p>In the existing <code>UIAbility</code> class of the client project (e.g., <code>PushMessageAbility</code>), use the <code>receiveMessage()</code> method in <code>onCreate()</code> with <code>PushType</code> as “DEFAULT” to receive notification messages when the app is in the foreground. Sample code:  </p>
<pre><code class="language-typescript">import &#123; UIAbility &#125; from &#39;@kit.AbilityKit&#39;;
import &#123; pushService &#125; from &#39;@kit.PushKit&#39;;
import &#123; BusinessError &#125; from &#39;@kit.BasicServicesKit&#39;;
import &#123; hilog &#125; from &#39;@kit.PerformanceAnalysisKit&#39;;


/**
 * Example of PushMessageAbility for receiving notification messages when the app is in the foreground
 */
export default class PushMessageAbility extends UIAbility &#123;
  onCreate(): void &#123;
    try &#123;
      // The parameter in receiveMessage is fixed as DEFAULT
      pushService.receiveMessage(&#39;DEFAULT&#39;, this, (payload) =&gt; &#123;
        try &#123;
          // Get data passed from the server
          const data: string = payload.data;
          // TODO: Custom business processing
          hilog.info(0x0000, &#39;testTag&#39;, &#39;Succeeded in getting notification,data=%&#123;public&#125;s&#39;,
            JSON.stringify(JSON.parse(data)?.notification));
        &#125; catch (e) &#123;
          let errRes: BusinessError = e as BusinessError;
          hilog.error(0x0000, &#39;testTag&#39;, &#39;Failed to process data: %&#123;public&#125;d %&#123;public&#125;s&#39;,
            errRes.code, errRes.message);
        &#125;
      &#125;);
    &#125; catch (err) &#123;
      let e: BusinessError = err as BusinessError;
      hilog.error(0x0000, &#39;testTag&#39;, &#39;Failed to get message: %&#123;public&#125;d %&#123;public&#125;s&#39;, e.code,
        e.message);
    &#125;
  &#125;
&#125;
</code></pre>
<p>WeChat currently employs this solution: notifications are displayed normally when the app is in the background, while only a subtle vibration is triggered in the foreground. However, in scenarios like official account pages, mini-programs, or video channels, message awareness is insufficient, increasing the risk of missed messages.  </p>
<p><strong>Note</strong>: Ensure correct configuration of <code>action.ohos.push.listener</code>. During development, multi-channel packages with this action only configured in the default <code>module.json5</code> may fail to receive foreground notifications.  </p>
<h4 id="Solution-Introduction"><a href="#Solution-Introduction" class="headerlink" title="Solution Introduction"></a>Solution Introduction</h4><p>Completely disabling foreground notifications via PushKit risks missed messages, yielding suboptimal results. HarmonyOS Next provides Notification Kit (User Notification Service), which offers a local notification publishing channel for developers. Notification Kit allows apps to push notifications directly to users locally when running in the foreground. When the app moves to the background, the local notification channel closes, and PushKit is used for cloud-side offline notification publishing. Local notification capabilities can be applied in various scenarios, such as syncing upload&#x2F;download progress, publishing instant customer service payment notifications, and updating step counts.  </p>
<p>Notification Kit supports the following key capabilities:  </p>
<ul>
<li>Publish text, progress bar, and other notification types.  </li>
<li>Carry or update app notification badge counts.  </li>
<li>Cancel specific or all previously published notifications.  </li>
<li>Query the list of published notifications.  </li>
<li>Query the app’s own notification switch status.  </li>
<li>The app’s notification capability is off by default; developers can trigger an authorization dialog to request user permission.</li>
</ul>
<p>The overall usage process is as follows:<br><img src="/../images/HarmonyOS%20Next%20IM%E5%AE%9E%E6%88%98%EF%BC%9APushKit%E5%9C%A8%E8%BE%85%E5%8A%A9IM%E6%B6%88%E6%81%AF%E9%80%9A%E7%9F%A5%E5%9C%BA%E6%99%AF%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5-2.png" alt="text"><br>Here is a simple example of publishing a text notification:  </p>
<pre><code class="language-typescript">let notificationRequest: notificationManager.NotificationRequest = &#123;
  id: 1,
  content: &#123;
    notificationContentType: notificationManager.ContentType.NOTIFICATION_CONTENT_BASIC_TEXT, // Basic text notification type
    normal: &#123;
      title: &#39;test_title&#39;,
      text: &#39;test_text&#39;,
      additionalText: &#39;test_additionalText&#39;,
    &#125;
  &#125;
&#125;;
notificationManager.publish(notificationRequest, (err: BusinessError) =&gt; &#123;
  if (err) &#123;
    hilog.error(DOMAIN_NUMBER, TAG, `Failed to publish notification. Code is $&#123;err.code&#125;, message is $&#123;err.message&#125;`);
    return;
  &#125;
  hilog.info(DOMAIN_NUMBER, TAG, &#39;Succeeded in publishing notification.&#39;);
&#125;);
</code></pre>
<p>For detailed explanations of <code>NotificationRequest</code>, refer to: <a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-inner-notification-notificationrequest#notificationrequest">https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-inner-notification-notificationrequest#notificationrequest</a>  </p>
<p>The <code>sound</code> field is also supported, but the specified file must be placed in the <code>resources/rawfile</code> directory, supporting formats like m4a, aac, mp3, ogg, wav, flac, and amr. This field only takes effect after the app applies for and obtains the notification custom ringtone privilege. Currently, this field works in PushKit but not in Notification Kit, an issue under investigation.  </p>
<p>The notification ID defaults to 0. When the same ID exists, the notification content is updated. This allows updating effects and list displays using conversation IDs or message IDs.  </p>
<p>The <code>wantAgent</code> field can specify the notification click jump logic. Notifications can be canceled via <code>notificationManager.cancel</code>, either for a specific ID or all notifications.  </p>
<h4 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h4><p>In HarmonyOS Next’s IM message notification scenarios, PushKit provides stable cloud-side pushing capabilities, but by default, it cannot distinguish between foreground and background states, causing frequent notifications on chat pages that degrade user experience. While <code>foregroundShow: false</code> can disable foreground notifications, it weakens message awareness. By combining PushKit with Notification Kit’s local notification capabilities, a more refined message reminder strategy is achieved: <strong>background messages are pushed via PushKit to ensure delivery, while foreground messages are triggered on demand via Notification Kit (e.g., for non-chat page reminders)</strong>, balancing message reach and user experience. This hybrid solution leverages the reliability of system-level pushing and implements scenario-based notification control through client-side logic, representing the best practice for IM app message notifications on HarmonyOS Next. Developers must pay attention to permission configuration, lifecycle management, and multi-module collaboration (e.g., ensuring correct declaration of <code>action.ohos.push.listener</code>) to fully leverage the advantages of dual-channel notifications.</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://harmonyostech.github.io/2025/06/24/HarmonyOS%20Next%20IM%20Combat:%20Functional%20Anomaly%20of%20Event%20Cancellation%20Caused%20by%20Dual%20Navigation%20Lifecycles/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Qingkouwei">
      <meta itemprop="description" content="Welcome to the HarmonyOS NEXT Knowledge Charging Station!  This is a hub for knowledge about HarmonyOS Next`s new-generation system. With its self-developed kernel, HarmonyOS NEXT achieves native smoothness, security, intelligence, and interconnectivity. We deeply analyze how its new distributed soft bus revolutionizes device connectivity experiences and explain the principles behind the enhanced perception and reasoning capabilities of the Xiaoyi intelligent agent based on the Pangu large model. Whether you are a developer exploring application development or an ordinary user eager to understand system features, you can "recharge" here and quickly grasp the essence of HarmonyOS NEXT.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HarmonyOS NEXT Knowledge Charging Station">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/06/24/HarmonyOS%20Next%20IM%20Combat:%20Functional%20Anomaly%20of%20Event%20Cancellation%20Caused%20by%20Dual%20Navigation%20Lifecycles/" class="post-title-link" itemprop="url">HarmonyOS Next IM Combat: Functional Anomaly of Event Cancellation Caused by Dual Navigation Lifecycles</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2025-06-24 15:09:32 / Modified: 16:09:29" itemprop="dateCreated datePublished" datetime="2025-06-24T15:09:32+08:00">2025-06-24</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="HarmonyOS-Next-IM-Combat-Functional-Anomaly-of-Event-Cancellation-Caused-by-Dual-Navigation-Lifecycles"><a href="#HarmonyOS-Next-IM-Combat-Functional-Anomaly-of-Event-Cancellation-Caused-by-Dual-Navigation-Lifecycles" class="headerlink" title="HarmonyOS Next IM Combat: Functional Anomaly of Event Cancellation Caused by Dual Navigation Lifecycles"></a>HarmonyOS Next IM Combat: Functional Anomaly of Event Cancellation Caused by Dual Navigation Lifecycles</h1><h4 id="Background-Introduction"><a href="#Background-Introduction" class="headerlink" title="Background Introduction"></a>Background Introduction</h4><p>Users of the IM application’s chat page reported being unable to view large images by clicking on them. Code review showed that the large image click used the <code>ohos.events.emitter</code> event mechanism. Further investigation revealed that events were emitted but not consumed. Logs indicated successful event registration, but no event reception.  </p>
<h4 id="Problem-Diagnosis"><a href="#Problem-Diagnosis" class="headerlink" title="Problem Diagnosis"></a>Problem Diagnosis</h4><p>Further analysis showed the issue consistently occurred when cold-starting the app by clicking a notification, while hot-starting via a push notification worked normally. Both company apps integrated HarmonyOS’s PushKit to receive notifications when backgrounded or closed, but only one exhibited the problem.  </p>
<p>Log analysis revealed that cold-starting the app from a notification and entering the chat page triggered one <code>aboutToAppear</code> and one proactive <code>aboutToDisappear</code> in the chat page. Further inspection showed the chat page’s lifecycle was executed twice: Chat Page 1 <code>aboutToAppear</code> → Chat Page 2 <code>aboutToAppear</code> → Chat Page 2 <code>aboutToDisappear</code>.  </p>
<p>Initially suspected to relate to PushKit, the hypothesis was dismissed when the other app functioned normally. Clicking a notification triggers navigation to the chat page via <code>onNewWant</code>. Expert consultation suggested the issue might stem from multiple <code>Navigation</code> instances in the app.  </p>
<p>Code review revealed that after a cold start, the app did not immediately navigate to the chat page in <code>onNewWant</code> but waited for the home page to load, then navigated to the chat page in the home page’s <code>aboutToAppear</code>. The app loads a splash screen in <code>onWindowStageCreate</code>, navigates from the splash screen’s <code>aboutToAppear</code> to the home page, and then from the home page’s <code>aboutToAppear</code> to the chat page. The splash screen and home page are two <code>Navigation</code> instances sharing a <code>NavPathStack</code>.  </p>
<p>Understanding <code>Navigation</code> lifecycles: As a routing container, <code>Navigation</code> lifecycles are hosted on <code>NavDestination</code> components, exposed as component events. Lifecycles fall into three categories: custom component lifecycles, universal component lifecycles, and proprietary lifecycles. <code>aboutToAppear</code> and <code>aboutToDisappear</code> are custom component lifecycles (for the custom component wrapping <code>NavDestination</code>), while <code>onAppear</code> and <code>onDisappear</code> are universal component lifecycles. The remaining lifecycles are unique to <code>NavDestination</code>.  </p>
<p>Lifecycle timeline:<br><img src="/../images/HarmonyOS%20Next%20IM%E5%AE%9E%E6%88%98%EF%BC%9A%E5%8F%8CNavigation%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E5%BC%95%E8%B5%B7%E7%9A%84%E4%BA%8B%E4%BB%B6%E8%A2%AB%E5%8F%96%E6%B6%88%E5%8A%9F%E8%83%BD%E5%BC%82%E5%B8%B8%E9%97%AE%E9%A2%98.png" alt="text"></p>
<ul>
<li><strong>aboutToAppear</strong>: Executed after creating a custom component and before its <code>build()</code> function (before <code>NavDestination</code> creation). Allows modifying state variables, which take effect in the subsequent <code>build()</code> execution.  </li>
<li><strong>onWillAppear</strong>: Executed after <code>NavDestination</code> creation and before mounting to the component tree. State changes here take effect in the current frame.  </li>
<li><strong>onAppear</strong>: Universal lifecycle event triggered when <code>NavDestination</code> mounts to the component tree.  </li>
<li><strong>onWillShow</strong>: Executed before <code>NavDestination</code> is layout-displayed (not triggered when the app switches to the foreground).  </li>
<li><strong>onShown</strong>: Executed after <code>NavDestination</code> is layout-displayed, indicating layout completion.  </li>
<li><strong>onActive</strong>: Triggered when <code>NavDestination</code> is active (at the stack top and operable, with no special components obscuring it).  </li>
<li><strong>onWillHide</strong>: Executed before <code>NavDestination</code> is hidden (not triggered when the app switches to the background).  </li>
<li><strong>onInactive</strong>: Triggered when <code>NavDestination</code> is inactive (not at the stack top or obscured by special components when at the stack top).  </li>
<li><strong>onHidden</strong>: Executed after <code>NavDestination</code> is hidden (when a new page is pushed, the top page is popped, or the app switches to the background).  </li>
<li><strong>onWillDisappear</strong>: Executed before <code>NavDestination</code> is destroyed. If there is a transition animation, it triggers before the animation (when the top page is popped).  </li>
<li><strong>onDisappear</strong>: Universal lifecycle event triggered when <code>NavDestination</code> is unmounted and destroyed from the component tree.  </li>
<li><strong>aboutToDisappear</strong>: Executed before a custom component is destructed; state variable modifications are prohibited.</li>
</ul>
<p>The lifecycle when navigating from Page A to Page B is: A <code>aboutToAppear</code> → B <code>aboutToAppear</code> → A <code>aboutToDisappear</code>.  </p>
<p>The root cause was identified: When navigating to the chat page in the home page’s <code>aboutToAppear</code>, the splash screen’s <code>aboutToDisappear</code> had not completed, leaving both <code>Navigation</code> instances active. This caused the chat page to execute <code>aboutToAppear</code> twice. After the splash screen’s <code>aboutToDisappear</code>, the second chat page instance was automatically <code>aboutToDisappear</code>ed, canceling event subscriptions.  </p>
<h4 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h4><p>After identifying the problem, the fix involved adding a 20ms delay to the chat page navigation, resolving the issue. A more elegant solution is to navigate to the chat page after the splash screen’s <code>aboutDisappear</code> or modify the splash screen to a non-<code>Navigation</code> structure.  </p>
<h4 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h4><p>Step-by-step troubleshooting revealed the root cause: Cold-starting the app with two <code>Navigation</code> components (splash screen and home page) sharing a <code>NavPathStack</code> caused the chat page to be repeatedly created and destroyed when navigating from the home page’s <code>aboutToAppear</code> before the splash screen’s <code>aboutToDisappear</code> completed. This invalidated event subscriptions (as the second page instance did not register event consumption logic). Solutions include delaying navigation, adjusting navigation timing until the splash screen is destroyed, or restructuring the splash screen as a non-<code>Navigation</code> to eliminate multi-<code>Navigation</code> coexistence. This case highlights the complexity of <code>Navigation</code> lifecycle management in HarmonyOS, emphasizing the need to strictly follow component mounting&#x2F;unmounting order in multi-page navigation to avoid lifecycle conflicts.  </p>
<blockquote>
<p>Reference: Component Navigation (Navigation) (Recommended): <a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-navigation-navigation#%E9%A1%B5%E9%9D%A2%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F">https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-navigation-navigation#%E9%A1%B5%E9%9D%A2%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F</a>  </p>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://harmonyostech.github.io/2025/06/24/HarmonyOS%20Next%20IM%20Combat:%20Sharing%20the%20Optimization%20Process%20for%20Slow%20Database%20Queries/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Qingkouwei">
      <meta itemprop="description" content="Welcome to the HarmonyOS NEXT Knowledge Charging Station!  This is a hub for knowledge about HarmonyOS Next`s new-generation system. With its self-developed kernel, HarmonyOS NEXT achieves native smoothness, security, intelligence, and interconnectivity. We deeply analyze how its new distributed soft bus revolutionizes device connectivity experiences and explain the principles behind the enhanced perception and reasoning capabilities of the Xiaoyi intelligent agent based on the Pangu large model. Whether you are a developer exploring application development or an ordinary user eager to understand system features, you can "recharge" here and quickly grasp the essence of HarmonyOS NEXT.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HarmonyOS NEXT Knowledge Charging Station">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/06/24/HarmonyOS%20Next%20IM%20Combat:%20Sharing%20the%20Optimization%20Process%20for%20Slow%20Database%20Queries/" class="post-title-link" itemprop="url">HarmonyOS Next IM Combat: Sharing the Optimization Process for Slow Database Queries</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2025-06-24 14:09:32 / Modified: 15:03:00" itemprop="dateCreated datePublished" datetime="2025-06-24T14:09:32+08:00">2025-06-24</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="HarmonyOS-Next-IM-Combat-Sharing-the-Optimization-Process-for-Slow-Database-Queries"><a href="#HarmonyOS-Next-IM-Combat-Sharing-the-Optimization-Process-for-Slow-Database-Queries" class="headerlink" title="HarmonyOS Next IM Combat: Sharing the Optimization Process for Slow Database Queries"></a>HarmonyOS Next IM Combat: Sharing the Optimization Process for Slow Database Queries</h1><h4 id="1-Background-Introduction"><a href="#1-Background-Introduction" class="headerlink" title="1. Background Introduction"></a>1. Background Introduction</h4><p>In the development of IMSDK, the client uses a relational database to store data such as conversations, users, and messages. Initially, when developing consumer (C-end) applications, no issues were found. However, this year, when business (B-end) users started using the application, they reported lags and message delays. Through troubleshooting, it was found that B-end users have more conversations and messages, leading to slower database queries. Since previous operations were all performed on the main thread, this caused application lags and delays. This article shares the problems encountered during the entire optimization process, problem-solving approaches, and final effects.  </p>
<h4 id="2-Introduction-to-HarmonyOS-Next-Relational-Database"><a href="#2-Introduction-to-HarmonyOS-Next-Relational-Database" class="headerlink" title="2. Introduction to HarmonyOS Next Relational Database"></a>2. Introduction to HarmonyOS Next Relational Database</h4><p>The HarmonyOS Next relational database is based on the SQLite component, suitable for scenarios requiring storage of data with complex relationships. For example, a user’s conversation information needs to include the conversation name, type, ID, etc., while chat information in conversations needs to include message IDs, types, contents, etc. Due to the strong correspondence between data elements—with complexity higher than key-value data—a relational database is required for persistent storage.  </p>
<p>The relational database provides universal operation interfaces for applications, using SQLite as the underlying persistent storage engine. It supports database features of SQLite, including but not limited to transactions, indexes, views, triggers, foreign keys, parameterized queries, and precompiled SQL statements.  </p>
<p>To implement data persistence using a relational database, a RdbStore must be obtained, which includes operations such as database creation, table creation, and version upgrades&#x2F;downgrades. Sample code is as follows:  </p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; relationalStore &#125; <span class="keyword">from</span> <span class="string">&#x27;@kit.ArkData&#x27;</span>; <span class="comment">// Import the module</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">UIAbility</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@kit.AbilityKit&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">BusinessError</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@kit.BasicServicesKit&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="variable language_">window</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@kit.ArkUI&#x27;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// This example is implemented in an Ability, but users can also use it in other reasonable scenarios</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">EntryAbility</span> <span class="keyword">extends</span> <span class="title class_ inherited__">UIAbility</span> &#123;</span><br><span class="line">  <span class="title function_">onWindowStageCreate</span>(<span class="params"><span class="attr">windowStage</span>: <span class="variable language_">window</span>.<span class="title class_">WindowStage</span></span>) &#123;</span><br><span class="line">    <span class="comment">// If a tokenizer is desired, call isStorageTypeSupported to check if the desired tokenizer is supported on the current platform.</span></span><br><span class="line">    <span class="keyword">let</span> tokenType = relationalStore.<span class="property">Tokenizer</span>.<span class="property">ICU_TOKENIZER</span>;</span><br><span class="line">    <span class="keyword">let</span> tokenTypeSupported = relationalStore.<span class="title function_">isTokenizerSupported</span>(tokenType);</span><br><span class="line">    <span class="keyword">if</span> (!tokenTypeSupported) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">`ICU_TOKENIZER is not supported on this platform.`</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> <span class="attr">STORE_CONFIG</span>: relationalStore.<span class="property">StoreConfig</span> = &#123;</span><br><span class="line">      <span class="attr">name</span>: <span class="string">&#x27;RdbTest.db&#x27;</span>, <span class="comment">// Database file name</span></span><br><span class="line">      <span class="attr">securityLevel</span>: relationalStore.<span class="property">SecurityLevel</span>.<span class="property">S3</span>, <span class="comment">// Database security level</span></span><br><span class="line">      <span class="attr">encrypt</span>: <span class="literal">false</span>, <span class="comment">// Optional parameter to specify if the database is encrypted (default: not encrypted)</span></span><br><span class="line">      <span class="attr">customDir</span>: <span class="string">&#x27;customDir/subCustomDir&#x27;</span>, <span class="comment">// Optional parameter for the database custom path. The database will be created in the directory structure: context.databaseDir + &#x27;/rdb/&#x27; + customDir, where context.databaseDir is the app sandbox path, &#x27;/rdb/&#x27; indicates a relational database, and customDir is the custom path. If this parameter is not provided, the RdbStore instance is created in the app sandbox directory by default.</span></span><br><span class="line">      <span class="attr">isReadOnly</span>: <span class="literal">false</span>, <span class="comment">// Optional parameter to specify if the database is opened in read-only mode (default: false, readable and writable). When true, only data reading is allowed; write operations will return error code 801.</span></span><br><span class="line">      <span class="attr">tokenizer</span>: tokenType <span class="comment">// Optional parameter to specify the tokenizer used in full-text search (FTS) scenarios. If not provided, only English tokenization is supported in FTS, not other languages.</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Determine the database version and perform upgrade/downgrade operations if it does not match</span></span><br><span class="line">    <span class="comment">// Assume the current database version is 3, with table structure: EMPLOYEE (NAME, AGE, SALARY, CODES, IDENTITY)</span></span><br><span class="line">    <span class="keyword">const</span> <span class="variable constant_">SQL_CREATE_TABLE</span> = <span class="string">&#x27;CREATE TABLE IF NOT EXISTS EMPLOYEE (ID INTEGER PRIMARY KEY AUTOINCREMENT, NAME TEXT NOT NULL, AGE INTEGER, SALARY REAL, CODES BLOB, IDENTITY UNLIMITED INT)&#x27;</span>; <span class="comment">// Table creation SQL statement, where IDENTITY is a bigint type specified as UNLIMITED INT in SQL</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    relationalStore.<span class="title function_">getRdbStore</span>(<span class="variable language_">this</span>.<span class="property">context</span>, <span class="variable constant_">STORE_CONFIG</span>, <span class="function">(<span class="params">err, store</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (err) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">`Failed to get RdbStore. Code:<span class="subst">$&#123;err.code&#125;</span>, message:<span class="subst">$&#123;err.message&#125;</span>`</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">info</span>(<span class="string">&#x27;Succeeded in getting RdbStore.&#x27;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">      <span class="comment">// When the database is created, the default version is 0</span></span><br><span class="line">      <span class="keyword">if</span> (store.<span class="property">version</span> === <span class="number">0</span>) &#123;</span><br><span class="line">        store.<span class="title function_">executeSql</span>(<span class="variable constant_">SQL_CREATE_TABLE</span>) <span class="comment">// Create the data table for subsequent insert operations</span></span><br><span class="line">          .<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">            <span class="comment">// Set the database version to an integer greater than 0</span></span><br><span class="line">            store.<span class="property">version</span> = <span class="number">3</span>;</span><br><span class="line">          &#125;)</span><br><span class="line">          .<span class="title function_">catch</span>(<span class="function">(<span class="params"><span class="attr">err</span>: <span class="title class_">BusinessError</span></span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">`Failed to executeSql. Code:<span class="subst">$&#123;err.code&#125;</span>, message:<span class="subst">$&#123;err.message&#125;</span>`</span>);</span><br><span class="line">          &#125;);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">      <span class="comment">// If the database version is not 0 and does not match the current version, upgrade/downgrade operations are required</span></span><br><span class="line">      <span class="comment">// When the database exists and is assumed to be version 1 (e.g., the app upgrades to the current version, requiring the database to upgrade from version 1 to 2)</span></span><br><span class="line">      <span class="keyword">if</span> (store.<span class="property">version</span> === <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">// version = 1: Table structure: EMPLOYEE (NAME, SALARY, CODES, ADDRESS) =&gt; version = 2: Table structure: EMPLOYEE (NAME, AGE, SALARY, CODES, ADDRESS)</span></span><br><span class="line">        store.<span class="title function_">executeSql</span>(<span class="string">&#x27;ALTER TABLE EMPLOYEE ADD COLUMN AGE INTEGER&#x27;</span>)</span><br><span class="line">          .<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">            store.<span class="property">version</span> = <span class="number">2</span>;</span><br><span class="line">          &#125;).<span class="title function_">catch</span>(<span class="function">(<span class="params"><span class="attr">err</span>: <span class="title class_">BusinessError</span></span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">`Failed to executeSql. Code:<span class="subst">$&#123;err.code&#125;</span>, message:<span class="subst">$&#123;err.message&#125;</span>`</span>);</span><br><span class="line">          &#125;);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">      <span class="comment">// When the database exists and is assumed to be version 2 (e.g., the app upgrades to the current version, requiring the database to upgrade from version 2 to 3)</span></span><br><span class="line">      <span class="keyword">if</span> (store.<span class="property">version</span> === <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="comment">// version = 2: Table structure: EMPLOYEE (NAME, AGE, SALARY, CODES, ADDRESS) =&gt; version = 3: Table structure: EMPLOYEE (NAME, AGE, SALARY, CODES)</span></span><br><span class="line">        store.<span class="title function_">executeSql</span>(<span class="string">&#x27;ALTER TABLE EMPLOYEE DROP COLUMN ADDRESS&#x27;</span>)</span><br><span class="line">          .<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">            store.<span class="property">version</span> = <span class="number">3</span>;</span><br><span class="line">          &#125;).<span class="title function_">catch</span>(<span class="function">(<span class="params"><span class="attr">err</span>: <span class="title class_">BusinessError</span></span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">`Failed to executeSql. Code:<span class="subst">$&#123;err.code&#125;</span>, message:<span class="subst">$&#123;err.message&#125;</span>`</span>);</span><br><span class="line">          &#125;);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// Ensure that after obtaining the RdbStore instance and completing data table creation, perform database operations such as insert, delete, update, and query</span></span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="string">``</span><span class="string">`  </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">HarmonyOS Next provides `</span>relationalStore<span class="string">` for database operations, but in CRUD (Create, Read, Update, Delete) operations, we generally implement a layer of encapsulation to convert database result sets to actual objects.  </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#### 3. Introduction to ORM Frameworks  </span></span><br><span class="line"><span class="string">HarmonyOS Next provides the `</span>dataORM<span class="string">` library for data relationship mapping. `</span>dataORM<span class="string">` is a lightweight ORM (Object-Relational Mapping) library that simplifies local database operations, offering high database access performance and low memory consumption. It supports features such as multi-threading, chain calls, backup, upgrade, caching, etc. Designed to be lightweight, fast, and easy to use, it helps developers quickly build high-performance applications. However, `</span>dataORM<span class="string">` has some limitations (e.g., no support for composite primary keys in database tables), and the official maintenance of this library has been discontinued.  </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Later, ByteDance open-sourced `</span>rdbStore<span class="string">`, which performs database operations in the form of DTO (Data Transfer Object) objects. It encapsulates capabilities such as database creation and automatic upgrade, database predicate construction, query result deserialization, and quality optimization, enabling simple and efficient database operations. In terms of operation and maintenance, it features comprehensive unit testing, quality data tracking and reporting, full-link logging, etc. Due to issues encountered in database upgrades, we switched to `</span>rdbStore<span class="string">` for data relationship mapping.  </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#### 4. Multi-Threading Optimization  </span></span><br><span class="line"><span class="string">In scenarios with large data volumes, querying data may cause long processing times or even application freezes. General recommendations include:  </span></span><br><span class="line"><span class="string">- Limit single query data volume to no more than 5,000 records.  </span></span><br><span class="line"><span class="string">- Perform queries in a TaskPool.  </span></span><br><span class="line"><span class="string">- Keep SQL statement concatenation concise.  </span></span><br><span class="line"><span class="string">- Implement reasonable batch querying.  </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">When the number of user conversations reached a certain level, due to a join query involving 50 columns after expansion, the query took 6-7 seconds, causing severe application lags and even freeze exceptions. Therefore, complex and time-consuming queries were moved to child threads.  </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">`</span><span class="string">``</span>ts</span><br><span class="line"><span class="meta">@Concurrent</span>  </span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getConvDetailObservableThread</span>(<span class="params"><span class="attr">context</span>: <span class="title class_">Context</span>, <span class="attr">param</span>: <span class="title class_">Param</span>, <span class="attr">convId</span>: <span class="built_in">number</span></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">ConvBean</span> | <span class="literal">undefined</span>&gt; &#123;  </span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;ConvImpl&#x27;</span>, <span class="string">&quot;getConvDetailObservableThread,convId=&quot;</span> + convId);  </span><br><span class="line">  <span class="comment">// Store parameters, context, etc., in the thread</span></span><br><span class="line">  <span class="keyword">await</span> <span class="title class_">DBManager</span>.<span class="title function_">getInstance</span>().<span class="title function_">initDB</span>();  </span><br><span class="line">  <span class="keyword">const</span> conv = <span class="keyword">await</span> <span class="title class_">DBManager</span>.<span class="title function_">getInstance</span>()  </span><br><span class="line">    .<span class="title function_">getConvDaoHelper</span>()  </span><br><span class="line">    .<span class="title function_">getConvById</span>(convId);  </span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> result = <span class="keyword">await</span> taskpool.<span class="title function_">execute</span>(getConvDetailObservableThread,  </span><br><span class="line">  context,</span><br><span class="line">  param,</span><br><span class="line">  convId);</span><br></pre></td></tr></table></figure>


<p>By default, data transfer between threads uses a copy method. For ultimate performance, it can be changed to the <code>Sendable</code> method.  </p>
<h4 id="5-Optimization-for-Slow-Data-Queries"><a href="#5-Optimization-for-Slow-Data-Queries" class="headerlink" title="5. Optimization for Slow Data Queries"></a>5. Optimization for Slow Data Queries</h4><p>Although the lag was basically resolved after the above optimizations, the issue of long query times persisted. The first entry into the conversation list took 7-8 seconds, resulting in poor user experience. Additionally, a strange phenomenon occurred: the Mac version simulator took tens of milliseconds, while real devices took 6-7 seconds.  </p>
<p>Analyzing the query process step by step, since it involved a join query, using <code>relationalStore</code> interfaces for direct query execution was fast, but the process of <code>resultSet.goToNextRow()</code> in the result set was time-consuming.  </p>
<p>Initially, traversal read data row by column: <code>resultSet.getLong(resultSet.getColumnIndex(&#39;unreadMsgCount&#39;));</code>. The official API12 provided the <code>getRow</code> interface, which can read an entire column at once. After switching to the <code>getRow</code> method, the query time was optimized from 7-8 seconds to 700-800 milliseconds—ten times faster.  </p>
<p>In API18, a new <code>getRows</code> interface was added, which can read all specified rows directly, yielding even better results.  </p>
<h3 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h3><p>This article focuses on the optimization process for database query lags caused by large conversation and message data volumes among B-end users in IMSDK development based on HarmonyOS Next. It first introduces the SQLite-based features of the HarmonyOS Next relational database, including transactions, indexes, and other functions, as well as the usage of RdbStore. It then compares two ORM frameworks, <code>dataORM</code> and <code>rdbStore</code>, and switches to the more efficient <code>rdbStore</code> due to <code>dataORM</code> being discontinued and upgrade-related issues.  </p>
<p>In terms of performance optimization, a multi-threading solution moves complex queries to child threads to avoid main thread blocking, while adhering to principles such as limiting single query data to under 5,000 records and concise SQL concatenation. For query latency issues, analysis revealed low result set traversal efficiency, which was improved by using HarmonyOS-provided new interfaces like <code>getRow</code> and <code>getRows</code>, reducing query time from 7-8 seconds to 700-800 milliseconds and significantly enhancing data reading efficiency. This optimization not only resolves application lags and message delays but also provides referable practical experience for database operations in large data volume scenarios on the HarmonyOS platform.</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://harmonyostech.github.io/2025/06/08/HarmonyOS-Next-IM-Practical-Combat-Handling-So-Dynamic-Library-Crash-Issues-Caused-by-Worker-Threads/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Qingkouwei">
      <meta itemprop="description" content="Welcome to the HarmonyOS NEXT Knowledge Charging Station!  This is a hub for knowledge about HarmonyOS Next`s new-generation system. With its self-developed kernel, HarmonyOS NEXT achieves native smoothness, security, intelligence, and interconnectivity. We deeply analyze how its new distributed soft bus revolutionizes device connectivity experiences and explain the principles behind the enhanced perception and reasoning capabilities of the Xiaoyi intelligent agent based on the Pangu large model. Whether you are a developer exploring application development or an ordinary user eager to understand system features, you can "recharge" here and quickly grasp the essence of HarmonyOS NEXT.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HarmonyOS NEXT Knowledge Charging Station">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/06/08/HarmonyOS-Next-IM-Practical-Combat-Handling-So-Dynamic-Library-Crash-Issues-Caused-by-Worker-Threads/" class="post-title-link" itemprop="url">HarmonyOS Next IM Practical Combat: Handling So Dynamic Library Crash Issues Caused by Worker Threads</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2025-06-08 17:15:15" itemprop="dateCreated datePublished" datetime="2025-06-08T17:15:15+08:00">2025-06-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-06-24 16:09:14" itemprop="dateModified" datetime="2025-06-24T16:09:14+08:00">2025-06-24</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h4 id="Background-Introduction"><a href="#Background-Introduction" class="headerlink" title="Background Introduction"></a>Background Introduction</h4><p>After the IM SDK for HarmonyOS Next was integrated into the application and launched, many users reported significant app lag, particularly those with a large number of conversations and messages. Due to design flaws in the SDK’s logic, receiving a message triggered a full refresh of the conversation list, which involved querying the entire database. This operation was time-consuming when there were many conversations and was originally performed on the main thread, causing the app to freeze.</p>
<p>To address this issue, we decided to leverage HarmonyOS’s Worker threads. We introduced two worker threads during app initialization: one for fetching the conversation list and another for message retrieval. This approach aimed to offload database operations from the main thread. Workers were chosen because these operations are complex, involve multiple tasks, and require background thread support.</p>
<h4 id="Problem-Description"><a href="#Problem-Description" class="headerlink" title="Problem Description"></a>Problem Description</h4><p>After creating the worker thread as per the standard procedure and starting it during SDK initialization:</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">this</span>.<span class="property">syncConfigWorkerInstance</span> = <span class="keyword">new</span> worker.<span class="title class_">ThreadWorker</span>(<span class="string">&quot;../workers/SyncConfigAndConvWorker.ets&quot;</span>);  </span><br><span class="line"><span class="variable language_">this</span>.<span class="property">syncConfigWorkerInstance</span>.<span class="property">onmessage</span> = <span class="title function_">async</span> (event) =&gt; &#123;</span><br><span class="line">  <span class="comment">// Event handler</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The application crashed or froze immediately after starting the worker, even though the worker thread itself did nothing. The crash occurred in a C++ shared library (<code>.so</code>) unrelated to the worker’s logic, which was puzzling:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Timestamp: 2025-05-07 17:12:54:794</span><br><span class="line">Tid: 8025, Name: beike.imsdk.tob</span><br><span class="line">#00 pc 00000000001b6344 /system/lib/ld-musl-aarch64.so.1(fcf57c313493609e8c78a5f07477c358)</span><br><span class="line">#01 pc 00000000001b834c /system/lib/ld-musl-aarch64.so.1(pthread_cond_timedwait+188)(fcf57c313493609e8c78a5f07477c358)</span><br><span class="line">#02 pc 00000000000c430c /data/storage/el1/bundle/libs/arm64/libc++_shared.so(std::__n1::condition_variable::wait(std::__n1::unique_lock&lt;std::__n1::mutex&gt;&amp;)+20)(cdf97be9396a35e8f4806f252f90a11320d26ec6)</span><br><span class="line">#03 pc 00000000000c4e9c /data/storage/el1/bundle/libs/arm64/libc++_shared.so(std::__n1::__assoc_sub_state::__sub_wait(std::__n1::unique_lock&lt;std::__n1::mutex&gt;&amp;)+48)(cdf97be9396a35e8f4806f252f90a11320d26ec6)</span><br><span class="line">#04 pc 00000000000447f4 /data/storage/el1/bundle/libs/arm64/libmarsstn.so(4ed6d779cb9585f42f228dfc8a706399ce60a56f)</span><br><span class="line">#05 pc 0000000000044344 /data/storage/el1/bundle/libs/arm64/libmarsstn.so(4ed6d779cb9585f42f228dfc8a706399ce60a56f)</span><br><span class="line">#06 pc 00000000000d7cf0 /data/storage/el1/bundle/libs/arm64/libmarsstn.so(4ed6d779cb9585f42f228dfc8a706399ce60a56f)</span><br><span class="line">#07 pc 000000000006983c /data/storage/el1/bundle/libs/arm64/libmarsstn.so(4ed6d779cb9585f42f228dfc8a706399ce60a56f)</span><br></pre></td></tr></table></figure>

<h4 id="Problem-Diagnosis"><a href="#Problem-Diagnosis" class="headerlink" title="Problem Diagnosis"></a>Problem Diagnosis</h4><p>Initially, the crash was reproducible in a specific scenario but later became random. Disabling the dynamic library initialization or the worker thread resolved the issue. To identify the root cause, we enabled multithreading detection on a physical device:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hdc shell param <span class="built_in">set</span> persist.ark.properties 0x107c</span><br></pre></td></tr></table></figure>

<p>After rebooting the device and reproducing the crash, we obtained the following details:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Process name: com.beike.imsdk.tob</span><br><span class="line">Process life time: 34s</span><br><span class="line">Reason: Signal: SIGABRT(SI_TKILL)@0x01317b4e00004e2a from: 20010:20020046</span><br><span class="line">LastFatalMessage: [(ark_native_reference.cpp:117)(Get)] param env is not equal to its owner</span><br><span class="line">Fault thread info:</span><br><span class="line">Tid: 20010, Name: kou.imsdk.tob</span><br><span class="line">#00 pc 0000000000199e1c /system/lib/ld-musl-aarch64.so.1(raise+228)(6b9883f518515f73e093bce9a89a2548)</span><br><span class="line">#01 pc 0000000000146f8c /system/lib/ld-musl-aarch64.so.1(abort+20)(6b9883f518515f73e093bce9a89a2548)</span><br><span class="line">#02 pc 0000000000056fac /system/lib64/platformsdk/libace_napi.z.so(ArkNativeReference::Get(NativeEngine*)+476)(edf034e044dbf26f955142c343577527)</span><br><span class="line">#03 pc 000000000005f0a0 /system/lib64/platformsdk/libace_napi.z.so(napi_get_reference_value+48)(edf034e044dbf26f955142c343577527)</span><br><span class="line">#04 pc 00000000000ea354 /data/storage/el1/bundle/libs/arm64/libmarsstn.so(160beef25288e9539a33ed6f307aa362ceb17fc1)</span><br><span class="line">#05 pc 0000000000070754 /system/lib64/platformsdk/libace_napi.z.so(NativeSafeAsyncWork::ProcessAsyncHandle()+596)</span><br></pre></td></tr></table></figure>

<p>Using the <code>addr2line</code> tool, we traced the crash to the <code>napi_get_reference_value</code> call in <code>libmarsstn.so</code>, where the <code>env</code> parameter was invalid.</p>
<p>Further investigation revealed that the <code>env</code> was cached from the main thread during SO initialization (performed on the main thread). Adding logs confirmed that the crash occurred when the main thread used this cached <code>env</code>, which had been overwritten by a worker thread:</p>
<p><img src="/../images/HarmonyOS%20Next%20IM%E5%AE%9E%E6%88%98%EF%BC%9AWorker%E7%BA%BF%E7%A8%8B%E4%B8%AD%E5%BC%95%E8%B5%B7%E7%9A%84so%E5%8A%A8%E6%80%81%E5%BA%93%E5%B4%A9%E6%BA%83%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86.png" alt="text"></p>
<p>Logs showed that the <code>napi_module_register</code> function in the SO library was being called from worker threads, overwriting the cached <code>mainEnv_</code> (a singleton in C++). </p>
<p>In HarmonyOS Next, Worker threads are isolated with their own memory spaces, similar to separate processes. Each Worker thread loads the SO library independently, leading to multiple initializations.</p>
<h4 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h4><p>To resolve the issue, we ensured that <code>mainEnv_</code> is initialized only once, during the first call from the main thread. We used <code>std::atomic</code> for thread-safe initialization:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">std::atomic&lt;<span class="type">bool</span>&gt; flag&#123;<span class="literal">false</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">bool</span> expected = <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">if</span> (flag.<span class="built_in">compare_exchange_strong</span>(expected, <span class="literal">true</span>)) &#123;</span><br><span class="line">    napi_status status;</span><br><span class="line">    <span class="type">int32_t</span> ret;</span><br><span class="line">    <span class="keyword">auto</span> context = MarsNapiManager::<span class="built_in">getInstance</span>();</span><br><span class="line">    <span class="keyword">if</span> (context) &#123;</span><br><span class="line">        context-&gt;mainEnv_ = env;</span><br><span class="line">        context-&gt;mainThreadId = std::this_thread::<span class="built_in">get_id</span>();</span><br><span class="line">        <span class="keyword">auto</span> marsNapi = context-&gt;<span class="built_in">getMarsNapi</span>();</span><br><span class="line">        marsNapi-&gt;<span class="built_in">Export</span>(env, exports);</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">xdebug2</span>(TSF<span class="string">&quot;napi--&gt;initXComponent not first&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Another-Multithreading-Issue"><a href="#Another-Multithreading-Issue" class="headerlink" title="Another Multithreading Issue"></a>Another Multithreading Issue</h4><p>When passing SDK configuration parameters to the worker thread using HarmonyOS Next’s Sendable mechanism, the application crashed with the error:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TypeError: Cannot set sendable property with mismatched type</span><br></pre></td></tr></table></figure>

<p>The crash occurred during <code>postMessage</code>. Initially, we serialized the object to JSON to bypass the issue. Further investigation revealed that the demo used class instances (which implemented Sendable), while the app used Record objects, which lacked Sendable implementation.</p>
<h4 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h4><p>This case highlights critical differences between HarmonyOS Next’s Worker threads and traditional thread models: each Worker thread loads SO libraries independently, causing the main thread’s <code>env</code> cached in C++ singletons to be overwritten. Key findings:</p>
<ol>
<li><strong>Root Cause</strong>: The main thread’s cached <code>env</code> (<code>mainEnv_</code>) was overwritten by worker threads during <code>napi_module_register</code>, leading to invalid <code>env</code> usage in <code>napi_get_reference_value</code>.</li>
<li><strong>Thread Characteristics</strong>: Worker threads have strong memory isolation, similar to separate processes, causing SO libraries to be reloaded.</li>
<li><strong>Solution</strong>: Use <code>std::atomic</code> to ensure <code>mainEnv_</code> is initialized only once on the main thread, with <code>compare_exchange_strong</code> for thread safety.</li>
<li><strong>Derived Issue</strong>: Cross-thread data transfer must strictly follow the Sendable protocol; non-Sendable objects (e.g., Record) should be serialized to JSON.</li>
</ol>
<p>This case underscores two critical considerations in HarmonyOS multithreading: <strong>thread safety during SO library initialization</strong> and <strong>strict adherence to cross-thread data transfer protocols</strong>.</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/33/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/33/">33</a><span class="page-number current">34</span><a class="page-number" href="/page/35/">35</a><a class="extend next" rel="next" href="/page/35/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Qingkouwei</p>
  <div class="site-description" itemprop="description">Welcome to the HarmonyOS NEXT Knowledge Charging Station!  This is a hub for knowledge about HarmonyOS Next`s new-generation system. With its self-developed kernel, HarmonyOS NEXT achieves native smoothness, security, intelligence, and interconnectivity. We deeply analyze how its new distributed soft bus revolutionizes device connectivity experiences and explain the principles behind the enhanced perception and reasoning capabilities of the Xiaoyi intelligent agent based on the Pangu large model. Whether you are a developer exploring application development or an ordinary user eager to understand system features, you can "recharge" here and quickly grasp the essence of HarmonyOS NEXT.</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">342</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">1</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Qingkouwei</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
